<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Habit</title>

    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f3f4f6">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/task.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/32/task.png">

    <style>
        /* ================== CSS å˜é‡å®šä¹‰ ================== */
        :root {
            /* â˜€ï¸ æ—¥é—´æ¨¡å¼ */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --header-bg: rgba(255, 255, 255, 0.95);

            /* åŠŸèƒ½è‰² */
            --success: #10b981;
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --info: #3b82f6;

            /* æ—¶é—´é“¶è¡Œè‰² (Indigo/Purple) */
            --time: #6366f1;
            --time-bg: #e0e7ff;

            /* é˜´å½±ä¸è¾¹è· */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* ğŸŒ™ å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            --input-bg: #111827;
            --header-bg: rgba(17, 24, 39, 0.95);

            --success: #34d399;
            --success-bg: rgba(6, 78, 59, 0.4);
            --warning: #fbbf24;
            --warning-bg: rgba(69, 26, 3, 0.4);
            --danger: #f87171;
            --danger-bg: rgba(69, 10, 10, 0.4);

            --time: #818cf8;
            --time-bg: rgba(67, 56, 202, 0.4);

            --shadow: none;
        }

        /* ================== åŸºç¡€æ ·å¼ ================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: calc(90px + var(--safe-area-bottom));
            line-height: 1.5;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--header-bg); backdrop-filter: blur(10px);
            padding: 10px 14px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            min-height: 56px;
            box-sizing: border-box;
        }
        .header-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Sticky Notification Bar */
        .sticky-notif-bar {
            position: sticky;
            top: 56px;
            z-index: 999;
            background: var(--header-bg);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 3px;
            padding: 6px 14px;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .notif-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
            padding: 5px 8px;
            border-radius: 6px;
        }
        .notif-timer { background: var(--success-bg); color: var(--success); border: 1px solid rgba(52, 211, 153, 0.2); }
        .notif-pinned { background: var(--time-bg); color: var(--time); border: 1px solid rgba(129, 140, 248, 0.2); }
        .notif-quick-study { background: var(--primary-bg); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.3); }
        .notif-btn { font-size: 12px; cursor: pointer; opacity: 0.9; padding: 4px 12px; border-radius: 6px; transition: all 0.2s; }
        .notif-btn:hover { opacity: 1; transform: scale(1.05); }

        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0; 
            height: 100%;
        }
        .header-left h1 {
            margin: 0; font-size: 16px; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, #a855f7 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1;
            padding: 0;
            display: block;
            text-indent: 0;
            letter-spacing: 0;
            position: relative;
        }
        .header-badges {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-badge {
            font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px;
            opacity: 0.9; color: var(--text-sub); background: var(--input-bg);
            padding: 3px 7px; border-radius: 10px; border: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s;
            line-height: 1;
            margin: 0;
            display: inline-flex;
        }
        .sync-badge:active { transform: scale(0.95); background: var(--border); }
        .sync-badge.status-syncing { cursor: not-allowed; opacity: 0.7; pointer-events: none; }
        .sync-icon { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #d1d5db; }
        .status-idle .sync-icon { background: var(--success); }
        .status-syncing .sync-icon { background: transparent; border: 2px solid var(--info); border-top-color: transparent; width: 10px; height: 10px; animation: spin 0.8s linear infinite; }
        .status-error .sync-icon { background: var(--danger); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-right {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
            height: 100%;
            flex-shrink: 0;
        }
        .theme-btn {
            background: none; border: 1px solid var(--border); font-size: 14px;
            cursor: pointer; padding: 0; width: 28px; height: 28px;
            border-radius: 50%; transition: all 0.3s; color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .fund-badge {
            padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 4px;
            white-space: nowrap; flex-shrink: 0; height: 28px; cursor: pointer;
            line-height: 1;
        }
        .badge-wallet { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--border); }
        .badge-debt { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--border); }
        .badge-time { background: var(--time-bg); color: var(--time); border: 1px solid var(--border); }

        .container { max-width: 500px; margin: 12px auto; padding: 0 14px; position: relative; z-index: 1; }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .card[style*="border-color:var(--primary)"] {
            background: transparent;
        }
        #view-todo .card {
            background: transparent;
            padding: 12px !important;
        }
        .card-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }

        .toggle-container { display: flex; background: var(--border); padding: 3px; border-radius: 10px; margin-bottom: 12px; }
        .toggle-btn { flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

        .week-btn {
            padding: 10px 16px; border-radius: 10px; background: var(--input-bg);
            border: 1px solid var(--border); color: var(--text-sub);
            font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center;
        }
        .week-btn.active {
            background: var(--info); color: #fff; border-color: var(--info);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .input-group { margin-bottom: 10px; }
        .input-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); margin-bottom: 4px; font-weight: 600;}
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        input, select, textarea {
            width: 100%; padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-main);
            font-weight: 600;
            outline: none; -webkit-appearance: none;
            font-family: inherit;
            text-align: left;
        }
        textarea { resize: vertical; min-height: 36px; }
        input:focus, textarea:focus { border-color: var(--primary); }

        button { user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-calc {
            width: 100%; padding: 10px; border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; font-size: 14px; font-weight: 700;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        [data-theme="dark"] .btn-calc { box-shadow: none; }

        .btn-secondary { background: var(--border); color: var(--text-sub); box-shadow: none; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3); }
        .btn-mini { width: auto; padding: 6px 12px; font-size: 12px; margin-top: 0; border-radius: 8px;}
        .btn-prevent { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; box-shadow:none;}
        [data-theme="dark"] .btn-prevent { background: rgba(55, 48, 163, 0.4); color: #818cf8; border-color: #4338ca; }

        .list-item {
            padding: 10px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
            background: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .list-item:last-child { margin-bottom: 0; }
        
        /* Inline Editor Styles */
        .inline-editor {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .inline-editor .input-group { margin-bottom: 12px; }
        .inline-editor .input-label { font-size: 11px; margin-bottom: 4px; }
        .inline-editor input, .inline-editor textarea { 
            padding: 10px; border-radius: 8px; font-size: 14px; 
            border-width: 1px;
        }

        .btn-action {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-sub); margin-left: 3px;
            background: var(--input-bg); transition: all 0.2s;
            font-size: 12px; font-weight: normal; border: 1px solid transparent; flex-shrink: 0;
        }
        .btn-action:hover { background: var(--border); }
        .btn-edit:hover { background: var(--info); color: #fff; }
        .btn-del:hover { background: var(--danger-bg); color: var(--danger); border-color: var(--danger); }

        .btn-nuke {
            font-size: 11px;
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 8px;
        }

        .privacy-check-label {
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: var(--text-sub); margin-top: 12px;
            cursor: pointer; padding: 12px; background: var(--input-bg);
            border-radius: 12px; border: 2px solid var(--border);
            transition: all 0.2s; user-select: none;
        }
        .privacy-check-label:active { transform: scale(0.98); }
        .privacy-check-label.checked { border-color: var(--warning); background: var(--warning-bg); color: var(--warning); font-weight: bold; }
        .privacy-check-label input { display: none; }
        .privacy-check-label::before { content: 'ğŸ”“'; margin-right: 8px; font-size: 14px; }
        .privacy-check-label.checked::before { content: 'ğŸ”’'; }

        .todo-section-title { font-size: 11px; font-weight: 800; color: var(--text-sub); margin: 18px 0 8px 4px; text-transform: uppercase; letter-spacing: 0.5px; display: none; align-items: center;}
        .todo-section-title.show { display: flex; }

        .todo-item {
            padding: 8px 10px; border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); transition: all 0.3s ease; position: relative;
        }

        .todo-expired-item { opacity: 0.6; background: var(--border); filter: grayscale(1); }

        .todo-check { width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--success); font-size: 14px; opacity: 0.7; transition: opacity 0.2s; flex-shrink: 0;}
        .todo-check:hover { opacity: 1; }
        .click-anim { animation: press 0.3s ease-out; }
        @keyframes press { 0% { transform: scale(1); } 50% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* æ‚¬æµ®èœå• */
        .action-menu {
            position: absolute;
            right: 46px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 4px 8px;
            display: none;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 20;
            animation: fadeIn 0.2s ease;
        }
        .action-menu.show { display: flex; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(10px, -50%); } to { opacity: 1; transform: translate(0, -50%); } }

        .action-menu-dropdown {
            flex-direction: column !important;
            border-radius: 12px !important;
            padding: 8px !important;
            min-width: 140px;
            gap: 4px !important;
            right: 0 !important;
            top: 40px !important;
            transform: none !important;
            align-items: stretch !important;
        }

        .review-history-item {
            border-bottom: 1px dashed var(--border);
            padding: 12px 0;
        }
        .review-history-item:last-child { border-bottom: none; }
        .review-history-date { font-size: 12px; font-weight: bold; color: var(--primary); margin-bottom: 4px; }
        .review-history-content { font-size: 13px; color: var(--text-main); line-height: 1.4; }
        .review-history-label { font-size: 11px; color: var(--text-sub); margin-top: 4px; }

        .tab-bar {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 460px; background: var(--header-bg); backdrop-filter: blur(10px);
            border-radius: 10px; display: flex; padding: 6px 10px;
            box-shadow: 0 4px 12px -4px rgba(0,0,0,0.1); z-index: 1000;
            border: 1px solid var(--border); justify-content: space-between;
            padding-bottom: calc(6px + var(--safe-area-bottom));
        }
        .tab { text-align: center; color: var(--text-sub); cursor: pointer; font-size: 9px; flex: 1; padding: 2px 0; transition: all 0.2s; }
        .tab.active { color: var(--primary); }
        .tab-icon { font-size: 16px; display: block; margin-bottom: 1px; }

        .page { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }

        .heatmap-container { display: flex; gap: 6px; justify-content: space-between; margin-bottom: 20px; }
        .heatmap-day { flex: 1; text-align: center; }
        .heatmap-box { height: 36px; border-radius: 8px; background: var(--border); margin-bottom: 6px; }
        .hm-success { background: var(--success); } .hm-fix { background: var(--warning); } .hm-repair { background: var(--danger); }

        .chips-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .chip { font-size: 12px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; color: var(--text-sub); transition: all 0.2s; }
        .chip:hover { background: var(--input-bg); border-color: var(--primary); color: var(--primary); }
        .chip.active { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .chip-removable { padding-right: 8px; display:inline-flex; align-items:center; }
        .chip-removable::after { content:'Ã—'; font-weight:bold; margin-left:6px; font-size:14px; opacity:0.5; }

        .record-img {
            width: 40px; height: 40px;
            border-radius: 6px; border: 1px solid var(--border);
            margin-left: 10px; object-fit: cover; cursor: zoom-in; background: #eee;
        }

        .close-pending { position: absolute; top: 12px; right: 12px; color: var(--text-sub); opacity: 0.5; cursor: pointer; font-weight: bold; }
        .close-pending:hover { opacity: 1; }
        
        /* å¾…åŠé€‰æ‹©å¼¹çª—æ ·å¼ */
        #todoSelectModal > div {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .todo-date-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 6px;
            background: var(--border); color: var(--text-main); margin-left: 6px;
            font-weight: 600;
        }

        .backup-file-item {
            padding: 12px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; cursor: pointer;
        }
        .backup-file-item:hover { background: var(--input-bg); }
        
        /* è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡† */
        .custom-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);
            z-index: 10000; align-items: center; justify-content: center;
        }
        .custom-modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card); border-radius: 16px;
            width: 90%; max-width: 420px; padding: 24px;
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-title {
            font-size: 18px; font-weight: 700; margin-bottom: 16px;
            color: var(--text-main);
        }
        .modal-message {
            font-size: 14px; color: var(--text-sub); margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex; gap: 12px; margin-top: 20px;
        }
        .modal-btn {
            flex: 1; padding: 12px; border: none; border-radius: 12px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn-primary {
            background: var(--primary); color: white;
        }
        .modal-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .modal-btn-secondary {
            background: var(--border); color: var(--text-main);
        }
        .modal-btn-secondary:hover { background: var(--input-bg); }
        .modal-input {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--input-bg);
            font-size: 14px; color: var(--text-main);
            margin-bottom: 12px; box-sizing: border-box;
        }
        .modal-input:focus {
            outline: none; border-color: var(--primary);
        }
        .modal-input-label {
            display: block; font-size: 13px; color: var(--text-sub);
            margin-bottom: 8px; font-weight: 600;
        }
        
        /* Global custom checkbox styling */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--input-bg);
            cursor: pointer;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            vertical-align: middle;
        }

        input[type="checkbox"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-size: 14px;
            background-position: center;
            background-repeat: no-repeat;
        }

        input[type="checkbox"]:checked::after {
            content: none;
        }
        
        /* ç•Œé¢æ˜¾ç¤ºé…ç½®å¤é€‰æ¡†æ ·å¼ - Special override */
        .interface-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }
        .interface-option-label {
            flex: 1; font-size: 14px; font-weight: 600;
            color: var(--text-main);
        }
        .interface-option.checked .interface-option-label {
            color: var(--success);
        }
        .interface-option-icon {
            font-size: 18px;
            opacity: 0.3;
            transition: all 0.2s;
        }
        .interface-option.checked .interface-option-icon {
            opacity: 1;
        }

        /* Time Bank Exchange Card */
        .exchange-card {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--time);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }


        /* ç§»åŠ¨ç«¯è¾“å…¥æ³•é®æŒ¡ä¿®å¤ */
        @media (max-width: 600px) {
            .custom-modal {
                /* æ”¹ç”¨ flex-start + margin:auto æ–¹å¼å±…ä¸­ï¼Œé¿å…é”®ç›˜å¼¹å‡ºæ—¶é¡¶éƒ¨è¢«åˆ‡ */
                align-items: flex-start;
                padding-top: 20px;
                padding-bottom: 20px;
                overflow-y: auto; /* å…è®¸æ•´ä¸ªé®ç½©å±‚æ»šåŠ¨ */
            }
            .modal-content {
                margin: auto; /* åœ¨ç©ºé—´è¶³å¤Ÿæ—¶å‚ç›´å±…ä¸­ */
                /* ç§»é™¤ max-height é™åˆ¶ï¼Œè®©å®¹å™¨æ»šåŠ¨ */
                max-height: none !important; 
                width: 95%;
            }
            /* é’ˆå¯¹ç‰¹å®š modal çš„å†…éƒ¨æ»šåŠ¨å®¹å™¨å–æ¶ˆé™åˆ¶ */
            #checkinModal .modal-content {
                max-height: none !important; 
            }
        }
    </style>
</head>
<body onclick="if(event.target.id === 'todoSelectModal') closeTodoSelectModal(); else closeAllMenus(event);">

    <div class="header">
        <div class="header-left">
            <h1>Habit</h1>
            <div id="syncBadge" class="sync-badge status-idle" onclick="if(!this.classList.contains('status-syncing')) { this.setAttribute('data-click-handled', 'true'); setTimeout(() => this.removeAttribute('data-click-handled'), 1000); syncAll('pull', false); }">
                <span class="sync-icon"></span><span id="syncText">æœ¬åœ°æ¨¡å¼</span>
            </div>
        </div>
        <div class="header-right">
            <div class="header-badges">
                <div class="fund-badge badge-time" onclick="showTimeBankModal()">â³ <span id="timeBankDisplay">0</span></div>
                <div class="fund-badge badge-wallet" onclick="showWalletModal()">ğŸ’° <span id="walletDisplay">0</span></div>
                <div class="fund-badge badge-debt" onclick="showDebtModal()">ğŸ’¸ <span id="debtDisplay">0</span></div>
            </div>
            <button id="checkinBtn" class="theme-btn" onclick="showCheckinModal()" title="æ™¨é—´æ‰“å¡">âœ¨</button>
            <button id="settingsBtn" class="theme-btn" onclick="showSettingsModal()" title="è®¾ç½®">âš™ï¸</button>
            <button id="themeToggle" class="theme-btn" onclick="toggleTheme()">â˜€ï¸</button>
        </div>
    </div>

    <div id="stickyNotifBar" class="sticky-notif-bar">
        <!-- å­¦ä¹ å¿«é€ŸæŒ‰é’® -->
        <div id="notifQuickStudy" class="notif-item notif-quick-study" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; flex:1; position:relative;">
                <span id="notifStudyLabel" style="font-weight:600; color:var(--primary); font-size:14px; cursor:pointer;" onclick="showQuickTaskSelectMenu(event)">ğŸ“š å­¦ä¹ </span>
                <span id="notifStudyTime" style="font-size:12px; color:var(--text-sub); opacity:0.8; font-family:monospace;">0.0h</span>
                <div id="quickTaskSelectMenu" style="display:none; position:absolute; left:0; top:100%; margin-top:4px; flex-direction:column; border-radius:12px; padding:8px; min-width:120px; max-height:200px; overflow-y:auto; z-index:1000; background:var(--bg-card); border:1px solid var(--border); box-shadow:0 4px 15px rgba(0,0,0,0.15); transform:none;">
                    <!-- èœå•å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div style="display:flex; gap:8px; position:relative;">
                <div style="position:relative;">
                    <div class="notif-btn" style="background:var(--primary); color:#fff; font-weight:600; padding:6px 16px; cursor:pointer;" onclick="event.stopPropagation(); quickStartFromNotif()">å¼€å§‹</div>
                </div>
                <div class="notif-btn" style="background:var(--info); color:#fff; font-weight:600; padding:6px 16px;" onclick="event.stopPropagation(); showTimerModal()">æŸ¥çœ‹</div>
            </div>
        </div>
        <!-- è®¡æ—¶çŠ¶æ€ -->
        <div id="notifTimer" class="notif-item notif-timer" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span id="notifTimerName">ä»»åŠ¡</span>
                <span id="notifTimerClock" style="font-family: monospace; font-size:14px;">00:00:00</span>
            </div>
            <div style="display:flex; gap:8px;">
                <div class="notif-btn" id="notifTimerPauseBtn" onclick="toggleTimerPause()">â¸ï¸</div>
                <div class="notif-btn" onclick="stopTimer()">â¹ï¸</div>
                <div class="notif-btn" onclick="event.stopPropagation(); showTimerModal()">æŸ¥çœ‹</div>
            </div>
        </div>
        <!-- ç½®é¡¶ä»»åŠ¡ -->
        <div id="notifPinned" class="notif-item notif-pinned" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span>ç½®é¡¶è®¡åˆ’: <span id="notifPinnedName">è®¡åˆ’å</span></span>
                <span id="notifPinnedTime" style="font-size:11px; opacity:0.8;"></span>
            </div>
            <div style="display:flex; gap:12px;">
                <div class="notif-btn" onclick="startPinnedTask()">å¼€å§‹</div>
                <div class="notif-btn" onclick="unpinTask()">âœ•</div>
            </div>
        </div>
        <!-- ç½®é¡¶å€’æ•°æ—¥ -->
        <div id="notifDaysMatter" class="notif-item" style="display:none; background:var(--bg-card); border:1px solid var(--border); padding:4px 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;"></div>
    </div>

    <!-- éšè—çš„æ‰“å¡å…ƒç´ ï¼Œç”¨äºè®¡ç®—åŠŸèƒ½ -->
    <div style="display:none;">
        <div id="pendingCard" class="card" style="background:var(--warning-bg); border-color:var(--warning); display:none; position:relative;">
            <div class="close-pending" onclick="closePendingCard()">âœ•</div>
            <div style="font-size:13px; font-weight:800; color:var(--warning); margin-bottom:8px;">å¾…æ‰§è¡Œè¡¥æ•‘æªæ–½</div>
            <div id="pendingText" style="font-weight:600; color:var(--text-main); font-size:15px; line-height:1.4;"></div>
        </div>
        <div id="exchangeCard" class="exchange-card" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div style="font-weight:800; color:var(--time);">æ—¶é—´é“¶è¡Œå…‘æ¢</div>
                <div class="btn-action" onclick="toggleExchangeCard()">âœ•</div>
            </div>
            <div style="font-size:13px; color:var(--text-sub); margin-bottom:12px;">1å°æ—¶ = <span id="rateDisplay">5</span> å…ƒ</div>
            <div style="display:flex; gap:8px;">
                <input type="number" id="exchangeHours" placeholder="å°æ—¶æ•°" style="flex:1;">
                <button class="btn-mini" style="background:var(--time); color:#fff; width:auto;" onclick="executeExchange()">å…‘æ¢</button>
            </div>
        </div>
        <div class="card" id="inputCard">
            <div class="card-title">æ‰“å¡ <span id="dayTypeBadge" style="display:none;background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:10px;">å‘¨æœ«</span></div>
            <div class="input-group">
                <label class="input-label">æ—¥æœŸ</label>
                <input type="date" id="dateInput" onchange="checkDateChange()">
                <div class="chips-container" style="margin-top:8px;">
                    <div class="chip" onclick="quickSetDate('today')">ä»Šæ—¥</div>
                    <div class="chip" onclick="quickSetDate('yesterday')">æ˜¨æ—¥</div>
                </div>
            </div>
            <div class="row">
                <div class="input-group"><label class="input-label">å…¥ç¡ <span id="targetSleep" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="sleepInput" value="00:00"></div>
                <div class="input-group"><label class="input-label">èµ·åºŠ <span id="targetWake" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="wakeInput" value="08:30"></div>
            </div>
            <div class="input-group"><label class="input-label">ä¸“æ³¨ (h)</label><input type="number" step="0.1" id="studyInput" placeholder="æ—¶é•¿"></div>
            <div id="strategyArea" class="chips-container" style="margin-bottom:15px;"></div>
            <div id="manualInputs" style="display:none; margin-top:15px; border-top:1px dashed var(--border); padding-top:15px;">
                <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="manualPenalty" placeholder="0"></div>
                <div class="input-group"><label class="input-label">åŸå› </label><textarea id="manualReason" placeholder="åŸå› "></textarea></div>
            </div>
        </div>
        <div id="analysisCard" class="card" style="display:none; text-align:center;"></div>
        <div id="formContainer"></div>
    </div>

    <!-- 1. é¦–é¡µ -->
    <div id="page-checkin" class="container page active">
        <!-- å¾…åŠè§†å›¾ -->
        <div id="view-todo">
            <div class="card" style="padding:6px; border-color:var(--primary);">
                <input type="hidden" id="editingId">
                
                <!-- æ—¶é—´è®¾ç½® -->
                <div style="margin-bottom:10px;">
                    <div style="display:flex;gap:8px; margin-bottom:8px;">
                        <input type="date" id="todoDate" style="flex:3; padding:8px; font-size:14px; text-align:left;">
                        <input type="time" id="todoTime" style="flex:2; padding:8px; font-size:14px; text-align:left;">
                    </div>
                    <div class="chips-container" style="margin-top:6px; gap:6px;" id="todoTimeChips"></div>
                </div>
                
                <!-- åç§°å’Œå¤‡æ³¨ -->
                <input type="text" id="todoTitle" placeholder="åç§°" style="margin-bottom:8px; padding:8px; font-size:15px; text-align:left;">
                <textarea id="todoNote" placeholder="å¤‡æ³¨" rows="1" style="margin-bottom:8px; padding:8px; font-size:14px; min-height:48px; resize:none; text-align:left;"></textarea>
                <div class="chips-container" style="margin-bottom:10px; gap:6px;" id="todoTaskChips"></div>

                <!-- ç±»å‹å’Œé‡è¦æ€§ -->
                <div class="chips-container" style="margin-bottom:10px; gap:6px;" id="todoTypeImportanceChips"></div>
                <input type="hidden" id="todoType" value="do">
                <input type="hidden" id="todoImportance" value="1">

                <!-- å¥–åŠ±/æƒ©ç½šå’Œæäº¤æŒ‰é’® -->
                <div style="display:flex; gap:8px; align-items:flex-start;">
                    <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
                        <div style="display:flex; gap:8px;">
                            <input type="number" id="todoReward" placeholder="å¥–åŠ±" value="1" style="flex:1; padding:8px; font-size:14px; border-color:var(--success); text-align:left; width:0;">
                            <input type="number" id="todoPenalty" placeholder="æƒ©ç½š" value="1" style="flex:1; padding:8px; font-size:14px; border-color:var(--danger); text-align:left; width:0;">
                        </div>
                        <div class="chips-container" style="gap:6px;" id="todoFundChips"></div>
                    </div>
                    <button id="todoSubmitBtn" class="btn-mini" style="background:var(--primary); color:#fff; height:auto; min-height:48px; width:48px; font-size:22px; flex-shrink:0; padding:0;" onclick="saveTodo()">+</button>
                </div>
            </div>

            <div id="todoContainer">
                <div id="head-do" class="todo-section-title">Do</div>
                <div id="list-do"></div>
                <div id="head-dont" class="todo-section-title">Not</div>
                <div id="list-dont"></div>
                <div id="head-other" class="todo-section-title">å…¶å®ƒ</div>
                <div id="list-other"></div>
                <div id="head-expired" class="todo-section-title">
                    å·²ç»“æŸ
                    <button class="btn-nuke" onclick="nukeExpiredTodos()">æ¸…ç©º</button>
                </div>
                <div id="list-expired"></div>
                <div id="empty-todo-hint" style="text-align:center;color:var(--text-sub);padding:30px;display:none;">ä»Šæ—¥åŠæœªæ¥æš‚æ— å¾…åŠ</div>
            </div>
        </div>
    </div>

    <!-- 2. ç»Ÿè®¡ -->
    <div id="page-stats" class="container page">
        <div class="card">
            <div class="card-title">ç»Ÿè®¡æ•°æ®</div>
            <select id="statPeriod" onchange="renderStats()" style="display:none;">
                <option value="7">æœ€è¿‘7å¤©</option>
                <option value="30">æœ€è¿‘30å¤©</option>
                <option value="today">ä»Šå¤©</option>
                <option value="yesterday">æ˜¨å¤©</option>
                <option value="all">å…¨éƒ¨å†å²</option>
            </select>
            <div class="chips-container" style="margin-bottom: 15px;">
                <div class="chip" onclick="setStatPeriod('today')">ä»Šå¤©</div>
                <div class="chip" onclick="setStatPeriod('yesterday')">æ˜¨å¤©</div>
                <div class="chip" onclick="setStatPeriod('7')">è¿‘7æ—¥</div>
                <div class="chip" onclick="setStatPeriod('30')">è¿‘30æ—¥</div>
                <div class="chip" onclick="setStatPeriod('all')">å…¨éƒ¨</div>
            </div>
            <div id="statTimerTopTasks" style="font-size:12px; color:var(--text-main);"></div>
        </div>

        <div id="paySection" class="card" style="background:var(--danger-bg); border-color:var(--danger); text-align:center; display:none;">
            <div style="color:var(--danger); font-weight:800; font-size:28px; margin:10px 0;" id="debtAmount">0</div>
            <div style="color:var(--danger); font-size:13px; margin-bottom:15px; opacity:0.8;">å¾…ç½šå…¬ç›Šé‡‘</div>
            <button class="btn-calc" style="background:var(--danger); width:auto; margin:0 auto;" onclick="document.getElementById('fileInput').click()">ğŸ“¸ ä¸Šä¼ å‡­è¯</button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handlePaymentWithCompress(this)">
        </div>

        <div class="card">
            <div class="card-title">å†å²æ¡£æ¡ˆ <button class="btn-mini btn-secondary" onclick="exportCSV()">ğŸ“¤ å¯¼å‡º</button></div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- 3. å•†åº— -->
    <div id="page-shop" class="container page">
        <div class="card" style="background: var(--bg-card); border: 1px solid var(--warning);">
            <div class="card-title" style="color:var(--warning)">
                <span>æ„¿æœ›å•†åº—</span>
                <div style="display:flex; gap:6px; align-items:center;">
                     <button class="btn-mini" style="background:transparent; border:1px solid var(--warning); color:var(--warning);" onclick="event.stopPropagation(); sortShopByPrice()">ğŸ’° æŒ‰ä»·æ ¼æ’åº</button>
                     <span id="shopPrivacyBtn" style="cursor:pointer; font-size:20px; padding:4px;" onclick="toggleShopPrivacy()">ğŸ”’</span>
                </div>
            </div>
            <div style="text-align:center; margin-bottom:15px; font-size:14px; color:var(--text-sub);">
                å¯ç”¨: <span id="shopWalletDisplay" style="font-weight:bold; font-size:18px; color:var(--warning);">0</span> å…ƒ
            </div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
                <input type="text" id="wishName" placeholder="åç§°">
                <input type="number" id="wishCost" placeholder="ä»·æ ¼">
            </div>
            <label id="wishHiddenLabel" class="privacy-check-label" onclick="togglePrivacyCheck()">
                <input type="checkbox" id="wishHidden"> ç§å¯†
            </label>
            <button id="btnShopAdd" class="btn-calc" style="background:var(--warning);" onclick="addWish()">+ ä¸Šæ¶</button>
            <button id="btnShopCancel" class="btn-calc btn-secondary" style="display:none; margin-top:8px;" onclick="cancelShopEdit()">âœ• å–æ¶ˆ</button>
        </div>

        <div class="card">
            <div id="shopList"></div>
        </div>
    </div>

    <!-- 4. è®¾ç½® -->
    <div id="page-settings" class="container page">
        <!-- GitHubåŒæ­¥å’Œäº‘ç«¯å­˜æ¡£ - æ”¾åœ¨æœ€å‰é¢ -->
        <div class="card" style="margin-bottom:12px;">
            <div class="card-title" style="margin-bottom:12px;">â˜ï¸ äº‘ç«¯åŒæ­¥</div>
            
            <div class="input-group" style="margin-bottom:12px;">
                <label class="input-label">åŒæ­¥ç­–ç•¥</label>
                <select id="syncProvider" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:8px; background:var(--input-bg); color:var(--text-main);">
                    <option value="both">è‡ªåŠ¨</option>
                    <option value="github">ä»… GitHub</option>
                    <option value="gitee">ä»… Gitee</option>
                </select>
            </div>

            <div class="input-group" style="margin-bottom:8px;">
                <input type="password" id="ghToken" placeholder="GitHub Token">
            </div>
            <div class="input-group" style="margin-bottom:12px;">
                <input type="text" id="ghRepo" placeholder="ç”¨æˆ·å/ä»“åº“å">
            </div>

            <div style="border-top:1px dashed var(--border); margin:12px 0;"></div>
            <div class="card-title" style="margin-bottom:12px; font-size:13px;">Gitee</div>
            <div class="input-group" style="margin-bottom:8px;">
                <input type="password" id="giteeToken" placeholder="Gitee Token">
            </div>
            <div class="input-group" style="margin-bottom:12px;">
                <input type="text" id="giteeRepo" placeholder="ç”¨æˆ·å/ä»“åº“å">
            </div>

            <div class="row" style="gap:8px; margin-bottom:12px;">
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="saveSettings()">ğŸ’¾ ä¿å­˜åŒæ­¥</button>
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0; background:var(--info); color:#fff; border:none;" onclick="archiveToGitHub()">â˜ï¸ åˆ›å»ºå­˜æ¡£</button>
            </div>
            <div>
                <button class="btn-calc btn-secondary" style="width:100%; margin-top:0;" onclick="listCloudBackups()">ğŸ“‚ æŸ¥çœ‹åˆ—è¡¨</button>
                <div id="cloudBackupList" style="margin-top:12px; display:none; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:12px;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ç›®æ ‡</div>
             <div class="row"><div class="input-group"><label class="input-label">å¹³æ—¥èµ·åºŠ</label><input type="time" id="setWake"></div><div class="input-group"><label class="input-label">å¹³æ—¥å…¥ç¡</label><input type="time" id="setSleep"></div></div>
            <div class="row"><div class="input-group"><label class="input-label">å‘¨æœ«èµ·åºŠ</label><input type="time" id="setWakeW"></div><div class="input-group"><label class="input-label">å‘¨æœ«å…¥ç¡</label><input type="time" id="setSleepW"></div></div>
            
            <div class="row">
                <div class="input-group">
                    <label class="input-label">ä¸“æ³¨ (h)</label>
                    <input type="number" id="setStudy">
                </div>
                <div class="input-group">
                    <label class="input-label">å½’æ¡£æ•°</label>
                    <input type="number" id="setExpiredLimit" min="1" max="50">
                </div>
            </div>
            <div class="row">
                <div class="input-group">
                    <label class="input-label">è®¡æ—¶æ•°</label>
                    <input type="number" id="setTimerLimit" min="1" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label">æ¡£æ¡ˆæ•°</label>
                    <input type="number" id="setHistoryLimit" min="1" max="50">
                </div>
            </div>
            <div class="input-group" style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px;">
                <label class="input-label">å‘¨æœ«</label>
                <div style="display:flex; gap:12px;">
                    <div id="btn_week_6" class="week-btn" onclick="event.stopPropagation(); toggleWeek(6)">å‘¨å…­</div>
                    <div id="btn_week_0" class="week-btn" onclick="event.stopPropagation(); toggleWeek(0)">å‘¨æ—¥</div>
                </div>
            </div>
             <button class="btn-calc" style="margin-top:20px;" onclick="saveSettings()">ğŸ’¾ ä¿å­˜</button>
        </div>

        <div class="card">
            <div class="card-title">å¥–æƒ© (å…ƒ)</div>
            <div class="row" style="margin-bottom:12px;">
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--warning); margin-bottom:0;">
                    <label class="input-label" style="color:var(--warning); margin-bottom:4px;">è¾¾æ ‡å¥–åŠ±</label>
                    <input type="number" id="rewardAmount" value="5">
                </div>
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--time); margin-bottom:0;">
                    <label class="input-label" style="color:var(--time); margin-bottom:4px;">æ±‡ç‡ (å…ƒ/h)</label>
                    <input type="number" id="exchangeRate" value="5">
                </div>
            </div>
            
            <div class="row" style="margin-bottom:12px;">
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--border); margin-bottom:0; width: 100%;">
                    <label class="input-label" style="margin-bottom:4px;">æ„¿æœ›å…‘æ¢ (å¸/é‡‘)</label>
                    <input type="number" id="wishToDebtRate" value="2">
                </div>
            </div>

            <div style="font-size:12px; font-weight:700; color:var(--danger); margin:15px 0 8px 0; text-transform:uppercase;">æƒ©ç½šé˜¶æ¢¯</div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">æ™šèµ·&lt;30m</span><input type="number" id="pWakeS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">æ™šèµ·â‰¥30m</span><input type="number" id="pWakeL"></div>
            </div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">æ™šç¡&lt;1h</span><input type="number" id="pSleepS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">æ™šç¡â‰¥1h</span><input type="number" id="pSleepL"></div>
            </div>
            <div class="row">
                <div><span style="font-size:11px;color:var(--text-sub)">å°‘å­¦&lt;1h</span><input type="number" id="pStudyS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">å°‘å­¦â‰¥1h</span><input type="number" id="pStudyL"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">å¿«æ·é¡¹</div>
            <div class="input-group">
                <label class="input-label">å¿«æ·ä»»åŠ¡</label>
                <div class="chips-container" id="setQuickTasksList"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_quicktask" placeholder="ä»»åŠ¡åç§°">
                    <button class="btn-mini" onclick="addQuickTask()">+</button>
                </div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--border);">
                <div style="font-size:11px;color:var(--text-sub);margin-bottom:8px;">æŒ‰ä½¿ç”¨é¢‘æ¬¡è‡ªåŠ¨æ’åº</div>
                <button class="btn-mini btn-secondary" style="width:100%;" onclick="resetTaskUsage()">ğŸ”„ é‡ç½®é¢‘æ¬¡</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">æ—¶é—´å¿«é€‰</div>
            <div class="input-group">
                <div class="chips-container" id="todoTimeChipsSettingsList"></div>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="addTodoTimeChip('offset')">â° åç§»æ—¶é—´</button>
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="addTodoTimeChip('fixed')">ğŸ• å›ºå®šæ—¶é—´</button>
            </div>
            <div style="margin-top:8px;">
                <button class="btn-mini btn-secondary" style="width:100%;" onclick="resetTodoTimeChips()">ğŸ”„ æ¢å¤é»˜è®¤</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">æ™¨é—´æ‰“å¡å¤ç›˜è®¾ç½®</div>
            <div class="input-group">
                <label class="input-label">å¤ç›˜æ ‡é¢˜å¿«é€‰ç®¡ç†</label>
                <div class="chips-container" id="settingReviewTagsList"></div>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="addReviewTagSetting()">+ æ·»åŠ æ ‡é¢˜</button>
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="resetReviewTags()">ğŸ”„ æ¢å¤é»˜è®¤</button>
            </div>
            <button class="btn-calc" style="margin-top:12px;" onclick="saveReviewSettings()">ğŸ’¾ ä¿å­˜å¤ç›˜è®¾ç½®</button>
        </div>

        <div class="card">
            <div class="card-title">æ•°æ®è°ƒèŠ‚</div>
            <div style="font-size:12px; color:var(--text-sub); margin-bottom:12px;">ä¿®æ”¹æ•°å€¼ï¼Œå°†è®°å½•è‡³å†å²</div>
            <div class="row">
                <div class="input-group"><label class="input-label">æ—¶é—´é“¶è¡Œ (h)</label><input type="number" step="0.1" min="0" id="adjTimeBank"></div>
                <div class="input-group"><label class="input-label">æ„¿æœ›é‡‘ (å…ƒ)</label><input type="number" min="0" id="adjWallet"></div>
            </div>
            <div class="input-group"><label class="input-label">å¾…ç½šå…¬ç›Šé‡‘ (å…ƒ)</label><input type="number" min="0" id="adjDebt"></div>
            <div class="input-group">
                <label class="input-label">ä¿®æ”¹åŸå› </label>
                <input type="text" id="adjReason" placeholder="åŸå› ">
            </div>
        <button id="btnApplyManualAdjustment" type="button" class="btn-calc" style="background:var(--primary);">âœ“ åº”ç”¨</button>
            <div id="manualAdjustmentStatus" style="margin-top:8px; font-size:12px; color:var(--text-sub);"></div>
        </div>

        <div class="card">
            <div class="card-title">æ•°æ®å®‰å…¨</div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="exportJSON()">ğŸ“¤ å¤‡ä»½</button>
                <button class="btn-calc btn-secondary" style="color:var(--success); border-color:var(--success);" onclick="document.getElementById('importFile').click()">ğŸ“¥ æ¢å¤</button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importJSON(this)">
            </div>
        </div>
    </div>

    <!-- è®¡æ—¶é¡µé¢ (æ–°å¢åŠ ) -->
    <div id="page-timer" class="container page">
        <div class="card">
            <div class="card-title">è®¡æ—¶</div>
            <div class="input-group">
                <label class="input-label">ä»»åŠ¡</label>
                <input type="text" id="timerTaskName" placeholder="ä»»åŠ¡åç§°">
                <!-- å¿«é€‰èƒ¶å›Š -->
                <div id="quickTasksContainer" class="chips-container" style="margin-top: 8px;"></div>
            </div>
            
            <!-- å¾…åŠé€‰æ‹©å¼¹çª— -->
            <div id="todoSelectModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div style="background:var(--bg-card); border-radius:20px; padding:24px; max-width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); border:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:800; font-size:18px; color:var(--text-main);">é€‰æ‹©å¾…åŠ</div>
                        <div class="btn-action" onclick="closeTodoSelectModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
                    </div>
                    <div id="todoSelectList" style="max-height:60vh; overflow-y:auto;"></div>
                </div>
            </div>

            <div class="row">
                <div class="input-group">
                    <label class="input-label">èµ·å§‹æ—¶é—´</label>
                    <input type="time" id="timerPlannedTime">
                </div>
                <div class="input-group">
                    <label class="input-label">ç»“æŸæ—¶é—´</label>
                    <input type="time" id="timerPlannedEndTime">
                </div>
            </div>
            <!-- è®¡æ—¶æ—¶é—´å¿«é€‰èƒ¶å›Š -->
            <div class="chips-container" style="margin-top:8px;" id="timerTimeChips"></div>
            
            <div class="input-group">
                <label class="input-label">å¤‡æ³¨</label>
                <textarea id="timerNote" placeholder="å¤‡æ³¨" rows="1" style="min-height: 46px;"></textarea>
            </div>

            <div id="timerControls">
                <div id="timerIdleBtns" style="display: flex; gap: 12px; align-items: stretch;">
                    <button class="btn-calc" style="flex: 2; margin-top: 0;" id="btnTimerStart" onclick="startTimer()">â–¶ï¸ å¼€å§‹</button>
                    <button class="btn-calc btn-secondary" style="flex: 1; margin-top: 0;" onclick="addPlannedTask()">ğŸ“… è®¡åˆ’</button>
                </div>
                <div id="timerActiveBtns" style="display: none; gap: 12px; align-items: stretch; flex-wrap: wrap;">
                    <div style="display: flex; gap: 12px; width: 100%;">
                        <button class="btn-calc btn-secondary" id="btnTimerPause" style="flex: 1; margin-top: 0;" onclick="toggleTimerPause()">â¸ï¸ æš‚åœ</button>
                        <button class="btn-calc btn-danger" style="flex: 1; margin-top: 0;" onclick="stopTimer()">â¹ï¸ ç»“æŸ</button>
                    </div>
                    <button class="btn-calc btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addPlannedTaskWhileRunning()">+ æ·»åŠ è®¡åˆ’</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>å¤ç›˜</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-mini" style="background:var(--info); color:#fff;" onclick="toggleHistoryReview()">ğŸ“œ å†å²</button>
                    <button id="btnSaveReview" class="btn-mini" style="background:var(--success); color:#fff;" onclick="saveDailyReview(true)">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>
            
            <div id="reviewInputArea">
                <div class="input-group">
                    <label class="input-label">åšå¾—å¥½çš„</label>
                    <textarea id="reviewGreat" placeholder="è®°å½•..." rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">éœ€æ”¹è¿›çš„</label>
                    <textarea id="reviewImprove" placeholder="æ”¹è¿›..." rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">æ„Ÿæ‚Ÿ</label>
                    <textarea id="reviewInsight" placeholder="æ„Ÿæ‚Ÿ..." rows="2"></textarea>
                </div>
            </div>

            <!-- å†å²å¤ç›˜å®¹å™¨ -->
            <div id="reviewHistoryArea" style="display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px; max-height:300px; overflow-y:auto;">
                <div id="reviewHistoryList"></div>
            </div>
        </div>

        <!-- è®¡åˆ’æ¸…å• -->
        <div class="card" id="card-planned-tasks">
            <div class="card-title">è®¡åˆ’</div>
            <div id="plannedTasksList"></div>
        </div>

        <div class="card">
            <div class="card-title">å†å²</div>
            <div id="timerHistoryList"></div>
        </div>
    </div>


    <!-- è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡† -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">æç¤º</div>
            <div class="modal-message" id="modalMessage"></div>
            <div id="modalInputContainer"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <!-- æ—¶é—´é“¶è¡Œå¼¹å‡ºçª—å£ -->
    <div id="timeBankModal" class="custom-modal" onclick="if(event.target.id === 'timeBankModal') closeTimeBankModal()">
        <div class="modal-content" style="max-width: 380px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div class="modal-title" style="color:var(--time); margin:0;"><span style="font-size:18px;">â³</span> æ—¶é—´é“¶è¡Œ</div>
                <div class="btn-action" onclick="closeTimeBankModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
            </div>
            <div style="text-align:center; padding:20px; background:var(--time-bg); border-radius:12px; margin-bottom:20px;">
                <div style="font-size:32px; font-weight:bold; color:var(--time);" id="timeBankModalDisplay">0.0</div>
                <div style="font-size:13px; color:var(--text-sub); margin-top:4px;">å¯ç”¨æ—¶é—´ï¼ˆå°æ—¶ï¼‰</div>
            </div>
            <div style="font-size:13px; color:var(--text-sub); margin-bottom:12px;">1å°æ—¶ = <span id="timeBankRateDisplay">5</span> å…ƒ</div>
            <div style="display:flex; gap:8px;">
                <input type="number" id="timeBankExchangeHours" placeholder="å°æ—¶æ•°" style="flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main);">
                <button class="btn-mini" style="background:var(--time); color:#fff; width:auto; padding:12px 20px;" onclick="executeExchangeFromModal()">å…‘æ¢</button>
            </div>
            
            <div style="border-top:1px dashed var(--border); margin:20px 0 16px 0;"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div class="modal-title" style="margin:0; font-size:16px; color:var(--text-main);">ğŸ“… å€’æ•°æ—¥</div>
                <button class="btn-mini" style="width:auto; margin:0; padding: 4px 10px;" onclick="addDaysMatterItem()">â•</button>
            </div>
            <div id="daysMatterList" style="display:flex; flex-direction:column; gap:8px; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- æ„¿æœ›å•†åº—å¼¹å‡ºçª—å£ -->
    <div id="walletModal" class="custom-modal" onclick="if(event.target.id === 'walletModal') closeWalletModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; position:sticky; top:0; background:var(--bg-card); z-index:10; padding-bottom:12px; border-bottom:1px solid var(--border);">
                <div class="modal-title" style="color:var(--warning); margin:0;">ğŸ’° æ„¿æœ›å•†åº—</div>
                <div class="btn-action" onclick="closeWalletModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
            </div>
            <div id="walletModalContent">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡æ•°æ®å¼¹å‡ºçª—å£ -->
    <div id="debtModal" class="custom-modal" onclick="if(event.target.id === 'debtModal') closeDebtModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; position:sticky; top:0; background:var(--bg-card); z-index:10; padding-bottom:12px; border-bottom:1px solid var(--border);">
                <div class="modal-title" style="color:var(--danger); margin:0;">ğŸ’¸ ç»Ÿè®¡æ•°æ®</div>
                <div class="btn-action" onclick="closeDebtModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
            </div>
            <div id="debtModalContent">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- æ™¨é—´æ‰“å¡å¼¹å‡ºçª—å£ -->
    <div id="checkinModal" class="custom-modal" onclick="if(event.target.id === 'checkinModal') closeCheckinModal()">
        <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; position:sticky; top:0; background:var(--bg-card); z-index:10; padding-bottom:12px; border-bottom:1px solid var(--border);">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="modal-title" id="checkinModalTitle" style="color:var(--primary); margin:0;">ğŸ“ æ‰“å¡</div>
                    <span onclick="toggleCheckinMode()" style="cursor:pointer; font-size:12px; color:var(--text-sub); border:1px solid var(--border); padding:1px 5px; border-radius:4px;" title="æ‰‹åŠ¨åˆ‡æ¢æ¨¡å¼">â‡„</span>
                    <span id="checkinModalDayTypeBadge" style="display:none;background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:10px;">å‘¨æœ«</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <div id="checkinModalHeaderButtons">
                        <!-- åŠ¨æ€æ˜¾ç¤ºçš„æŒ‰é’® -->
                    </div>
                    <div class="btn-action" onclick="closeCheckinModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
                </div>
            </div>
            
            <!-- æ‰“å¡è¡¨å•åŒºåŸŸ -->
            <div id="checkinModalCheckinArea">
                <div class="card" style="box-shadow: none; border: none; padding: 0;">
                    <div class="input-group">
                        <label class="input-label">æ—¥æœŸ</label>
                        <input type="date" id="checkinModalDateInput" onchange="checkCheckinModalDateChange(); calculateCheckinModalPenalty();">
                    </div>
                    <div class="row">
                        <div class="input-group">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label class="input-label" style="margin-bottom:0">å…¥ç¡ <span id="checkinModalTargetSleep" style="opacity:0.6;font-weight:normal"></span> <span id="checkinModalSleepDayIndicator" style="font-size:10px; margin-left:5px; padding:1px 4px; border-radius:4px; display:none;"></span></label>
                                <span class="btn-mini" style="background:var(--time); color:#fff; padding:2px 6px; font-size:10px;" onclick="setInputToNow('checkinModalSleepInput'); calculateCheckinModalPenalty();">æ­¤åˆ»</span>
                            </div>
                            <input type="time" id="checkinModalSleepInput" value="00:00" onchange="calculateCheckinModalPenalty()" oninput="calculateCheckinModalPenalty()">
                        </div>
                        <div class="input-group">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label class="input-label" style="margin-bottom:0">èµ·åºŠ <span id="checkinModalTargetWake" style="opacity:0.6;font-weight:normal"></span></label>
                                <span class="btn-mini" style="background:var(--time); color:#fff; padding:2px 6px; font-size:10px;" onclick="setInputToNow('checkinModalWakeInput'); calculateCheckinModalPenalty();">æ­¤åˆ»</span>
                            </div>
                            <input type="time" id="checkinModalWakeInput" value="08:30" onchange="calculateCheckinModalPenalty()" oninput="calculateCheckinModalPenalty()">
                        </div>
                    </div>
                    <div class="input-group"><label class="input-label">ä¸“æ³¨ (h)</label><input type="number" step="0.1" id="checkinModalStudyInput" placeholder="æ—¶é•¿" oninput="calculateCheckinModalPenalty()"></div>
                    
                    <div class="input-group" id="useTimeBankGroup" style="display:none; align-items: center; justify-content: space-between; margin-top: 8px;">
                        <label class="input-label" style="margin-bottom:0; cursor:pointer;" for="useTimeBankCheckbox">ä½¿ç”¨æ—¶é—´é“¶è¡ŒæŠµæ‰£ (<span id="timeBankBalanceDisplay">0</span>h)</label>
                        <input type="checkbox" id="useTimeBankCheckbox" onchange="calculateCheckinModalPenalty(); updateTimeBankCheckboxStyle();" style="width:20px; height:20px;">
                    </div>

                    <div id="checkinModalPenaltyArea" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                        <div class="input-group">
                            <label class="input-label" id="checkinModalAmountLabel">é‡‘é¢ (å…ƒ)</label>
                            <input type="number" step="0.01" id="checkinModalPenaltyAmount" placeholder="0" onchange="checkCheckinModalPenaltyChange()" oninput="checkCheckinModalPenaltyChange()">
                        </div>
                        <div id="checkinModalPenaltyReasonBox" style="display:none;">
                            <div class="input-group">
                                <label class="input-label">ä¿®æ”¹åŸå›  <span style="color:var(--danger);">*</span></label>
                                <textarea id="checkinModalPenaltyReason" placeholder="è¯·å¡«å†™ä¿®æ”¹æƒ©ç½šé‡‘çš„åŸå› ..." rows="2"></textarea>
                            </div>
                        </div>
                        <button class="btn-calc" onclick="submitCheckinModal()" style="margin-top:12px;">âœ“ ç¡®è®¤æäº¤</button>
                    </div>

                    <!-- å†å²æ‰“å¡å®¹å™¨ -->
                    <div id="checkinModalHistoryCheckinArea" style="display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px; max-height:300px; overflow-y:auto;">
                        <div id="checkinModalHistoryCheckinList"></div>
                    </div>
                </div>

                <div id="checkinModalAnalysisCard" class="card" style="display:none; text-align:center; margin-top:16px;"></div>
                <div id="checkinModalFormContainer" style="margin-top:16px;"></div>
            </div>

            <!-- å¤ç›˜åŒºåŸŸ -->
            <div id="checkinModalReviewArea" style="display:none;">
                <div class="card" style="box-shadow: none; border: none; padding: 0;">
                    
                    <div id="checkinModalReviewInputArea">
                        <div class="input-group">
                            <label class="input-label">åšå¾—å¥½çš„</label>
                            <textarea id="checkinModalReviewGreat" placeholder="è®°å½•..." rows="2"></textarea>
                        </div>
                        <div class="input-group">
                            <label class="input-label">éœ€æ”¹è¿›çš„</label>
                            <textarea id="checkinModalReviewImprove" placeholder="æ”¹è¿›..." rows="2"></textarea>
                        </div>
                        <div class="input-group">
                            <div id="checkinModalReviewTags" class="chips-container" style="margin-bottom:8px;"></div>
                            <textarea id="checkinModalReviewInsight" placeholder="æ¸…å•..." rows="2"></textarea>
                            <div style="text-align:right; margin-top:8px;">
                                <button class="btn-mini" style="background:var(--success); color:#fff; width:auto; padding:6px 16px;" onclick="addReviewListItem()">â• æ·»åŠ </button>
                            </div>
                            <!-- Removed checkinModalDailyList -->
                        </div>
                    </div>

                    <!-- å†å²å¤ç›˜å®¹å™¨ -->
                    <div id="checkinModalReviewHistoryArea" style="display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px; max-height:300px; overflow-y:auto;">
                        <div id="checkinModalReviewHistoryList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¡æ—¶é¡µé¢å¼¹å‡ºçª—å£ -->
    <div id="timerModal" class="custom-modal" onclick="if(event.target.id === 'timerModal') closeTimerModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; position:sticky; top:0; background:var(--bg-card); z-index:10; padding-bottom:12px; border-bottom:1px solid var(--border);">
                <div class="modal-title" style="color:var(--primary); margin:0;">â±ï¸ è®¡æ—¶</div>
                <div class="btn-action" onclick="closeTimerModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
            </div>
            
            <div id="timerModalContent">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹å‡ºçª—å£ -->
    <div id="settingsModal" class="custom-modal" onclick="if(event.target.id === 'settingsModal') closeSettingsModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; position:sticky; top:0; background:var(--bg-card); z-index:10; padding-bottom:12px; border-bottom:1px solid var(--border);">
                <div class="modal-title" style="color:var(--primary); margin:0;">âš™ï¸ è®¾ç½®</div>
                <div class="btn-action" onclick="closeSettingsModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
            </div>
            
            <!-- å°†è®¾ç½®é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°modalä¸­ï¼Œä½¿ç”¨ä¸åŒçš„IDå‰ç¼€é¿å…å†²çª -->
            <div id="settingsModalContent">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
        </div>
    </div>

    <!-- å†å²å¤ç›˜å¼¹å‡ºçª—å£ -->
    <div id="historyReviewModal" class="custom-modal" onclick="if(event.target.id === 'historyReviewModal') closeHistoryReviewModal()" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid var(--border); background:var(--bg-card); border-radius: 16px 16px 0 0;">
                <div class="modal-title" style="color:var(--primary); margin:0;">ğŸ“œ å†å²å¤ç›˜</div>
                <div class="btn-action" onclick="closeHistoryReviewModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
            </div>
            
            <!-- é™æ€ç­›é€‰å™¨åŒºåŸŸ -->
            <div style="padding:10px 16px; border-bottom:1px solid var(--border); background:var(--bg-card);">
                <div style="margin-bottom:8px;">
                    <select id="historyReviewModalFilter" onchange="renderCheckinModalHistoryReviews()" style="width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main); outline:none;">
                        <option value="">å…¨éƒ¨æ¸…å•/æ ‡é¢˜</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="historyReviewModalSearch" placeholder="æœç´¢å†…å®¹..." oninput="renderCheckinModalHistoryReviews()" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main);">
                    <button class="btn-mini" style="background:var(--primary); color:#fff; width:auto;" onclick="renderCheckinModalHistoryReviews()">ğŸ”</button>
                </div>
            </div>
            
            <div id="historyReviewModalBody" style="overflow-y: auto; flex: 1; padding: 0;">
                <div id="historyReviewModalList"></div>
            </div>
        </div>
    </div>

<script>
    const DEFAULT_CONFIG = { 
        wake: "08:30", 
        sleep: "01:00", 
        study: 4.0, 
        wakeW: "10:00", 
        sleepW: "02:00", 
        reward: 5, 
        preventCost: 10, 
        exchangeRate: 5, 
        initialPage: "checkin",
        expiredLimit: 5,
        timerLimit: 5,
        historyLimit: 5,
        quickTasks: ['ğŸ“š é˜…è¯»', 'ğŸ’» ç¼–ç¨‹', 'âœï¸ å†™ä½œ', 'ğŸƒ è¿åŠ¨', 'ğŸ¸ ç»ƒä¹ ', 'ğŸ§¹ å®¶åŠ¡'],
        reviewTags: ['ğŸ›ï¸ è´­ç‰©', 'ğŸ’Š å¥åº·', 'ğŸ“š å­¦ä¹ ', 'ğŸƒ è¿åŠ¨'],
        penalties: { wakeS: 2, wakeL: 5, sleepS: 2, sleepL: 5, studyS: 5, studyL: 10 }, 
        weekend: [0, 6],
        todoTimeChips: [], // é»˜è®¤ä¸ºç©ºæ•°ç»„ï¼Œä½¿ç”¨å†…ç½®é»˜è®¤å¿«é€‰
        interface: { showTimer: true, showStats: true, showShop: true, showQuickStudy: true } // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰ç•Œé¢
    };
    
    function safeParse(key, defaultVal) {
        try {
            const val = localStorage.getItem(key);
            if (!val || val === 'undefined') return defaultVal;
            return JSON.parse(val);
        } catch (e) {
            console.error("Error parsing " + key, e);
            return defaultVal;
        }
    }
    
    // è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†å‡½æ•°
    function showModal(options) {
        const modal = document.getElementById('customModal');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const inputContainer = document.getElementById('modalInputContainer');
        const buttonsContainer = document.getElementById('modalButtons');
        
        // ç¡®ä¿customModalçš„z-indexé«˜äºæ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†ï¼ˆåŒ…æ‹¬settingsModalï¼‰
        modal.style.zIndex = '99999';
        
        // ä¸´æ—¶é™ä½å…¶ä»–æ¨¡æ€æ¡†çš„z-indexï¼Œç¡®ä¿customModalåœ¨æœ€é¡¶å±‚
        const otherModals = document.querySelectorAll('.custom-modal:not(#customModal)');
        otherModals.forEach(m => {
            if (m.classList.contains('show')) {
                m.dataset.originalZIndex = m.style.zIndex || '';
                m.style.zIndex = '10000';
            }
        });
        
        title.textContent = options.title || 'æç¤º';
        message.textContent = options.message || '';
        inputContainer.innerHTML = '';
        buttonsContainer.innerHTML = '';
        
        // æ·»åŠ è¾“å…¥æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰
        if (options.inputs && options.inputs.length > 0) {
            options.inputs.forEach(input => {
                const label = document.createElement('label');
                label.className = 'modal-input-label';
                label.textContent = input.label;
                
                let inputEl;
                if (input.type === 'select') {
                    // åˆ›å»ºéšè—çš„ input æ¥å­˜å‚¨é€‰ä¸­çš„å€¼
                    inputEl = document.createElement('input');
                    inputEl.type = 'hidden';
                    inputEl.id = input.id;
                    inputEl.value = input.value || '';
                    
                    // åˆ›å»ºå¿«æ·èƒ¶å›Šå®¹å™¨
                    const chipsContainer = document.createElement('div');
                    chipsContainer.className = 'chips-container';
                    chipsContainer.style.marginTop = '6px';
                    chipsContainer.style.marginBottom = '6px';
                    
                    // ä¸ºæ¯ä¸ªé€‰é¡¹åˆ›å»ºèƒ¶å›ŠæŒ‰é’®
                    if (input.options && input.options.length > 0) {
                        input.options.forEach(opt => {
                            const chip = document.createElement('div');
                            chip.className = 'chip';
                            const optValue = opt.value || opt;
                            const optLabel = opt.label || opt;
                            chip.textContent = optLabel;
                            chip.dataset.value = optValue;
                            
                            // è®¾ç½®åˆå§‹é€‰ä¸­çŠ¶æ€
                            if (input.value === optValue || (!input.value && optValue === '0')) {
                                chip.style.background = 'var(--primary-bg)';
                                chip.style.borderColor = 'var(--primary)';
                                chip.style.color = 'var(--primary)';
                                inputEl.value = optValue;
                            }
                            
                            // ç‚¹å‡»äº‹ä»¶ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                            chip.onclick = () => {
                                // ç§»é™¤æ‰€æœ‰èƒ¶å›Šçš„é€‰ä¸­æ ·å¼
                                chipsContainer.querySelectorAll('.chip').forEach(c => {
                                    c.style.background = '';
                                    c.style.borderColor = '';
                                    c.style.color = '';
                                });
                                
                                // è®¾ç½®å½“å‰èƒ¶å›Šä¸ºé€‰ä¸­çŠ¶æ€
                                chip.style.background = 'var(--primary-bg)';
                                chip.style.borderColor = 'var(--primary)';
                                chip.style.color = 'var(--primary)';
                                
                                // æ›´æ–°éšè— input çš„å€¼
                                inputEl.value = optValue;
                            };
                            
                            chipsContainer.appendChild(chip);
                        });
                    }
                    
                    // å°†éšè— input å’Œèƒ¶å›Šå®¹å™¨æ·»åŠ åˆ° DOM
                    inputContainer.appendChild(label);
                    inputContainer.appendChild(inputEl);
                    inputContainer.appendChild(chipsContainer);
                } else {
                    inputEl = document.createElement(input.type === 'textarea' ? 'textarea' : 'input');
                    inputEl.className = 'modal-input';
                    inputEl.id = input.id;
                    inputEl.placeholder = input.placeholder || '';
                    inputEl.value = input.value || '';
                    if (input.type && input.type !== 'textarea') inputEl.type = input.type;
                    if (input.type === 'textarea') inputEl.rows = 3;
                    
                    inputContainer.appendChild(label);
                    inputContainer.appendChild(inputEl);
                }
            });
        }
        
        // æ·»åŠ æŒ‰é’®
        if (options.buttons && options.buttons.length > 0) {
            options.buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `modal-btn ${btn.primary ? 'modal-btn-primary' : 'modal-btn-secondary'}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    // æ”¶é›†è¾“å…¥å€¼
                    const values = {};
                    if (options.inputs) {
                        options.inputs.forEach(input => {
                            const el = document.getElementById(input.id);
                            values[input.id] = el ? el.value : '';
                        });
                    }
                    
                    hideModal();
                    if (btn.callback) btn.callback(values);
                };
                buttonsContainer.appendChild(button);
            });
        }
        
        modal.classList.add('show');
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.onclick = (e) => {
            if (e.target === modal) hideModal();
        };
    }
    
    function hideModal() {
        const modal = document.getElementById('customModal');
        modal.classList.remove('show');
        // æ¢å¤é»˜è®¤z-index
        modal.style.zIndex = '';
        
        // æ¢å¤å…¶ä»–æ¨¡æ€æ¡†çš„z-index
        const otherModals = document.querySelectorAll('.custom-modal:not(#customModal)');
        otherModals.forEach(m => {
            if (m.dataset.originalZIndex !== undefined) {
                m.style.zIndex = m.dataset.originalZIndex || '';
                delete m.dataset.originalZIndex;
            }
        });
    }

    let historyData = safeParse('habit_data_v15', []);
    let config = safeParse('habit_config_v7', DEFAULT_CONFIG);
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«å¿«æ·ä»»åŠ¡ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.quickTasks || config.quickTasks.length === 0) {
        config.quickTasks = DEFAULT_CONFIG.quickTasks;
    }
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«ç•Œé¢æ˜¾ç¤ºè®¾ç½®ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.interface) {
        config.interface = DEFAULT_CONFIG.interface;
    }
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«å¾…åŠæ—¶é—´å¿«é€‰ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.todoTimeChips) {
        config.todoTimeChips = DEFAULT_CONFIG.todoTimeChips;
    }
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«å¤ç›˜æ ‡ç­¾ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.reviewTags) {
        config.reviewTags = DEFAULT_CONFIG.reviewTags;
    }
    
    let wishList = safeParse('habit_wishes_v1', []);
    let deletedTodoIds = safeParse('habit_deleted_todo_ids_v1', []);
    let todoList = safeParse('habit_todos_v1', []);
    // é¡µé¢åŠ è½½æ—¶ï¼Œå¼ºåˆ¶å°†å·²ç»“æŸé¡¹ç›®çš„å¤‡æ³¨è®¾ä¸ºæŠ˜å çŠ¶æ€
    (function() {
        try {
            const todayStr = getLocalTodayStr();
            todoList.forEach(t => {
                const isExpired = t.archived || t.status.startsWith('expired_') || (t.date < todayStr);
                if (isExpired && t.noteExpanded) {
                    t.noteExpanded = false;
                }
            });
        } catch(e) { console.error('Auto collapse expired notes error:', e); }
    })();

    let userStrategies = safeParse('habit_strategies_v1', { study: ["âš¡ ç•ªèŒ„é’Ÿ"], sleep: ["ğŸ“µ è¿œç¦»å±å¹•"], wake: ["â° é—¹é’Ÿæ”¾è¿œ"] });
    let timeBank = parseFloat(localStorage.getItem('habit_time_bank_v1'));
    if (isNaN(timeBank) || timeBank < 0) timeBank = 0;
    let timerRecords = safeParse('habit_timer_records_v1', []);
    let plannedTasks = safeParse('habit_planned_tasks_v1', []);
    let ghConfig = safeParse('habit_gh_v1', { token: '', repo: '', path: 'habit_backup.json' });
    let giteeConfig = safeParse('habit_gitee_v1', { token: '', repo: '', path: 'habit_backup.json' });
    let daysMatterList = safeParse('habit_days_matter_v1', []);
    let currentTheme = localStorage.getItem('habit_theme') || 'dark';
    let todayIsWeekend = false;
    let isDeleting = false;
    let isShopPrivacyOn = true;
    let openMenuId = null;
    let editingPlannedId = null;
    let editingTimerRecordId = null;
    let editingHistoryItemId = null;
    let pinnedTaskId = localStorage.getItem('habit_pinned_task_id') || null;
    let globalWallet = 0, globalDebt = 0;
    let dailyReviews = safeParse('habit_daily_reviews_v1', {});
    let taskUsageCount = safeParse('habit_task_usage_v1', {}); // ä»»åŠ¡ä½¿ç”¨é¢‘æ¬¡ç»Ÿè®¡
    let expiredFullView = false;
    let timerFullView = false;
    let historyFullView = false;
    let isReviewHistoryOpen = false;

    // â€œå·²ç»“æŸå…¥åˆ—æ—¶é—´â€çš„åˆ†ç•Œç‚¹ï¼šç”¨äºæŠŠæ—§æ•°æ®ï¼ˆæ²¡æœ‰çœŸæ­£å…¥åˆ—æ—¶é—´ï¼Œæˆ–å†å²è¡¥å†™çš„ endedAtï¼‰ç»Ÿä¸€æ’åˆ°åé¢
    // åªæœ‰åœ¨ cutoff ä¹‹åè¿›å…¥â€œå·²ç»“æŸâ€çš„é¡¹ç›®ï¼Œæ‰ä¼šè¢«æ’åˆ°å‰é¢ï¼Œæ–¹ä¾¿ä½ çœ‹åˆ°â€œåˆšåˆšå‘ç”Ÿçš„æ”¹å˜â€ã€‚
    let endedAtCutoff = Number(localStorage.getItem('habit_endedAt_cutoff_v1'));
    if (!Number.isFinite(endedAtCutoff) || endedAtCutoff <= 0) {
        endedAtCutoff = Date.now();
        try { localStorage.setItem('habit_endedAt_cutoff_v1', String(endedAtCutoff)); } catch (_) {}
    }

    function switchPage(id){
        if (typeof closeAllMenus === 'function') closeAllMenus();

        const exchangeCard = document.getElementById('exchangeCard');
        if (exchangeCard) exchangeCard.style.display = 'none';

        if (id !== 'shop') {
            isShopPrivacyOn = true;
            const shopBtn = document.getElementById('shopPrivacyBtn');
            if (shopBtn) shopBtn.innerText = 'ğŸ”’';
        }

        // å¦‚æœç¦»å¼€checkiné¡µé¢ï¼Œé‡ç½®æ‰€æœ‰å¤‡æ³¨çš„å±•å¼€çŠ¶æ€
        const currentPage = document.querySelector('.page.active');
        if (currentPage && currentPage.id === 'page-checkin' && id !== 'checkin') {
            todoList.forEach(t => {
                if (t.noteExpanded) {
                    t.noteExpanded = false;
                }
            });
        }

        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        
        const targetPage = document.getElementById('page-'+id);
        if (targetPage) targetPage.classList.add('active');

        const maps={checkin:0, timer:1, stats:2, shop:3, settings:4};
        const tabs = document.querySelectorAll('.tab');
        if (tabs[maps[id]]) tabs[maps[id]].classList.add('active');

        if(id==='stats' && typeof renderStats === 'function') renderStats();
        if(id==='shop' && typeof renderShop === 'function') renderShop();
        if(id==='settings') { 
            if (typeof applySettingsToUI === 'function') applySettingsToUI();
            if (typeof renderQuickTaskSettings === 'function') renderQuickTaskSettings();
        }
        if(id==='timer') { 
            if (typeof renderPlannedTasks === 'function') renderPlannedTasks(); 
            if (typeof renderTimerHistory === 'function') renderTimerHistory(); 
            if (typeof loadDailyReview === 'function') loadDailyReview();
            if (typeof renderQuickTasks === 'function') renderQuickTasks();
            if (typeof renderTimerTimeChips === 'function') renderTimerTimeChips();
            if (!timerRunning) initTimerTime();
        }
        
        // è®°å½•æœ€åä¸€æ¬¡è®¿é—®çš„ä¹ æƒ¯é¡µé¢ (ç”¨äºä»è´¢å¯Œæ¨¡å¼åˆ‡å›)
        if (id !== 'wealth') {
            localStorage.setItem('habit_last_page', id);
        }
    }

    let tempTimeDiff = 0;
    let useTimeBank = false;
    let defaultFund = 0;
    let calcReason = "";
    let failedTypes = [];
    let editingWishIndex = -1; // è®°å½•æ­£åœ¨ç¼–è¾‘çš„å•†å“ç´¢å¼•

    // è®¡æ—¶å™¨å˜é‡
    let timerRunning = false;
    let timerPaused = false;
    let timerSeconds = 0;
    let timerInterval = null;
    let timerSyncInterval = null; // ç”¨äºå®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€
    let isTimerFromPlan = false; // è®°å½•å½“å‰è®¡æ—¶æ˜¯å¦æ¥è‡ªè®¡åˆ’æ¸…å•
    
    // ä¿å­˜å½“å‰è®¡æ—¶å™¨çŠ¶æ€åˆ°localStorage
    function saveTimerState() {
        if (!timerRunning) {
            localStorage.removeItem('habit_timer_state_v1');
            return;
        }
        
        // å°è¯•è·å–å·²å­˜åœ¨çš„startTimestampï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¡ç®—æ–°çš„
        let startTimestamp;
        const existingState = localStorage.getItem('habit_timer_state_v1');
        if (existingState) {
            try {
                const parsed = JSON.parse(existingState);
                startTimestamp = parsed.startTimestamp || (Date.now() - (timerSeconds * 1000));
            } catch (e) {
                startTimestamp = Date.now() - (timerSeconds * 1000);
            }
        } else {
            startTimestamp = Date.now() - (timerSeconds * 1000);
        }
        
        // å…¼å®¹ï¼šå¦‚æœè¾“å…¥æ¡†ä¸å­˜åœ¨ï¼ˆæ¯”å¦‚åœ¨å¾…åŠé¡µé¢ï¼‰ï¼Œä»å·²ä¿å­˜çš„çŠ¶æ€æˆ–å…¨å±€å˜é‡è·å–
        const taskNameEl = document.getElementById('timerTaskName');
        const noteEl = document.getElementById('timerNote');
        let taskName = '';
        let note = '';
        let todoId = null;
        
        if (taskNameEl) {
            taskName = taskNameEl.value || '';
            todoId = taskNameEl.getAttribute('data-todo-id') || null;
        } else if (existingState) {
            // å¦‚æœè¾“å…¥æ¡†ä¸å­˜åœ¨ï¼Œå°è¯•ä»å·²ä¿å­˜çš„çŠ¶æ€æ¢å¤
            try {
                const parsed = JSON.parse(existingState);
                taskName = parsed.taskName || '';
                todoId = parsed.todoId || null;
            } catch (_) {}
        }
        
        if (noteEl) {
            note = noteEl.value || '';
        } else if (existingState) {
            try {
                const parsed = JSON.parse(existingState);
                note = parsed.note || '';
            } catch (_) {}
        }
        
        const timerState = {
            running: timerRunning,
            paused: timerPaused,
            seconds: timerSeconds,
            taskName: taskName,
            note: note,
            todoId: todoId,
            fromPlan: isTimerFromPlan,
            lastUpdate: Date.now(),
            startTimestamp: startTimestamp // ä¿æŒåŸæœ‰çš„å¼€å§‹æ—¶é—´æˆ³
        };
        localStorage.setItem('habit_timer_state_v1', JSON.stringify(timerState));
    }
    
    // ä»localStorageæ¢å¤è®¡æ—¶å™¨çŠ¶æ€
    function restoreTimerState() {
        // å…ˆæ¸…ç†ç°æœ‰çš„è®¡æ—¶å™¨
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (timerSyncInterval) {
            clearInterval(timerSyncInterval);
            timerSyncInterval = null;
        }
        
        const saved = localStorage.getItem('habit_timer_state_v1');
        if (!saved) {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œåœæ­¢è®¡æ—¶å™¨å¹¶é‡ç½®UI
            const wasRunning = timerRunning;
            
            timerRunning = false;
            timerPaused = false;
            timerSeconds = 0;
            
            // é‡ç½®UI
            const idleBtns = document.getElementById('timerIdleBtns');
            const activeBtns = document.getElementById('timerActiveBtns');
            if (idleBtns) idleBtns.style.display = 'flex';
            if (activeBtns) activeBtns.style.display = 'none';
            
            // é‡ç½®æ˜¾ç¤º
            updateTimerUI();
            updateStickyNotif();
            
            if (wasRunning) {
                console.log('â¹ï¸ è®¡æ—¶å™¨å·²åœ¨å…¶ä»–è®¾å¤‡ç»“æŸï¼Œæœ¬åœ°åŒæ­¥åœæ­¢');
            }
            return;
        }
        
        try {
            const state = JSON.parse(saved);
            const now = Date.now();
            
            // åªæ¢å¤24å°æ—¶å†…çš„è®¡æ—¶çŠ¶æ€ï¼Œé¿å…æ¢å¤è¿‡æ—§çš„çŠ¶æ€
            if (!state.running || now - state.lastUpdate > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('habit_timer_state_v1');
                return;
            }
            
            // å¦‚æœè®¡æ—¶å™¨æ²¡æœ‰æš‚åœï¼Œæ ¹æ®å¼€å§‹æ—¶é—´æˆ³è®¡ç®—å®é™…å·²ç»è¿‡å»çš„ç§’æ•°
            if (!state.paused && state.startTimestamp) {
                const elapsedMs = now - state.startTimestamp;
                timerSeconds = Math.floor(elapsedMs / 1000);
            } else {
                // å¦‚æœæš‚åœäº†ï¼Œå°±ä½¿ç”¨ä¿å­˜çš„ç§’æ•°
                timerSeconds = state.seconds || 0;
            }
            
            timerRunning = state.running;
            timerPaused = state.paused || false;
            isTimerFromPlan = state.fromPlan || false;
            
            // æ¢å¤UI
            const taskNameInput = document.getElementById('timerTaskName');
            const noteInput = document.getElementById('timerNote');
            
            if (taskNameInput) taskNameInput.value = state.taskName || '';
            if (noteInput) noteInput.value = state.note || '';
            if (state.todoId && taskNameInput) taskNameInput.setAttribute('data-todo-id', state.todoId);
            
            // é‡æ–°å¯åŠ¨è®¡æ—¶å™¨
            if (timerRunning) {
                const idleBtns = document.getElementById('timerIdleBtns');
                const activeBtns = document.getElementById('timerActiveBtns');
                if (idleBtns) idleBtns.style.display = 'none';
                if (activeBtns) activeBtns.style.display = 'flex';
                
                const pauseBtn = document.getElementById('btnTimerPause');
                if (pauseBtn) {
                    pauseBtn.innerText = timerPaused ? 'ç»§ç»­' : 'æš‚åœ';
                }
                
                updateTimerUI();
                updateStickyNotif();
                
                // è·å–å¼€å§‹æ—¶é—´æˆ³ç”¨äºå‡†ç¡®è®¡ç®—
                const savedState = localStorage.getItem('habit_timer_state_v1');
                let startTimestamp = Date.now();
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        if (parsed.startTimestamp) {
                            startTimestamp = parsed.startTimestamp;
                        }
                    } catch (e) {}
                }
                
                timerInterval = setInterval(() => {
                    if (!timerPaused && timerRunning) {
                        // åŸºäºæ—¶é—´æˆ³è®¡ç®—å·²è¿‡å»çš„ç§’æ•°ï¼Œé¿å…é”å±å¯¼è‡´çš„åå·®
                        const elapsedMs = Date.now() - startTimestamp;
                        timerSeconds = Math.floor(elapsedMs / 1000);
                        updateTimerUI();
                        saveTimerState(); // æ¯ç§’ä¿å­˜ä¸€æ¬¡çŠ¶æ€åˆ°æœ¬åœ°
                    }
                }, 1000);
                
                // æ¢å¤åä¹Ÿå¯åŠ¨å®šæœŸåŒæ­¥
                timerSyncInterval = setInterval(async () => {
                    const provider = config.syncProvider || 'both';
                    const hasGh = (provider === 'both' || provider === 'github') && ghConfig.token && ghConfig.repo;
                    const hasGitee = (provider === 'both' || provider === 'gitee') && giteeConfig.token && giteeConfig.repo;

                    if (timerRunning && (hasGh || hasGitee)) {
                        console.log('ğŸ”„ å®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€...');
                        // å…ˆ pull æ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰å˜åŒ–ï¼ˆæ¯”å¦‚å…¶ä»–è®¾å¤‡å·²ç»“æŸè®¡æ—¶ï¼‰
                        await syncAll('pull', true);
                        // å¦‚æœè®¡æ—¶å™¨è¿˜åœ¨è¿è¡Œï¼ˆæ²¡æœ‰è¢« pull åœæ­¢ï¼‰ï¼Œå† push æœ¬åœ°çŠ¶æ€
                        if (timerRunning) {
                            triggerAutoSave();
                        }
                    } else if (timerRunning) {
                        // å¦‚æœæ²¡æœ‰é…ç½®åŒæ­¥ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                        saveTimerState();
                    }
                }, 30000); // 30ç§’
                
                console.log('âœ… å·²æ¢å¤è®¡æ—¶å™¨çŠ¶æ€:', state.taskName, 'å·²è®¡æ—¶', Math.floor(timerSeconds / 60), 'åˆ†é’Ÿ');
            }
        } catch (e) {
            console.error('æ¢å¤è®¡æ—¶å™¨çŠ¶æ€å¤±è´¥:', e);
            localStorage.removeItem('habit_timer_state_v1');
        }
    }

    /* ================== âœ… æ•°æ®åˆå¹¶å‡½æ•°ï¼šæ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ® ================== */
    function mergeData(cloudData, localData) {
        if (!cloudData || !localData) return;
        
        // 1. å…ˆåˆå¹¶åˆ é™¤è®°å½•ï¼Œä»¥ä¾¿åç»­è¿‡æ»¤
        if (cloudData.deletedTodoIds && Array.isArray(cloudData.deletedTodoIds)) {
            if (typeof deletedTodoIds === 'undefined') deletedTodoIds = [];
            const localDeletedSet = new Set(deletedTodoIds);
            cloudData.deletedTodoIds.forEach(id => localDeletedSet.add(String(id)));
            deletedTodoIds = Array.from(localDeletedSet);
            // é™åˆ¶å¤§å°
            if (deletedTodoIds.length > 500) deletedTodoIds = deletedTodoIds.slice(-500);
            localStorage.setItem('habit_deleted_todo_ids_v1', JSON.stringify(deletedTodoIds));
        }

        // åˆå¹¶å†å²è®°å½•ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€è®°å½•ï¼ˆæŒ‰idå»é‡ï¼‰
        if (cloudData.data && Array.isArray(cloudData.data)) {
            const localDataArray = localData.data || [];
            const localIds = new Set(localDataArray.map(r => r && r.id ? r.id : null).filter(id => id !== null));
            const cloudIds = new Set(cloudData.data.map(r => r && r.id ? r.id : null).filter(id => id !== null));
            
            // æ·»åŠ äº‘ç«¯ç‹¬æœ‰çš„è®°å½•
            cloudData.data.forEach(record => {
                if (record && record.id && !localIds.has(record.id)) {
                    localDataArray.push(record);
                }
            });
            
            // æŒ‰æ—¥æœŸå’Œidæ’åº
            localDataArray.sort((a, b) => {
                if (!a || !b) return 0;
                if (a.date !== b.date) return (b.date || '').localeCompare(a.date || '');
                return (b.id || 0) - (a.id || 0);
            });
            
            historyData = localDataArray;
        }
        
        // åˆå¹¶å¾…åŠäº‹é¡¹ï¼šæŒ‰ id åˆå¹¶ï¼Œå¹¶å°½é‡ä¿ç•™â€œæœ€æ–°ä¿®æ”¹â€çš„çŠ¶æ€
        if (cloudData.todos && Array.isArray(cloudData.todos)) {
            const localTodosArray = localData.todos || [];
            
            // ç»Ÿä¸€è®¡ç®—æ¯ä¸ªå¾…åŠçš„â€œæœ€è¿‘ä¿®æ”¹æ—¶é—´â€
            const getTodoTimestamp = (todo) => {
                if (!todo) return 0;
                const ts = Number(todo.updatedAt || todo.endedAt || todo.archivedAt || 0);
                return Number.isFinite(ts) && ts > 0 ? ts : 0;
            };
            
            // åˆå¹¶åŒä¸€ä¸ª id çš„å¾…åŠæ—¶çš„å†³ç­–å‡½æ•°
            const pickNewerTodo = (localTodo, cloudTodo) => {
                if (!localTodo) return cloudTodo;
                if (!cloudTodo) return localTodo;
                
                const localTs = getTodoTimestamp(localTodo);
                const cloudTs = getTodoTimestamp(cloudTodo);
                
                // å¦‚æœä¸¤è¾¹éƒ½æœ‰æœ‰æ•ˆæ—¶é—´æˆ³ï¼Œåˆ™é€‰æ—¶é—´æˆ³æ›´å¤§çš„ï¼ˆæ›´æ–°æ›´æ™šçš„ï¼‰
                if (localTs !== 0 || cloudTs !== 0) {
                    return cloudTs > localTs ? cloudTodo : localTodo;
                }
                
                // æ²¡æœ‰æ—¶é—´æˆ³ï¼ˆæ—§æ•°æ®ï¼‰ï¼šå¦‚æœçŠ¶æ€ä¸åŒï¼Œä¼˜å…ˆä¿ç•™â€œé pendingâ€çš„ç‰ˆæœ¬ï¼Œ
                // é¿å…ä¸€ä¸ªå·²ç»å®Œæˆ/è¿‡æœŸçš„ä»»åŠ¡è¢«å¦ä¸€å°è®¾å¤‡çš„æœªå®ŒæˆçŠ¶æ€è¦†ç›–
                if (localTodo.status !== cloudTodo.status) {
                    const scoreStatus = (t) => (t && t.status && t.status !== 'pending') ? 1 : 0;
                    return scoreStatus(cloudTodo) > scoreStatus(localTodo) ? cloudTodo : localTodo;
                }
                
                // çŠ¶æ€ç›¸åŒæˆ–æ— æ³•åŒºåˆ†æ—¶ï¼Œä¿ç•™æœ¬åœ°ç‰ˆæœ¬
                return localTodo;
            };
            
            const todoMap = new Map();
            
            // å…ˆæ”¾å…¥æœ¬åœ°çš„å¾…åŠ
            localTodosArray.forEach(t => {
                if (t && t.id) {
                    todoMap.set(t.id, t);
                }
            });
            
            // ä½¿ç”¨åˆå¹¶ç­–ç•¥å åŠ äº‘ç«¯çš„å¾…åŠ
            cloudData.todos.forEach(todo => {
                if (todo && todo.id) {
                    const existing = todoMap.get(todo.id);
                    const merged = pickNewerTodo(existing, todo);
                    todoMap.set(todo.id, merged);
                }
            });
            
            // å°† Map è½¬å›æ•°ç»„
            todoList = Array.from(todoMap.values());
            
            // è¿‡æ»¤æ‰å·²åˆ é™¤çš„å¾…åŠ
            if (typeof deletedTodoIds !== 'undefined' && deletedTodoIds.length > 0) {
                const deletedSet = new Set(deletedTodoIds);
                todoList = todoList.filter(t => !deletedSet.has(String(t.id)));
            }
        }
        
        // åˆå¹¶æ„¿æœ›æ¸…å•ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€æ„¿æœ›ï¼ˆæŒ‰åç§°å»é‡ï¼‰
        if (cloudData.wishes && Array.isArray(cloudData.wishes)) {
            const localWishesArray = localData.wishes || [];
            const localWishNames = new Set(localWishesArray.map(w => w && w.name ? w.name : null).filter(name => name !== null));
            
            cloudData.wishes.forEach(wish => {
                if (wish && wish.name && !localWishNames.has(wish.name)) {
                    localWishesArray.push(wish);
                }
            });
            
            wishList = localWishesArray;
        }
        
        // åˆå¹¶ç­–ç•¥ï¼šåˆå¹¶æ•°ç»„
        if (cloudData.strategies && typeof cloudData.strategies === 'object') {
            const localStrategies = localData.strategies || {};
            Object.keys(cloudData.strategies).forEach(key => {
                if (!localStrategies[key]) {
                    localStrategies[key] = [];
                }
                if (Array.isArray(cloudData.strategies[key])) {
                    cloudData.strategies[key].forEach(strategy => {
                        if (strategy && !localStrategies[key].includes(strategy)) {
                            localStrategies[key].push(strategy);
                        }
                    });
                }
            });
            userStrategies = localStrategies;
        }
        
        // åˆå¹¶è®¡æ—¶å™¨è®°å½•ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€è®°å½•
        if (cloudData.timerRecords && Array.isArray(cloudData.timerRecords)) {
            const localTimerArray = localData.timerRecords || [];
            const localTimerIds = new Set(localTimerArray.map(r => r && r.id ? r.id : null).filter(id => id !== null));
            
            cloudData.timerRecords.forEach(record => {
                if (record && record.id && !localTimerIds.has(record.id)) {
                    localTimerArray.push(record);
                }
            });
            
            timerRecords = localTimerArray;
        }
        
        // åˆå¹¶è®¡åˆ’ä»»åŠ¡ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€ä»»åŠ¡
        if (cloudData.plannedTasks && Array.isArray(cloudData.plannedTasks)) {
            const localPlansArray = localData.plannedTasks || [];
            const localPlanIds = new Set(localPlansArray.map(p => p && p.id ? p.id : null).filter(id => id !== null));
            
            cloudData.plannedTasks.forEach(task => {
                if (task && task.id && !localPlanIds.has(task.id)) {
                    localPlansArray.push(task);
                }
            });
            
            plannedTasks = localPlansArray;
        }
        
        // åˆå¹¶æ¯æ—¥å¤ç›˜ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€å¤ç›˜ï¼ˆæŒ‰æ—¥æœŸå»é‡ï¼Œä¿ç•™æœ€æ–°çš„ï¼‰
        if (cloudData.dailyReviews && typeof cloudData.dailyReviews === 'object') {
            const localReviews = localData.dailyReviews || {};
            Object.keys(cloudData.dailyReviews).forEach(date => {
                const cloudReview = cloudData.dailyReviews[date];
                const localReview = localReviews[date];
                
                if (!localReview || (cloudReview && cloudReview.timestamp && cloudReview.timestamp > (localReview.timestamp || 0))) {
                    localReviews[date] = cloudReview;
                }
            });
            dailyReviews = localReviews;
        }
        
        // åˆå¹¶ä»»åŠ¡ä½¿ç”¨è®¡æ•°ï¼šå–è¾ƒå¤§å€¼
        if (cloudData.taskUsageCount && typeof cloudData.taskUsageCount === 'object') {
            const localUsageCount = localData.taskUsageCount || {};
            Object.keys(cloudData.taskUsageCount).forEach(task => {
                const cloudCount = cloudData.taskUsageCount[task] || 0;
                const localCount = localUsageCount[task] || 0;
                localUsageCount[task] = Math.max(cloudCount, localCount);
            });
            taskUsageCount = localUsageCount;
        }
        
        // æ—¶é—´é“¶è¡Œï¼šå–è¾ƒå¤§å€¼ï¼ˆé¿å…ä¸¢å¤±æ—¶é—´ï¼‰
        if (cloudData.timeBank !== undefined) {
            timeBank = Math.max(timeBank, cloudData.timeBank);
        }
        
        // é…ç½®ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°é…ç½®ï¼ˆç”¨æˆ·è®¾ç½®ä¸åº”è¯¥è¢«è¦†ç›–ï¼‰
        // config ä¿æŒä¸å˜
        
        // ç½®é¡¶ä»»åŠ¡ï¼šå¦‚æœäº‘ç«¯æœ‰ä¸”æœ¬åœ°æ²¡æœ‰ï¼Œä½¿ç”¨äº‘ç«¯çš„
        if (cloudData.pinnedTaskId && !pinnedTaskId) {
            pinnedTaskId = cloudData.pinnedTaskId;
            localStorage.setItem('habit_pinned_task_id', pinnedTaskId);
        }
        
        // ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°æœ¬åœ°
        persistAllLocal();
    }
    
    /* ================== âœ… åŒæ­¥ä¿®å¤ï¼šå‰¥ç¦»å›¾ç‰‡å­—æ®µï¼ˆä»…ç”¨äºäº‘ç«¯/æ‹‰å–å†™å…¥ï¼‰ ================== */
    function stripImagesFromHistory(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(r => {
            if (!r || typeof r !== 'object') return r;
            const nr = { ...r };
            if (nr.details && typeof nr.details === 'object') {
                const nd = { ...nr.details };
                if (nd.image) delete nd.image; // ä¸åŒæ­¥/ä¸è½ç›˜å›¾ç‰‡
                nr.details = nd;
            }
            return nr;
        });
    }

    function persistAllLocal() {
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList));
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        localStorage.setItem('habit_time_bank_v1', timeBank);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
    }

    function setSyncBadgeStatus(status, text) {
        const badge = document.getElementById('syncBadge');
        const badgeText = document.getElementById('syncText');
        const syncIcon = badge ? badge.querySelector('.sync-icon') : null;
        if (!badge) {
            console.warn('syncBadgeå…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        console.log('è®¾ç½®åŒæ­¥çŠ¶æ€:', status, text);
        // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»ï¼Œç„¶åæ·»åŠ æ–°çŠ¶æ€ç±»
        badge.className = badge.className.replace(/\s*status-\w+/g, '');
        badge.className = `sync-badge ${status}`.trim();
        if (badgeText && typeof text === 'string') {
            badgeText.innerText = text;
        }
        // AIGC START
        // å¦‚æœåˆ‡æ¢åˆ°syncingçŠ¶æ€ï¼Œé‡ç½®åŠ¨ç”»ä»¥ç¡®ä¿ç«‹å³å¼€å§‹ï¼Œå¹¶ç¦ç”¨ç‚¹å‡»
        if (status === 'status-syncing' && syncIcon) {
            syncIcon.style.animation = 'none';
            void syncIcon.offsetHeight;
            syncIcon.style.animation = '';
            // ç¡®ä¿åŠ¨ç”»ç±»æ­£ç¡®åº”ç”¨
            syncIcon.style.display = 'inline-block';
            // ç¦ç”¨æŒ‰é’®ç‚¹å‡»ï¼Œé˜²æ­¢é‡å¤è§¦å‘
            badge.style.pointerEvents = 'none';
            badge.style.cursor = 'not-allowed';
        } else {
            // æ¢å¤æŒ‰é’®ç‚¹å‡»
            badge.style.pointerEvents = '';
            badge.style.cursor = 'pointer';
        }
        // å¼ºåˆ¶æµè§ˆå™¨ç«‹å³é‡ç»˜ï¼Œç¡®ä¿çŠ¶æ€å˜åŒ–å¯è§
        void badge.offsetHeight;
        console.log('åŒæ­¥çŠ¶æ€å·²è®¾ç½®ï¼Œå½“å‰ç±»å:', badge.className);
        // AIGC END
    }

    function initTodoTime() {
        // é»˜è®¤è®¾ç½®ä¸º1å°æ—¶å
        const now = new Date();
        const after1h = new Date(now.getTime() + 60 * 60 * 1000);
        const time1h = `${String(after1h.getHours()).padStart(2, '0')}:${String(after1h.getMinutes()).padStart(2, '0')}`;
        
        const todoTimeInput = document.getElementById('todoTime');
        if (todoTimeInput) todoTimeInput.value = time1h;
        
        // æ¸²æŸ“æ—¶é—´å¿«é€‰èƒ¶å›Š
        renderTodoTimeChips();
        // æ¸²æŸ“ä»»åŠ¡å¿«é€‰èƒ¶å›Š
        renderTodoTaskChips();
        // æ¸²æŸ“é‡‘é¢å¿«é€‰èƒ¶å›Š
        renderTodoFundChips();
        // æ¸²æŸ“ç±»å‹å’Œé‡è¦æ€§èƒ¶å›Š
        renderTodoTypeChips();
        renderTodoImportanceChips();
    }
    
    // è·å–æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆè¾…åŠ©å‡½æ•°ï¼Œæ”¯æŒä¼ å…¥Dateå¯¹è±¡ï¼‰
    function getLocalDateStr(date) {
        if (!date) date = new Date();
        return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹æ—¶é—´å¿«é€‰èƒ¶å›Š
    function renderTodoTimeChips() {
        const container = document.getElementById('todoTimeChips');
        if (!container) return;
        
        const now = new Date();
        const todayStr = getLocalDateStr(now);
        const offsetChips = []; // æ—¶é—´æ®µï¼ˆoffsetç±»å‹ï¼‰
        const fixedChips = [];  // å›ºå®šæ—¶é—´ç‚¹ï¼ˆfixedç±»å‹ï¼‰
        
        // è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„æ—¶é—´å¿«é€‰ï¼ˆå¦‚æœæœ‰ï¼‰
        const customTimeChips = config.todoTimeChips || [];
        
        if (customTimeChips.length > 0) {
            // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å¿«é€‰
            customTimeChips.forEach(chipConfig => {
                if (chipConfig.type === 'offset') {
                    // åç§»ç±»å‹ï¼šå¦‚"1å°æ—¶å"
                    const offsetMs = chipConfig.hours * 60 * 60 * 1000;
                    const targetTime = new Date(now.getTime() + offsetMs);
                    const timeStr = `${String(targetTime.getHours()).padStart(2, '0')}:${String(targetTime.getMinutes()).padStart(2, '0')}`;
                    const targetDateStr = getLocalDateStr(targetTime);
                    const isNextDay = targetDateStr > todayStr;
                    const displayLabel = isNextDay ? `æ¬¡æ—¥ ${chipConfig.label}` : chipConfig.label;
                    const dateParam = isNextDay ? `, '${targetDateStr}'` : '';
                    offsetChips.push({ 
                        html: `<div class="chip" onclick="applyTodoTimeOffset(${chipConfig.hours})">${displayLabel}</div>`,
                        hours: chipConfig.hours 
                    });
                } else if (chipConfig.type === 'fixed') {
                    // å›ºå®šæ—¶é—´ç±»å‹ï¼šå¦‚"ä»Šæ™š23:59"
                    const [hours, minutes] = chipConfig.time.split(':').map(Number);
                    const fixedTime = new Date(now);
                    fixedTime.setHours(hours, minutes, 0, 0);
                    
                    // å¦‚æœæœ‰æ—¶é—´æ®µå åŠ ï¼ˆåŒ…æ‹¬å¼ºåˆ¶ä»Šå¤©daysOffset=0çš„æƒ…å†µï¼‰ï¼Œå…ˆåŠ ä¸Šå¤©æ•°
                    if (typeof chipConfig.daysOffset !== 'undefined') {
                        fixedTime.setDate(fixedTime.getDate() + chipConfig.daysOffset);
                    } else {
                        // å¦‚æœæ²¡æœ‰å åŠ ï¼Œæ£€æŸ¥å›ºå®šæ—¶é—´æ˜¯å¦è·¨å¤©
                        // å¦‚æœå›ºå®šæ—¶é—´å·²è¿‡ï¼Œåˆ™è®¾ç½®ä¸ºæ˜å¤©
                        if (fixedTime <= now) {
                            fixedTime.setDate(fixedTime.getDate() + 1);
                        }
                    }
                    
                    const fixedDateStr = getLocalDateStr(fixedTime);
                    const isNextDay = fixedDateStr > todayStr;
                    
                    // ç”Ÿæˆæ˜¾ç¤ºæ ‡ç­¾
                    let displayLabel = chipConfig.label;
                    if (isNextDay) {
                        // ä¸å†æ˜¾ç¤ºå¤©æ•°æ ‡æ³¨ï¼Œåªä¿ç•™æ ‡ç­¾æœ¬èº«
                        displayLabel = chipConfig.label;
                    }
                    
                    const dateParam = isNextDay ? `, '${fixedDateStr}'` : '';
                    fixedChips.push({ 
                        html: `<div class="chip" onclick="setTodoTime('${chipConfig.time}'${dateParam})">${displayLabel}</div>`,
                        time: chipConfig.time 
                    });
                }
            });
        } else {
            // é»˜è®¤å¿«é€‰
            // 1å°æ—¶å
            const after1h = new Date(now.getTime() + 60 * 60 * 1000);
            const time1h = `${String(after1h.getHours()).padStart(2, '0')}:${String(after1h.getMinutes()).padStart(2, '0')}`;
            const date1h = getLocalDateStr(after1h);
            const isNextDay1h = date1h > todayStr;
            const label1h = isNextDay1h ? 'æ¬¡æ—¥ 1å°æ—¶å' : '1å°æ—¶å';
            const dateParam1h = isNextDay1h ? `, '${date1h}'` : '';
            offsetChips.push({ html: `<div class="chip" onclick="applyTodoTimeOffset(1)">${label1h}</div>`, hours: 1 });
            
            // 2å°æ—¶å
            const after2h = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const time2h = `${String(after2h.getHours()).padStart(2, '0')}:${String(after2h.getMinutes()).padStart(2, '0')}`;
            const date2h = getLocalDateStr(after2h);
            const isNextDay2h = date2h > todayStr;
            const label2h = isNextDay2h ? 'æ¬¡æ—¥ 2å°æ—¶å' : '2å°æ—¶å';
            const dateParam2h = isNextDay2h ? `, '${date2h}'` : '';
            offsetChips.push({ html: `<div class="chip" onclick="applyTodoTimeOffset(2)">${label2h}</div>`, hours: 2 });
            
            // 3å°æ—¶å
            const after3h = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            const time3h = `${String(after3h.getHours()).padStart(2, '0')}:${String(after3h.getMinutes()).padStart(2, '0')}`;
            const date3h = getLocalDateStr(after3h);
            const isNextDay3h = date3h > todayStr;
            const label3h = isNextDay3h ? 'æ¬¡æ—¥ 3å°æ—¶å' : '3å°æ—¶å';
            const dateParam3h = isNextDay3h ? `, '${date3h}'` : '';
            offsetChips.push({ html: `<div class="chip" onclick="applyTodoTimeOffset(3)">${label3h}</div>`, hours: 3 });
            
            // ä»Šæ™š11ç‚¹åŠ
            const fixedTime = new Date(now);
            fixedTime.setHours(23, 30, 0, 0);
            // å¦‚æœ23:30å·²è¿‡ï¼Œåˆ™è®¾ç½®ä¸ºæ˜å¤©
            if (fixedTime <= now) {
                fixedTime.setDate(fixedTime.getDate() + 1);
            }
            const fixedDateStr = getLocalDateStr(fixedTime);
            const isNextDayFixed = fixedDateStr > todayStr;
            const labelFixed = isNextDayFixed ? 'æ¬¡æ—¥ ä»Šæ™š' : 'ä»Šæ™š';
            const dateParamFixed = isNextDayFixed ? `, '${fixedDateStr}'` : '';
            fixedChips.push({ html: `<div class="chip" onclick="setTodoTime('23:30'${dateParamFixed})">${labelFixed}</div>`, time: '23:30' });
        }
        
        // æ’åºï¼šæ—¶é—´æ®µæŒ‰hoursæ’åºï¼Œå›ºå®šæ—¶é—´ç‚¹æŒ‰timeæ’åº
        offsetChips.sort((a, b) => a.hours - b.hours);
        fixedChips.sort((a, b) => a.time.localeCompare(b.time));
        
        // åˆå¹¶ï¼šå…ˆæ—¶é—´æ®µï¼Œå†å›ºå®šæ—¶é—´ç‚¹
        const allChips = offsetChips.map(c => c.html).concat(fixedChips.map(c => c.html));
        container.innerHTML = allChips.join('');
    }
    
    // è®¾ç½®å¾…åŠæ—¶é—´
    function setTodoTime(time, dateStr) {
        const todoTimeInput = document.getElementById('todoTime');
        if (todoTimeInput) todoTimeInput.value = time;
        if (dateStr) {
            const todoDateInput = document.getElementById('todoDate');
            if (todoDateInput) todoDateInput.value = dateStr;
        }
        renderTodoTimeChips();
    }
    
    function applyTodoTimeOffset(hours) {
        const h = Number(hours) || 0;
        if (h <= 0) return;
        const todoDateInput = document.getElementById('todoDate');
        const todoTimeInput = document.getElementById('todoTime');
        let base = new Date();
        if (todoDateInput && todoDateInput.value && todoTimeInput && todoTimeInput.value) {
            const ds = todoDateInput.value;
            const ts = todoTimeInput.value;
            const parsed = new Date(`${ds}T${ts}:00`);
            if (Number.isFinite(parsed.getTime())) base = parsed;
        }
        const target = new Date(base.getTime() + h * 60 * 60 * 1000);
        const timeStr = `${String(target.getHours()).padStart(2, '0')}:${String(target.getMinutes()).padStart(2, '0')}`;
        const dateStr = getLocalDateStr(target);
        setTodoTime(timeStr, dateStr);
    }
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹ä»»åŠ¡å¿«é€‰èƒ¶å›Šï¼ˆä¸è®¡æ—¶å™¨åŒæ­¥ï¼‰
    function renderTodoTaskChips() {
        const container = document.getElementById('todoTaskChips');
        if (!container) return;
        
        const quickTasks = config.quickTasks || [];
        container.innerHTML = quickTasks.map(task => 
            `<div class="chip" onclick="setTodoTask('${task}')">${task}</div>`
        ).join('');
    }
    
    // è®¾ç½®å¾…åŠä»»åŠ¡
    function setTodoTask(task) {
        const todoTitleInput = document.getElementById('todoTitle');
        if (todoTitleInput) todoTitleInput.value = task;
    }
    
    let lastReward = parseFloat(localStorage.getItem('habit_last_reward')) || 1;
    let lastPenalty = parseFloat(localStorage.getItem('habit_last_penalty')) || 1;
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹é‡‘é¢å¿«é€‰èƒ¶å›Š
    function renderTodoFundChips() {
        const container = document.getElementById('todoFundChips');
        if (!container) return;
        
        const chips = [];
        
        // ç»Ÿè®¡å†å²è¾“å…¥ä¸­çš„å¸¸ç”¨é‡‘é¢
        const rewardCounts = {};
        const penaltyCounts = {};
        const comboCounts = {};
        
        todoList.forEach(t => {
            if (t.reward && t.reward > 0) {
                rewardCounts[t.reward] = (rewardCounts[t.reward] || 0) + 1;
            }
            if (t.penalty && t.penalty > 0) {
                penaltyCounts[t.penalty] = (penaltyCounts[t.penalty] || 0) + 1;
            }
            // ç»Ÿè®¡ç»„åˆ
            const combo = `${t.reward || 0}/${t.penalty || 0}`;
            comboCounts[combo] = (comboCounts[combo] || 0) + 1;
        });
        
        // æ‰¾å‡ºæœ€å¸¸ç”¨çš„å¥–åŠ±å’Œæƒ©ç½šé‡‘é¢ï¼ˆå„å–å‰3ä¸ªï¼‰
        const topRewards = Object.entries(rewardCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([val]) => parseFloat(val));
        
        const topPenalties = Object.entries(penaltyCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([val]) => parseFloat(val));
        
        // æ‰¾å‡ºæœ€å¸¸ç”¨çš„ç»„åˆï¼ˆå–å‰3ä¸ªï¼‰
        const topCombos = Object.entries(comboCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([combo]) => {
                const [r, p] = combo.split('/').map(parseFloat);
                return { reward: r, penalty: p };
            });
        
        // æ·»åŠ "ä¸Šæ¬¡"é€‰é¡¹ï¼ˆä¸æ˜¾ç¤º"ä¸Šæ¬¡"æ–‡å­—ï¼‰
        if (lastReward > 0 || lastPenalty > 0) {
            chips.push(`<div class="chip" onclick="setTodoFunds(${lastReward}, ${lastPenalty})">${lastReward}/${lastPenalty}</div>`);
        }
        
        // æ·»åŠ æœ€å¸¸ç”¨çš„ç»„åˆï¼ˆæœ€å¤š3ä¸ªï¼‰
        topCombos.forEach(combo => {
            if (combo.reward > 0 || combo.penalty > 0) {
                chips.push(`<div class="chip" onclick="setTodoFunds(${combo.reward}, ${combo.penalty})">${combo.reward}/${combo.penalty}</div>`);
            }
        });
        
        // å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤å€¼
        if (chips.length === 0) {
            chips.push(`<div class="chip" onclick="setTodoFunds(1, 1)">1/1</div>`);
            chips.push(`<div class="chip" onclick="setTodoFunds(5, 5)">5/5</div>`);
            chips.push(`<div class="chip" onclick="setTodoFunds(10, 10)">10/10</div>`);
        }
        
        container.innerHTML = chips.join('');
    }
    
    // è®¾ç½®å¾…åŠé‡‘é¢
    function setTodoFunds(reward, penalty) {
        const rewardInput = document.getElementById('todoReward');
        const penaltyInput = document.getElementById('todoPenalty');
        if (rewardInput) rewardInput.value = reward;
        if (penaltyInput) penaltyInput.value = penalty;
    }

    // æ¸²æŸ“å¾…åŠç±»å‹å’Œé‡è¦æ€§èƒ¶å›Šï¼ˆåˆå¹¶åœ¨ä¸€è¡Œï¼‰
    function renderTodoTypeChips() {
        const container = document.getElementById('todoTypeImportanceChips');
        if (!container) return;
        
        const currentType = document.getElementById('todoType')?.value || 'do';
        const currentImportance = document.getElementById('todoImportance')?.value || '1';
        
        const types = [
            { value: 'do', label: 'å»åš' },
            { value: 'dont', label: 'ä¸åš' },
            { value: 'other', label: 'å…¶å®ƒ' }
        ];
        
        const importances = [
            { value: '1', label: 'æ™®é€š', color: 'var(--info)', bg: 'rgba(59, 130, 246, 0.2)' },
            { value: '2', label: 'ä¸­ç­‰', color: 'var(--warning)', bg: 'rgba(245, 158, 11, 0.2)' },
            { value: '3', label: 'é‡è¦', color: 'var(--danger)', bg: 'rgba(239, 68, 68, 0.2)' }
        ];
        
        const typeChips = types.map(t => {
            const active = currentType === t.value ? 'style="background:var(--primary-bg); border-color:var(--primary); color:var(--primary);"' : '';
            return `<div class="chip" ${active} onclick="setTodoType('${t.value}')">${t.label}</div>`;
        }).join('');
        
        const importanceChips = importances.map(i => {
            const isActive = currentImportance === i.value;
            const activeStyle = isActive ? `background:${i.bg}; border-color:${i.color}; color:${i.color}; font-weight:700;` : `border-color:${i.color}; color:${i.color}; opacity:0.7;`;
            return `<div class="chip" style="${activeStyle}" onclick="setTodoImportance('${i.value}')">${i.label}</div>`;
        }).join('');
        
        container.innerHTML = typeChips + importanceChips;
    }

    // æ¸²æŸ“å¾…åŠé‡è¦æ€§èƒ¶å›Šï¼ˆä¿ç•™å‡½æ•°ä»¥å…¼å®¹ï¼‰
    function renderTodoImportanceChips() {
        renderTodoTypeChips();
    }

    // è®¾ç½®å¾…åŠç±»å‹
    function setTodoType(type) {
        const typeInput = document.getElementById('todoType');
        if (typeInput) {
            typeInput.value = type;
            checkTodoTypeChange();
            renderTodoTypeChips(); // æ›´æ–°åˆå¹¶åçš„èƒ¶å›Šæ˜¾ç¤º
        }
    }

    // è®¾ç½®å¾…åŠé‡è¦æ€§
    function setTodoImportance(importance) {
        const importanceInput = document.getElementById('todoImportance');
        if (importanceInput) {
            importanceInput.value = importance;
            renderTodoTypeChips(); // æ›´æ–°åˆå¹¶åçš„èƒ¶å›Šæ˜¾ç¤º
        }
    }

    function initTimerTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        const timerPlannedTimeInput = document.getElementById('timerPlannedTime');
        if (timerPlannedTimeInput) timerPlannedTimeInput.value = timeStr;
        
        // æ¸²æŸ“è®¡æ—¶å™¨æ—¶é—´å¿«é€‰èƒ¶å›Š
        renderTimerTimeChips();
    }
    
    // æ¸²æŸ“è®¡æ—¶å™¨æ—¶é—´å¿«é€‰èƒ¶å›Š
    function renderTimerTimeChips() {
        const container = document.getElementById('timerTimeChips');
        if (!container) return;
        
        const now = new Date();
        const chips = [];
        
        // è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„æ—¶é—´å¿«é€‰ï¼ˆä¸å¾…åŠå…±äº«é…ç½®ï¼‰
        const customTimeChips = config.todoTimeChips || [];
        
        if (customTimeChips.length > 0) {
            // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å¿«é€‰
            customTimeChips.forEach(chipConfig => {
                if (chipConfig.type === 'offset') {
                    // åç§»ç±»å‹ï¼šå¦‚"1å°æ—¶å"
                    const offsetMs = chipConfig.hours * 60 * 60 * 1000;
                    const targetTime = new Date(now.getTime() + offsetMs);
                    const timeStr = `${String(targetTime.getHours()).padStart(2, '0')}:${String(targetTime.getMinutes()).padStart(2, '0')}`;
                    chips.push(`<div class="chip" onclick="setTimerPlannedTime('${timeStr}')">${chipConfig.label} ${timeStr}</div>`);
                } else if (chipConfig.type === 'fixed') {
                    // å›ºå®šæ—¶é—´ç±»å‹ï¼šå¦‚"ä»Šæ™š23:59"
                    chips.push(`<div class="chip" onclick="setTimerPlannedTime('${chipConfig.time}')">${chipConfig.label}</div>`);
                }
            });
        } else {
            // é»˜è®¤å¿«é€‰
            // 1å°æ—¶å
            const after1h = new Date(now.getTime() + 60 * 60 * 1000);
            const time1h = `${String(after1h.getHours()).padStart(2, '0')}:${String(after1h.getMinutes()).padStart(2, '0')}`;
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('${time1h}')">1å°æ—¶å ${time1h}</div>`);
            
            // 2å°æ—¶å
            const after2h = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const time2h = `${String(after2h.getHours()).padStart(2, '0')}:${String(after2h.getMinutes()).padStart(2, '0')}`;
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('${time2h}')">2å°æ—¶å ${time2h}</div>`);
            
            // 3å°æ—¶å
            const after3h = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            const time3h = `${String(after3h.getHours()).padStart(2, '0')}:${String(after3h.getMinutes()).padStart(2, '0')}`;
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('${time3h}')">3å°æ—¶å ${time3h}</div>`);
            
            // ä»Šæ™š11ç‚¹åŠ
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('23:30')">ä»Šæ™š 23:30</div>`);
        }
        
        container.innerHTML = chips.join('');
    }
    
    // è®¾ç½®è®¡æ—¶å™¨èµ·å§‹æ—¶é—´
    function setTimerPlannedTime(time) {
        const input = document.getElementById('timerPlannedTime');
        if (input) input.value = time;
    }
    
    // è®¾ç½®è®¡æ—¶å™¨ç»“æŸæ—¶é—´
    function setTimerPlannedEndTime(time) {
        const input = document.getElementById('timerPlannedEndTime');
        if (input) input.value = time;
    }
    
    // å¿«é€Ÿè®¾ç½®è®¡æ—¶å™¨æ—¶é—´æ®µï¼ˆèµ·å§‹+ç»“æŸï¼‰
    function setTimerTimeRange(startTime, duration) {
        const startInput = document.getElementById('timerPlannedTime');
        if (startInput) startInput.value = startTime;
        
        // è®¡ç®—ç»“æŸæ—¶é—´
        const [hours, minutes] = startTime.split(':').map(Number);
        const startDate = new Date();
        startDate.setHours(hours, minutes, 0, 0);
        const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
        const endTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
        
        const endInput = document.getElementById('timerPlannedEndTime');
        if (endInput) endInput.value = endTime;
    }

    function init() {
        fixCorruptData();
        initTheme();
        const today = getLocalTodayStr();
        const dateInput = document.getElementById('dateInput');
        if (dateInput) dateInput.value = today;
        const todoDateInput = document.getElementById('todoDate');
        if (todoDateInput) todoDateInput.value = today;
        initTodoTime();
        initTimerTime();
        checkWeekend(); applySettingsToUI();
        renderStrategySettings();
        renderQuickTaskSettings(); // åˆå§‹åŒ–å¿«æ·ä»»åŠ¡è®¾ç½®æ˜¾ç¤º
        if(ghConfig.token && ghConfig.repo) { document.getElementById('ghToken').value = ghConfig.token; document.getElementById('ghRepo').value = ghConfig.repo; }
        if(giteeConfig.token && giteeConfig.repo) { 
            const gt = document.getElementById('giteeToken');
            const gr = document.getElementById('giteeRepo');
            if(gt) gt.value = giteeConfig.token;
            if(gr) gr.value = giteeConfig.repo;
        }
        renderTodos();
        renderStrategies();
        restoreTimerState(); // æ¢å¤æ­£åœ¨è¿›è¡Œçš„è®¡æ—¶å™¨çŠ¶æ€
        updateUI();
        updateStickyNotif(); // åŠ è½½æ—¶æ˜¾ç¤ºå¯èƒ½çš„ç½®é¡¶ä»»åŠ¡

        // é»˜è®¤è¿›å…¥èµ·å§‹é¡µ
        switchPage(config.initialPage || 'checkin');

        setInterval(() => {
            if(!isDeleting) {
                autoCheckTodos();
                updateStickyNotif(); // å‘¨æœŸæ€§æ›´æ–°ç½®é¡¶é€šçŸ¥ï¼ˆç¡®ä¿"ä¸‹ä¸€è®¡åˆ’"éšæ—¶é—´è‡ªåŠ¨åˆ‡æ¢ï¼‰
            }
        }, 2000);

        // åˆå§‹åŒæ­¥
        syncAll('pull', true);
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå¤„ç†é”å±/è§£é”ç­‰æƒ…å†µ
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && timerRunning && !timerPaused) {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼ŒåŸºäºæ—¶é—´æˆ³æ ¡æ­£è®¡æ—¶å™¨æ—¶é—´ï¼Œé¿å…é”å±å¯¼è‡´çš„åå·®
                const savedState = localStorage.getItem('habit_timer_state_v1');
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        if (parsed.startTimestamp) {
                            const elapsedMs = Date.now() - parsed.startTimestamp;
                            timerSeconds = Math.floor(elapsedMs / 1000);
                            updateTimerUI();
                            saveTimerState();
                        }
                    } catch (e) {
                        console.error('æ ¡æ­£è®¡æ—¶å™¨æ—¶é—´å¤±è´¥:', e);
                    }
                }
            }
        });
        
        // æ¯2åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼Œæ£€æµ‹å…¶ä»–è®¾å¤‡çš„å˜åŒ–
        const provider = config.syncProvider || 'both';
        const hasGh = (provider === 'both' || provider === 'github') && ghConfig.token && ghConfig.repo;
        const hasGitee = (provider === 'both' || provider === 'gitee') && giteeConfig.token && giteeConfig.repo;
        
        if(hasGh || hasGitee) {
            setInterval(() => {
                console.log('ğŸ”„ å®šæœŸæ£€æŸ¥äº‘ç«¯æ•°æ®æ›´æ–°...');
                syncAll('pull', true);
            }, 120000); // 2åˆ†é’Ÿ
        }
    }

    function toggleWeek(day) {
        if(!config.weekend) config.weekend = [0, 6];
        const idx = config.weekend.indexOf(day);
        if(idx > -1) config.weekend.splice(idx, 1);
        else config.weekend.push(day);

        // æ›´æ–°æŒ‰é’®çŠ¶æ€ - æ£€æŸ¥æ˜¯å¦åœ¨modalä¸­
        const modalContent = document.getElementById('settingsModalContent');
        if (modalContent) {
            // åœ¨modalä¸­ï¼Œç›´æ¥æ›´æ–°modalä¸­çš„æŒ‰é’®
            const we = config.weekend || [0, 6];
            const btnWeek6 = modalContent.querySelector('#btn_week_6');
            const btnWeek0 = modalContent.querySelector('#btn_week_0');
            if (btnWeek6) btnWeek6.className = `week-btn ${we.includes(6)?'active':''}`;
            if (btnWeek0) btnWeek0.className = `week-btn ${we.includes(0)?'active':''}`;
        } else {
            // ä¸åœ¨modalä¸­ï¼Œä½¿ç”¨applySettingsToUIæ›´æ–°ä¸»é¡µé¢
            applySettingsToUI();
        }
        
        checkWeekend();

        config.weekend = config.weekend || [0, 6];
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
    }

    function toggleExchangeCard() {
        // æ‰“å¡è§†å›¾å·²ç§»é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼Œä½†ä¸å†æ˜¾ç¤ºexchangeCard
        // æ—¶é—´å…‘æ¢åŠŸèƒ½å·²ç§»è‡³æ—¶é—´é“¶è¡Œå¼¹å‡ºçª—å£
    }

    function executeExchange() {
        const hours = parseFloat(document.getElementById('exchangeHours').value);
        if(!hours || hours <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆå°æ—¶æ•°");
        if(hours > timeBank) return alert(`ä½™é¢ä¸è¶³ï¼Œå½“å‰ä»…æœ‰ ${timeBank.toFixed(1)} å°æ—¶`);

        const rate = config.exchangeRate || 5;
        const money = hours * rate;

        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${hours} å°æ—¶å…‘æ¢ ${money} å…ƒæ„¿æœ›é‡‘ï¼Ÿ`)) return;

        timeBank -= hours;
        addWallet(money);
        saveRecord({
            fund: money,
            title: 'æ—¶é—´å…‘æ¢',
            theme: 'theme-success',
            details: { note: `æ¶ˆè€— ${hours}h, æ±‡ç‡ ${rate}`, time_bank_change: `-${hours}h` }
        }, false);

        toggleExchangeCard();
        alert("å…‘æ¢æˆåŠŸï¼");
    }

    // æ—¶é—´é“¶è¡Œå¼¹å‡ºçª—å£å‡½æ•°
    function showTimeBankModal() {
        const modal = document.getElementById('timeBankModal');
        if (!modal) return;
        document.getElementById('timeBankModalDisplay').innerText = timeBank.toFixed(1);
        document.getElementById('timeBankRateDisplay').innerText = config.exchangeRate || 5;
        document.getElementById('timeBankExchangeHours').value = '';
        
        // æ¸²æŸ“å€’æ•°æ—¥
        renderDaysMatter();
        
        modal.classList.add('show');
    }

    function closeTimeBankModal() {
        const modal = document.getElementById('timeBankModal');
        if (modal) modal.classList.remove('show');
    }

    function executeExchangeFromModal() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ 
        const timeBankModal = document.getElementById('timeBankModal');
        const isModalOpen = timeBankModal && timeBankModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('timeBankModal') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const hoursInput = getEl('timeBankExchangeHours');
        if (!hoursInput) return;
        
        const hours = parseFloat(hoursInput.value);
        if(!hours || hours <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆå°æ—¶æ•°");
        if(hours > timeBank) return alert(`ä½™é¢ä¸è¶³ï¼Œå½“å‰ä»…æœ‰ ${timeBank.toFixed(1)} å°æ—¶`);

        const rate = config.exchangeRate || 5;
        const money = hours * rate;

        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${hours} å°æ—¶å…‘æ¢ ${money} å…ƒæ„¿æœ›é‡‘ï¼Ÿ`)) return;

        timeBank -= hours;
        addWallet(money);
        saveRecord({
            fund: money,
            title: 'æ—¶é—´å…‘æ¢',
            theme: 'theme-success',
            details: { note: `æ¶ˆè€— ${hours}h, æ±‡ç‡ ${rate}`, time_bank_change: `-${hours}h` }
        }, false);

        // æ›´æ–°modalä¸­çš„æ˜¾ç¤º
        if (isModalOpen) {
            const display = modalContent.querySelector('#timeBankModalDisplay');
            if (display) display.innerText = timeBank.toFixed(1);
            hoursInput.value = '';
        }
        
        closeTimeBankModal();
        alert("å…‘æ¢æˆåŠŸï¼");
    }

    // æ„¿æœ›å•†åº—å¼¹å‡ºçª—å£å‡½æ•°
    function showWalletModal() {
        const modal = document.getElementById('walletModal');
        if (!modal) return;
        
        try {
            // å…‹éš†å•†åº—é¡µé¢çš„å†…å®¹åˆ°modalä¸­
            const shopPage = document.getElementById('page-shop');
            const modalContent = document.getElementById('walletModalContent');
            
            if (shopPage && modalContent) {
                // å…‹éš†æ•´ä¸ªå•†åº—é¡µé¢çš„å†…å®¹
                modalContent.innerHTML = shopPage.innerHTML;
                
                // æ¸²æŸ“å•†åº—å†…å®¹
                if (typeof renderShop === 'function') {
                    renderShop();
                }
            }
        } catch (e) {
            console.error('showWalletModal error:', e);
        }
        
        modal.classList.add('show');
    }

    function closeWalletModal() {
        const modal = document.getElementById('walletModal');
        if (modal) modal.classList.remove('show');
    }

    function addWishFromModal() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ 
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const nameInput = getEl('walletWishName');
        const costInput = getEl('walletWishCost');
        if (!nameInput || !costInput) return;
        
        const n = nameInput.value.trim();
        const c = parseFloat(costInput.value);
        if(!n || !c || c <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®çš„åç§°å’Œä»·æ ¼");

        wishList.push({name:n, cost:c, hidden:false});
        nameInput.value = '';
        costInput.value = '';
        
        // å¦‚æœåœ¨modalä¸­ï¼Œé‡æ–°æ¸²æŸ“modalä¸­çš„å•†åº—å†…å®¹
        if (isModalOpen && typeof renderShop === 'function') {
            renderShop();
        }
        
        triggerAutoSave();
        alert("æ„¿æœ›å·²æ·»åŠ ï¼");
    }

    // ç»Ÿè®¡æ•°æ®å¼¹å‡ºçª—å£å‡½æ•°
    function showDebtModal() {
        const modal = document.getElementById('debtModal');
        if (!modal) return;
        
        try {
            // å…‹éš†ç»Ÿè®¡é¡µé¢çš„å†…å®¹åˆ°modalä¸­ï¼ˆæ’é™¤ç¬¬ä¸€ä¸ªç»Ÿè®¡æ•°æ®å¡ç‰‡ï¼‰
            const statsPage = document.getElementById('page-stats');
            const modalContent = document.getElementById('debtModalContent');
            
            if (statsPage && modalContent) {
                // å…‹éš†æ‰€æœ‰å¡ç‰‡ï¼Œä½†æ’é™¤ç¬¬ä¸€ä¸ªï¼ˆç»Ÿè®¡æ•°æ®å¡ç‰‡ï¼‰å’Œ paySectionï¼ˆæ”¯ä»˜å¡ç‰‡ï¼Œå› ä¸ºmodalä¸­ä¼šåŠ¨æ€åˆ›å»ºï¼‰
                const allCards = statsPage.querySelectorAll('.card');
                modalContent.innerHTML = '';
                
                // ä»ç¬¬äºŒä¸ªå¡ç‰‡å¼€å§‹å…‹éš†ï¼ˆè·³è¿‡ç¬¬ä¸€ä¸ªç»Ÿè®¡æ•°æ®å¡ç‰‡ï¼‰
                for (let i = 1; i < allCards.length; i++) {
                    const card = allCards[i];
                    // æ’é™¤ paySectionï¼ˆæ”¯ä»˜å¡ç‰‡åœ¨modalä¸­ä¼šåŠ¨æ€åˆ›å»ºï¼Œé¿å…é‡å¤ï¼‰
                    if (card.id === 'paySection') continue;
                    const clonedCard = card.cloneNode(true);
                    modalContent.appendChild(clonedCard);
                }
            }
        } catch (e) {
            console.error('showDebtModal error:', e);
        }
        
        modal.classList.add('show');
        
        // å…ˆè®¡ç®—èµ„é‡‘ï¼Œç¡®ä¿globalDebtæ˜¯æœ€æ–°çš„
        if (typeof calculateFunds === 'function') {
            calculateFunds();
        }
        
        // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²åˆ—è¡¨ï¼ˆç¡®ä¿äº‹ä»¶ç»‘å®šæ­£ç¡®ï¼‰
        if (typeof updateDebtModalHistoryList === 'function') {
            updateDebtModalHistoryList();
        }
    }

    function closeDebtModal() {
        const modal = document.getElementById('debtModal');
        if (modal) modal.classList.remove('show');
    }

    // åˆå§‹åŒ–æ‰“å¡è¡¨å•æ•°æ®
    function initCheckinModalForm() {
        const today = getLocalTodayStr();
        const dateInput = document.getElementById('checkinModalDateInput');
        if (dateInput) {
            dateInput.value = today;
            if (typeof checkCheckinModalDateChange === 'function') {
                checkCheckinModalDateChange();
            }
            
            // å°è¯•æ¢å¤è‰ç¨¿æ•°æ®
            const savedDraft = localStorage.getItem('habit_checkin_draft_v1');
            let draftRestored = false;
            
            if (savedDraft) {
                try {
                    const draft = JSON.parse(savedDraft);
                    // é€»è¾‘ä¿®æ”¹ï¼šå³ä½¿æ—¥æœŸä¸åŒ¹é…ï¼Œå¦‚æœç”¨æˆ·æ‰‹åŠ¨è®°å½•äº†è‰ç¨¿ï¼Œå¯èƒ½å¸Œæœ›æ¢å¤
                    // æˆ–è€…æˆ‘ä»¬åº”è¯¥åˆ¤æ–­ï¼Œå¦‚æœè‰ç¨¿æ—¥æœŸæ˜¯æ˜¨å¤©ï¼Œä¸”ä»Šå¤©æ˜¯ä»Šå¤©ï¼Œæ˜¯å¦åº”è¯¥æç¤ºï¼Ÿ
                    // ç®€å•èµ·è§ï¼Œå¦‚æœ draft å­˜åœ¨ï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥æ¢å¤ä¸€äº›å­—æ®µ
                    
                    // å¦‚æœè‰ç¨¿æ—¥æœŸå’Œå½“å‰é€‰æ‹©æ—¥æœŸä¸€è‡´ï¼Œå®Œå…¨æ¢å¤
                    if (draft.date === today) {
                        if (draft.sleep) document.getElementById('checkinModalSleepInput').value = draft.sleep;
                        if (draft.wake) document.getElementById('checkinModalWakeInput').value = draft.wake;
                        if (draft.study) document.getElementById('checkinModalStudyInput').value = draft.study;
                        if (draft.penalty) document.getElementById('checkinModalPenaltyAmount').value = draft.penalty;
                        if (draft.reason) document.getElementById('checkinModalPenaltyReason').value = draft.reason;
                        draftRestored = true;
                        console.log('å·²æ¢å¤ä»Šæ—¥æ‰“å¡è‰ç¨¿');
                    } else {
                        // å¦‚æœè‰ç¨¿æ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼ˆæ¯”å¦‚æ˜¯æ˜¨å¤©ï¼‰ï¼Œä½†ç”¨æˆ·å¯èƒ½åªæƒ³æ¢å¤å…¥ç¡æ—¶é—´
                        // åœºæ™¯ï¼šæ˜¨å¤©æ™šä¸Šå¡«äº†å…¥ç¡æ—¶é—´ï¼ˆå¯¹åº”æ˜¨å¤©ï¼‰ï¼Œä»Šå¤©æ—©ä¸Šæ‰“å¼€ï¼ˆæ—¥æœŸé»˜è®¤ä¸ºä»Šå¤©ï¼‰
                        // æ­¤æ—¶è‰ç¨¿é‡Œçš„ date æ˜¯æ˜¨å¤©ã€‚
                        // æˆ‘ä»¬åº”è¯¥æ£€æŸ¥ï¼Œå¦‚æœ draft.sleep å­˜åœ¨ï¼Œæ˜¯å¦è‡ªåŠ¨å¡«å……åˆ° sleepInputï¼Ÿ
                        // é€šå¸¸å…¥ç¡æ—¶é—´æ˜¯æ˜¨æ™šçš„ï¼Œæ‰€ä»¥å¦‚æœè‰ç¨¿é‡Œæœ‰ sleepï¼Œä¸”å½“å‰ sleepInput ä¸ºç©ºï¼Œå¯ä»¥å°è¯•å¡«å……
                        if (draft.sleep && !document.getElementById('checkinModalSleepInput').value) {
                            document.getElementById('checkinModalSleepInput').value = draft.sleep;
                            console.log('å·²ä»è¿‡å¾€è‰ç¨¿æ¢å¤å…¥ç¡æ—¶é—´');
                        }
                    }
                } catch(e) { console.error('è‰ç¨¿æ¢å¤å¤±è´¥', e); }
            }
            
            if (!draftRestored) {
                const studyInput = document.getElementById('checkinModalStudyInput');
                if (studyInput && !studyInput.value) { 
                    const yesterdayStr = getYesterdayStr();
                    const yesterdayStudyTime = getStudyTimeForDate(yesterdayStr);
                    if (yesterdayStudyTime > 0) {
                        studyInput.value = yesterdayStudyTime.toFixed(1);
                    }
                }
            }
            
            setTimeout(() => {
                if (typeof calculateCheckinModalPenalty === 'function') {
                    calculateCheckinModalPenalty();
                }
            }, 200);
        }
    }

    // æ‰‹åŠ¨åˆ‡æ¢æ‰“å¡/å¤ç›˜æ¨¡å¼
    function updateCheckinModalHeaderButtons(isReview) {
        const container = document.getElementById('checkinModalHeaderButtons');
        if (!container) return;
        
        if (isReview) {
            container.innerHTML = `
                <button class="btn-mini" style="background:var(--info); color:#fff;" onclick="toggleCheckinModalHistoryReview()">ğŸ“œ</button>
                <button id="checkinModalBtnSaveReview" class="btn-mini" style="background:var(--success); color:#fff;" onclick="saveCheckinModalDailyReview(true)">ğŸ’¾</button>
            `;
        } else {
            container.innerHTML = `
                <button class="btn-mini" style="background:var(--info); color:#fff;" onclick="toggleCheckinModalHistoryCheckin()">ğŸ“œ</button>
            `;
        }
    }

    function toggleCheckinMode() {
        const checkinArea = document.getElementById('checkinModalCheckinArea');
        const reviewArea = document.getElementById('checkinModalReviewArea');
        const modalTitle = document.getElementById('checkinModalTitle');

        if (checkinArea && reviewArea && modalTitle) {
            // é‡ç½®å†å²è§†å›¾çŠ¶æ€
            isCheckinModalHistoryCheckinOpen = false;
            isCheckinModalReviewHistoryOpen = false;
            
            // ç¡®ä¿å†å²åŒºåŸŸéšè—ï¼Œè¾“å…¥åŒºåŸŸæ˜¾ç¤º
            const historyCheckinArea = document.getElementById('checkinModalHistoryCheckinArea');
            if (historyCheckinArea) historyCheckinArea.style.display = 'none';
            // æ¢å¤æ‰“å¡å¡ç‰‡å­å…ƒç´ æ˜¾ç¤º (ç®€å•é‡ç½®ï¼Œä¾èµ–initCheckinModalFormå¯èƒ½ä¸å¤Ÿï¼Œå› ä¸ºtoggleCheckinModalHistoryCheckinä¿®æ”¹äº†display)
            // è¿™é‡Œé‡æ–°è·å–å¹¶æ¢å¤displayæ¯”è¾ƒå®‰å…¨
            const checkinCard = document.querySelector('#checkinModalCheckinArea .card');
            if (checkinCard) {
                Array.from(checkinCard.children).forEach(child => {
                    if (child.id !== 'checkinModalHistoryCheckinArea') child.style.display = '';
                });
            }

            const historyReviewArea = document.getElementById('checkinModalReviewHistoryArea');
            const reviewInputArea = document.getElementById('checkinModalReviewInputArea');
            if (historyReviewArea) historyReviewArea.style.display = 'none';
            if (reviewInputArea) reviewInputArea.style.display = 'block';

            if (checkinArea.style.display !== 'none') {
                // åˆ‡æ¢åˆ°å¤ç›˜
                checkinArea.style.display = 'none';
                reviewArea.style.display = 'block';
                modalTitle.innerText = 'ğŸ¤” å¤ç›˜';
                updateCheckinModalHeaderButtons(true);
                loadCheckinModalReview(getLocalTodayStr());
            } else {
                // åˆ‡æ¢åˆ°æ‰“å¡
                checkinArea.style.display = 'block';
                reviewArea.style.display = 'none';
                modalTitle.innerText = 'ğŸ“ æ‰“å¡';
                updateCheckinModalHeaderButtons(false);
                initCheckinModalForm();
            }
        }
    }

    // æ™¨é—´æ‰“å¡å¼¹å‡ºçª—å£å‡½æ•°
    function showCheckinModal() {
        const modal = document.getElementById('checkinModal');
        if (!modal) {
            console.error('checkinModal not found');
            return;
        }
        
        try {
            const today = getLocalTodayStr();
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡ (ä»…åŒ¹é…æ™¨é—´æ‰“å¡è®°å½•ï¼Œæ’é™¤æ™®é€šå¾…åŠ)
            const hasCheckin = historyData.some(r => r.date === today && r.details && (r.details.type === 'checkin' || r.details.sleep || r.details.wake));
            
            const checkinArea = document.getElementById('checkinModalCheckinArea');
            const reviewArea = document.getElementById('checkinModalReviewArea');
            const modalTitle = document.getElementById('checkinModalTitle');
            
            if (hasCheckin) {
                // å·²æ‰“å¡ï¼Œæ˜¾ç¤ºå¤ç›˜ç•Œé¢
                if (checkinArea) checkinArea.style.display = 'none';
                if (reviewArea) reviewArea.style.display = 'block';
                if (modalTitle) modalTitle.innerText = 'ğŸ¤” å¤ç›˜';
                updateCheckinModalHeaderButtons(true);
                
                // åŠ è½½å½“å¤©çš„å¤ç›˜å†…å®¹
                loadCheckinModalReview(today);
            } else {
                // æœªæ‰“å¡ï¼Œæ˜¾ç¤ºæ‰“å¡è¡¨å•
                if (checkinArea) checkinArea.style.display = 'block';
                if (reviewArea) reviewArea.style.display = 'none';
                if (modalTitle) modalTitle.innerText = 'ğŸ“ æ‰“å¡';
                updateCheckinModalHeaderButtons(false);
                
                initCheckinModalForm();
            }
        } catch (e) {
            console.error('showCheckinModal error:', e);
            // å‡ºé”™æ—¶é»˜è®¤æ˜¾ç¤ºæ‰“å¡è¡¨å•
            const checkinArea = document.getElementById('checkinModalCheckinArea');
            const reviewArea = document.getElementById('checkinModalReviewArea');
            if (checkinArea) checkinArea.style.display = 'block';
            if (reviewArea) reviewArea.style.display = 'none';
        }
        
        // æ˜¾ç¤ºmodal
        modal.classList.add('show');
    }

    function closeCheckinModal() {
        const modal = document.getElementById('checkinModal');
        if (modal) modal.classList.remove('show');
    }

    // åŠ è½½å¤ç›˜å†…å®¹åˆ°modal
    function loadCheckinModalReview(date) {
        try {
            const review = dailyReviews[date] || { great: '', improve: '', insight: '' };
            const greatInput = document.getElementById('checkinModalReviewGreat');
            const improveInput = document.getElementById('checkinModalReviewImprove');
            const insightInput = document.getElementById('checkinModalReviewInsight');
            
            if (greatInput) greatInput.value = review.great || '';
            if (improveInput) improveInput.value = review.improve || '';
            if (insightInput) {
                // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå‡†å¤‡è¾“å…¥æ–°æ¡ç›®
                insightInput.value = '';
                // æ¢å¤é»˜è®¤ placeholder
                insightInput.placeholder = 'æ¸…å•...';
            }
            
            // é‡ç½®é€‰ä¸­çš„æ ‡ç­¾
            const tagsContainer = document.getElementById('checkinModalReviewTags');
            if (tagsContainer) {
                // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                const chips = tagsContainer.querySelectorAll('.chip');
                chips.forEach(c => c.classList.remove('active'));
                delete tagsContainer.dataset.selectedTag;

                if (config.reviewTags && config.reviewTags.length > 0) {
                    tagsContainer.style.display = 'flex';
                    tagsContainer.innerHTML = config.reviewTags.map(tag => {
                        return `<div class="chip" onclick="setReviewTitle(this, '${tag}')">${tag}</div>`;
                    }).join('');
                } else {
                    tagsContainer.style.display = 'none';
                }
            }
            
            // æ¸²æŸ“ä»Šæ—¥å·²æ·»åŠ çš„æ¸…å•åˆ—è¡¨
            renderDailyReviewList(date);
            
            // å­˜å‚¨å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ—¥æœŸï¼Œä¾›æ·»åŠ æ¡ç›®ä½¿ç”¨
            if (tagsContainer) tagsContainer.dataset.currentDate = date;
            
        } catch (e) {
            console.error('loadCheckinModalReview error:', e);
        }
    }

    function setReviewTitle(el, tag) {
        // ä¸å†ä¿®æ”¹labelå†…å®¹ï¼Œåªå¤„ç†æ ·å¼é€‰ä¸­
        const tagsContainer = document.getElementById('checkinModalReviewTags');
        if (tagsContainer) {
            const chips = tagsContainer.querySelectorAll('.chip');
            chips.forEach(c => c.classList.remove('active'));
        }
        if (el) el.classList.add('active');
        // å°†é€‰ä¸­çš„tagæš‚å­˜åœ¨tagsContainerçš„datasetä¸­ï¼Œä»¥ä¾¿ä¿å­˜æ—¶è·å–
        if (tagsContainer) tagsContainer.dataset.selectedTag = tag;
        
        // æ›´æ–°è¾“å…¥æ¡†
        const insightInput = document.getElementById('checkinModalReviewInsight');
        if (insightInput) {
            insightInput.placeholder = tag + '...';
            // ä¸å†è‡ªåŠ¨å¡«å……æ ‡ç­¾å†…å®¹
        }
    }
    
    // æ·»åŠ å¤ç›˜æ¸…å•é¡¹
    function addReviewListItem() {
        const tagsContainer = document.getElementById('checkinModalReviewTags');
        const insightInput = document.getElementById('checkinModalReviewInsight');
        const currentDate = tagsContainer ? (tagsContainer.dataset.currentDate || getLocalTodayStr()) : getLocalTodayStr();
        
        if (!insightInput) return;
        
        const content = insightInput.value.trim();
        if (!content) return alert('è¯·è¾“å…¥æ¸…å•å†…å®¹');
        
        let title = '';
        if (tagsContainer) {
            if (tagsContainer.dataset.selectedTag) {
                title = tagsContainer.dataset.selectedTag;
            } else {
                const activeChip = tagsContainer.querySelector('.chip.active');
                if (activeChip) title = activeChip.innerText.trim();
            }
        }
        
        // åˆå§‹åŒ–æ•°æ®ç»“æ„
        if (!dailyReviews[currentDate]) dailyReviews[currentDate] = {};
        if (!dailyReviews[currentDate].list) dailyReviews[currentDate].list = [];
        
        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœ list ä¸ºç©ºä½†æœ‰ insight/titleï¼Œå…ˆè¿ç§»
        if (dailyReviews[currentDate].list.length === 0 && (dailyReviews[currentDate].insight || dailyReviews[currentDate].title)) {
            dailyReviews[currentDate].list.push({
                id: Date.now() - 1000, // ç¡®ä¿IDä¸åŒ
                title: dailyReviews[currentDate].title || '',
                content: dailyReviews[currentDate].insight || ''
            });
            // æ¸…ç©ºæ—§å­—æ®µï¼Œé¿å…é‡å¤æ˜¾ç¤º
            dailyReviews[currentDate].insight = '';
            dailyReviews[currentDate].title = '';
        }
        
        // æ·»åŠ æ–°æ¡ç›®
        dailyReviews[currentDate].list.push({
            id: Date.now(),
            title: title,
            content: content
        });
        
        // ä¿å­˜
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        triggerAutoSave();
        
        // åˆ·æ–°åˆ—è¡¨
        renderDailyReviewList(currentDate);
        
        // å¦‚æœå†å²åˆ—è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°å®ƒï¼Œä»¥ä¾¿çœ‹åˆ°æœ€æ–°çš„åˆ—è¡¨é¡¹
        if (typeof isCheckinModalReviewHistoryOpen !== 'undefined' && isCheckinModalReviewHistoryOpen) {
            renderCheckinModalHistoryReviews();
        }

        // æ¸…ç©ºè¾“å…¥æ¡†å’Œæ ‡ç­¾é€‰ä¸­çŠ¶æ€
        insightInput.value = '';
        insightInput.placeholder = 'æ¸…å•...';
        if (tagsContainer) {
            const chips = tagsContainer.querySelectorAll('.chip');
            chips.forEach(c => c.classList.remove('active'));
            delete tagsContainer.dataset.selectedTag;
        }
    }
    
    // æ¸²æŸ“ä»Šæ—¥æ¸…å•åˆ—è¡¨ï¼ˆåœ¨è¾“å…¥åŒºåŸŸä¸‹æ–¹ï¼‰
    function renderDailyReviewList(date) {
        const listContainer = document.getElementById('checkinModalDailyList');
        if (!listContainer) return;
        
        const review = dailyReviews[date] || {};
        let listItems = review.list || [];
        
        // å…¼å®¹æ˜¾ç¤ºï¼šå¦‚æœ list ä¸ºç©ºä½†æœ‰ insight/titleï¼Œæ˜¾ç¤ºå®ƒï¼ˆä½†ä¸ç‰©ç†è¿ç§»ï¼Œç›´åˆ°ç”¨æˆ·æ·»åŠ æ–°æ¡ç›®ï¼‰
        if (listItems.length === 0 && (review.insight || review.title)) {
            listItems = [{ id: 'legacy', title: review.title, content: review.insight }];
        }
        
        if (listItems.length === 0) {
            listContainer.innerHTML = '';
            return;
        }
        
        listContainer.innerHTML = listItems.map((item, index) => {
            const tagHtml = item.title ? `<span style="font-size:11px; padding:2px 6px; background:var(--primary-bg); color:var(--primary); border-radius:4px; margin-right:6px; flex-shrink:0;">${item.title}</span>` : '';
            
            // æ“ä½œæŒ‰é’®
            let actionBtns = '';
            
            if (item.id === 'legacy') {
                // Legacy item: Only edit allowed (to convert it)
                actionBtns = `<div class="btn-mini" style="padding:2px 6px; font-size:10px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-main); width:auto; margin-left:8px; cursor:pointer;" onclick="editReviewListItem('${date}', 'legacy')">âœï¸</div>`;
            } else {
                // Normal item: Edit and Delete
                actionBtns = `
                    <div style="display:flex; gap:4px;">
                        <div class="btn-mini" style="padding:2px 6px; font-size:10px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-main); width:auto; margin-left:8px; cursor:pointer;" onclick="editReviewListItem('${date}', ${index})">âœï¸</div>
                        <div class="btn-mini" style="padding:2px 6px; font-size:10px; background:var(--bg-card); border:1px solid var(--danger); color:var(--danger); width:auto; margin-left:0; cursor:pointer;" onclick="deleteReviewListItem('${date}', ${index})">âœ•</div>
                    </div>
                `;
            }
            
            return `
                <div style="padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="font-size:13px; color:var(--text-main); line-height:1.4; flex:1;">
                        ${tagHtml}
                        <span>${item.content.replace(/\n/g, '<br>')}</span>
                    </div>
                    ${actionBtns}
                </div>
            `;
        }).join('');
    }
    
    // ç¼–è¾‘æ¸…å•é¡¹
    function editReviewListItem(date, index) {
        // å…³é—­å†å²å¼¹çª—
        closeHistoryReviewModal();
        
        // ç¡®ä¿åˆ‡æ¢åˆ°å¤ç›˜è§†å›¾
        const checkinArea = document.getElementById('checkinModalCheckinArea');
        const reviewArea = document.getElementById('checkinModalReviewArea');
        const modalTitle = document.getElementById('checkinModalTitle');
        
        if (checkinArea) checkinArea.style.display = 'none';
        if (reviewArea) reviewArea.style.display = 'block';
        if (modalTitle) modalTitle.innerText = 'å¤ç›˜';
        updateCheckinModalHeaderButtons(true);
        
        // ç¡®ä¿è¾“å…¥åŒºåŸŸå¯è§
        const inputArea = document.getElementById('checkinModalReviewInputArea');
        const saveBtn = document.getElementById('checkinModalBtnSaveReview');
        if (inputArea) inputArea.style.display = 'block';
        if (saveBtn) saveBtn.style.display = 'inline-block';

        // è®¾ç½®å½“å‰ç¼–è¾‘çš„æ—¥æœŸ
        const tagsContainer = document.getElementById('checkinModalReviewTags');
        if (tagsContainer) tagsContainer.dataset.currentDate = date;

        // åŠ è½½è¯¥æ—¥æœŸçš„å…¶ä»–æ•°æ®ï¼ˆGreat/Improveï¼‰
        const review = dailyReviews[date];
        if (review) {
            const great = document.getElementById('checkinModalReviewGreat');
            const improve = document.getElementById('checkinModalReviewImprove');
            if (great) great.value = review.great || '';
            if (improve) improve.value = review.improve || '';
        }
        
        // æ¸²æŸ“è¯¥æ—¥æœŸçš„æ¸…å•åˆ—è¡¨
        renderDailyReviewList(date);
        
        // Check if textarea is not empty
        const insightInput = document.getElementById('checkinModalReviewInsight');
        if (insightInput && insightInput.value.trim()) {
            if (!confirm('è¾“å…¥æ¡†ä¸­æœ‰æœªä¿å­˜çš„å†…å®¹ï¼Œç¼–è¾‘æ­¤æ¡ç›®å°†è¦†ç›–å®ƒã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
        }

        // Special handling for legacy
        if (index === 'legacy') {
             if (!review || (!review.title && !review.insight)) return;
             
             const item = { title: review.title, content: review.insight };
             
             // Clear legacy fields
             review.title = '';
             review.insight = '';
             
             // Update UI
             loadItemToInput(item);
             
             // Save change (item removed from legacy)
             localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
             triggerAutoSave();
             renderDailyReviewList(date); 
             renderCheckinModalHistoryReviews(); // Refresh history list
             return;
        }

        if (!review || !review.list || !review.list[index]) return;
        
        const item = review.list[index];
        // Remove from list
        review.list.splice(index, 1);
        
        // Update UI
        loadItemToInput(item);
        
        // Save change (item removed from list)
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        triggerAutoSave();
        renderDailyReviewList(date); 
        renderCheckinModalHistoryReviews(); // Refresh history list
    }

    function loadItemToInput(item) {
        const insightInput = document.getElementById('checkinModalReviewInsight');
        const tagsContainer = document.getElementById('checkinModalReviewTags');
        
        if (insightInput) {
            insightInput.value = item.content || '';
            insightInput.focus();
        }
        
        if (tagsContainer) {
            // Clear current selection
            const chips = tagsContainer.querySelectorAll('.chip');
            chips.forEach(c => c.classList.remove('active'));
            delete tagsContainer.dataset.selectedTag;
            
            if (item.title) {
                 const chip = Array.from(chips).find(c => c.innerText.trim() === item.title);
                 if (chip) {
                     chip.classList.add('active');
                     tagsContainer.dataset.selectedTag = item.title;
                 } else {
                     // If tag not in list, just set dataset
                     tagsContainer.dataset.selectedTag = item.title;
                 }
                 // Update placeholder
                 if (insightInput) insightInput.placeholder = item.title + '...';
            } else {
                 if (insightInput) insightInput.placeholder = 'æ¸…å•...';
            }
        }
    }
    
    // åˆ é™¤æ¸…å•é¡¹
    function deleteReviewListItem(date, index) {
        if (!dailyReviews[date] || !dailyReviews[date].list) return;
        
        if (confirm('ç¡®å®šåˆ é™¤æ­¤æ¡ç›®å—ï¼Ÿ')) {
            dailyReviews[date].list.splice(index, 1);
            localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
            triggerAutoSave();
            renderDailyReviewList(date); 
            renderCheckinModalHistoryReviews(); // Refresh history list
        }
    }

    // ä¿å­˜modalä¸­çš„å¤ç›˜
    function saveCheckinModalDailyReview(showMsg = false) {
        try {
            const tagsContainer = document.getElementById('checkinModalReviewTags');
            // è·å–å½“å‰æ“ä½œçš„æ—¥æœŸï¼Œé»˜è®¤ä¸ºä»Šå¤©
            const date = tagsContainer ? (tagsContainer.dataset.currentDate || getLocalTodayStr()) : getLocalTodayStr();
            
            const great = document.getElementById('checkinModalReviewGreat').value.trim();
            const improve = document.getElementById('checkinModalReviewImprove').value.trim();
            // insight è¾“å…¥æ¡†çš„å†…å®¹å¦‚æœæœªæ·»åŠ ï¼Œå¯ä»¥é€‰æ‹©ä¿å­˜ä¸ºè‰ç¨¿æˆ–è€…å¿½ç•¥
            // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ï¼šå¦‚æœè¾“å…¥æ¡†æœ‰å†…å®¹ï¼Œä¸”æœªç‚¹å‡»æ·»åŠ ï¼Œè‡ªåŠ¨æ·»åŠ ï¼ˆé˜²æ­¢ä¸¢å¤±ï¼‰
            const insightInput = document.getElementById('checkinModalReviewInsight');
            if (insightInput && insightInput.value.trim()) {
                addReviewListItem(); // è¿™ä¼šä¿å­˜ list
            }
            
            if (!dailyReviews[date]) dailyReviews[date] = {};
            dailyReviews[date].great = great;
            dailyReviews[date].improve = improve;
            
            // list å·²ç»åœ¨ addReviewListItem ä¸­ä¿å­˜äº†ï¼Œæˆ–è€…é€šè¿‡ä¸Šé¢çš„è‡ªåŠ¨æ·»åŠ ä¿å­˜äº†
            // å¦‚æœæ—¢æ²¡æœ‰ list ä¹Ÿæ²¡æœ‰ insightï¼ŒdailyReviews[date] ä¾ç„¶æœ‰æ•ˆ
            
            localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
            triggerAutoSave();
            
            if(showMsg) alert(`âœ… å¤ç›˜å·²ä¿å­˜`);
            
            // åˆ·æ–°å†å²åˆ—è¡¨ï¼ˆå¦‚æœæ‰“å¼€çš„è¯ï¼‰
            if (isCheckinModalReviewHistoryOpen) {
                renderCheckinModalHistoryReviews();
            }
        } catch (e) {
            console.error('saveCheckinModalDailyReview error:', e);
        }
    }

    // åˆ‡æ¢modalä¸­çš„å†å²æ‰“å¡æ˜¾ç¤º
    let isCheckinModalHistoryCheckinOpen = false;
    function toggleCheckinModalHistoryCheckin() {
        const area = document.getElementById('checkinModalHistoryCheckinArea');
        // è¾“å…¥åŒºåŸŸåŒ…å«ï¼šcard-titleä¸‹çš„input-group, row(sleep/wake), study, penalty
        // ç®€å•å¤„ç†ï¼šå°† checkinModalCheckinArea ä¸‹é™¤äº† card-title å’Œ historyArea ä¹‹å¤–çš„å…ƒç´ éšè—/æ˜¾ç¤º
        // æˆ–è€…æ›´ç®€å•ï¼šç»™è¾“å…¥éƒ¨åˆ†åŒ…ä¸€ä¸ª divã€‚ä½†ç°åœ¨çš„ HTML ç»“æ„æ¯”è¾ƒæ•£ã€‚
        // è§‚å¯Ÿç»“æ„ï¼šcheckinModalCheckinArea -> card -> [card-title, input-group, row, input-group, penaltyArea, historyArea]
        // æˆ‘ä»¬éœ€è¦éšè—çš„æ˜¯ card-title ä¹‹åçš„è¾“å…¥éƒ¨åˆ†ï¼Œç›´åˆ° historyArea ä¹‹å‰ã€‚
        
        const card = document.querySelector('#checkinModalCheckinArea .card');
        if (!card) return;
        
        // è·å–æ‰€æœ‰å­å…ƒç´ 
        const children = Array.from(card.children);
        const title = card.querySelector('.card-title');
        const historyArea = document.getElementById('checkinModalHistoryCheckinArea');
        
        isCheckinModalHistoryCheckinOpen = !isCheckinModalHistoryCheckinOpen;
        
        children.forEach(child => {
            if (child === title || child === historyArea) return;
            // éšè—/æ˜¾ç¤ºå…¶ä»–å…ƒç´ 
            child.style.display = isCheckinModalHistoryCheckinOpen ? 'none' : 'block'; // æ³¨æ„ï¼šrowæ˜¯flexå¸ƒå±€ï¼Œç›´æ¥è®¾blockå¯èƒ½ç ´åæ ·å¼ã€‚
            // æ›´å¥½çš„æ–¹å¼ï¼šå¦‚æœåŸæ¥æ˜¯flexï¼Œè¦æ¢å¤flexã€‚ä½†rowç±»å®šä¹‰äº†display:flexå—ï¼Ÿ
            // çœ‹å‰é¢ä»£ç ï¼š<div class="row">...</div> usually implies flex in frameworks, but here let's check.
            // åœ¨ index.html å¤´éƒ¨å¯èƒ½æœ‰ .row { display: flex; gap: 10px; }
            // ç®€å•èµ·è§ï¼Œå¦‚æœ child åŒ…å« row classï¼Œæ¢å¤æ—¶è®¾ä¸º flexï¼Œå¦åˆ™ blockã€‚
            if (!isCheckinModalHistoryCheckinOpen) {
                 if (child.classList.contains('row')) child.style.display = 'flex';
                 else if (child.id === 'checkinModalPenaltyReasonBox') {
                     // ç‰¹æ®Šå¤„ç†åŸå› æ¡†ï¼Œåªæœ‰å½“æœ‰æƒ©ç½šæ—¶æ‰æ˜¾ç¤ºï¼Ÿæˆ–è€…ä¿æŒåŸæ ·
                     // è¿™é‡Œçš„éšè—æ˜¯é’ˆå¯¹"åˆ‡æ¢åˆ°å†å²æ¨¡å¼"ï¼Œæ¢å¤æ—¶åº”è¯¥æ¢å¤åˆ°"è¾“å…¥æ¨¡å¼"ã€‚
                     // è¾“å…¥æ¨¡å¼ä¸‹ï¼ŒreasonBox æ˜¯æ ¹æ®é€»è¾‘æ˜¾ç¤ºçš„ã€‚
                     // ç®€å•ç²—æš´ï¼šæ¢å¤æ˜¾ç¤ºæ—¶ï¼Œå…¨éƒ¨è®¾ä¸º '' (remove inline display style)ï¼Œè®© CSS class æ§åˆ¶ï¼Ÿ
                     // ä½†æ˜¯ row æ˜¯ divï¼Œé»˜è®¤ blockï¼Œå¦‚æœæœ‰ css .row { display: flex } å°±å¯ä»¥ã€‚
                     child.style.display = ''; 
                     // å¯¹äº penaltyReasonBoxï¼Œå®ƒé»˜è®¤æ˜¯ noneã€‚å¦‚æœä»…ä»… remove inline styleï¼Œå®ƒä¼šå˜å› none (assuming it has style="display:none" initially or in css).
                     // åªè¦ checkCheckinModalPenaltyChange ä¼šè¢«è°ƒç”¨ï¼ŒçŠ¶æ€å°±ä¼šä¿®æ­£ã€‚
                 } else {
                     child.style.display = '';
                 }
            } else {
                child.style.display = 'none';
            }
        });
        
        if (isCheckinModalHistoryCheckinOpen) {
            if (historyArea) historyArea.style.display = 'block';
            renderCheckinModalHistoryCheckin();
        } else {
            if (historyArea) historyArea.style.display = 'none';
            // æ¢å¤æ—¶ï¼Œé‡æ–°è®¡ç®—ä¸€ä¸‹ç•Œé¢çŠ¶æ€ï¼ˆå¦‚æƒ©ç½šæ¡†æ˜¯å¦æ˜¾ç¤ºï¼‰
            checkCheckinModalPenaltyChange();
        }
    }

    // æ¸²æŸ“modalä¸­çš„å†å²æ‰“å¡åˆ—è¡¨
    function renderCheckinModalHistoryCheckin() {
        const list = document.getElementById('checkinModalHistoryCheckinList');
        if (!list) return;
        
        let data = [];
        // ä½¿ç”¨å…¨å±€ historyData å˜é‡
        if (typeof historyData !== 'undefined' && Array.isArray(historyData)) {
            // ç­›é€‰å‡ºæ™¨é—´æ‰“å¡è®°å½• (é€šå¸¸åŒ…å« sleep æˆ– wake ä¿¡æ¯ï¼Œæˆ–è€… type='checkin')
            data = historyData.filter(r => r.details && (r.details.type === 'checkin' || r.details.sleep || r.details.wake));
        } else {
            // å°è¯•è¯»å– localStorage ä½œä¸ºåå¤‡
            try {
                const stored = localStorage.getItem('habit_history_v1'); // æ³¨æ„ç‰ˆæœ¬å·å¯èƒ½ä¸åŒï¼Œä½†é€šå¸¸ç”¨ historyData
                if (stored) {
                    const parsed = JSON.parse(stored);
                    data = parsed.filter(r => r.details && (r.details.type === 'checkin' || r.details.sleep || r.details.wake));
                }
            } catch(e) {}
        }
        
        // æŒ‰æ—¥æœŸå€’åº
        data.sort((a, b) => b.date.localeCompare(a.date));
        
        if (data.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">æš‚æ— æ‰“å¡è®°å½•</div>';
            return;
        }

        list.innerHTML = data.map(item => {
            // itemç»“æ„: { date: "...", details: { sleep: "...", wake: "...", study: "..." } }
            const d = item.details || {};
            const studyTime = parseFloat(d.study || 0).toFixed(1);
            const wakeTime = d.wake || '--:--';
            const sleepTime = d.sleep || '--:--';
            
            return `
                <div class="history-item" style="padding:10px 0; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center;" onclick="loadCheckinModalCheckin('${item.date}'); toggleCheckinModalHistoryCheckin();">
                    <div style="font-weight:600; color:var(--text-main); font-size:14px;">${item.date.slice(5)}</div>
                    <div style="display:flex; gap:12px; font-size:12px; color:var(--text-sub);">
                        <span>ğŸŒ… ${wakeTime}</span>
                        <span>ğŸ›Œ ${sleepTime}</span>
                        <span style="color:var(--primary); font-weight:600;">â±ï¸ ${studyTime}h</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // åŠ è½½å†å²æ‰“å¡æ•°æ®åˆ°è¡¨å• (ç”¨äºæŸ¥çœ‹æˆ–ä¿®æ”¹)
    function loadCheckinModalCheckin(date) {
        // æ‰¾åˆ°å¯¹åº”çš„æ•°æ®
        let item = null;
        if (typeof historyData !== 'undefined' && Array.isArray(historyData)) {
             item = historyData.find(r => r.date === date && r.details && (r.details.type === 'checkin' || r.details.sleep || r.details.wake));
        }
        
        if (!item) return;
        const d = item.details || {};
        
        // å¡«å……è¡¨å•
        const dateInput = document.getElementById('checkinModalDateInput');
        const sleepInput = document.getElementById('checkinModalSleepInput');
        const wakeInput = document.getElementById('checkinModalWakeInput');
        const studyInput = document.getElementById('checkinModalStudyInput');
        const penaltyAmount = document.getElementById('checkinModalPenaltyAmount');
        const penaltyReason = document.getElementById('checkinModalPenaltyReason');
        
        if (dateInput) dateInput.value = item.date;
        if (sleepInput) sleepInput.value = d.sleep || '';
        if (wakeInput) wakeInput.value = d.wake || '';
        if (studyInput) studyInput.value = d.study || '';
        
        // æ¢å¤é‡‘é¢å’ŒåŸå› ï¼ˆå¦‚æœæœ‰ï¼‰
        // æ³¨æ„ï¼šhistoryData ä¸­çš„ fund æ˜¯æ­£æ•°è¡¨ç¤ºæ”¶å…¥ï¼Œè´Ÿæ•°è¡¨ç¤ºæ”¯å‡ºï¼ˆæƒ©ç½šï¼‰
        // è¿™é‡Œ item.fund æ˜¯æ€»é‡‘é¢å˜åŠ¨ã€‚æ™¨é—´æ‰“å¡å¯èƒ½æœ‰å¥–åŠ±ä¹Ÿå¯èƒ½æœ‰æƒ©ç½šã€‚
        // å¦‚æœæ˜¯æƒ©ç½šï¼Œfund ä¸ºè´Ÿæ•°ã€‚
        // checkinModalPenaltyAmount æ˜¾ç¤ºçš„æ˜¯"é‡‘é¢(å…ƒ)"ï¼Œé€šå¸¸è¾“å…¥æ­£æ•°è¡¨ç¤ºæ‰£æ¬¾ï¼Ÿ
        // çœ‹ UI é€»è¾‘ï¼š<label>é‡‘é¢ (å…ƒ)</label> placeholder="0"
        // ä¹‹å‰é€»è¾‘ calculateCheckinModalPenalty ä¼šè®¾ç½® value ä¸ºè´Ÿæ•° (ä¾‹å¦‚ -3.00)
        // æ‰€ä»¥è¿™é‡Œåº”è¯¥ç›´æ¥å›å¡« item.fund
        
        if (penaltyAmount) penaltyAmount.value = item.fund !== undefined ? item.fund : '';
        // åŸå› å¯èƒ½åœ¨ details.reason æˆ–è€… item.title? 
        // é€šå¸¸ reason å­˜åœ¨ details ä¸­å—ï¼Ÿ saveRecord æ—¶ details: { ... }
        // æ£€æŸ¥ submitForm é€»è¾‘ï¼Œreason å¯èƒ½è¢«å­˜å…¥ details.reason æˆ– details.fundReason
        // å‡è®¾å­˜åœ¨ details.reason
        if (penaltyReason) penaltyReason.value = d.reason || '';
        
        // è§¦å‘å˜æ›´è®¡ç®—
        checkCheckinModalDateChange(); 
        // calculateCheckinModalPenalty(); // åŠ è½½å†å²æ—¶ä¸åº”è¯¥é‡æ–°è®¡ç®—æƒ©ç½šï¼Œåº”è¯¥ä¿ç•™å†å²è®°å½•çš„å€¼
        // ä½†æ˜¯å¦‚æœç”¨æˆ·ä¿®æ”¹äº†æ—¶é—´ï¼Œéœ€è¦é‡æ–°è®¡ç®—å—ï¼Ÿ
        // ç”¨æˆ·æ„å›¾å¯èƒ½æ˜¯æŸ¥çœ‹ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¿®æ”¹ã€‚
        // å¦‚æœåªæ˜¯æŸ¥çœ‹ï¼Œä¸åº”è‡ªåŠ¨æ”¹å˜é‡‘é¢ã€‚
        // å¦‚æœç”¨æˆ·ä¿®æ”¹äº†æ—¶é—´ï¼Œonchange äº‹ä»¶ä¼šè§¦å‘ calculateCheckinModalPenaltyã€‚
        // æ‰€ä»¥è¿™é‡Œä¸ä¸»åŠ¨è°ƒç”¨ calculateï¼Œé™¤éä¸ºäº†æ›´æ–° UI çŠ¶æ€ï¼ˆå¦‚æ˜¾ç¤ºåŸå› æ¡†ï¼‰
        
        checkCheckinModalPenaltyChange(); // è¿™ä¼šæ ¹æ®é‡‘é¢æ˜¾ç¤º/éšè—åŸå› æ¡†
    }

    // åˆ‡æ¢modalä¸­çš„å†å²å¤ç›˜æ˜¾ç¤º
    let isCheckinModalReviewHistoryOpen = false; 
    
    function showHistoryReviewModal() {
        const modal = document.getElementById('historyReviewModal');
        if (modal) {
            modal.classList.add('show');
            isCheckinModalReviewHistoryOpen = true;
            renderCheckinModalHistoryReviews();
        }
    }
    
    function closeHistoryReviewModal() {
        const modal = document.getElementById('historyReviewModal');
        if (modal) {
            modal.classList.remove('show');
            isCheckinModalReviewHistoryOpen = false;
        }
    }

    function toggleCheckinModalHistoryReview(targetDate) {
        // å¦‚æœæä¾›äº† targetDateï¼Œè¯´æ˜æ˜¯ç‚¹å‡»äº†ç¼–è¾‘æŒ‰é’®
        if (targetDate) {
            closeHistoryReviewModal();
            
            const inputArea = document.getElementById('checkinModalReviewInputArea');
            const saveBtn = document.getElementById('checkinModalBtnSaveReview');
            
            // ç¡®ä¿è¾“å…¥åŒºåŸŸå¯è§
            if (inputArea) inputArea.style.display = 'block';
            if (saveBtn) saveBtn.style.display = 'inline-block';
            
            // åŠ è½½æŒ‡å®šæ—¥æœŸçš„å†…å®¹
            loadCheckinModalReview(targetDate);
            return;
        }
        
        // æ‰“å¼€å†å²modal
        showHistoryReviewModal();
    }

    // åˆ é™¤å¤ç›˜è®°å½•
    function deleteReview(date) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤ ' + date + ' çš„å¤ç›˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
        
        try {
            if (dailyReviews[date]) {
                delete dailyReviews[date];
                localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
                triggerAutoSave();
                renderCheckinModalHistoryReviews();
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸï¼ˆè™½ç„¶ç°åœ¨æ˜¯åœ¨å†å²åˆ—è¡¨é‡Œæ“ä½œï¼‰ï¼Œä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºæ˜¯åœ¨åˆ—è¡¨é‡Œã€‚
            }
        } catch (e) {
            console.error('deleteReview error:', e);
            alert('åˆ é™¤å¤±è´¥');
        }
    }

    // æ¸²æŸ“modalä¸­çš„å†å²å¤ç›˜åˆ—è¡¨
    function renderCheckinModalHistoryReviews() {
        // ä¼˜å…ˆä½¿ç”¨æ–°modalä¸­çš„åˆ—è¡¨å®¹å™¨
        let list = document.getElementById('historyReviewModalList');
        // å¦‚æœæ–°å®¹å™¨ä¸å­˜åœ¨ï¼Œå›é€€åˆ°æ—§å®¹å™¨ï¼ˆå…¼å®¹æ€§ï¼‰
        if (!list) list = document.getElementById('checkinModalReviewHistoryList');
        if (!list) return;
        
        // å°è¯•ä»æ–°modalä¸­è·å–ç­›é€‰æ§ä»¶ (ä½¿ç”¨æ–°çš„å”¯ä¸€ID)
        let filterSelect = document.getElementById('historyReviewModalFilter');
        let searchInput = document.getElementById('historyReviewModalSearch');
        
        // å…¼å®¹æ—§æ¨¡å¼ï¼ˆå¦‚æœæ–°modalæœªæ‰“å¼€æˆ–ä¸å­˜åœ¨ï¼‰
        if (!filterSelect) filterSelect = document.getElementById('reviewHistoryFilterSelect');
        if (!searchInput) searchInput = document.getElementById('reviewHistorySearchInput');
        
        // è·å–å½“å‰å€¼
        const currentFilter = filterSelect ? filterSelect.value : '';
        const currentSearch = searchInput ? searchInput.value.trim() : '';
        
        const sortedDates = Object.keys(dailyReviews).sort((a,b) => b.localeCompare(a));
        const allTitles = (config.reviewTags || []).filter(t => t);
        
        // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹ (ä»…å½“ select å­˜åœ¨ä¸”ä¸ºç©ºæ—¶æ‰å¡«å……ï¼Œé¿å…é¢‘ç¹é‡ç»˜å¯¼è‡´é—ªçƒï¼Œæˆ–è€…æ¯æ¬¡éƒ½å¡«å……ä½†ä¿ç•™é€‰ä¸­å€¼)
        if (filterSelect && filterSelect.options.length <= 1) { // åªæœ‰é»˜è®¤é€‰é¡¹æ—¶å¡«å……
             // æ¸…ç©ºé™¤ç¬¬ä¸€é¡¹å¤–çš„é€‰é¡¹
             while (filterSelect.options.length > 1) {
                 filterSelect.remove(1);
             }
             allTitles.forEach(t => {
                 const opt = document.createElement('option');
                 opt.value = t;
                 opt.text = t;
                 if (t === currentFilter) opt.selected = true;
                 filterSelect.add(opt);
             });
        }
        
        // ç­›é€‰é€»è¾‘...
        const filteredDates = sortedDates.filter(date => {
            const r = dailyReviews[date];
            const hasLegacy = r.insight || r.title;
            const hasList = r.list && r.list.length > 0;
            const hasReview = r.great || r.improve;
            
            if (!r || (!hasReview && !hasLegacy && !hasList)) return false;
            
            if (currentFilter && r.title !== currentFilter) return false;
            
            if (currentSearch) {
                const listContent = (r.list || []).map(i => (i.title || '') + (i.content || '')).join(' ');
                const legacyContent = (r.insight || '') + (r.title || '');
                const content = (listContent || legacyContent) + (r.great || '') + (r.improve || '');
                if (!content.toLowerCase().includes(currentSearch.toLowerCase())) return false;
            }
            
            return true;
        });
        
        let html = '';
        
        // å¦‚æœä½¿ç”¨çš„æ˜¯æ—§å®¹å™¨ï¼ˆinlineæ¨¡å¼ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œæ¸²æŸ“ç­›é€‰å™¨
        // ä½†ç°åœ¨ä¸»è¦ä½¿ç”¨æ–°modalæ¨¡å¼ï¼Œä¸”æ–°modalæœ‰é™æ€å¤´éƒ¨ã€‚
        // å¦‚æœ list æ˜¯ checkinModalReviewHistoryList (æ—§)ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦æ¸²æŸ“å¤´éƒ¨ã€‚
        // ä¸ºäº†ç®€å•èµ·è§ï¼Œå¦‚æœæ˜¯åœ¨æ—§å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶æ¸²æŸ“å¤´éƒ¨ï¼ˆä½†è¿™ä¼šå¯¼è‡´ä¹‹å‰çš„ focus é—®é¢˜ï¼‰ã€‚
        // ä¸è¿‡ç”¨æˆ·ç°åœ¨ä½¿ç”¨çš„æ˜¯æ–° modalï¼Œæ‰€ä»¥ list åº”è¯¥æ˜¯ historyReviewModalListã€‚
        // åœ¨æ–° modal ä¸­ï¼Œå¤´éƒ¨æ˜¯é™æ€çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨ html ä¸­åŒ…å«å®ƒã€‚
        
        const isLegacyContainer = list.id === 'checkinModalReviewHistoryList';
        
        if (isLegacyContainer) {
            // æ—§æ¨¡å¼ï¼šæ¸²æŸ“å¤´éƒ¨ï¼ˆä¼šå¯¼è‡´ focus é—®é¢˜ï¼Œä½†ä½œä¸º fallbackï¼‰
            html += `
            <div style="padding:10px 12px; border-bottom:1px solid var(--border); background:var(--bg-card); position:sticky; top:0; z-index:5;">
                <div style="margin-bottom:8px;">
                    <select id="reviewHistoryFilterSelect" onchange="renderCheckinModalHistoryReviews()" style="width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main); outline:none;">
                        <option value="">å…¨éƒ¨æ¸…å•/æ ‡é¢˜</option>
                        ${allTitles.map(t => `<option value="${t}" ${t === currentFilter ? 'selected' : ''}>${t}</option>`).join('')}
                    </select>
                </div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="reviewHistorySearchInput" placeholder="æœç´¢å†…å®¹..." value="${currentSearch}" oninput="renderCheckinModalHistoryReviews()" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main);">
                    <button class="btn-mini" style="background:var(--primary); color:#fff; width:auto;" onclick="renderCheckinModalHistoryReviews()">ğŸ”</button>
                </div>
            </div>
            `;
        }
        
        // åˆ—è¡¨å†…å®¹ HTML
        if (filteredDates.length === 0) {
            html += '<div style="text-align:center; color:var(--text-sub); padding:20px;">æš‚æ— åŒ¹é…è®°å½•</div>';
        } else {
            html += filteredDates.map(date => {
                const r = dailyReviews[date];
                let fullContentParts = [];

                if (r.great) fullContentParts.push(`<b>åšå¾—å¥½çš„:</b><br>${r.great.replace(/\n/g, '<br>')}`);
                if (r.improve) fullContentParts.push(`<b>éœ€æ”¹è¿›çš„:</b><br>${r.improve.replace(/\n/g, '<br>')}`);

                let listItems = r.list || [];
                if (listItems.length === 0 && (r.insight || r.title)) {
                    listItems.push({ title: r.title, content: r.insight });
                }

                if (listItems.length > 0) {
                    listItems.forEach((item, index) => {
                         const tagHtml = item.title ? `<span style="font-size:11px; padding:2px 6px; background:var(--primary-bg); color:var(--primary); border-radius:4px; margin-right:4px; display:inline-block;">${item.title}</span>` : '';
                         
                         let actionBtns = '';
                         if (item.id === 'legacy') {
                             actionBtns = `<span class="btn-mini" style="padding:1px 5px; font-size:9px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-main); width:auto; margin-left:6px; cursor:pointer; display:inline-block;" onclick="event.stopPropagation(); editReviewListItem('${date}', 'legacy')">âœï¸</span>`;
                         } else {
                             actionBtns = `
                                 <span style="display:inline-flex; gap:4px; margin-left:6px;">
                                     <span class="btn-mini" style="padding:1px 5px; font-size:9px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-main); width:auto; cursor:pointer;" onclick="event.stopPropagation(); editReviewListItem('${date}', ${index})">âœï¸</span>
                                     <span class="btn-mini" style="padding:1px 5px; font-size:9px; background:var(--bg-card); border:1px solid var(--danger); color:var(--danger); width:auto; cursor:pointer;" onclick="event.stopPropagation(); deleteReviewListItem('${date}', ${index})">âœ•</span>
                                 </span>
                             `;
                         }
                         
                         fullContentParts.push(`<div style="display:flex; align-items:center; flex-wrap:wrap;">${tagHtml} <span style="flex:1;">${item.content ? item.content.replace(/\n/g, '<br>') : ''}</span> ${actionBtns}</div>`);
                    });
                }
                
                const fullContentHtml = fullContentParts.join('<div style="margin-top:8px; border-top:1px dashed var(--border); margin-bottom:8px;"></div>') || 'æ— å†…å®¹';
                
                let displayTitleHtml = '';
                let displayContent = 'æ— å†…å®¹';
                
                if (listItems.length > 0) {
                    const firstItem = listItems[0];
                    if (firstItem.title) {
                        displayTitleHtml = `<span style="font-size:11px; padding:2px 6px; background:var(--primary-bg); color:var(--primary); border-radius:4px; margin-right:6px; flex-shrink:0;">${firstItem.title}</span>`;
                    }
                    if (firstItem.content) {
                        displayContent = firstItem.content.split('\n')[0];
                        if (listItems.length > 1) displayContent += ` (+${listItems.length-1})`;
                    }
                } else if (r.great) {
                    displayTitleHtml = `<span style="font-size:11px; padding:2px 6px; background:var(--success-bg); color:var(--success); border-radius:4px; margin-right:6px; flex-shrink:0;">å¥½</span>`;
                    displayContent = r.great.split('\n')[0];
                } else if (r.improve) {
                    displayTitleHtml = `<span style="font-size:11px; padding:2px 6px; background:var(--warning-bg); color:var(--warning); border-radius:4px; margin-right:6px; flex-shrink:0;">æ”¹</span>`;
                    displayContent = r.improve.split('\n')[0];
                }

                // æ ¹æ®åˆ—è¡¨é¡¹æ•°é‡å†³å®šæ ‡é¢˜ç¼–è¾‘æŒ‰é’®çš„è¡Œä¸º
                let headerEditBtn = '';
                if (listItems.length === 1) {
                    // åªæœ‰ä¸€ä¸ªåˆ—è¡¨é¡¹ï¼šç‚¹å‡»ç›´æ¥ç¼–è¾‘è¯¥é¡¹
                    let isLegacy = false;
                    if (listItems[0].id === 'legacy') isLegacy = true;
                    const editArg = isLegacy ? "'legacy'" : 0;
                    headerEditBtn = `<div class="btn-mini" style="padding:2px 8px; font-size:11px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-main); width:auto;" onclick="event.stopPropagation(); editReviewListItem('${date}', ${editArg});">âœï¸</div>`;
                } else if (listItems.length > 1) {
                    // å¤šä¸ªåˆ—è¡¨é¡¹ï¼šéšè—çˆ¶æ ‡é¢˜ç¼–è¾‘æŒ‰é’®
                    headerEditBtn = ''; // æˆ–è€…ä½¿ç”¨ display:none
                } else {
                    // æ²¡æœ‰åˆ—è¡¨é¡¹ï¼ˆå¯èƒ½åªæœ‰Great/Improveï¼‰ï¼šä¿æŒé»˜è®¤è¡Œä¸ºï¼ˆç¼–è¾‘æ•´å¤©ï¼‰
                    headerEditBtn = `<div class="btn-mini" style="padding:2px 8px; font-size:11px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-main); width:auto;" onclick="event.stopPropagation(); toggleCheckinModalHistoryReview('${date}');">âœï¸</div>`;
                }

                return `
                    <div class="review-history-item" style="padding:12px; border-bottom:1px solid var(--border); display:flex; flex-direction:column; cursor:pointer;" onclick="this.classList.toggle('expanded');">
                        <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                            <div style="font-weight:bold; color:var(--text-main); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; margin-right:10px; display:flex; align-items:center;">
                                ${displayTitleHtml}
                                <span class="review-snippet" style="overflow:hidden; text-overflow:ellipsis;">${displayContent}</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="review-history-date" style="font-size:12px; color:var(--primary); white-space:nowrap;">${date.slice(5)}</div>
                                ${headerEditBtn}
                                <div class="btn-mini" style="padding:2px 8px; font-size:11px; background:var(--bg-card); border:1px solid var(--danger); color:var(--danger); width:auto;" onclick="event.stopPropagation(); deleteReview('${date}');">ğŸ—‘ï¸</div>
                            </div>
                        </div>
                        <div class="review-full-content" style="display:none; margin-top:8px; font-size:13px; color:var(--text-main); line-height:1.5; white-space: pre-wrap; word-break: break-word; background:var(--bg-main); padding:8px; border-radius:6px;">${fullContentHtml}</div>
                    </div>
                `;
            }).join('');
        }

        list.innerHTML = html;
        
        // æ¢å¤ç„¦ç‚¹ (ä»…é’ˆå¯¹æ—§å®¹å™¨)
        if (isLegacyContainer) {
            const newSelect = document.getElementById('reviewHistoryFilterSelect');
            const newInput = document.getElementById('reviewHistorySearchInput');
            
            if (newSelect && currentFilter) {
                 newSelect.value = currentFilter;
                 if (document.activeElement && document.activeElement.id === 'reviewHistoryFilterSelect') {
                     newSelect.focus();
                 }
            }
            
            if (newInput) {
                newInput.value = currentSearch;
                if (document.activeElement && document.activeElement.id === 'reviewHistorySearchInput') {
                    newInput.focus();
                    const len = currentSearch.length;
                    newInput.setSelectionRange(len, len);
                }
            }
        }
        
        // ç¡®ä¿æ ·å¼å­˜åœ¨
        if (!document.getElementById('reviewHistoryStyles')) {
            const style = document.createElement('style');
            style.id = 'reviewHistoryStyles';
            style.innerHTML = `
                .review-history-item.expanded .review-full-content { display: block !important; }
                .review-history-item.expanded .review-snippet { display: none !important; }
            `;
            document.head.appendChild(style);
        }
    }

    // è®¾ç½®å¼¹å‡ºçª—å£å‡½æ•°
    function showSettingsModal() {
        const modal = document.getElementById('settingsModal');
        if (!modal) {
            console.error('settingsModal not found');
            return;
        }
        
        try {
            // å…‹éš†è®¾ç½®é¡µé¢çš„å†…å®¹åˆ°modalä¸­
            const settingsPage = document.getElementById('page-settings');
            const modalContent = document.getElementById('settingsModalContent');
            
            if (settingsPage && modalContent) {
                // å…‹éš†æ•´ä¸ªè®¾ç½®é¡µé¢çš„å†…å®¹
                modalContent.innerHTML = settingsPage.innerHTML;
                
                // åœ¨modalä¸­ç›´æ¥åº”ç”¨è®¾ç½®å€¼
                const modalDoc = modalContent;
                
                // ç›®æ ‡è®¾ç½®
                const setWake = modalDoc.querySelector('#setWake');
                const setSleep = modalDoc.querySelector('#setSleep');
                const setWakeW = modalDoc.querySelector('#setWakeW');
                const setSleepW = modalDoc.querySelector('#setSleepW');
                const setStudy = modalDoc.querySelector('#setStudy');
                const setExpiredLimit = modalDoc.querySelector('#setExpiredLimit');
                const setTimerLimit = modalDoc.querySelector('#setTimerLimit');
                const setHistoryLimit = modalDoc.querySelector('#setHistoryLimit');
                if (setWake) setWake.value = config.wake || '';
                if (setSleep) setSleep.value = config.sleep || '';
                if (setWakeW) setWakeW.value = config.wakeW || '';
                if (setSleepW) setSleepW.value = config.sleepW || '';
                if (setStudy) setStudy.value = config.study || '';
                if (setExpiredLimit) setExpiredLimit.value = config.expiredLimit || 5;
                if (setTimerLimit) setTimerLimit.value = config.timerLimit || 5;
                if (setHistoryLimit) setHistoryLimit.value = config.historyLimit || 5;
                
                // å¥–æƒ©è®¾ç½®
                const rewardAmount = modalDoc.querySelector('#rewardAmount');
                const exchangeRate = modalDoc.querySelector('#exchangeRate');
                const wishToDebtRate = modalDoc.querySelector('#wishToDebtRate');
                
                if (rewardAmount) rewardAmount.value = config.reward || 5;
                if (exchangeRate) exchangeRate.value = config.exchangeRate || 5;
                if (wishToDebtRate) wishToDebtRate.value = config.wishToDebtRate || 2;
                
                // æƒ©ç½šé˜¶æ¢¯
                if (config.penalties) {
                    const pWakeS = modalDoc.querySelector('#pWakeS');
                    const pWakeL = modalDoc.querySelector('#pWakeL');
                    const pSleepS = modalDoc.querySelector('#pSleepS');
                    const pSleepL = modalDoc.querySelector('#pSleepL');
                    const pStudyS = modalDoc.querySelector('#pStudyS');
                    const pStudyL = modalDoc.querySelector('#pStudyL');
                    
                    if (pWakeS) pWakeS.value = config.penalties.wakeS || 0;
                    if (pWakeL) pWakeL.value = config.penalties.wakeL || 0;
                    if (pSleepS) pSleepS.value = config.penalties.sleepS || 0;
                    if (pSleepL) pSleepL.value = config.penalties.sleepL || 0;
                    if (pStudyS) pStudyS.value = config.penalties.studyS || 0;
                    if (pStudyL) pStudyL.value = config.penalties.studyL || 0;
                }
                
                // å‘¨æœ«è®¾ç½®
                const we = config.weekend || [0, 6];
                const btnWeek6 = modalDoc.querySelector('#btn_week_6');
                const btnWeek0 = modalDoc.querySelector('#btn_week_0');
                if (btnWeek6) btnWeek6.className = `week-btn ${we.includes(6)?'active':''}`;
                if (btnWeek0) btnWeek0.className = `week-btn ${we.includes(0)?'active':''}`;
                
                // æ‰‹åŠ¨è°ƒèŠ‚æ•°å€¼
                const adjTimeBank = modalDoc.querySelector('#adjTimeBank');
                const adjWallet = modalDoc.querySelector('#adjWallet');
                const adjDebt = modalDoc.querySelector('#adjDebt');
                if (adjTimeBank) adjTimeBank.value = Number(timeBank).toFixed(1);
                if (adjWallet) adjWallet.value = globalWallet;
                if (adjDebt) adjDebt.value = globalDebt;
                
                // GitHubé…ç½®
                const ghToken = modalDoc.querySelector('#ghToken');
                const ghRepo = modalDoc.querySelector('#ghRepo');
                if (ghToken) ghToken.value = ghConfig.token || '';
                if (ghRepo) ghRepo.value = ghConfig.repo || '';

                // Giteeé…ç½®
                const giteeToken = modalDoc.querySelector('#giteeToken');
                const giteeRepo = modalDoc.querySelector('#giteeRepo');
                if (giteeToken) giteeToken.value = giteeConfig.token || '';
                if (giteeRepo) giteeRepo.value = giteeConfig.repo || '';
                
                // åŒæ­¥ç­–ç•¥
                const syncProvider = modalDoc.querySelector('#syncProvider');
                if (syncProvider) syncProvider.value = config.syncProvider || 'both';
                 
                 // åœ¨modalä¸­æ‰‹åŠ¨æ¸²æŸ“å¿«æ·ä»»åŠ¡
                const setQuickTasksList = modalDoc.querySelector('#setQuickTasksList');
                if (setQuickTasksList) {
                    let tasks = (config.quickTasks || []).map((t, idx) => ({
                        name: t,
                        index: idx,
                        count: taskUsageCount[t] || 0
                    }));
                    tasks.sort((a, b) => b.count - a.count);
                    setQuickTasksList.innerHTML = tasks.map(t => {
                        return `<div class="chip chip-removable" onclick="removeQuickTask(${t.index})">${t.name}</div>`;
                    }).join('');
                }
                
                // åœ¨modalä¸­æ‰‹åŠ¨æ¸²æŸ“ç­–ç•¥è®¾ç½®
                ['wake','sleep','study'].forEach(type => {
                    const container = modalDoc.querySelector('#list_' + type);
                    if (!container) return;
                    container.innerHTML = (userStrategies[type]||[]).map((s, idx) => `
                        <div class="chip chip-removable" onclick="removeStrat('${type}', ${idx})">${s}</div>
                    `).join('');
                });
                
                // åœ¨modalä¸­æ‰‹åŠ¨æ¸²æŸ“å¾…åŠæ—¶é—´å¿«é€‰è®¾ç½®
                const todoTimeChipsSettingsList = modalDoc.querySelector('#todoTimeChipsSettingsList');
                if (todoTimeChipsSettingsList) {
                    const chips = config.todoTimeChips || [];
                    if (chips.length === 0) {
                        todoTimeChipsSettingsList.innerHTML = '';
                    } else {
                        todoTimeChipsSettingsList.innerHTML = chips.map((chip, idx) => {
                            const label = chip.type === 'offset' ? `${chip.label} (+${chip.hours}h)` : chip.label;
                            return `<div class="chip chip-removable" onclick="removeTodoTimeChip(${idx})">${label}</div>`;
                        }).join('');
                    }
                }
                
                // åœ¨modalä¸­æ‰‹åŠ¨åº”ç”¨ç•Œé¢è®¾ç½®
                const interfaceConfig = config.interface || { showTimer: true, showStats: true, showShop: true, showQuickStudy: true };
                
                const showTimerCheckbox = modalDoc.querySelector('#showTimer');
                const showStatsCheckbox = modalDoc.querySelector('#showStats');
                const showShopCheckbox = modalDoc.querySelector('#showShop');
                const showQuickStudyCheckbox = modalDoc.querySelector('#showQuickStudy');
                
                const labelTimer = modalDoc.querySelector('#label-showTimer');
                const labelStats = modalDoc.querySelector('#label-showStats');
                const labelShop = modalDoc.querySelector('#label-showShop');
                const labelQuickStudy = modalDoc.querySelector('#label-showQuickStudy');
                
                if (showTimerCheckbox) {
                    showTimerCheckbox.checked = interfaceConfig.showTimer !== false;
                    if (labelTimer) labelTimer.classList.toggle('checked', interfaceConfig.showTimer !== false);
                }
                if (showStatsCheckbox) {
                    showStatsCheckbox.checked = interfaceConfig.showStats !== false;
                    if (labelStats) labelStats.classList.toggle('checked', interfaceConfig.showStats !== false);
                }
                if (showShopCheckbox) {
                    showShopCheckbox.checked = interfaceConfig.showShop !== false;
                    if (labelShop) labelShop.classList.toggle('checked', interfaceConfig.showShop !== false);
                }
                if (showQuickStudyCheckbox) {
                    showQuickStudyCheckbox.checked = interfaceConfig.showQuickStudy !== false;
                    if (labelQuickStudy) labelQuickStudy.classList.toggle('checked', interfaceConfig.showQuickStudy !== false);
                }
            }
        } catch (e) {
            console.error('showSettingsModal error:', e);
        }
        
        // æ˜¾ç¤ºmodal
        modal.classList.add('show');
    }

    function closeSettingsModal() {
        const modal = document.getElementById('settingsModal');
        if (modal) modal.classList.remove('show');
    }

    // è®¡æ—¶é¡µé¢å¼¹å‡ºçª—å£å‡½æ•°
    function showTimerModal() {
        const modal = document.getElementById('timerModal');
        if (!modal) {
            console.error('timerModal not found');
            return;
        }
        
        const timerPage = document.getElementById('page-timer');
        const statsPage = document.getElementById('page-stats');
        const modalContent = document.getElementById('timerModalContent');
        
        if (modalContent) {
            // æ¸…ç©ºå†…å®¹
            modalContent.innerHTML = '';
            
            // 1. å…ˆæ·»åŠ ç»Ÿè®¡æ•°æ®å¡ç‰‡ï¼ˆä» page-stats å…‹éš†ï¼‰
            if (statsPage) {
                const statsCard = statsPage.querySelector('.card:first-child');
                if (statsCard) {
                    const clonedStatsCard = statsCard.cloneNode(true);
                    modalContent.appendChild(clonedStatsCard);
                }
            }
            
            // 2. ç„¶åæ·»åŠ å†å²è®°å½•å¡ç‰‡
            if (timerPage) {
                const historyList = timerPage.querySelector('#timerHistoryList');
                let historyCard = null;
                
                // æŸ¥æ‰¾åŒ…å«å†å²åˆ—è¡¨çš„å¡ç‰‡
                if (historyList) {
                    historyCard = historyList.closest('.card');
                }
                
                if (historyCard) {
                    // å…‹éš†å†å²å¡ç‰‡
                    const clonedCard = historyCard.cloneNode(true);
                    
                    // æ›´æ–°IDï¼Œé¿å…å†²çª
                    const clonedHistoryList = clonedCard.querySelector('#timerHistoryList');
                    if (clonedHistoryList) {
                        clonedHistoryList.id = 'timerHistoryListModal';
                    }
                    
                    modalContent.appendChild(clonedCard);
                    
                    // æ¸²æŸ“å†å²è®°å½•
                    const historyListModal = modalContent.querySelector('#timerHistoryListModal');
                    if (historyListModal) {
                        renderTimerHistoryForModal(historyListModal);
                    }
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°å†å²å¡ç‰‡ï¼Œåˆ›å»ºä¸€ä¸ª
                    const historyCardDiv = document.createElement('div');
                    historyCardDiv.className = 'card';
                    historyCardDiv.innerHTML = `
                        <div class="card-title">å†å²</div>
                        <div id="timerHistoryListModal"></div>
                    `;
                    modalContent.appendChild(historyCardDiv);
                    
                    const historyListModal = modalContent.querySelector('#timerHistoryListModal');
                    if (historyListModal) {
                        renderTimerHistoryForModal(historyListModal);
                    }
                }
            }
            
            // 3. æ¸²æŸ“ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (typeof renderStats === 'function') {
                renderStats();
            }
        }
        
        // æ˜¾ç¤ºmodal
        modal.classList.add('show');
    }
    
    function closeTimerModal() {
        const modal = document.getElementById('timerModal');
        if (modal) modal.classList.remove('show');
        
        // åŒæ­¥æ•°æ®å›ä¸»é¡µé¢
        syncTimerModalToMain();
    }
    
    function syncTimerModalToMain() {
        const modalContent = document.getElementById('timerModalContent');
        if (!modalContent) return;
        
        // åŒæ­¥ä»»åŠ¡åç§°
        const modalTaskName = modalContent.querySelector('#timerTaskNameModal');
        const mainTaskName = document.getElementById('timerTaskName');
        if (modalTaskName && mainTaskName) {
            mainTaskName.value = modalTaskName.value;
        }
        
        // åŒæ­¥èµ·å§‹æ—¶é—´
        const modalPlannedTime = modalContent.querySelector('#timerPlannedTimeModal');
        const mainPlannedTime = document.getElementById('timerPlannedTime');
        if (modalPlannedTime && mainPlannedTime) {
            mainPlannedTime.value = modalPlannedTime.value;
        }
        
        // åŒæ­¥ç»“æŸæ—¶é—´
        const modalPlannedEndTime = modalContent.querySelector('#timerPlannedEndTimeModal');
        const mainPlannedEndTime = document.getElementById('timerPlannedEndTime');
        if (modalPlannedEndTime && mainPlannedEndTime) {
            mainPlannedEndTime.value = modalPlannedEndTime.value;
        }
        
        // åŒæ­¥å¤‡æ³¨
        const modalNote = modalContent.querySelector('#timerNoteModal');
        const mainNote = document.getElementById('timerNote');
        if (modalNote && mainNote) {
            mainNote.value = modalNote.value;
        }
    }
    
    function updateTimerModalButtons() {
        const modalContent = document.getElementById('timerModalContent');
        if (!modalContent) return;
        
        const idleBtns = modalContent.querySelector('#timerIdleBtnsModal');
        const activeBtns = modalContent.querySelector('#timerActiveBtnsModal');
        const pauseBtn = modalContent.querySelector('#btnTimerPauseModal');
        
        if (timerRunning) {
            if (idleBtns) idleBtns.style.display = 'none';
            if (activeBtns) activeBtns.style.display = 'flex';
            if (pauseBtn) pauseBtn.innerText = timerPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
        } else {
            if (idleBtns) idleBtns.style.display = 'flex';
            if (activeBtns) activeBtns.style.display = 'none';
        }
    }
    
    function renderTimerHistoryForModal(container) {
        if (!container) return;
        
        if (timerRecords.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:20px;">æš‚æ— è®¡æ—¶è®°å½•</div>';
            return;
        }

        // æŒ‰æ—¶é—´å€’åºæ’åºï¼ˆè¿‘æœŸåœ¨å‰ï¼‰
        timerRecords.sort((a, b) => {
            if (a.date !== b.date) return b.date.localeCompare(a.date);
            return b.time.localeCompare(a.time);
        });

        const limit = timerFullView ? timerRecords.length : (config.timerLimit || 5);
        const displayedRecords = timerRecords.slice(0, limit);

        container.innerHTML = displayedRecords.map(r => {
            const startTime = r.startTime || calculateStartTime(r.time, r.duration);
            
            // å¦‚æœæ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œæ˜¾ç¤ºç¼–è¾‘è¡¨å•
            if (editingTimerRecordId === r.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">ä»»åŠ¡åç§°</label><input type="text" id="editHistoryName-${r.id}" value="${formatTaskName(r.name)}" style="font-weight:bold;"></div>
                    <div class="input-group"><label class="input-label">æ—¥æœŸ</label><input type="date" id="editHistoryDate-${r.id}" value="${r.date}"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">èµ·å§‹æ—¶é—´</label><input type="time" id="editHistoryStart-${r.id}" value="${startTime}"></div>
                        <div class="input-group"><label class="input-label">ç»“æŸæ—¶é—´</label><input type="time" id="editHistoryEnd-${r.id}" value="${r.time}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">å¤‡æ³¨</label><textarea id="editHistoryNote-${r.id}" style="min-height:60px;">${r.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryRecord(${r.id})">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelTimerRecordEdit(); renderTimerHistoryForModal(document.querySelector('#timerModalContent #timerHistoryListModal')); renderTimerHistory();">âœ• å–æ¶ˆ</button>
                    </div>
                </div>`;
            }
            
            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${formatTaskName(r.name)}</div>
                    <div style="font-size:12px; color:var(--primary);">${r.duration}h | ${r.date} ${startTime} - ${r.time}</div>
                    ${r.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px; background:var(--input-bg); padding:4px; border-radius:4px;">' + r.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:8px;">
                    <div class="btn-action" onclick="editTimerRecord(${r.id}); renderTimerHistoryForModal(document.querySelector('#timerModalContent #timerHistoryListModal'));">âœï¸</div>
                    <div class="btn-action btn-del" onclick="deleteTimerRecord(${r.id}); renderTimerHistoryForModal(document.querySelector('#timerModalContent #timerHistoryListModal')); renderTimerHistory();">âœ•</div>
                </div>
            </div>
        `;}).join('');

        // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
        if (!timerFullView && timerRecords.length > limit) {
            container.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleTimerFullView(); renderTimerHistoryForModal(document.querySelector('#timerModalContent #timerHistoryListModal')); renderTimerHistory();" title="å±•å¼€æ›´å¤š">
                    <span>å±•å¼€æ›´å¤š</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>`
            );
        } else if (timerFullView && timerRecords.length > (config.timerLimit || 5)) {
            container.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleTimerFullView(); renderTimerHistoryForModal(document.querySelector('#timerModalContent #timerHistoryListModal')); renderTimerHistory();" title="æ”¶èµ·">
                    <span>æ”¶èµ·</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </div>`
            );
        }
    }

    // ä¿å­˜æ‰“å¡è‰ç¨¿
    function saveCheckinDraft() {
        const modalDate = document.getElementById('checkinModalDateInput');
        const modalSleep = document.getElementById('checkinModalSleepInput');
        const modalWake = document.getElementById('checkinModalWakeInput');
        const modalStudy = document.getElementById('checkinModalStudyInput');
        const penaltyAmount = document.getElementById('checkinModalPenaltyAmount');
        const penaltyReason = document.getElementById('checkinModalPenaltyReason');

        if (!modalDate || !modalDate.value) return;

        const draft = {
            date: modalDate.value,
            sleep: modalSleep ? modalSleep.value : '',
            wake: modalWake ? modalWake.value : '',
            study: modalStudy ? modalStudy.value : '',
            penalty: penaltyAmount ? penaltyAmount.value : '',
            reason: penaltyReason ? penaltyReason.value : '',
            updatedAt: Date.now()
        };

        localStorage.setItem('habit_checkin_draft_v1', JSON.stringify(draft));
        
        // ä¸ºäº†æ”¯æŒå¤šç«¯åŒæ­¥ï¼Œå°†è‰ç¨¿ä¿å­˜åˆ° config ä¸­
        if (config) {
            config.checkinDraft = draft;
            localStorage.setItem('habit_config_v7', JSON.stringify(config));
            // æ³¨æ„ï¼šè¿™é‡Œä¸ç›´æ¥è°ƒç”¨ triggerAutoSave ä»¥é¿å…è¿‡äºé¢‘ç¹çš„ç½‘ç»œè¯·æ±‚ï¼Œ
            // è€Œæ˜¯ä¾èµ–å®šæ—¶åŒæ­¥æˆ–ç”¨æˆ·æ‰‹åŠ¨åŒæ­¥ï¼Œæˆ–è€…åœ¨è¾“å…¥åœæ­¢åçš„é˜²æŠ–é€»è¾‘ä¸­åŒæ­¥ã€‚
            // ä½†ä¸ºäº†ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ° config ä¸­ä¹Ÿå­˜äº†ä¸€ä»½ã€‚
        }
    }

    function checkCheckinModalDateChange() {
        try {
            const dateInput = document.getElementById('checkinModalDateInput');
            if (!dateInput) return;
            
            const dateStr = dateInput.value;
            if (typeof checkWeekend === 'function') {
                checkWeekend();
            }
            if (typeof updateCheckinModalTargets === 'function') {
                updateCheckinModalTargets();
            }
            if (typeof renderCheckinModalStrategies === 'function') {
                renderCheckinModalStrategies();
            }
        } catch (e) {
            console.warn('checkCheckinModalDateChange error:', e);
        }
    }

    function quickSetCheckinModalDate(type) {
        const input = document.getElementById('checkinModalDateInput');
        if (type === 'today') {
            input.value = getLocalTodayStr();
        } else if (type === 'yesterday') {
            const yest = new Date();
            yest.setDate(yest.getDate() - 1);
            input.value = yest.toISOString().split('T')[0];
        }
        checkCheckinModalDateChange();
    }

    function updateCheckinModalTargets() {
        try {
            const dateInput = document.getElementById('checkinModalDateInput');
            if (!dateInput) return;
            
            const dateStr = dateInput.value;
            const isWeekend = checkWeekendForDate(dateStr);
            const wakeTarget = isWeekend ? (config.wakeW || '10:00') : (config.wake || '08:30');
            const sleepTarget = isWeekend ? (config.sleepW || '02:00') : (config.sleep || '01:00');
            
            const wakeTargetEl = document.getElementById('checkinModalTargetWake');
            const sleepTargetEl = document.getElementById('checkinModalTargetSleep');
            if (wakeTargetEl) wakeTargetEl.innerText = wakeTarget;
            if (sleepTargetEl) sleepTargetEl.innerText = sleepTarget;
            
            // æ›´æ–°å‘¨æœ«æ ‡è¯†
            const badge = document.getElementById('checkinModalDayTypeBadge');
            if (badge) {
                if (isWeekend) {
                    badge.style.display = 'inline';
                    badge.innerText = 'å‘¨æœ«';
                } else {
                    badge.style.display = 'none';
                }
            }
        } catch (e) {
            console.warn('updateCheckinModalTargets error:', e);
        }
    }

    function checkWeekendForDate(dateStr) {
        const date = new Date(dateStr);
        const day = date.getDay();
        return (config.weekend || [0, 6]).includes(day);
    }

    function renderCheckinModalStrategies() {
        try {
            const container = document.getElementById('checkinModalStrategyArea');
            if (!container) return;
            
            const dateInput = document.getElementById('checkinModalDateInput');
            if (!dateInput) return;
            
            const dateStr = dateInput.value;
            const strategies = [];
            
            // è·å–ç­–ç•¥ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»userStrategiesè·å–ï¼‰
            if (typeof userStrategies !== 'undefined' && userStrategies) {
                if (userStrategies.wake && Array.isArray(userStrategies.wake)) {
                    strategies.push(...userStrategies.wake.map(s => ({type: 'wake', text: s})));
                }
                if (userStrategies.sleep && Array.isArray(userStrategies.sleep)) {
                    strategies.push(...userStrategies.sleep.map(s => ({type: 'sleep', text: s})));
                }
                if (userStrategies.study && Array.isArray(userStrategies.study)) {
                    strategies.push(...userStrategies.study.map(s => ({type: 'study', text: s})));
                }
            }
            
            if (strategies.length > 0) {
                container.innerHTML = strategies.map(s => {
                    const escapedText = s.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `<div class="chip" onclick="selectCheckinModalStrategy('${s.type}', '${escapedText}')">${s.text}</div>`;
                }).join('');
            } else {
                container.innerHTML = '';
            }
        } catch (e) {
            console.warn('renderCheckinModalStrategies error:', e);
        }
    }

    function selectCheckinModalStrategy(type, text) {
        // æ ¹æ®ç­–ç•¥ç±»å‹å¡«å……ç›¸åº”çš„è¾“å…¥
        if (type === 'wake') {
            // è§£ææ—¶é—´å¹¶è®¾ç½®
            const timeMatch = text.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                document.getElementById('checkinModalWakeInput').value = timeMatch[0];
            }
        } else if (type === 'sleep') {
            const timeMatch = text.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                document.getElementById('checkinModalSleepInput').value = timeMatch[0];
            }
        } else if (type === 'study') {
            const hoursMatch = text.match(/(\d+(?:\.\d+)?)\s*h/);
            if (hoursMatch) {
                document.getElementById('checkinModalStudyInput').value = hoursMatch[1];
            }
        }
    }

    function setInputToNow(id) {
        const input = document.getElementById(id);
        if (input) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            input.value = `${hours}:${minutes}`;
        }
    }

    function updateTimeBankCheckboxStyle() {
        const checkbox = document.getElementById('useTimeBankCheckbox');
        const group = document.getElementById('useTimeBankGroup');
        if (checkbox && group) {
            if (checkbox.checked) {
                group.style.background = 'var(--time-bg)';
                group.style.border = '1px solid var(--time)';
                group.style.borderRadius = '8px';
                group.style.padding = '8px';
                group.querySelector('label').style.color = 'var(--time)';
                group.querySelector('label').style.fontWeight = 'bold';
            } else {
                group.style.background = 'transparent';
                group.style.border = 'none';
                group.style.padding = '0';
                group.querySelector('label').style.color = 'var(--text-main)';
                group.querySelector('label').style.fontWeight = 'normal';
            }
        }
    }

    function calculateCheckinModalPenalty() {
        // å®æ—¶ä¿å­˜è‰ç¨¿
        saveCheckinDraft();
        
        // æ›´æ–°æ ·å¼
        updateTimeBankCheckboxStyle();

        // æ›´æ–°å…¥ç¡æ—¶é—´æ—¥æœŸæŒ‡ç¤ºå™¨ (æ˜¨æ—¥/ä»Šæ—¥)
        const sleepInput = document.getElementById('checkinModalSleepInput');
        const sleepIndicator = document.getElementById('checkinModalSleepDayIndicator');
        if (sleepInput && sleepIndicator) {
            if (sleepInput.value) {
                const [h, m] = sleepInput.value.split(':').map(Number);
                sleepIndicator.style.display = 'inline-block';
                // 12:00ä¹‹å‰ç®—ä»Šæ—¥å‡Œæ™¨ï¼Œ12:00ä¹‹åç®—æ˜¨æ—¥
                if (h < 12) {
                    sleepIndicator.innerText = 'ä»Šæ—¥';
                    sleepIndicator.style.background = 'var(--time)'; 
                    sleepIndicator.style.color = '#fff';
                } else {
                    sleepIndicator.innerText = 'æ˜¨æ—¥';
                    sleepIndicator.style.background = '#9e9e9e'; // Gray
                    sleepIndicator.style.color = '#fff';
                }
            } else {
                sleepIndicator.style.display = 'none';
            }
        }

        // å®æ—¶è®¡ç®—æƒ©ç½šé‡‘
        const modalDate = document.getElementById('checkinModalDateInput');
        const modalSleep = document.getElementById('checkinModalSleepInput');
        const modalWake = document.getElementById('checkinModalWakeInput');
        const modalStudy = document.getElementById('checkinModalStudyInput');
        const penaltyAmountInput = document.getElementById('checkinModalPenaltyAmount');
        
        if (!modalDate || !modalDate.value) {
            // å¦‚æœæ—¥æœŸæœªå¡«å†™ï¼Œæ¸…ç©ºæƒ©ç½šé‡‘
            if (penaltyAmountInput) {
                penaltyAmountInput.value = '0';
                penaltyAmountInput.dataset.defaultValue = '0';
            }
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…å¡«é¡¹éƒ½å·²å¡«å†™
        const sleepVal = modalSleep ? modalSleep.value : '';
        const wakeVal = modalWake ? modalWake.value : '';
        const studyVal = modalStudy ? (modalStudy.value === '' ? null : parseFloat(modalStudy.value)) : null;
        
        // å¦‚æœå¿…å¡«é¡¹æœªå®Œæ•´ï¼Œä¸è®¡ç®—
        if (!sleepVal || !wakeVal || studyVal === null || studyVal === undefined || isNaN(studyVal) || studyVal < 0) {
            if (penaltyAmountInput) {
                penaltyAmountInput.value = '0';
                penaltyAmountInput.dataset.defaultValue = '0';
            }
            return;
        }
        
        // ä¸´æ—¶ä¿å­˜ä¸»è¡¨å•çš„å€¼
        const mainDate = document.getElementById('dateInput').value;
        const mainSleep = document.getElementById('sleepInput').value;
        const mainWake = document.getElementById('wakeInput').value;
        const mainStudy = document.getElementById('studyInput').value;
        
        // è®¾ç½®ä¸»è¡¨å•çš„å€¼è¿›è¡Œè®¡ç®—
        document.getElementById('dateInput').value = modalDate.value;
        document.getElementById('sleepInput').value = sleepVal;
        document.getElementById('wakeInput').value = wakeVal;
        document.getElementById('studyInput').value = studyVal;
        
        // æ‰§è¡Œè®¡ç®—ï¼ˆä½†ä¸æ˜¾ç¤ºè¡¨å•ï¼Œåªè·å–è®¡ç®—ç»“æœï¼‰
        tempTimeDiff = 0; 
        useTimeBank = false;
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«ï¼ˆä½¿ç”¨é…ç½®ä¸­çš„å‘¨æœ«è®¾ç½®ï¼‰
        const date = new Date(modalDate.value);
        const dayOfWeek = date.getDay();
        const weekendDays = config.weekend || [0, 6]; // é»˜è®¤å‘¨å…­æ—¥
        const todayIsWeekend = weekendDays.includes(dayOfWeek);
        
        const limitWake = todayIsWeekend ? config.wakeW : config.wake;
        const limitSleep = todayIsWeekend ? config.sleepW : config.sleep;
        const p = config.penalties || {};
        let penalty = 0, reasons = [];
        
        // ============================================
        // é‡æ–°è®¾è®¡çš„è®¡ç®—å…¬å¼
        // ============================================
        // è§„åˆ™ï¼š
        // 1. ä¸‰é¡¹æŒ‡æ ‡ï¼ˆå…¥ç¡ã€èµ·åºŠã€ä¸“æ³¨æ—¶é—´ï¼‰å¿…é¡»å…¨éƒ¨è¾¾æˆæ‰èƒ½è·å¾—å¥–åŠ±
        // 2. å¦‚æœä»»ä½•ä¸€é¡¹æœªè¾¾æˆï¼ŒæŒ‰ç…§æƒ©ç½šé˜¶æ¢¯ç´¯åŠ æƒ©ç½šé‡‘é¢
        // 3. åªæœ‰ä¸‰é¡¹å…¨éƒ¨è¾¾æˆï¼ˆpenalty === 0ï¼‰ï¼Œæ‰æ˜¾ç¤ºå¥–åŠ±é‡‘é¢ï¼ˆæ­£æ•°ï¼‰
        // ============================================
        
        // è·å–è¦æ±‚çš„å­¦ä¹ æ—¶é—´ï¼ˆä»è®¾ç½®ä¸­è¯»å–ï¼‰
        const requiredStudy = parseFloat(config.study) || 0;
        
        // ============================================
        // 1. æ£€æŸ¥ä¸“æ³¨æ—¶é•¿
        // ============================================
        // å®é™…å­¦ä¹ æ—¶é—´ vs è¦æ±‚å­¦ä¹ æ—¶é—´
        const studyDiff = studyVal - requiredStudy;
        tempTimeDiff = studyDiff;
        
        // Time Bank logic elements
        const useTimeBankGroup = document.getElementById('useTimeBankGroup');
        const useTimeBankCheckbox = document.getElementById('useTimeBankCheckbox');
        const timeBankDisplay = document.getElementById('timeBankBalanceDisplay');

        if (studyDiff < 0) {
            // å­¦ä¹ æ—¶é—´ä¸è¶³
            const shortageHours = Math.abs(studyDiff); // å°‘å­¦çš„å°æ—¶æ•°
            let applyPenalty = true;
            
            // Check if Time Bank has enough balance
            if (useTimeBankGroup && timeBank >= shortageHours) {
                 useTimeBankGroup.style.display = 'flex';
                 if (timeBankDisplay) timeBankDisplay.innerText = timeBank.toFixed(1);
                 
                 if (useTimeBankCheckbox && useTimeBankCheckbox.checked) {
                     useTimeBank = true; // Mark as used
                     reasons.push(`ä½¿ç”¨æ—¶é—´é“¶è¡ŒæŠµæ‰£${shortageHours.toFixed(1)}h`);
                     applyPenalty = false;
                 } else {
                     useTimeBank = false;
                 }
            } else {
                 if (useTimeBankGroup) useTimeBankGroup.style.display = 'none';
                 if (useTimeBankCheckbox) useTimeBankCheckbox.checked = false;
                 useTimeBank = false;
            }

            if (applyPenalty) {
                // æ ¹æ®å°‘å­¦æ—¶é—´åˆ¤æ–­æƒ©ç½šé˜¶æ¢¯
                if (shortageHours < 1) {
                    // å°‘å­¦æ—¶é—´ < 1å°æ—¶ï¼Œä½¿ç”¨"å­¦ä¹ <1h"çš„å›ºå®šæƒ©ç½š
                    const studyPenalty = parseFloat(p.studyS) || 0;
                    penalty += studyPenalty;
                    if (studyPenalty > 0) {
                        reasons.push(`å°‘å­¦${shortageHours.toFixed(1)}h (<1h): -${studyPenalty}å…ƒ`);
                    }
                } else {
                    // å°‘å­¦æ—¶é—´ â‰¥ 1å°æ—¶ï¼Œä½¿ç”¨"å­¦ä¹ â‰¥1h"çš„å›ºå®šæƒ©ç½š
                    const studyPenalty = parseFloat(p.studyL) || 0;
                    penalty += studyPenalty;
                    if (studyPenalty > 0) {
                        reasons.push(`å°‘å­¦${shortageHours.toFixed(1)}h (â‰¥1h): -${studyPenalty}å…ƒ`);
                    }
                }
            }
        } else {
            if (useTimeBankGroup) useTimeBankGroup.style.display = 'none';
            if (useTimeBankCheckbox) useTimeBankCheckbox.checked = false;
            useTimeBank = false;
        }
        // æ³¨æ„ï¼šå¦‚æœ studyDiff >= 0ï¼ˆå­¦ä¹ æ—¶é—´è¾¾æ ‡æˆ–è¶…è¿‡ï¼‰ï¼Œä¸è®¡ç®—æƒ©ç½š
        // è¶…è¿‡çš„æ—¶é—´ä¼šå­˜å…¥æ—¶é—´é“¶è¡Œï¼ˆåœ¨å…¶ä»–åœ°æ–¹å¤„ç†ï¼‰
        
        // ============================================
        // 2. æ£€æŸ¥èµ·åºŠæ—¶é—´
        // ============================================
        const wakeMinutes = toMin(wakeVal);
        const requiredWakeMinutes = toMin(limitWake);
        
        if (wakeMinutes > requiredWakeMinutes) {
            // èµ·åºŠæ—¶é—´æ™šäºè¦æ±‚æ—¶é—´
            const delayMinutes = wakeMinutes - requiredWakeMinutes;
            
            // æ ¹æ®å»¶è¿Ÿæ—¶é—´åˆ¤æ–­æƒ©ç½šé˜¶æ¢¯
            if (delayMinutes < 30) {
                // å»¶è¿Ÿ < 30åˆ†é’Ÿï¼Œä½¿ç”¨"èµ·åºŠ<30m"çš„å›ºå®šæƒ©ç½š
                const wakePenalty = parseFloat(p.wakeS) || 0;
                penalty += wakePenalty;
                if (wakePenalty > 0) {
                    reasons.push(`æ™šèµ·${delayMinutes}åˆ†é’Ÿ (<30m): -${wakePenalty}å…ƒ`);
                }
            } else {
                // å»¶è¿Ÿ â‰¥ 30åˆ†é’Ÿï¼Œä½¿ç”¨"èµ·åºŠâ‰¥30m"çš„å›ºå®šæƒ©ç½š
                const wakePenalty = parseFloat(p.wakeL) || 0;
                penalty += wakePenalty;
                if (wakePenalty > 0) {
                    reasons.push(`æ™šèµ·${delayMinutes}åˆ†é’Ÿ (â‰¥30m): -${wakePenalty}å…ƒ`);
                }
            }
        }
        
        // ============================================
        // 3. æ£€æŸ¥å…¥ç¡æ—¶é—´
        // ============================================
        const actualSleepMinutes = toAdjMin(sleepVal);
        const requiredSleepMinutes = toAdjMin(limitSleep);
        
        if (actualSleepMinutes > requiredSleepMinutes) {
            // å…¥ç¡æ—¶é—´æ™šäºè¦æ±‚æ—¶é—´
            const delayMinutes = actualSleepMinutes - requiredSleepMinutes;
            
            // æ ¹æ®å»¶è¿Ÿæ—¶é—´åˆ¤æ–­æƒ©ç½šé˜¶æ¢¯
            if (delayMinutes < 60) {
                // å»¶è¿Ÿ < 60åˆ†é’Ÿï¼ˆ1å°æ—¶ï¼‰ï¼Œä½¿ç”¨"å…¥ç¡<1h"çš„å›ºå®šæƒ©ç½š
                const sleepPenalty = parseFloat(p.sleepS) || 0;
                penalty += sleepPenalty;
                if (sleepPenalty > 0) {
                    reasons.push(`æ™šç¡${delayMinutes}åˆ†é’Ÿ (<1h): -${sleepPenalty}å…ƒ`);
                }
            } else {
                // å»¶è¿Ÿ â‰¥ 60åˆ†é’Ÿï¼ˆ1å°æ—¶ï¼‰ï¼Œä½¿ç”¨"å…¥ç¡â‰¥1h"çš„å›ºå®šæƒ©ç½š
                const sleepPenalty = parseFloat(p.sleepL) || 0;
                penalty += sleepPenalty;
                if (sleepPenalty > 0) {
                    reasons.push(`æ™šç¡${delayMinutes}åˆ†é’Ÿ (â‰¥1h): -${sleepPenalty}å…ƒ`);
                }
            }
        }
        
        // ============================================
        // è®¡ç®—æœ€ç»ˆé‡‘é¢
        // ============================================
        // å¦‚æœ penalty > 0ï¼šè‡³å°‘æœ‰ä¸€é¡¹æœªè¾¾æˆï¼Œæ˜¾ç¤ºæƒ©ç½šé‡‘é¢ï¼ˆè´Ÿæ•°ï¼‰
        // å¦‚æœ penalty === 0ï¼šä¸‰é¡¹å…¨éƒ¨è¾¾æˆï¼Œæ˜¾ç¤ºå¥–åŠ±é‡‘é¢ï¼ˆæ­£æ•°ï¼‰
        const defaultFund = penalty > 0 ? -penalty : parseFloat(config.reward || 5);
        
        // æ¢å¤ä¸»è¡¨å•çš„å€¼
        document.getElementById('dateInput').value = mainDate;
        document.getElementById('sleepInput').value = mainSleep;
        document.getElementById('wakeInput').value = mainWake;
        document.getElementById('studyInput').value = mainStudy;
        
        // æ›´æ–°é‡‘é¢æ˜¾ç¤ºå’Œæ ‡ç­¾ï¼ˆåªæœ‰åœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨ä¿®æ”¹æ—¶æ‰æ›´æ–°ï¼‰
        if (penaltyAmountInput) {
            const currentValue = parseFloat(penaltyAmountInput.value) || 0;
            const defaultValue = parseFloat(penaltyAmountInput.dataset.defaultValue) || 0;
            
            // å¦‚æœå½“å‰å€¼ç­‰äºä¹‹å‰çš„é»˜è®¤å€¼ï¼Œè¯´æ˜ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨ä¿®æ”¹ï¼Œå¯ä»¥æ›´æ–°
            if (Math.abs(currentValue - defaultValue) < 0.01 || !penaltyAmountInput.dataset.defaultValue) {
                // æ˜¾ç¤ºå®é™…é‡‘é¢ï¼ˆæ­£æ•°è¡¨ç¤ºå¥–åŠ±ï¼Œè´Ÿæ•°è¡¨ç¤ºæƒ©ç½šï¼‰
                penaltyAmountInput.value = defaultFund.toFixed(2);
                penaltyAmountInput.dataset.defaultValue = defaultFund.toFixed(2);
                
                // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
                const amountLabel = document.getElementById('checkinModalAmountLabel');
                if (amountLabel) {
                    if (defaultFund >= 0) {
                        amountLabel.innerText = 'æ„¿æœ›é‡‘ (å…ƒ)';
                    } else {
                        amountLabel.innerText = 'å…¬ç›Šé‡‘ (å…ƒ)';
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºä¿®æ”¹åŸå› è¾“å…¥æ¡†
                checkCheckinModalPenaltyChange();
            }
        }
    }
    
    function checkCheckinModalPenaltyChange() {
        const penaltyAmountInput = document.getElementById('checkinModalPenaltyAmount');
        const penaltyReasonBox = document.getElementById('checkinModalPenaltyReasonBox');
        const penaltyReasonInput = document.getElementById('checkinModalPenaltyReason');
        
        if (!penaltyAmountInput || !penaltyReasonBox) return;
        
        const currentValue = parseFloat(penaltyAmountInput.value) || 0;
        const defaultValue = parseFloat(penaltyAmountInput.dataset.defaultValue) || 0;
        
        // å¦‚æœä¿®æ”¹äº†é‡‘é¢ï¼Œæ˜¾ç¤ºåŸå› è¾“å…¥æ¡†
        if (Math.abs(currentValue - defaultValue) > 0.01) {
            penaltyReasonBox.style.display = 'block';
        } else {
            penaltyReasonBox.style.display = 'none';
            if (penaltyReasonInput) {
                penaltyReasonInput.value = '';
            }
        }
    }
    
    function submitCheckinModal() {
        const dateInput = document.getElementById('checkinModalDateInput');
        const penaltyAmountInput = document.getElementById('checkinModalPenaltyAmount');
        const penaltyReasonInput = document.getElementById('checkinModalPenaltyReason');
        const penaltyReasonBox = document.getElementById('checkinModalPenaltyReasonBox');
        
        if (!dateInput || !dateInput.value) {
            return alert("è¯·é€‰æ‹©æ—¥æœŸ");
        }
        
        if (!penaltyAmountInput) {
            return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        }
        
        const date = dateInput.value;
        const amount = parseFloat(penaltyAmountInput.value) || 0;
        const defaultValue = parseFloat(penaltyAmountInput.dataset.defaultValue) || 0;
        const penaltyReason = penaltyReasonInput ? penaltyReasonInput.value.trim() : '';
        
        // å¦‚æœä¿®æ”¹äº†é‡‘é¢ï¼Œå¿…é¡»å¡«å†™åŸå› 
        if (Math.abs(amount - defaultValue) > 0.01 && !penaltyReason) {
            return alert("âš ï¸ ä¿®æ”¹é‡‘é¢å¿…é¡»å¡«å†™ä¿®æ”¹åŸå› ï¼");
        }
        
        // è·å–å…¶ä»–è¾“å…¥å€¼
        const sleepVal = document.getElementById('checkinModalSleepInput') ? document.getElementById('checkinModalSleepInput').value : '';
        const wakeVal = document.getElementById('checkinModalWakeInput') ? document.getElementById('checkinModalWakeInput').value : '';
        const studyVal = document.getElementById('checkinModalStudyInput') ? parseFloat(document.getElementById('checkinModalStudyInput').value) : null;
        
        // æ£€æŸ¥å­¦ä¹ æ—¶é•¿æ˜¯å¦è¶…è¿‡è¦æ±‚æ—¶é—´ï¼Œå°†å¤šä½™æ—¶é—´å­˜å…¥æ—¶é—´é“¶è¡Œ
        const requiredStudy = parseFloat(config.study) || 0;
        let timeBankChange = 0;
        
        // Time Bank logic for deduction
        const useTimeBankCheckbox = document.getElementById('useTimeBankCheckbox');

        if (studyVal !== null && !isNaN(studyVal)) {
            if (studyVal > requiredStudy) {
                // å­¦ä¹ æ—¶é•¿è¶…è¿‡è¦æ±‚æ—¶é—´ï¼Œè®¡ç®—å¤šä½™çš„æ—¶é—´
                const extraHours = studyVal - requiredStudy;
                timeBankChange = extraHours;
                
                // å­˜å…¥æ—¶é—´é“¶è¡Œ
                timeBank += extraHours;
                localStorage.setItem('habit_time_bank_v1', timeBank);
            } else if (studyVal < requiredStudy && useTimeBankCheckbox && useTimeBankCheckbox.checked) {
                // å­¦ä¹ æ—¶é•¿ä¸è¶³ï¼Œä¸”ç”¨æˆ·é€‰æ‹©ä½¿ç”¨æ—¶é—´é“¶è¡ŒæŠµæ‰£
                const shortageHours = requiredStudy - studyVal;
                // Double check balance
                if (timeBank >= shortageHours) {
                    timeBankChange = -shortageHours;
                    timeBank -= shortageHours;
                    localStorage.setItem('habit_time_bank_v1', timeBank);
                }
            }
        }
        
        // æ„å»ºè®°å½•æ•°æ®ï¼šæ­£æ•°è¡¨ç¤ºå¥–åŠ±ï¼Œè´Ÿæ•°è¡¨ç¤ºæƒ©ç½š
        const fund = amount; // ç›´æ¥ä½¿ç”¨è¾“å…¥çš„é‡‘é¢ï¼ˆæ­£æ•°æˆ–è´Ÿæ•°ï¼‰
        const title = amount >= 0 ? 'å®Œç¾è¾¾æ ‡' : 'æ‰“å¡è®°å½•';
        const theme = amount >= 0 ? 'theme-success' : 'theme-penalty';
        const details = { type: 'checkin' };
        
        if (sleepVal) details.sleep = sleepVal;
        if (wakeVal) details.wake = wakeVal;
        if (studyVal) details.study = studyVal;
        if (penaltyReason) details.manual_edit_reason = penaltyReason;
        
        // å¦‚æœæœ‰æ—¶é—´é“¶è¡Œå˜åŠ¨ï¼Œè®°å½•åœ¨ details ä¸­
        if (timeBankChange > 0) {
            details.time_bank_change = `+${timeBankChange.toFixed(1)}h`;
            details.note = `å­¦ä¹ æ—¶é•¿è¶…è¿‡è¦æ±‚ ${timeBankChange.toFixed(1)}hï¼Œå·²å­˜å…¥æ—¶é—´é“¶è¡Œ`;
        } else if (timeBankChange < 0) {
            details.time_bank_change = `${timeBankChange.toFixed(1)}h`;
            details.note = `å­¦ä¹ æ—¶é•¿ä¸è¶³ ${Math.abs(timeBankChange).toFixed(1)}hï¼Œä½¿ç”¨æ—¶é—´é“¶è¡ŒæŠµæ‰£`;
        }
        
        // ä¿å­˜è®°å½•
        const mainDateInput = document.getElementById('dateInput');
        const originalDate = mainDateInput ? mainDateInput.value : '';
        
        // ä¸´æ—¶è®¾ç½®ä¸»è¡¨å•æ—¥æœŸä»¥ä¿å­˜è®°å½•
        if (mainDateInput) {
            mainDateInput.value = date;
        }
        
        if (amount >= 0) { addWallet(amount); } else { addDebt(Math.abs(amount)); }
        saveRecord({ fund, title, theme, details }, false);
        
        // æ¢å¤ä¸»è¡¨å•æ—¥æœŸ
        if (mainDateInput) {
            mainDateInput.value = originalDate;
        }
        
        // æ›´æ–°æ—¶é—´é“¶è¡Œæ˜¾ç¤º
        if (timeBankChange !== 0) {
            updateUI();
        }
        
        // å…³é—­å¼¹çª—
        closeCheckinModal();
        
        // æ¸…ç©ºè¡¨å•
        const penaltyArea = document.getElementById('checkinModalPenaltyArea');
        if (penaltyArea) penaltyArea.style.display = 'none';
        if (penaltyAmountInput) {
            penaltyAmountInput.value = '0';
            penaltyAmountInput.dataset.defaultValue = '0';
        }
        if (penaltyReasonInput) penaltyReasonInput.value = '';
        if (penaltyReasonBox) penaltyReasonBox.style.display = 'none';
        
        // æ›´æ–°UI
        updateUI();
    }

    function applyRestFromModal() {
        const modalDate = document.getElementById('checkinModalDateInput').value;
        const mainDate = document.getElementById('dateInput').value;
        
        document.getElementById('dateInput').value = modalDate;
        applyRest();
        
        // è·å–è¡¨å•å¹¶æ˜¾ç¤ºåœ¨modalä¸­
        const formContainer = document.getElementById('formContainer');
        const modalFormContainer = document.getElementById('checkinModalFormContainer');
        if (formContainer && modalFormContainer) {
            modalFormContainer.innerHTML = formContainer.innerHTML;
        }
        
        document.getElementById('dateInput').value = mainDate;
    }

    function applyPreventFromModal() {
        const modalDate = document.getElementById('checkinModalDateInput').value;
        const mainDate = document.getElementById('dateInput').value;
        
        document.getElementById('dateInput').value = modalDate;
        applyPrevent();
        
        // è·å–åˆ†æç»“æœå’Œè¡¨å•å¹¶æ˜¾ç¤ºåœ¨modalä¸­
        const analysisCard = document.getElementById('analysisCard');
        const modalAnalysisCard = document.getElementById('checkinModalAnalysisCard');
        if (analysisCard && modalAnalysisCard) {
            modalAnalysisCard.innerHTML = analysisCard.innerHTML;
            modalAnalysisCard.style.display = analysisCard.style.display;
        }
        
        const formContainer = document.getElementById('formContainer');
        const modalFormContainer = document.getElementById('checkinModalFormContainer');
        if (formContainer && modalFormContainer) {
            modalFormContainer.innerHTML = formContainer.innerHTML;
        }
        
        document.getElementById('dateInput').value = mainDate;
    }

    function toggleTheme() {
        currentTheme = (currentTheme === 'light' ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('habit_theme', currentTheme);
        document.getElementById('themeToggle').innerText = (currentTheme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™');
    }

    function initTheme() {
        const saved = localStorage.getItem('habit_theme') || 'dark';
        currentTheme = saved;
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('themeToggle').innerText = (saved === 'light' ? 'â˜€ï¸' : 'ğŸŒ™');
    }

    function toggleHomeView(view) {
        // æ‰“å¡è§†å›¾å·²ç§»é™¤ï¼Œåªä¿ç•™å¾…åŠè§†å›¾
        if (view === 'todo') {
            renderTodos();
            renderTodoTimeChips();
            renderTodoTaskChips();
            renderTodoFundChips();
        }
    }

    function getLocalTodayStr() {
        const d = new Date();
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    
    function getYesterdayStr() {
        const d = new Date();
        d.setDate(d.getDate() - 1);
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    
    function getStudyTimeForDate(dateStr) {
        // è·å–æŒ‡å®šæ—¥æœŸçš„å­¦ä¹ æ—¶é•¿ï¼ˆä»è®¡æ—¶è®°å½•ä¸­ï¼Œä½¿ç”¨è§„èŒƒåŒ–åç§°åŒ¹é…ï¼‰
        if (!dateStr || !timerRecords || timerRecords.length === 0) return 0;
        
        const studyRecords = timerRecords.filter(r => {
            if (!r.name || r.date !== dateStr) return false;
            const normalizedName = normalizeTaskName(r.name);
            return normalizedName.includes('å­¦ä¹ ') || normalizedName.toLowerCase().includes('study');
        });
        const totalHours = studyRecords.reduce((sum, r) => sum + parseFloat(r.duration || 0), 0);
        return totalHours;
    }

    function checkDateChange() {
        checkWeekend();
        const dateInput = document.getElementById('dateInput');
        if (!dateInput) return;
        
        const dateStr = dateInput.value;
        const todoDateInput = document.getElementById('todoDate');
        if (todoDateInput) todoDateInput.value = dateStr;
        
        renderTodos();
        renderStrategies();
    }

    function calculateCheckin() {
        autoCalculate();
    }

    function applyRest() {
        const leaveCount = historyData.filter(r => r.date.startsWith(document.getElementById('dateInput').value.slice(0, 7)) && r.theme === 'theme-skip').length;
        renderForm('skip', leaveCount);
    }

    function applyPrevent() {
        document.getElementById('analysisCard').style.display = 'block';
        document.getElementById('analysisCard').innerHTML = `<div style="font-weight:700;color:var(--primary);padding:15px;text-align:center;">è¯Šæ–­ä¸­...</div>`;
        renderForm('prevent');
    }

    function renderStrategySettings() {
        ['wake','sleep','study'].forEach(type => {
            const container = document.getElementById('list_' + type);
            if (!container) return;
            container.innerHTML = (userStrategies[type]||[]).map((s, idx) => `
                <div class="chip chip-removable" onclick="removeStrat('${type}', ${idx})">${s}</div>
            `).join('');
        });
    }

    function addStrat(type) {
        const input = document.getElementById(`input_${type}`);
        const val = input.value.trim();
        if(!val) return;
        if(!userStrategies[type]) userStrategies[type] = [];
        userStrategies[type].push(val);
        input.value = '';
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        renderStrategySettings(); triggerAutoSave();
    }
    function removeStrat(type, idx) {
        if(!confirm(`åˆ é™¤æ­¤ç­–ç•¥?`)) return;
        userStrategies[type].splice(idx, 1);
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        renderStrategySettings(); triggerAutoSave();
    }

    function getTimestampStr() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        return now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + "_" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
    }

    function fixCorruptData() {
        let originalLen = todoList.length;
        todoList = todoList.filter(t => t);
        todoList.forEach(t => { if(!t.id) t.id = 'fixed_' + Math.random(); if(!t.title) t.title = "ä¿®å¤çš„æ•°æ®"; });
        const seen = new Set();
        todoList = todoList.filter(t => { if(seen.has(t.id)) return false; seen.add(t.id); return true; });
        if(todoList.length !== originalLen) localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
    }

    function nukeExpiredTodos() {
        if(!confirm("âš ï¸ ç¡®è®¤æ¸…ç©ºåˆ—è¡¨ä¸­çš„æ‰€æœ‰ã€å·²ç»“æŸ/å·²è¿‡æœŸã€‘é¡¹ç›®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
        isDeleting = true;
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        const todayStr = getLocalTodayStr();
        todoList = todoList.filter(t => {
            if(t.archived) return false; // ç§»é™¤å·²å½’æ¡£
            if(t.date > todayStr) return true;
            if(t.date === todayStr && t.time >= currentHm) return true;
            let isExpired = (t.date < todayStr) ||
                            (t.date === todayStr && currentHm > t.time && (t.status === 'pending' || t.status.startsWith('expired_')));
            return !isExpired;
        });
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        renderTodos();
        triggerAutoSave();
        setTimeout(() => isDeleting = false, 500);
    }

    // å¾…åŠçš„â€œåˆ°æœŸæ—¶é—´æˆ³â€ï¼ˆç”¨äºé€¾æœŸ/å·²ç»“æŸæ’åºï¼‰
    function getTodoDueTimestamp(t) {
        try {
            if (!t || !t.date || !t.time) return 0;
            const ms = new Date(`${t.date}T${t.time}:00`).getTime();
            return Number.isFinite(ms) ? ms : 0;
        } catch (_) {
            return 0;
        }
    }

    // å¾…åŠçš„â€œè¿›å…¥å·²ç»“æŸ/å·²è¿‡æœŸâ€çš„æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
    // ä½ çš„æœŸæœ›æ˜¯â€œä»€ä¹ˆæ—¶å€™è¢«æ”¾è¿›å·²ç»“æŸåˆ—è¡¨â€ï¼Œå› æ­¤åªè®¤ endedAtï¼ˆå…¥åˆ—æ—¶é—´ï¼‰ï¼›
    // å¯¹äºæ‰‹åŠ¨å½’æ¡£ï¼šç”¨ archivedAt ä½œä¸ºå…¥åˆ—æ—¶é—´ï¼›å…¶å®ƒæƒ…å†µè‹¥æ—  endedAt åˆ™è§†ä¸ºâ€œåˆšåˆšå…¥åˆ—â€ã€‚
    function getTodoEndedTimestamp(t) {
        // å…³é”®ï¼šå†å²æ•°æ®å¯èƒ½è¢«æ—§é€»è¾‘å†™å…¥è¿‡ endedAtï¼Œä½†é‚£ä¸æ˜¯â€œçœŸå®å…¥åˆ—æ—¶é—´â€ã€‚
        // åªæœ‰ endedAtV === 1ï¼ˆæœ¬ç‰ˆæœ¬å¼€å§‹æ–°å¢ï¼‰æ‰è®¤ä¸ºæ˜¯â€œæ–°å…¥åˆ—â€ï¼Œç”¨äºæ’åˆ°å‰é¢ã€‚
        if (!t || t.endedAtV !== 1) return 0;

        const endedAt = Number(t && t.endedAt);
        if (Number.isFinite(endedAt) && endedAt > 0) return endedAt;

        const archivedAt = Number(t && t.archivedAt);
        if (Number.isFinite(archivedAt) && archivedAt > 0) return archivedAt;

        return 0;
    }

    function checkTodoTypeChange() {
        const type = document.getElementById('todoType').value;
        if(type === 'other') {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            document.getElementById('todoDate').value = d.toISOString().split('T')[0];
            document.getElementById('todoReward').value = 1;
            document.getElementById('todoPenalty').value = 1;
        } else {
            if(document.getElementById('todoReward').value == 0 || !document.getElementById('todoReward').value) document.getElementById('todoReward').value = 1;
            if(document.getElementById('todoPenalty').value == 0 || !document.getElementById('todoPenalty').value) document.getElementById('todoPenalty').value = 1;
            document.getElementById('todoDate').value = getLocalTodayStr();
        }
    }

    function renderTodos() {
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);

        ['list-do','list-dont','list-other','list-expired'].forEach(id=>document.getElementById(id).innerHTML='');
        ['head-do','head-dont','head-other','head-expired'].forEach(id=>document.getElementById(id).classList.remove('show'));

        // 1. åˆ†ç¦» Active å’Œ Expired
        let activeItems = [];
        let expiredItems = [];

        todoList.forEach(t => {
            let isExpired = (t.date < todayStr) || t.archived; // å¢åŠ æ‰‹åŠ¨å½’æ¡£åˆ¤æ–­
            if (!isExpired && t.date === todayStr && currentHm >= t.time) {
                 if (currentHm > t.time) {
                     if (t.status === 'pending' || t.status.startsWith('expired_')) {
                         isExpired = true;
                     }
                 }
            }
            if(isExpired) expiredItems.push(t);
            else activeItems.push(t);
        });

        // 2. æ¸²æŸ“ Active (é‡è¦ç­‰çº§ä¼˜å…ˆï¼Œå…¶æ¬¡æŒ‰æ—¶é—´æ’åº)
        activeItems.sort((a, b) => {
            const impA = a.importance || 1;
            const impB = b.importance || 1;
            if (impA !== impB) return impB - impA; // æŒ‰é‡è¦ç­‰çº§é™åº
            return (a.date + a.time).localeCompare(b.date + b.time); // åŒçº§æŒ‰æ—¶é—´å‡åº
        });
        
        let activeCount = 0;
        activeItems.forEach(t => {
            const html = generateTodoHtml(t, false);
            activeCount++;
            if(t.type === 'do') { document.getElementById('list-do').insertAdjacentHTML('beforeend', html); document.getElementById('head-do').classList.add('show'); }
            else if(t.type === 'dont') { document.getElementById('list-dont').insertAdjacentHTML('beforeend', html); document.getElementById('head-dont').classList.add('show'); }
            else { document.getElementById('list-other').insertAdjacentHTML('beforeend', html); document.getElementById('head-other').classList.add('show'); }
        });

        // 3. æ¸²æŸ“ Expiredï¼ˆæŒ‰è¿›å…¥â€œå·²ç»“æŸ/å·²è¿‡æœŸâ€çš„å…ˆåæ’åºï¼Œå€’åºï¼šæœ€æ–°åœ¨å‰ï¼‰
        if(expiredItems.length > 0) {
            expiredItems.sort((a, b) => {
                // æŒ‰â€œå…¥åˆ—æ—¶é—´â€å€’åºï¼šæœ€æ–°å…¥åˆ—çš„åœ¨å‰
                const endA = getTodoEndedTimestamp(a);
                const endB = getTodoEndedTimestamp(b);
                
                // å¦‚æœéƒ½æœ‰ç»“æŸæ—¶é—´ï¼ŒæŒ‰ç»“æŸæ—¶é—´å€’åº
                if (endA > 0 && endB > 0) {
                    const diff = endB - endA;
                    if (diff !== 0) return diff;
                    // äºŒçº§æ’åºï¼šä¿æŒç¨³å®šï¼ˆid å€’åºï¼‰
                    return String(b.id).localeCompare(String(a.id));
                }
                // å¦‚æœåªæœ‰ä¸€ä¸ªæœ‰ç»“æŸæ—¶é—´ï¼Œæœ‰ç»“æŸæ—¶é—´çš„æ’åœ¨å‰é¢
                if (endA > 0) return -1;
                if (endB > 0) return 1;
                
                // éƒ½æ²¡æœ‰ç»“æŸæ—¶é—´ï¼ˆæç«¯æ—§æ•°æ®ï¼‰ï¼ŒæŒ‰äº‹ä»¶æ—¶é—´å€’åºä½œä¸ºfallback
                const dtA = a.date + a.time;
                const dtB = b.date + b.time;
                return dtB.localeCompare(dtA);
            });

            const limit = expiredFullView ? expiredItems.length : (config.expiredLimit || 5);
            const displayedExpired = expiredItems.slice(0, limit);

            const expiredHtml = displayedExpired.map(t => generateTodoHtml(t, true)).join('');
            document.getElementById('list-expired').innerHTML = expiredHtml;
            document.getElementById('head-expired').classList.add('show');
            
            // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
            if (!expiredFullView && expiredItems.length > limit) {
                document.getElementById('list-expired').insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleExpiredFullView()" title="å±•å¼€æ›´å¤š">
                        <span>å±•å¼€æ›´å¤š</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>`
                );
            } else if (expiredFullView && expiredItems.length > (config.expiredLimit || 5)) {
                document.getElementById('list-expired').insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleExpiredFullView()" title="æ”¶èµ·">
                        <span>æ”¶èµ·åˆ—è¡¨</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    </div>`
                );
            }
        }

        document.getElementById('empty-todo-hint').style.display = activeCount === 0 ? 'block' : 'none';

        if(openMenuId) {
             const menu = document.getElementById(`menu-${openMenuId}`);
             if(menu && menu.classList.contains('show')) {
                 clearTimeout(menuTimer);
                 menuTimer = setTimeout(() => {
                    menu.classList.remove('show');
                    openMenuId = null;
                 }, 8000);
             }
        }
    }

    function generateTodoHtml(t, isExpired) {
        let statusIcon = '', actionBtn = '';
        const reward = t.reward || 0;
        const penalty = t.penalty || 0;

        const importance = t.importance || 1;
        // æ ¹æ®é‡è¦ç¨‹åº¦è®¾ç½®é¢œè‰²æ¡é¢œè‰²
        const importanceColors = {
            1: 'var(--info)',      // æ™®é€š - è“è‰²
            2: 'var(--warning)',    // ä¸­ç­‰ - æ©™è‰²
            3: 'var(--danger)'      // é‡è¦ - çº¢è‰²
        };
        const importanceColor = importanceColors[importance] || importanceColors[1];
        // é¢œè‰²æ¡ä½äºå·¦ä¾§ï¼Œå®½åº¦4pxï¼Œè¡¨ç¤ºé‡è¦ç¨‹åº¦
        const importanceBar = `<div style="position:absolute; left:0; top:0; bottom:0; width:4px; background:${importanceColor}; border-radius:8px 0 0 8px; z-index:1;"></div>`;

        const safeId = String(t.id);
        const noteContent = t.hideNote ? '******' : t.note;
        const isNoteExpanded = t.noteExpanded || false;
        const noteStyle = isNoteExpanded 
            ? 'font-size:11px;color:var(--text-sub);margin-top:2px;background:var(--input-bg);padding:4px;border-radius:6px;word-break:break-all;'
            : 'font-size:11px;color:var(--text-sub);margin-top:2px;background:var(--input-bg);padding:4px;border-radius:6px;word-break:break-all;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;';
        const note = t.note ? `<div id="note-${safeId}" style="${noteStyle}">${noteContent}</div>` : '';
        const todayStr = getLocalTodayStr();
        const isFuture = t.date > todayStr;

        if (t.status === 'success') {
            // å·²å®ŒæˆçŠ¶æ€ï¼šç§»é™¤çŠ¶æ€å›¾æ ‡ï¼Œåªæ˜¾ç¤ºå¥–åŠ±é‡‘é¢
            statusIcon = '';
            actionBtn = `<span style="font-size:11px;color:var(--success);opacity:0.8;">+${reward}</span>`;
        } else if (t.status === 'fail') {
            // å·²å¤±è´¥çŠ¶æ€ï¼šç§»é™¤çŠ¶æ€å›¾æ ‡ï¼Œåªæ˜¾ç¤ºæƒ©ç½šé‡‘é¢
            statusIcon = '';
            actionBtn = `<span style="font-size:11px;color:var(--danger);opacity:0.8;">-${penalty}</span>`;
        } else {
            // pendingçŠ¶æ€
            statusIcon = '';
            if (isExpired) {
                // å·²è¿‡æœŸçŠ¶æ€ï¼šç§»é™¤çŠ¶æ€å›¾æ ‡
                if(t.status === 'expired_fail') actionBtn = `<span style="font-size:11px;color:var(--danger);opacity:0.7;">å·²è¶…æ—¶</span>`;
                else if(t.status === 'expired_success') actionBtn = `<span style="font-size:11px;color:var(--success);opacity:0.7;">å·²è¾¾æˆ</span>`;
                else actionBtn = `<span style="font-size:11px;color:var(--text-sub);opacity:0.7;">å·²è¿‡æœŸ</span>`;
            } else {
                // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰typeï¼Œé»˜è®¤ä¸º'do'
                if (!t.type || t.type === 'do' || t.type==='other') {
                    actionBtn = `<div id="btn-${safeId}" class="todo-check" onclick="finishTodoWithAnim('${safeId}', 'success')">âœ”</div>`;
                } else {
                    actionBtn = `<button class="btn-mini" style="background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger);font-size:11px;padding:4px 8px;" onclick="finishTodoWithAnim('${safeId}', 'fail')">ç ´æˆ’</button>`;
                }
            }
        }
        const wrapperClass = isExpired ? 'todo-item todo-expired-item' : `todo-item todo-${t.type}`;

        let menuHtml = '';
        const showClass = (safeId === openMenuId) ? 'show' : '';

        let customActions = '';
        // å¯¹äºæœªè¿‡æœŸçš„å·²å®Œæˆ/å·²å¤±è´¥ä»»åŠ¡ï¼Œæ·»åŠ æ’¤é”€å’Œå½’æ¡£åŠŸèƒ½
        if (!isExpired && (t.status === 'success' || t.status === 'fail')) {
            customActions += `<div class="btn-action" onclick="undoTodoFinish('${safeId}')">â†©ï¸</div>`;
            customActions += `<div class="btn-action" onclick="archiveTodo('${safeId}')">ğŸ“¦</div>`;
        }
        // ä¸ºå¾…åŠä¸­çš„ä»»åŠ¡æ·»åŠ è®¡æ—¶åŠŸèƒ½
        if (!isExpired && t.status === 'pending') {
            customActions += `<div class="btn-action" onclick="startTimerFromTodo('${safeId}')">â±ï¸</div>`;
        }
        // ä¸ºè¿‡æœŸçš„ä»»åŠ¡æ·»åŠ æ¢å¤åŠŸèƒ½
        if (isExpired || t.status.startsWith('expired_')) {
            customActions += `<div class="btn-action" onclick="restoreTodo('${safeId}')">â†©ï¸</div>`;
        }
        // ä¸ºæ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…æ‹¬è¿‡æœŸçš„ï¼‰æ·»åŠ å¤‡æ³¨å±•å¼€/éšè—åŠŸèƒ½
        if (t.note) {
            const expandIcon = isNoteExpanded ? 'ğŸ“•' : 'ğŸ“–';
            customActions += `<div class="btn-action" onclick="toggleTodoNoteExpand('${safeId}')">${expandIcon}</div>`;
            // æ·»åŠ éšè—åŠŸèƒ½
            const hideIcon = t.hideNote ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
            customActions += `<div class="btn-action" onclick="toggleTodoNote('${safeId}')">${hideIcon}</div>`;
        }

        // å¯¹äºå¾…åŠä¸­æˆ–è¿‡æœŸçš„ä»»åŠ¡ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
        if(t.status === 'pending' || t.status.startsWith('expired_') || isExpired) {
            menuHtml = `
                <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">â‹®</div>
                <div id="menu-${safeId}" class="action-menu ${showClass}">
                    ${customActions}
                    <div class="btn-action btn-edit" onclick="editTodo('${safeId}')">âœï¸</div>
                    <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">ğŸ—‘ï¸</div>
                </div>
            `;
        } else {
            // å¯¹äºå·²å®Œæˆçš„éè¿‡æœŸä»»åŠ¡ï¼Œåªæ˜¾ç¤ºæ’¤é”€ã€å½’æ¡£å’Œåˆ é™¤
            menuHtml = `
                <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">â‹®</div>
                <div id="menu-${safeId}" class="action-menu ${showClass}">
                    ${customActions}
                    <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">ğŸ—‘ï¸</div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼šä»Šå¤©ä¸æ˜¾ç¤ºï¼Œæœ€è¿‘æ—¥æœŸç”¨"æ˜¨"ã€"æ˜"ä»£æ›¿
        let dateBadgeFormatted = '';
        if (isFuture || isExpired) {
            const todoDate = new Date(t.date + 'T00:00:00');
            const today = new Date(todayStr + 'T00:00:00');
            const diffDays = Math.floor((todoDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays === -1) {
                dateBadgeFormatted = '<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">æ˜¨</span>';
            } else if (diffDays === 0) {
                dateBadgeFormatted = '';
            } else if (diffDays === 1) {
                dateBadgeFormatted = '<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">æ˜</span>';
            } else {
                dateBadgeFormatted = `<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">${t.date.slice(5)}</span>`;
            }
        }
        
        // å¥–åŠ±/æƒ©ç½šä¿¡æ¯ï¼šéƒ½è¦æ˜¾ç¤º
        const rewardText = reward > 0 ? `+${reward}` : reward === 0 ? '0' : '';
        const penaltyText = penalty > 0 ? `-${penalty}` : penalty === 0 ? '0' : '';
        const fundInfo = `<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">${rewardText}/${penaltyText}</span>`;
        
        return `
        <div class="${wrapperClass}" id="todo-row-${safeId}" style="position:relative; padding-left:8px;">
            ${importanceBar}
            <div style="flex:1; display:flex; align-items:flex-start; gap:6px; min-width:0;">
                <div style="flex:1; min-width:0;">
                    <div style="font-size:10px; color:var(--text-sub); opacity:0.7; margin-bottom:3px; display:flex; align-items:center; gap:6px;">
                        <span>${t.time}</span>
                        ${dateBadgeFormatted}
                        ${fundInfo}
                    </div>
                    <div style="font-weight:600; color:var(--text-main); font-size:14px; line-height:1.3;">
                        ${t.title}
                    </div>
                    ${note}
                </div>
            </div>
            <div style="display:flex;align-items:center; gap:3px; flex-shrink:0;">
                ${actionBtn} ${menuHtml}
            </div>
        </div>`;
    }

    let menuTimer = null;
    function toggleMenu(e, id) {
        if (e) e.stopPropagation();
        
        // ä¼˜å…ˆä»æ¨¡æ€æ¡†ä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼‰
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        let menu = null;
        if (isModalOpen && modalContent) {
            menu = modalContent.querySelector(`#menu-${id}`);
        }
        if (!menu) {
            menu = document.getElementById(`menu-${id}`);
        }
        
        if (!menu) return;
        
        const isShown = menu.classList.contains('show');

        closeAllMenus();

        if(!isShown) {
            menu.classList.add('show');
            openMenuId = id;

            clearTimeout(menuTimer);
            menuTimer = setTimeout(() => {
                menu.classList.remove('show');
                openMenuId = null;
            }, 8000);
        }
    }

    function closeAllMenus(e) {
        clearTimeout(menuTimer);
        document.querySelectorAll('.action-menu.show').forEach(el => el.classList.remove('show'));
        openMenuId = null;
    }

    function saveTodo() {
        const id = document.getElementById('editingId').value;
        const title = document.getElementById('todoTitle').value;
        const note = document.getElementById('todoNote').value;
        const time = document.getElementById('todoTime').value;
        const date = document.getElementById('todoDate').value;
        const type = document.getElementById('todoType').value;
        const importance = parseInt(document.getElementById('todoImportance').value) || 1;
        const reward = parseFloat(document.getElementById('todoReward').value) || 1;
        const penalty = parseFloat(document.getElementById('todoPenalty').value) || 1;

        if(!title || !time || !date) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆä»»åŠ¡åç§°ã€æˆªæ­¢æ—¶é—´ï¼‰',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }

        // ä¿å­˜æœ¬æ¬¡é‡‘é¢ï¼Œç”¨äºä¸‹æ¬¡å¿«é€‰
        if (reward > 0) {
            lastReward = reward;
            localStorage.setItem('habit_last_reward', reward);
        }
        if (penalty > 0) {
            lastPenalty = penalty;
            localStorage.setItem('habit_last_penalty', penalty);
        }
        renderTodoFundChips(); // æ›´æ–°é‡‘é¢å¿«é€‰èƒ¶å›Š

        if (id) {
            const t = todoList.find(x => String(x.id) === id);
            if (t) {
                t.title = title;
                t.note = note;
                t.time = time;
                t.date = date;
                t.type = type;
                t.importance = importance;
                t.reward = reward;
                t.penalty = penalty;
                t.status = 'pending';
                // æ ‡è®°ä¸ºæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹ï¼Œæ–¹ä¾¿å¤šè®¾å¤‡åˆå¹¶æ—¶åˆ¤æ–­â€œè°æ›´æ–°æ›´æ™šâ€
                t.updatedAt = Date.now();
                delete t.archived; // ç¼–è¾‘åå–æ¶ˆå½’æ¡£çŠ¶æ€
                delete t.archivedAt;
                delete t.endedAt;
                delete t.endedAtV;
            }
        } else {
            const newId = 't_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            todoList.push({ 
                id: newId, 
                date, 
                title, 
                note, 
                time, 
                type, 
                importance, 
                reward, 
                penalty, 
                status: 'pending',
                // æ–°å»ºä»»åŠ¡è®°å½•åˆ›å»ºæ—¶é—´
                updatedAt: Date.now()
            });
        }

        renderTodos();
        if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
        triggerAutoSave();
        cancelEdit();
    }

    function editTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t) return;

        document.getElementById('editingId').value = t.id;
        document.getElementById('todoTitle').value = t.title;
        document.getElementById('todoNote').value = t.note || '';
        document.getElementById('todoTime').value = t.time;
        document.getElementById('todoDate').value = t.date;
        document.getElementById('todoType').value = t.type;
        document.getElementById('todoImportance').value = t.importance || 1;
        document.getElementById('todoReward').value = t.reward;
        document.getElementById('todoPenalty').value = t.penalty;

        // æ›´æ–°èƒ¶å›Šé€‰ä¸­çŠ¶æ€
        renderTodoTypeChips();
        renderTodoImportanceChips();

        const submitBtn = document.getElementById('todoSubmitBtn');
        submitBtn.innerHTML = 'ä¿å­˜';
        submitBtn.style.fontSize = '16px';

        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('editingId').value = '';
        document.getElementById('todoTitle').value = '';
        document.getElementById('todoNote').value = '';
        document.getElementById('todoType').value = 'do';
        document.getElementById('todoImportance').value = '1';

        document.getElementById('todoReward').value = '1';
        document.getElementById('todoPenalty').value = '1';
        
        // æ›´æ–°èƒ¶å›Šé€‰ä¸­çŠ¶æ€
        renderTodoTypeChips();
        renderTodoImportanceChips();

        initTodoTime();
        document.getElementById('todoDate').value = getLocalTodayStr();

        const submitBtn = document.getElementById('todoSubmitBtn');
        submitBtn.innerHTML = '+';
        submitBtn.style.fontSize = '20px';
    }

    function toggleTodoNote(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (t) {
            t.hideNote = !t.hideNote;
            renderTodos();
            triggerAutoSave();
        }
    }
    
    // å±•å¼€/æ”¶èµ·å¤‡æ³¨
    function toggleTodoNoteExpand(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t || !t.note) return;
        
        t.noteExpanded = !t.noteExpanded;
        
        // æ›´æ–°å¤‡æ³¨å…ƒç´ çš„æ ·å¼
        const noteElement = document.getElementById(`note-${String(id)}`);
        if (noteElement) {
            if (t.noteExpanded) {
                // å±•å¼€ï¼šç§»é™¤è¡Œæ•°é™åˆ¶
                noteElement.style.display = 'block';
                noteElement.style.webkitLineClamp = 'unset';
                noteElement.style.overflow = 'visible';
            } else {
                // æ”¶èµ·ï¼šæ¢å¤ä¸¤è¡Œé™åˆ¶
                noteElement.style.display = '-webkit-box';
                noteElement.style.webkitLineClamp = '2';
                noteElement.style.overflow = 'hidden';
            }
        }
        
        // æ›´æ–°èœå•ä¸­çš„æŒ‰é’®å›¾æ ‡
        const menu = document.getElementById(`menu-${String(id)}`);
        if (menu) {
            const expandBtn = menu.querySelector('[onclick*="toggleTodoNoteExpand"]');
            if (expandBtn) {
                expandBtn.textContent = t.noteExpanded ? 'ğŸ“•' : 'ğŸ“–';
            }
        }
        
        // å…³é—­èœå•
        closeAllMenus();
    }

    function archiveTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (t) {
            t.archived = true;
            t.noteExpanded = false;
            t.archivedAt = Date.now(); // è®°å½•å½’æ¡£æ—¶é—´æˆ³
            t.endedAt = t.archivedAt; // è¿›å…¥â€œå·²ç»“æŸ/å·²è¿‡æœŸâ€çš„æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
            t.endedAtV = 1; // æ ‡è®°ï¼šæœ¬ç‰ˆæœ¬äº§ç”Ÿçš„â€œçœŸå®å…¥åˆ—æ—¶é—´â€
            // è®°å½•æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ—¶é—´
            t.updatedAt = Date.now();
            renderTodos();
            triggerAutoSave();
        }
    }

    function addTodo() { saveTodo(); }

    function deleteTodo(id) {
        if(!confirm("åˆ é™¤æ­¤å¾…åŠï¼Ÿ")) return;
        isDeleting = true;
        
        // è®°å½•åˆ é™¤çš„IDï¼Œç”¨äºå¤šç«¯åŒæ­¥
        if (typeof deletedTodoIds === 'undefined') deletedTodoIds = [];
        deletedTodoIds.push(String(id));
        // é™åˆ¶åˆ é™¤è®°å½•çš„å¤§å°ï¼Œé˜²æ­¢æ— é™å¢é•¿
        if (deletedTodoIds.length > 500) deletedTodoIds = deletedTodoIds.slice(-500);
        localStorage.setItem('habit_deleted_todo_ids_v1', JSON.stringify(deletedTodoIds));
        
        todoList = todoList.filter(t => String(t.id) !== String(id));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        const el = document.getElementById(`todo-row-${id}`);
        if(el) el.remove();
        setTimeout(() => { 
            renderTodos(); 
            if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
            triggerAutoSave(); 
            isDeleting = false; 
        }, 300);
    }

    function finishTodoWithAnim(id, result) {
        const btn = document.getElementById(`btn-${id}`);
        if(btn) btn.classList.add('click-anim');
        setTimeout(() => { finishTodo(id, result); }, 300);
    }

    function finishTodo(id, result) {
        const t = todoList.find(x => String(x.id) === String(id));
        if(!t) return;
        t.status = result;
        // è®°å½•æœ€è¿‘ä¸€æ¬¡çŠ¶æ€å˜æ›´æ—¶é—´ï¼Œä¾›å¤šè®¾å¤‡åˆå¹¶ä½¿ç”¨
        t.updatedAt = Date.now();

        let fund, theme, displayTitle, recordType;
        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰typeï¼Œé»˜è®¤ä¸º'do'
        if (!t.type || t.type === 'do' || t.type === 'other') {
            if (result === 'success') { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
            else { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
        } else if (t.type === 'dont') {
            if (result === 'fail') { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
            else { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
        }

        displayTitle = t.title;
        if (!t.type || t.type === 'do' || t.type === 'other') {
            if (result === 'success') { addWallet(Number(t.reward)||0); } else { addDebt(Number(t.penalty)||0); }
        } else if (t.type === 'dont') {
            if (result === 'fail') { addDebt(Number(t.penalty)||0); } else { addWallet(Number(t.reward)||0); }
        }
        const recordId = Date.now();
        // åœ¨è®°å½•ä¸­ä¿å­˜å¾…åŠIDï¼Œæ–¹ä¾¿åç»­å–æ¶ˆæ—¶æŸ¥æ‰¾
        saveRecord({ fund, title: displayTitle, theme, details:{type:'Todoç»“ç®—', result, recordType, todoId: String(id)} }, false);
        // ä¿å­˜è®°å½•IDåˆ°å¾…åŠé¡¹ï¼Œæ–¹ä¾¿å–æ¶ˆæ—¶æŸ¥æ‰¾
        t.finishRecordId = recordId;
        renderTodos();
        if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
    }
    
    // å–æ¶ˆå¾…åŠå®ŒæˆçŠ¶æ€
    function undoTodoFinish(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t || (t.status !== 'success' && t.status !== 'fail')) return;
        
        // è®¡ç®—éœ€è¦æ’¤é”€çš„ç§¯åˆ†
        let fundToUndo = 0;
        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰typeï¼Œé»˜è®¤ä¸º'do'
        if (!t.type || t.type === 'do' || t.type === 'other') {
            if (t.status === 'success') { fundToUndo = -t.reward; } // æ’¤é”€å¥–åŠ±ï¼Œå‡å»
            else { fundToUndo = t.penalty; } // æ’¤é”€æƒ©ç½šï¼ŒåŠ å›
        } else if (t.type === 'dont') {
            if (t.status === 'fail') { fundToUndo = t.penalty; } // æ’¤é”€æƒ©ç½šï¼ŒåŠ å›
            else { fundToUndo = -t.reward; } // æ’¤é”€å¥–åŠ±ï¼Œå‡å»
        }
        
        // æŸ¥æ‰¾å¹¶åˆ é™¤ç›¸å…³çš„å†å²è®°å½•
        const recordToDelete = historyData.find(r => 
            r.details && 
            r.details.type === 'Todoç»“ç®—' && 
            r.details.todoId === String(id)
        );
        
        if (recordToDelete) {
            // åˆ é™¤å†å²è®°å½•
            historyData = historyData.filter(i => i.id !== recordToDelete.id);
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        } else {
            // å¦‚æœæ‰¾ä¸åˆ°è®°å½•ï¼Œç›´æ¥æ’¤é”€ç§¯åˆ†
            saveRecord({ 
                fund: fundToUndo, 
                title: `å–æ¶ˆ: ${t.title}`, 
                theme: fundToUndo > 0 ? 'theme-success' : 'theme-pay', 
                details: { type: 'å–æ¶ˆTodoç»“ç®—', todoId: String(id) } 
            }, false);
        }
        
        const prevStatus = t.status;
        t.status = 'pending';
        t.updatedAt = Date.now();
        delete t.finishRecordId;
        
        if (!t.type || t.type === 'do' || t.type === 'other') {
            if (prevStatus === 'success') { addWallet(-(Number(t.reward)||0)); } else if (prevStatus === 'fail') { addDebt(-(Number(t.penalty)||0)); }
        } else if (t.type === 'dont') {
            if (prevStatus === 'fail') { addDebt(-(Number(t.penalty)||0)); } else if (prevStatus === 'success') { addWallet(-(Number(t.reward)||0)); }
        }
        // æ›´æ–°UIå’Œç»Ÿè®¡æ•°æ®
        calculateFunds();
        updateUI();
        renderTodos();
        if (typeof updateDebtModalHistoryList === 'function') updateDebtModalHistoryList();
        triggerAutoSave();
        closeAllMenus();
    }

    function restoreTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t || (!t.status.startsWith('expired_') && !(t.date < getLocalTodayStr()) && !t.archived)) return;
        
        const prevStatus = t.status;

        // å°è¯•åˆ é™¤å…³è”çš„å†å²è®°å½•ï¼ˆå®ç°å½»åº•æ’¤é”€ï¼‰
        let recordDeleted = false;
        if (t.finishRecordId) {
            const idx = historyData.findIndex(r => r.id === t.finishRecordId);
            if (idx > -1) {
                historyData.splice(idx, 1);
                recordDeleted = true;
            }
        }
        if (!recordDeleted) {
            // å°è¯•é€šè¿‡ ID å’Œç±»å‹æŸ¥æ‰¾
            const idx = historyData.findIndex(r => r.details && r.details.todoId === String(id) && r.details.type === 'Todoç»“ç®—');
            if (idx > -1) {
                historyData.splice(idx, 1);
                recordDeleted = true;
            }
        }
        if (recordDeleted) {
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        }

        // æ¢å¤çŠ¶æ€ä¸ºpending
        t.status = 'pending';
        delete t.archived;
        delete t.archivedAt;
        delete t.endedAt;
        delete t.endedAtV;
        delete t.finishRecordId;
        
        // å¦‚æœæ—¥æœŸæ˜¯è¿‡å»çš„ï¼Œæ›´æ–°ä¸ºä»Šå¤©
        const todayStr = getLocalTodayStr();
        if (t.date < todayStr) {
            t.date = todayStr;
        }
        // å¦‚æœæ—¶é—´å·²è¿‡ï¼Œè‡ªåŠ¨é¡ºå»¶åˆ°å½“å‰æ—¶é—´å15åˆ†é’Ÿ
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        if (t.date === todayStr && (!t.time || t.time <= currentHm)) {
            const next = new Date(now.getTime() + 15 * 60 * 1000);
            const pad = (n) => String(n).padStart(2, '0');
            t.time = `${pad(next.getHours())}:${pad(next.getMinutes())}`;
        }
        
        // å›æ»šé€¾æœŸ/å®Œæˆäº§ç”Ÿçš„èµ„é‡‘å½±å“
        if (prevStatus === 'expired_success' || prevStatus === 'success') {
            addWallet(-(Number(t.reward) || 0));
        } else if (prevStatus === 'expired_fail' || prevStatus === 'fail') {
            addDebt(-(Number(t.penalty) || 0));
        }

        // å¦‚æœæ²¡æ‰¾åˆ°è®°å½•è¢«åˆ é™¤ï¼ˆè¯´æ˜å¯èƒ½æ˜¯æ—§æ•°æ®æˆ–å·²è¢«æ¸…ç†ï¼‰ï¼Œä½†äº§ç”Ÿäº†èµ„é‡‘å˜åŠ¨ï¼Œè¡¥ä¸€æ¡è®°å½•
        if (!recordDeleted && (prevStatus === 'expired_success' || prevStatus === 'expired_fail' || prevStatus === 'success' || prevStatus === 'fail')) {
            let recordFund = 0;
            let theme = '';
            if (prevStatus === 'expired_success' || prevStatus === 'success') {
                recordFund = -(Number(t.reward) || 0); // æ‰£é™¤å¥–åŠ±
                theme = 'theme-pay'; // ç±»ä¼¼æ”¯å‡º
            } else if (prevStatus === 'expired_fail' || prevStatus === 'fail') {
                recordFund = (Number(t.penalty) || 0); // æ’¤é”€æƒ©ç½šï¼ˆç›¸å½“äºæ”¶å…¥ï¼‰
                theme = 'theme-success';
            }
            
            if (recordFund !== 0) {
                saveRecord({
                    fund: recordFund,
                    title: `æ¢å¤: ${t.title}`,
                    theme: theme,
                    details: { type: 'Todoæ¢å¤', todoId: String(id) }
                }, false);
            }
        }
        
        // æ ‡è®°æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ—¶é—´
        t.updatedAt = Date.now();
        
        // æ›´æ–°UI
        renderTodos();
        updateUI();
        triggerAutoSave();
        closeAllMenus();
    }

    function autoCheckTodos() {
        if(isDeleting) return;
        const now = new Date(), currentHm = now.toTimeString().slice(0, 5), todayStr = getLocalTodayStr();
        let changed = false;

        todoList.forEach(t => {
            // é€¾æœŸåˆ¤å®šï¼š
            // - è·¨å¤©ï¼šæ—¥æœŸæ—©äºä»Šå¤©ä¸”ä» pending
            // - å½“å¤©ï¼šåˆ°è¾¾/è¶…è¿‡è®¾å®šæ—¶é—´ä¸”ä» pending
            const isOverdue =
                (t.status === 'pending') &&
                (
                    (t.date < todayStr) ||
                    (t.date === todayStr && currentHm >= t.time)
                );

            if (isOverdue) {
                if (t.type === 'dont') {
                    t.status = 'expired_success';
                    t.noteExpanded = false;
                    const recordId = Date.now();
                    addWallet(Number(t.reward)||0);
                    saveRecord({ fund: t.reward, title: t.title, theme: 'theme-success', details: { type: 'Todoç»“ç®—', result: 'expired_success', note: 'åšæŒè¾¾æˆ', recordType: 'todo-success', todoId: String(t.id) } }, false);
                    t.finishRecordId = recordId;
                    t.endedAt = Date.now(); // ç”¨â€œå…¥åˆ—æ—¶åˆ»â€æ’åºï¼ˆç¬¦åˆä½ çš„éœ€æ±‚ï¼‰
                    t.endedAtV = 1; // æ ‡è®°ï¼šæœ¬ç‰ˆæœ¬äº§ç”Ÿçš„â€œçœŸå®å…¥åˆ—æ—¶é—´â€
                    t.updatedAt = Date.now(); // è®°å½•æœ€è¿‘ä¸€æ¬¡çŠ¶æ€å˜æ›´æ—¶é—´
                    changed = true;
                } else {
                    t.status = 'expired_fail';
                    t.noteExpanded = false;
                    const recordId = Date.now();
                    addDebt(Number(t.penalty)||0);
                    saveRecord({ fund: -t.penalty, title: t.title, theme: 'theme-pay', details: { type: 'Todoç»“ç®—', result: 'expired_fail', note: 'è¶…æ—¶æœªå®Œæˆ', recordType: 'todo-fail', todoId: String(t.id) } }, false);
                    t.finishRecordId = recordId;
                    t.endedAt = Date.now(); // ç”¨â€œå…¥åˆ—æ—¶åˆ»â€æ’åºï¼ˆç¬¦åˆä½ çš„éœ€æ±‚ï¼‰
                    t.endedAtV = 1; // æ ‡è®°ï¼šæœ¬ç‰ˆæœ¬äº§ç”Ÿçš„â€œçœŸå®å…¥åˆ—æ—¶é—´â€
                    t.updatedAt = Date.now(); // è®°å½•æœ€è¿‘ä¸€æ¬¡çŠ¶æ€å˜æ›´æ—¶é—´
                    changed = true;
                }
            }
        });
        if (changed) { 
            renderTodos(); 
            updateUI(); 
            if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
            triggerAutoSave(); 
        }
    }

    function toggleShopPrivacy() {
        isShopPrivacyOn = !isShopPrivacyOn;
        const shopBtn = document.getElementById('shopPrivacyBtn');
        if (shopBtn) {
            shopBtn.innerText = isShopPrivacyOn ? 'ğŸ”’' : 'ğŸ”“';
        }
        renderShop();
    }

    function renderShop() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        // æ›´æ–°éšç§æŒ‰é’®çŠ¶æ€
        const shopPrivacyBtn = getEl('shopPrivacyBtn');
        if (shopPrivacyBtn) {
            shopPrivacyBtn.innerText = isShopPrivacyOn ? 'ğŸ”’' : 'ğŸ”“';
        }
        
        const list = getEl('shopList');
        if (!list) return;

        // æ³¨å…¥å…¬ç›Šé‡‘æŠµæ‰£å…‘æ¢é¡¹
        const rate = config.wishToDebtRate || 2;
        const exchangeItem = `
            <div class="list-item" style="background:rgba(255,193,7,0.05);">
                <div style="flex:1">
                    <div style="font-weight:bold;color:var(--text-main);">ğŸ›¡ï¸ å…¬ç›Šé‡‘æŠµæ‰£</div>
                    <div style="font-size:12px;color:var(--text-sub);opacity:0.8;">æ¶ˆè€— ${rate} æ„¿æœ›é‡‘ / æŠµ 1 å…¬ç›Šé‡‘</div>
                </div>
                <button class="btn-mini" style="background:var(--warning);color:#fff;" onclick="exchangeWishCoinForDebt()">å…‘æ¢</button>
            </div>
        `;

        if (wishList.length === 0) { 
            list.innerHTML = exchangeItem + '<div style="color:var(--text-sub);text-align:center;padding:30px;">æ„¿æœ›æ¸…å•ç©ºç©ºå¦‚ä¹Ÿ</div>'; 
            return; 
        }

        const itemsHtml = wishList.map((item, idx) => {
            const isHidden = item.hidden && isShopPrivacyOn;
            const nameDisplay = isHidden ? '******' : item.name;
            const btnState = isHidden ? 'disabled style="background:var(--border);cursor:not-allowed;"' : 'style="background:var(--warning);color:#fff;" onclick="buyItem(' + idx + ')"';

            const idSuffix = `shop-${idx}`;
            const showClass = (openMenuId === idSuffix) ? 'show' : '';

            const moveUp = idx > 0 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, -1)">â¬†ï¸</div>` : '';
            const moveDown = idx < wishList.length - 1 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, 1)">â¬‡ï¸</div>` : '';

            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold;color:var(--text-main);">${nameDisplay}</div>
                    <div style="font-size:12px;color:var(--warning);">${item.cost}</div>
                </div>
                <div style="display:flex;gap:4px; align-items:center;">
                    <button class="btn-mini" ${btnState}>å…‘æ¢</button>
                    <div class="btn-action" onclick="event.stopPropagation(); toggleMenu(event, '${idSuffix}')">â‹®</div>

                    <div id="menu-${idSuffix}" class="action-menu ${showClass}">
                        ${moveUp} ${moveDown}
                        <div class="btn-action btn-edit" onclick="editWish(${idx})">âœï¸</div>
                        <div class="btn-del btn-action" onclick="deleteWish(${idx})">ğŸ—‘ï¸</div>
                    </div>
                </div>
            </div>`;
        }).join('');
        
        list.innerHTML = exchangeItem + itemsHtml;
    }

    function exchangeWishCoinForDebt() {
        const cost = config.wishToDebtRate || 2;
        const benefit = 1;
        const currentWallet = getWallet();
        const currentDebt = getDebt();
        
        if (currentWallet < cost) {
            alert(`æ„¿æœ›é‡‘ä¸è¶³ï¼éœ€è¦ ${cost} å…ƒï¼Œå½“å‰åªæœ‰ ${currentWallet} å…ƒ`);
            return;
        }
        if (currentDebt <= 0) {
            alert("å½“å‰æ²¡æœ‰å¾…ç½šé‡‘ï¼Œæ— éœ€å…‘æ¢ï¼");
            return;
        }
        
        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${cost} å…ƒæ„¿æœ›é‡‘æŠµæ‰£ ${benefit} å…ƒå…¬ç›Šé‡‘ï¼Ÿ`)) return;
        
        // Deduct wallet
        addWallet(-cost);
        // Deduct debt (addDebt takes delta, so negative)
        addDebt(-benefit);
        
        saveRecord({
            fund: -cost,
            title: 'å…¬ç›Šé‡‘æŠµæ‰£',
            theme: 'theme-warning',
            details: { 
                type: 'exchange_debt', 
                wallet_change: -cost,
                debt_change: -benefit,
                note: `æ¶ˆè€— ${cost} æ„¿æœ›é‡‘æŠµæ‰£ ${benefit} å…¬ç›Šé‡‘`
            }
        }, false);
        
        calculateFunds();
        renderShop();
        alert("å…‘æ¢æˆåŠŸï¼");
    }

    function moveWish(index, direction) {
        if (direction === -1 && index > 0) { [wishList[index], wishList[index-1]] = [wishList[index-1], wishList[index]]; }
        else if (direction === 1 && index < wishList.length - 1) { [wishList[index], wishList[index+1]] = [wishList[index+1], wishList[index]]; }
        else return;
        renderShop(); triggerAutoSave();
    }
    
    function sortShopByPrice() {
        // æŒ‰ä»·æ ¼æ’åºæ„¿æœ›åˆ—è¡¨
        wishList.sort((a, b) => (a.cost || 0) - (b.cost || 0));
        renderShop();
        triggerAutoSave();
    }

    function editWish(index) {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const item = wishList[index];
        const wishNameEl = getEl('wishName');
        const wishCostEl = getEl('wishCost');
        if (wishNameEl) wishNameEl.value = item.name;
        if (wishCostEl) wishCostEl.value = item.cost;

        const checkbox = getEl('wishHidden');
        if (checkbox) {
            checkbox.checked = item.hidden || false;
            const wishHiddenLabel = getEl('wishHiddenLabel');
            if (wishHiddenLabel) {
                if(checkbox.checked) wishHiddenLabel.classList.add('checked');
                else wishHiddenLabel.classList.remove('checked');
            }
        }

        editingWishIndex = index;
        const btnShopAdd = getEl('btnShopAdd');
        const btnShopCancel = getEl('btnShopCancel');
        if (btnShopAdd) btnShopAdd.innerText = "ä¿å­˜";
        if (btnShopCancel) btnShopCancel.style.display = "inline-block";
        
        // å¦‚æœåœ¨modalä¸­ï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨
        if (isModalOpen && modalContent) {
            modalContent.scrollTo({top: 0, behavior: 'smooth'});
        } else {
            const shopCard = document.querySelector('#page-shop .card');
            if (shopCard) shopCard.scrollIntoView({behavior:'smooth'});
        }
    }

    function cancelShopEdit() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const wishNameEl = getEl('wishName');
        const wishCostEl = getEl('wishCost');
        const wishHiddenEl = getEl('wishHidden');
        const wishHiddenLabelEl = getEl('wishHiddenLabel');
        const btnShopAddEl = getEl('btnShopAdd');
        const btnShopCancelEl = getEl('btnShopCancel');
        
        if (wishNameEl) wishNameEl.value = '';
        if (wishCostEl) wishCostEl.value = '';
        if (wishHiddenEl) wishHiddenEl.checked = false;
        if (wishHiddenLabelEl) wishHiddenLabelEl.classList.remove('checked');

        editingWishIndex = -1;
        if (btnShopAddEl) btnShopAddEl.innerText = "ä¸Šæ¶";
        if (btnShopCancelEl) btnShopCancelEl.style.display = "none";
    }

    function togglePrivacyCheck() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const checkbox = getEl('wishHidden');
        const label = getEl('wishHiddenLabel');
        if (!checkbox || !label) return;
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) { label.classList.add('checked'); } else { label.classList.remove('checked'); }
    }

    function addWish() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const walletModal = document.getElementById('walletModal');
        const isModalOpen = walletModal && walletModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('walletModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const wishNameEl = getEl('wishName');
        const wishCostEl = getEl('wishCost');
        const checkbox = getEl('wishHidden');
        if (!wishNameEl || !wishCostEl || !checkbox) return;
        
        const n = wishNameEl.value.trim();
        const c = parseFloat(wishCostEl.value);
        const h = checkbox.checked;
        if(!n || !c || c <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®çš„åç§°å’Œä»·æ ¼");

        if (editingWishIndex > -1) {
            wishList[editingWishIndex] = {name:n, cost:c, hidden:h};
            cancelShopEdit();
        } else {
            wishList.push({name:n, cost:c, hidden:h});
            wishNameEl.value = '';
            wishCostEl.value = '';
            checkbox.checked = false;
            const wishHiddenLabelEl = getEl('wishHiddenLabel');
            if (wishHiddenLabelEl) wishHiddenLabelEl.classList.remove('checked');
        }
        renderShop(); triggerAutoSave();
    }
    function deleteWish(idx) { if(!confirm("ç¡®è®¤åˆ é™¤æ­¤å•†å“ï¼Ÿ")) return; wishList.splice(idx, 1); if(idx === editingWishIndex) cancelShopEdit(); renderShop(); triggerAutoSave(); }
    function buyItem(idx){
        const item = wishList[idx];
        if(globalWallet < item.cost) return alert(`âŒ ä½™é¢ä¸è¶³ï¼è¿˜å·® ${item.cost - globalWallet} å…ƒ`);
        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${item.cost} å…ƒå…‘æ¢ã€${item.name}ã€‘?`)) return;
        addWallet(-Number(item.cost)||0);
        saveRecord({fund: -item.cost, title:'å•†åº—å…‘æ¢', theme:'theme-shop', details:{item: item.name}}, false);
    }

    function handlePaymentWithCompress(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if(width > 800) { height *= 800 / width; width = 800; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                const payAmount = getDebt();
                setDebt(0);
                saveRecord({ fund: -payAmount, title: 'æ”¯ä»˜æ¸…é›¶', theme: 'theme-pay', details: { image: dataUrl, note: 'ä¸Šä¼ å‡­è¯æ¸…é›¶' } }, false);
                alert("âœ… æ”¯ä»˜å‡­è¯å·²ä¸Šä¼ ï¼Œå€ºåŠ¡å·²æ¸…é›¶ï¼");
                
                // æ¸…ç†å†…å­˜
                reader.onload = null;
                img.onload = null;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function handleDebtModalPayment(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if(width > 800) { height *= 800 / width; width = 800; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                const payAmount = getDebt();
                setDebt(0);
                saveRecord({ fund: -payAmount, title: 'æ”¯ä»˜æ¸…é›¶', theme: 'theme-pay', details: { image: dataUrl, note: 'ä¸Šä¼ å‡­è¯æ¸…é›¶' } }, false);
                alert("âœ… æ”¯ä»˜å‡­è¯å·²ä¸Šä¼ ï¼Œå€ºåŠ¡å·²æ¸…é›¶ï¼");
                
                // æ›´æ–°modalä¸­çš„æ˜¾ç¤º
                const debtModalAmount = document.getElementById('debtModalAmount');
                const payCard = input.closest('.card');
                if (payCard) {
                    // å¦‚æœå€ºåŠ¡å·²æ¸…é›¶ï¼Œéšè—æ”¯ä»˜å¡ç‰‡
                    if (globalDebt <= 0) {
                        payCard.style.display = 'none';
                    } else {
                        // å¦åˆ™æ›´æ–°é‡‘é¢æ˜¾ç¤º
                        if (debtModalAmount) {
                            debtModalAmount.innerText = globalDebt.toFixed(0);
                        }
                    }
                }
                
                // æ›´æ–°modalä¸­çš„å†å²åˆ—è¡¨
                if (typeof updateDebtModalHistoryList === 'function') {
                    updateDebtModalHistoryList();
                }
                
                // æ¸…ç†å†…å­˜
                reader.onload = null;
                img.onload = null;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function updateUI() {
        calculateFunds();
        if (timeBank < 0) timeBank = 0; // ç¡®ä¿æ—¶é—´é“¶è¡Œä¸ä¸ºè´Ÿæ•°
        document.getElementById('timeBankDisplay').innerText = (Number(timeBank) || 0).toFixed(1); // æ›´æ–°æ—¶é—´é“¶è¡Œæ˜¾ç¤º
        
        // Update checkin modal time bank display
        const timeBankBalanceDisplay = document.getElementById('timeBankBalanceDisplay');
        if (timeBankBalanceDisplay) timeBankBalanceDisplay.innerText = (Number(timeBank) || 0).toFixed(1);
        
        const list = document.getElementById('historyList');
        // ç¡®ä¿åªæ›´æ–°ä¸»é¡µé¢çš„historyListï¼Œä¸æ›´æ–°modalä¸­çš„
        if (list && !list.closest('#debtModalContent')) {
            if (historyData.length === 0) {
                list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
            } else {
                const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
                const displayedHistory = historyData.slice(0, limit);

                list.innerHTML = displayedHistory.map(i => {
                if (editingHistoryItemId === i.id) {
                    return `
                    <div class="inline-editor">
                        <div class="input-group"><label class="input-label">è®°å½•æ ‡é¢˜</label><input type="text" id="editItemTitle-${i.id}" value="${i.title}" style="font-weight:bold;"></div>
                        <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="editItemFund-${i.id}" value="${i.fund}"></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryItem(${i.id})">ğŸ’¾ ä¿å­˜</button>
                            <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                        </div>
                    </div>`;
                }

                let imgHtml = '';
                if(i.details && i.details.image) {
                    imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                }
                    return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; if(k==='todoId') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div> </div>`;
                }).join('');

                // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
                if (!historyFullView && historyData.length > limit) {
                    list.insertAdjacentHTML('beforeend', 
                        `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="å±•å¼€æ›´å¤š">
                            <span>å±•å¼€æ›´å¤š</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>`
                    );
                } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                    list.insertAdjacentHTML('beforeend', 
                        `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="æ”¶èµ·">
                            <span>æ”¶èµ·</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                        </div>`
                    );
                }
            }
        }

        const pendingCard = document.getElementById('pendingCard');
        const lastRecord = historyData[0];
        if (lastRecord && (lastRecord.theme === 'theme-repair' || lastRecord.theme === 'theme-fix')) {
            const fixPlan = lastRecord.details.r_fix || lastRecord.details.f_plan;
            if (fixPlan && pendingHiddenId !== lastRecord.id.toString()) {
                pendingCard.style.display = 'block';
                pendingCard.dataset.id = lastRecord.id;
                document.getElementById('pendingText').innerHTML = `${lastRecord.date}: ${fixPlan}`;
            } else { pendingCard.style.display = 'none'; }
        } else { pendingCard.style.display = 'none'; }

        const paySection = document.getElementById('paySection');
        if (globalDebt > 0) { paySection.style.display = 'block'; document.getElementById('debtAmount').innerText = (Number(globalDebt) || 0).toFixed(0); }
        else { paySection.style.display = 'none'; }
        renderStats(); renderShop();
        
        // æ›´æ–°æ‰“å¼€çš„modalæ˜¾ç¤º
        const timeBankModal = document.getElementById('timeBankModal');
        if (timeBankModal && timeBankModal.classList.contains('show')) {
            document.getElementById('timeBankModalDisplay').innerText = timeBank.toFixed(1);
        }
        
        const walletModal = document.getElementById('walletModal');
        if (walletModal && walletModal.classList.contains('show')) {
            document.getElementById('walletModalDisplay').innerText = globalWallet.toFixed(0);
        }
        
        const debtModal = document.getElementById('debtModal');
        if (debtModal && debtModal.classList.contains('show')) {
            document.getElementById('debtModalDisplay').innerText = globalDebt.toFixed(0);
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const todayStr = getLocalTodayStr();
            const todayHistory = historyData.filter(r => r.date === todayStr && !['theme-skip','theme-shop','theme-pay'].includes(r.theme));
            const todayStudy = todayHistory.reduce((a,c) => a + parseFloat(c.study||0), 0);
            const todayRate = todayHistory.length ? Math.round((todayHistory.filter(r => r.theme==='theme-success').length/todayHistory.length)*100) : 0;
            document.getElementById('debtStatStudy').innerText = todayStudy.toFixed(1) + 'h';
            document.getElementById('debtStatRate').innerText = todayRate + '%';
        }
        
        // æ›´æ–°debtModalä¸­çš„å†å²åˆ—è¡¨
        updateDebtModalHistoryList();
    }

    // æ›´æ–°debtModalä¸­çš„å†å²åˆ—è¡¨
    function updateDebtModalHistoryList() {
        const debtModal = document.getElementById('debtModal');
        const isModalOpen = debtModal && debtModal.classList.contains('show');
        if (!isModalOpen) return;
        
        const modalContent = document.getElementById('debtModalContent');
        if (!modalContent) return;
        
        const modalHistoryList = modalContent.querySelector('#historyList');
        
        // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (modalHistoryList) {
            if (historyData.length === 0) {
                modalHistoryList.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
            } else {
                const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
                const displayedHistory = historyData.slice(0, limit);
                
                modalHistoryList.innerHTML = displayedHistory.map(i => {
                    // ç¡®ä¿ç±»å‹ä¸€è‡´è¿›è¡Œæ¯”è¾ƒ
                    let isEditing = false;
                    if (editingHistoryItemId != null) {
                        const itemId = typeof i.id === 'string' ? parseInt(i.id, 10) : i.id;
                        const editingId = typeof editingHistoryItemId === 'string' ? parseInt(editingHistoryItemId, 10) : editingHistoryItemId;
                        isEditing = (editingId == itemId);
                    }
                    
                    if (isEditing) {
                        return `
                        <div class="inline-editor">
                            <div class="input-group"><label class="input-label">è®°å½•æ ‡é¢˜</label><input type="text" id="editItemTitle-${i.id}" value="${i.title}" style="font-weight:bold;"></div>
                            <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="editItemFund-${i.id}" value="${i.fund}"></div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="event.stopPropagation(); saveInlineHistoryItem(${i.id})">ğŸ’¾ ä¿å­˜</button>
                                <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="event.stopPropagation(); cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                            </div>
                        </div>`;
                    }
                    
                    let imgHtml = '';
                    if(i.details && i.details.image) {
                        imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                    }
                    return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; if(k==='todoId') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="event.stopPropagation(); editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="event.stopPropagation(); deleteItem(${i.id})">âœ•</div> </div> </div>`;
                }).join('');
                
                // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
                if (!historyFullView && historyData.length > limit) {
                    modalHistoryList.insertAdjacentHTML('beforeend', 
                        `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="historyFullView = true; updateDebtModalHistoryList(); updateUI();" title="å±•å¼€æ›´å¤š">
                            <span>å±•å¼€æ›´å¤š</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>`
                    );
                } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                    modalHistoryList.insertAdjacentHTML('beforeend', 
                        `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="historyFullView = false; updateDebtModalHistoryList(); updateUI();" title="æ”¶èµ·">
                            <span>æ”¶èµ·</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                        </div>`
                    );
                }
                
                // åœ¨å†å²æ¡£æ¡ˆåé¢æ·»åŠ è®¡æ—¶è®°å½•
                if (timerRecords && timerRecords.length > 0) {
                    const timerLimit = timerFullView ? timerRecords.length : (config.timerLimit || 5);
                    const displayedTimerRecords = timerRecords.slice(0, timerLimit);
                    
                    // æ·»åŠ åˆ†éš”çº¿
                    modalHistoryList.insertAdjacentHTML('beforeend', 
                        `<div style="border-top:1px solid var(--border); margin:12px 0; padding-top:12px;">
                            <div style="font-size:12px; color:var(--text-sub); font-weight:600; margin-bottom:8px;">â±ï¸ è®¡æ—¶è®°å½•</div>
                        </div>`
                    );
                    
                    // æ·»åŠ è®¡æ—¶è®°å½•
                    displayedTimerRecords.forEach(r => {
                        const startTime = r.startTime || calculateStartTime(r.time, r.duration);
                        const timerHtml = `
                            <div class="list-item">
                                <div style="flex:1">
                                    <div style="font-weight:bold; color:var(--text-main);">${formatTaskName(r.name)}</div>
                                    <div style="font-size:12px; color:var(--primary);">${r.duration}h | ${r.date} ${startTime} - ${r.time}</div>
                                    ${r.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px; background:var(--input-bg); padding:4px; border-radius:4px;">' + r.note + '</div>' : ''}
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <div class="btn-action" onclick="editTimerRecord(${r.id})">âœï¸</div>
                                    <div class="btn-action btn-del" onclick="deleteTimerRecord(${r.id})">âœ•</div>
                                </div>
                            </div>
                        `;
                        modalHistoryList.insertAdjacentHTML('beforeend', timerHtml);
                    });
                    
                    // å¦‚æœæœ‰æ›´å¤šè®¡æ—¶è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
                    if (!timerFullView && timerRecords.length > timerLimit) {
                        modalHistoryList.insertAdjacentHTML('beforeend', 
                            `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleTimerFullView(); updateDebtModalHistoryList();" title="å±•å¼€æ›´å¤š">
                                <span>å±•å¼€æ›´å¤š</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>`
                        );
                    } else if (timerFullView && timerRecords.length > (config.timerLimit || 5)) {
                        modalHistoryList.insertAdjacentHTML('beforeend', 
                            `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleTimerFullView(); updateDebtModalHistoryList();" title="æ”¶èµ·">
                                <span>æ”¶èµ·</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            </div>`
                        );
                    }
                }
            }
        }
        
        // åœ¨å†å²æ¡£æ¡ˆå¡ç‰‡åé¢æ·»åŠ æˆ–æ›´æ–°æ”¯ä»˜æƒ©ç½šé‡‘å¡ç‰‡
        // å…ˆç¡®ä¿globalDebtæ˜¯æœ€æ–°çš„
        if (typeof calculateFunds === 'function') {
            calculateFunds();
        }
        
        // å°è¯•é€šè¿‡å¤šç§æ–¹å¼æ‰¾åˆ°å†å²æ¡£æ¡ˆå¡ç‰‡
        let historyCard = null;
        if (modalHistoryList) {
            historyCard = modalHistoryList.closest('.card');
        }
        if (!historyCard) {
            // å¦‚æœé€šè¿‡historyListæ‰¾ä¸åˆ°ï¼Œå°è¯•ç›´æ¥æŸ¥æ‰¾åŒ…å«"å†å²æ¡£æ¡ˆ"æ–‡æœ¬çš„å¡ç‰‡
            const allCards = modalContent.querySelectorAll('.card');
            for (let card of allCards) {
                const cardTitle = card.querySelector('.card-title');
                if (cardTitle && (cardTitle.textContent.includes('å†å²æ¡£æ¡ˆ') || cardTitle.textContent.includes('å†å²'))) {
                    historyCard = card;
                    break;
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ”¯ä»˜å¡ç‰‡ï¼ˆé€šè¿‡IDæŸ¥æ‰¾ï¼‰
        let payCard = modalContent.querySelector('#debtModalPayCard');
        
        if (historyCard) {
            if (payCard) {
                // æ”¯ä»˜å¡ç‰‡å·²å­˜åœ¨ï¼Œæ›´æ–°æˆ–éšè—
                if (globalDebt > 0) {
                    payCard.style.display = 'block';
                    const debtModalAmount = payCard.querySelector('#debtModalAmount');
                    if (debtModalAmount) {
                        debtModalAmount.innerText = globalDebt.toFixed(0);
                    }
                } else {
                    payCard.style.display = 'none';
                }
            } else if (globalDebt > 0) {
                // æ”¯ä»˜å¡ç‰‡ä¸å­˜åœ¨ä¸”å€ºåŠ¡å¤§äº0ï¼Œåˆ›å»ºæ”¯ä»˜å¡ç‰‡
                payCard = document.createElement('div');
                payCard.id = 'debtModalPayCard';
                payCard.className = 'card';
                payCard.style.cssText = 'background:var(--danger-bg); border-color:var(--danger); text-align:center; margin-top:16px;';
                payCard.innerHTML = `
                    <div style="color:var(--danger); font-weight:800; font-size:28px; margin:10px 0;" id="debtModalAmount">${globalDebt.toFixed(0)}</div>
                    <div style="color:var(--danger); font-size:13px; margin-bottom:15px; opacity:0.8;">å¾…ç½šå…¬ç›Šé‡‘</div>
                    <button class="btn-calc" style="background:var(--danger); width:auto; margin:0 auto;" onclick="document.getElementById('debtModalFileInput').click()">ğŸ“¸ ä¸Šä¼ å‡­è¯å¹¶æ¸…é›¶</button>
                    <input type="file" id="debtModalFileInput" hidden accept="image/*" onchange="handleDebtModalPayment(this)">
                `;
                // åœ¨å†å²æ¡£æ¡ˆå¡ç‰‡åæ’å…¥æ”¯ä»˜å¡ç‰‡
                historyCard.insertAdjacentElement('afterend', payCard);
            }
        } else {
            // å¦‚æœæ‰¾ä¸åˆ°å†å²æ¡£æ¡ˆå¡ç‰‡ï¼Œä½†ä»ç„¶æœ‰å€ºåŠ¡ï¼Œå°è¯•åœ¨modalContentçš„æœ€åæ·»åŠ æ”¯ä»˜å¡ç‰‡
            if (!payCard && globalDebt > 0) {
                payCard = document.createElement('div');
                payCard.id = 'debtModalPayCard';
                payCard.className = 'card';
                payCard.style.cssText = 'background:var(--danger-bg); border-color:var(--danger); text-align:center; margin-top:16px;';
                payCard.innerHTML = `
                    <div style="color:var(--danger); font-weight:800; font-size:28px; margin:10px 0;" id="debtModalAmount">${globalDebt.toFixed(0)}</div>
                    <div style="color:var(--danger); font-size:13px; margin-bottom:15px; opacity:0.8;">å¾…ç½šå…¬ç›Šé‡‘</div>
                    <button class="btn-calc" style="background:var(--danger); width:auto; margin:0 auto;" onclick="document.getElementById('debtModalFileInput').click()">ğŸ“¸ ä¸Šä¼ å‡­è¯å¹¶æ¸…é›¶</button>
                    <input type="file" id="debtModalFileInput" hidden accept="image/*" onchange="handleDebtModalPayment(this)">
                `;
                modalContent.appendChild(payCard);
            }
        }
        
        // åŒæ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
        if (typeof renderStats === 'function') {
            renderStats();
        }
    }
    
    function cancelInlineEdit() {
        editingHistoryItemId = null;
        // å…ˆæ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²åˆ—è¡¨
        updateDebtModalHistoryList();
        // ç„¶åæ›´æ–°ä¸»é¡µé¢
        updateUI();
    }

    function editItem(id) {
        // ç¡®ä¿ ID æ˜¯æ•°å­—ç±»å‹
        editingHistoryItemId = typeof id === 'string' ? parseInt(id, 10) : id;
        // ç«‹å³æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²åˆ—è¡¨
        setTimeout(() => {
            updateDebtModalHistoryList();
        }, 0);
        // ç„¶åæ›´æ–°ä¸»é¡µé¢
        updateUI();
    }

    function saveInlineHistoryItem(id) {
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        
        // ä»ä¸»é¡µé¢æˆ–æ¨¡æ€æ¡†è·å–è¾“å…¥å€¼
        const debtModal = document.getElementById('debtModal');
        const isModalOpen = debtModal && debtModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('debtModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const titleEl = getEl(`editItemTitle-${id}`);
        const fundEl = getEl(`editItemFund-${id}`);
        
        if (!titleEl || !fundEl) return;
        
        const newTitle = titleEl.value.trim();
        const newFund = parseFloat(fundEl.value);
        
        if (!newTitle) return alert("è¯·è¾“å…¥æ ‡é¢˜");
        if (newFund === undefined || newFund === null) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");

        record.title = newTitle;
        record.fund = newFund;
        
        editingHistoryItemId = null;
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        
        // å…ˆæ›´æ–°ä¸»é¡µé¢ï¼ˆä½†ä¸è°ƒç”¨updateDebtModalHistoryListï¼Œé¿å…é‡å¤ï¼‰
        calculateFunds();
        document.getElementById('timeBankDisplay').innerText = (Number(timeBank) || 0).toFixed(1);
        
        const list = document.getElementById('historyList');
        if (list && !list.closest('#debtModalContent')) { // åªæ›´æ–°ä¸»é¡µé¢çš„ï¼Œä¸æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„
            if (historyData.length === 0) {
                list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
            } else {
                const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
                const displayedHistory = historyData.slice(0, limit);
                
                list.innerHTML = displayedHistory.map(i => {
                    if (editingHistoryItemId === i.id) {
                        return `
                        <div class="inline-editor">
                            <div class="input-group"><label class="input-label">è®°å½•æ ‡é¢˜</label><input type="text" id="editItemTitle-${i.id}" value="${i.title}" style="font-weight:bold;"></div>
                            <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="editItemFund-${i.id}" value="${i.fund}"></div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryItem(${i.id})">ğŸ’¾ ä¿å­˜</button>
                                <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                            </div>
                        </div>`;
                    }
                    
                    let imgHtml = '';
                    if(i.details && i.details.image) {
                        imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                    }
                    return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; if(k==='todoId') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div> </div>`;
                }).join('');
                
                if (!historyFullView && historyData.length > limit) {
                    list.insertAdjacentHTML('beforeend', 
                        `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="å±•å¼€æ›´å¤š">
                            <span>å±•å¼€æ›´å¤š</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>`
                    );
                } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                    list.insertAdjacentHTML('beforeend', 
                        `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="æ”¶èµ·">
                            <span>æ”¶èµ·</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                        </div>`
                    );
                }
            }
        }
        
        // å¼ºåˆ¶æ›´æ–°debtModalä¸­çš„å†å²åˆ—è¡¨ï¼ˆé‡ç”¨ä¹‹å‰å®šä¹‰çš„å˜é‡ï¼‰
        if (isModalOpen) {
            const modalContent = document.getElementById('debtModalContent');
            if (modalContent) {
                const modalHistoryList = modalContent.querySelector('#historyList');
                if (modalHistoryList) {
                    // ç«‹å³æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²åˆ—è¡¨
                    if (historyData.length === 0) {
                        modalHistoryList.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
                    } else {
                        const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
                        const displayedHistory = historyData.slice(0, limit);
                        
                        modalHistoryList.innerHTML = displayedHistory.map(i => {
                            let imgHtml = '';
                            if(i.details && i.details.image) {
                                imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                            }
                            return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; if(k==='todoId') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div> </div>`;
                        }).join('');
                        
                        // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
                        if (!historyFullView && historyData.length > limit) {
                            modalHistoryList.insertAdjacentHTML('beforeend', 
                                `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="å±•å¼€æ›´å¤š">
                                    <span>å±•å¼€æ›´å¤š</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </div>`
                            );
                        } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                            modalHistoryList.insertAdjacentHTML('beforeend', 
                                `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="æ”¶èµ·">
                                    <span>æ”¶èµ·</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                                </div>`
                            );
                        }
                    }
                }
                // åŒæ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
                if (typeof renderStats === 'function') {
                    renderStats();
                }
            }
        }
        
        // æ›´æ–°å…¶ä»–UIå…ƒç´ 
        const pendingCard = document.getElementById('pendingCard');
        const lastRecord = historyData[0];
        if (lastRecord && (lastRecord.theme === 'theme-repair' || lastRecord.theme === 'theme-fix')) {
            const fixPlan = lastRecord.details.r_fix || lastRecord.details.f_plan;
            if (fixPlan && pendingHiddenId !== lastRecord.id.toString()) {
                if (pendingCard) {
                    pendingCard.style.display = 'block';
                    pendingCard.dataset.id = lastRecord.id;
                    document.getElementById('pendingText').innerHTML = `${lastRecord.date}: ${fixPlan}`;
                }
            } else { 
                if (pendingCard) pendingCard.style.display = 'none'; 
            }
        } else { 
            if (pendingCard) pendingCard.style.display = 'none'; 
        }
        
        const paySection = document.getElementById('paySection');
        if (globalDebt > 0) { 
            if (paySection) {
                paySection.style.display = 'block'; 
                document.getElementById('debtAmount').innerText = (Number(globalDebt) || 0).toFixed(0); 
            }
        } else { 
            if (paySection) paySection.style.display = 'none'; 
        }
        
        if (typeof renderShop === 'function') renderShop();
        
        triggerAutoSave();
    }

    function closePendingCard() {
        const card = document.getElementById('pendingCard');
        const id = card.dataset.id;
        if(id) { pendingHiddenId = id.toString(); localStorage.setItem('habit_pending_hide', pendingHiddenId); card.style.display = 'none'; }
    }

    function calculateFunds() {
        globalWallet = getWallet();
        globalDebt = getDebt();
        
        // æ›´æ–°ä¸»é¡µé¢å’Œæ‰€æœ‰modalä¸­çš„ä½™é¢æ˜¾ç¤º
        const walletDisplay = document.getElementById('walletDisplay');
        if (walletDisplay) walletDisplay.innerText = (Number(globalWallet) || 0).toFixed(0);
        
        const shopWalletDisplay = document.getElementById('shopWalletDisplay');
        if (shopWalletDisplay) shopWalletDisplay.innerText = (Number(globalWallet) || 0).toFixed(0);
        
        // æ›´æ–°walletModalä¸­çš„ä½™é¢æ˜¾ç¤º
        const walletModal = document.getElementById('walletModal');
        if (walletModal && walletModal.classList.contains('show')) {
            const modalContent = document.getElementById('walletModalContent');
            if (modalContent) {
                const modalShopWalletDisplay = modalContent.querySelector('#shopWalletDisplay');
                if (modalShopWalletDisplay) modalShopWalletDisplay.innerText = (Number(globalWallet) || 0).toFixed(0);
            }
        }
        
        const debtDisplay = document.getElementById('debtDisplay');
        if (debtDisplay) debtDisplay.innerText = (Number(globalDebt) || 0).toFixed(0);
        
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœå¤´éƒ¨å€ºåŠ¡å¾½ç« ä¸­æ²¡æœ‰å•ç‹¬çš„ debtDisplay spanï¼Œä¹Ÿå¼ºåˆ¶æ›´æ–°å…¶æ–‡æœ¬
        const debtBadge = document.querySelector('.fund-badge.badge-debt');
        if (debtBadge) {
            const span = debtBadge.querySelector('#debtDisplay');
            if (span) {
                span.innerText = (Number(globalDebt) || 0).toFixed(0);
            } else {
                // ä¿ç•™å‰é¢çš„å›¾æ ‡ï¼Œåªæ›´æ–°æ•°å­—
                debtBadge.innerHTML = `ğŸ’¸ ${(Number(globalDebt) || 0).toFixed(0)}`;
            }
        }
    }

    function saveRecord(data, reload = true) { historyData.unshift({ id: Date.now(), date: document.getElementById('dateInput').value, ...data }); updateUI(); triggerAutoSave(); if(reload) setTimeout(() => location.reload(), 500); }

    function deleteItem(id){
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ\n(æ³¨æ„ï¼šå…³è”çš„æ•°å€¼è°ƒæ•´å°†è‡ªåŠ¨å›æ»š)")){
            // 1. å›æ»šæ—¶é—´é“¶è¡Œ
            let tbChange = 0;
            if (record.details && record.details.time_bank_change_val !== undefined) {
                tbChange = parseFloat(record.details.time_bank_change_val);
            } else if (record.details && record.details.time_bank_change !== undefined) {
                // å°è¯•ä»å­—ç¬¦ä¸²ä¸­æå–æ•°å€¼ (å…¼å®¹æ—§æ•°æ®)
                const match = String(record.details.time_bank_change).match(/([+-]?[\d\.]+)/);
                if (match) tbChange = parseFloat(match[1]);
                else tbChange = parseFloat(record.details.time_bank_change);
            } else if (record.title === "â³ æ—¶é—´é“¶è¡Œæ‰‹åŠ¨è°ƒèŠ‚" && record.details && record.details.note) {
                 const match = record.details.note.match(/([+-]?[\d\.]+)/);
                 if (match) tbChange = parseFloat(match[1]);
            }
            if (tbChange && !isNaN(tbChange)) {
                timeBank -= tbChange;
                localStorage.setItem('habit_time_bank_v1', timeBank);
                alert(`ğŸ”„ æ—¶é—´é“¶è¡Œå·²å›æ»š: ${tbChange > 0 ? '-' : '+'}${Math.abs(tbChange).toFixed(1)}h`);
            }

            // 2. å›æ»šæ„¿æœ›é‡‘
            let wChange = 0;
            if (record.details && record.details.wallet_change !== undefined) {
                wChange = parseFloat(record.details.wallet_change);
            } else if (record.title === "ğŸ’° æ„¿æœ›é‡‘æ‰‹åŠ¨è°ƒèŠ‚" && record.fund !== undefined) {
                wChange = parseFloat(record.fund);
            } else if (record.details && record.details.type === 'checkin' && record.fund > 0) {
                wChange = parseFloat(record.fund);
            }
            if (wChange && !isNaN(wChange)) {
                let currentWallet = getWallet();
                currentWallet -= wChange;
                setWallet(currentWallet);
                alert(`ğŸ”„ æ„¿æœ›é‡‘å·²å›æ»š: ${wChange > 0 ? '-' : '+'}${Math.abs(wChange)}`);
            }

            // 3. å›æ»šå¾…ç½šé‡‘
            let dChange = 0;
            if (record.details && record.details.debt_change !== undefined) {
                dChange = parseFloat(record.details.debt_change);
            } else if (record.title === "ğŸ’¸ å¾…ç½šé‡‘æ‰‹åŠ¨è°ƒèŠ‚" && record.fund !== undefined) {
                dChange = parseFloat(record.fund);
            } else if (record.details && record.details.type === 'checkin' && record.fund < 0) {
                dChange = Math.abs(parseFloat(record.fund));
            }
            if (dChange && !isNaN(dChange)) {
                let currentDebt = getDebt();
                currentDebt -= dChange;
                setDebt(currentDebt);
                alert(`ğŸ”„ å¾…ç½šé‡‘å·²å›æ»š: ${dChange > 0 ? '-' : '+'}${Math.abs(dChange)}`);
            }

            historyData = historyData.filter(i => i.id !== id);
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            
            // å…ˆæ›´æ–°ä¸»é¡µé¢ï¼ˆä½†ä¸è°ƒç”¨updateDebtModalHistoryListï¼Œé¿å…é‡å¤ï¼‰
            calculateFunds();
            document.getElementById('timeBankDisplay').innerText = (Number(timeBank) || 0).toFixed(1);
            
            const list = document.getElementById('historyList');
            if (list && !list.closest('#debtModalContent')) { // åªæ›´æ–°ä¸»é¡µé¢çš„ï¼Œä¸æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„
                if (historyData.length === 0) {
                    list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
                } else {
                    const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
                    const displayedHistory = historyData.slice(0, limit);
                    
                    list.innerHTML = displayedHistory.map(i => {
                        if (editingHistoryItemId === i.id) {
                            return `
                            <div class="inline-editor">
                                <div class="input-group"><label class="input-label">è®°å½•æ ‡é¢˜</label><input type="text" id="editItemTitle-${i.id}" value="${i.title}" style="font-weight:bold;"></div>
                                <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="editItemFund-${i.id}" value="${i.fund}"></div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryItem(${i.id})">ğŸ’¾ ä¿å­˜</button>
                                    <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                                </div>
                            </div>`;
                        }
                        
                        let imgHtml = '';
                        if(i.details && i.details.image) {
                            imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                        }
                        return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; if(k==='todoId') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div> </div>`;
                    }).join('');
                    
                    if (!historyFullView && historyData.length > limit) {
                        list.insertAdjacentHTML('beforeend', 
                            `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="å±•å¼€æ›´å¤š">
                                <span>å±•å¼€æ›´å¤š</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>`
                        );
                    } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                        list.insertAdjacentHTML('beforeend', 
                            `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="æ”¶èµ·">
                                <span>æ”¶èµ·åˆ—è¡¨</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            </div>`
                        );
                    }
                }
            }
            
            // å¼ºåˆ¶æ›´æ–°debtModalä¸­çš„å†å²åˆ—è¡¨
            const debtModal = document.getElementById('debtModal');
            const isModalOpen = debtModal && debtModal.classList.contains('show');
            if (isModalOpen) {
                const modalContent = document.getElementById('debtModalContent');
                if (modalContent) {
                    const modalHistoryList = modalContent.querySelector('#historyList');
                    if (modalHistoryList) {
                        // ç«‹å³æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²åˆ—è¡¨
                        if (historyData.length === 0) {
                            modalHistoryList.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
                        } else {
                            const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
                            const displayedHistory = historyData.slice(0, limit);
                            
                            modalHistoryList.innerHTML = displayedHistory.map(i => {
                                let imgHtml = '';
                                if(i.details && i.details.image) {
                                    imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                                }
                                return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; if(k==='todoId') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div> </div>`;
                            }).join('');
                            
                            // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
                            if (!historyFullView && historyData.length > limit) {
                                modalHistoryList.insertAdjacentHTML('beforeend', 
                                    `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="å±•å¼€æ›´å¤š">
                                        <span>å±•å¼€æ›´å¤š</span>
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </div>`
                                );
                            } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                                modalHistoryList.insertAdjacentHTML('beforeend', 
                                    `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleHistoryFullView()" title="æ”¶èµ·">
                                        <span>æ”¶èµ·åˆ—è¡¨</span>
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                                    </div>`
                                );
                            }
                        }
                    }
                    // åŒæ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
                    if (typeof renderStats === 'function') {
                        renderStats();
                    }
                }
            }
            
            // æ›´æ–°å…¶ä»–UIå…ƒç´ 
            const pendingCard = document.getElementById('pendingCard');
            const lastRecord = historyData[0];
            if (lastRecord && (lastRecord.theme === 'theme-repair' || lastRecord.theme === 'theme-fix')) {
                const fixPlan = lastRecord.details.r_fix || lastRecord.details.f_plan;
                if (fixPlan && pendingHiddenId !== lastRecord.id.toString()) {
                    if (pendingCard) {
                        pendingCard.style.display = 'block';
                        pendingCard.dataset.id = lastRecord.id;
                        document.getElementById('pendingText').innerHTML = `${lastRecord.date}: ${fixPlan}`;
                    }
                } else { 
                    if (pendingCard) pendingCard.style.display = 'none'; 
                }
            } else { 
                if (pendingCard) pendingCard.style.display = 'none'; 
            }
            
            const paySection = document.getElementById('paySection');
            if (globalDebt > 0) { 
                if (paySection) {
                    paySection.style.display = 'block'; 
                    document.getElementById('debtAmount').innerText = (Number(globalDebt) || 0).toFixed(0); 
                }
            } else { 
                if (paySection) paySection.style.display = 'none'; 
            }
            
            if (typeof renderShop === 'function') renderShop();
            
            triggerAutoSave();
        }
    }

    function autoCalculate() {
        tempTimeDiff = 0; useTimeBank = false;
        const studyInput = document.getElementById('studyInput');
        const studyVal = studyInput.value === '' ? null : parseFloat(studyInput.value);
        const sleepVal = document.getElementById('sleepInput').value;
        const wakeVal = document.getElementById('wakeInput').value;

        if (studyVal === null || studyVal === undefined || isNaN(studyVal) || studyVal < 0 || !sleepVal || !wakeVal) { 
            const card = document.getElementById('analysisCard');
            card.style.display = 'block';
            card.style.textAlign = 'center';
            card.innerHTML = `<div style="color:var(--danger); font-weight:bold; padding:20px;">âš ï¸ è¯·å¡«å…¨æ‰“å¡æ•°æ®åå†ç»“ç®—</div>`;
            return; 
        }

        const limitWake = todayIsWeekend ? config.wakeW : config.wake;
        const limitSleep = todayIsWeekend ? config.sleepW : config.sleep;
        const p = config.penalties;
        let penalty = 0, reasons = [], faults = [], types = [];

        const diff = studyVal - config.study;
        tempTimeDiff = diff;

        if (diff < 0) {
            if (timeBank >= Math.abs(diff)) {
                if(confirm(`ä¸“æ³¨æ—¶é•¿ä¸è¶³ ${Math.abs(diff)}hã€‚\nä½™é¢: ${timeBank.toFixed(1)}hã€‚\n\næ˜¯å¦æ¶ˆè€—å­˜æ¬¾æŠµæ¶ˆæƒ©ç½šï¼Ÿ`)) {
                    useTimeBank = true;
                } else {
                    types.push('study');
                    const gap = Math.abs(diff);
                    if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`å°‘å­¦<1h`); faults.push("è½»å¾®å°‘å­¦"); }
                    else { penalty += parseFloat(p.studyL); reasons.push(`å°‘å­¦â‰¥1h`); faults.push("ä¸¥é‡å°‘å­¦"); }
                }
            } else {
                types.push('study');
                const gap = Math.abs(diff);
                if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`å°‘å­¦<1h`); faults.push("è½»å¾®å°‘å­¦"); }
                else { penalty += parseFloat(p.studyL); reasons.push(`å°‘å­¦â‰¥1h`); faults.push("ä¸¥é‡å°‘å­¦"); }
            }
        }

        if (wakeVal > limitWake) { types.push('wake'); const diffW = toMin(wakeVal) - toMin(limitWake); if (diffW < 30) { penalty += parseFloat(p.wakeS); reasons.push(`æ™šèµ·<30m`); faults.push("è½»å¾®æ™šèµ·"); } else { penalty += parseFloat(p.wakeL); reasons.push(`æ™šèµ·â‰¥30m`); faults.push("ä¸¥é‡æ™šèµ·"); } }
        const actSleep = toAdjMin(sleepVal); const limSleep = toAdjMin(limitSleep);
        if (actSleep > limSleep) { types.push('sleep'); const diffS = actSleep - limSleep; if (diffS < 60) { penalty += parseFloat(p.sleepS); reasons.push(`æ™šç¡<1h`); faults.push("è½»å¾®æ™šç¡"); } else { penalty += parseFloat(p.sleepL); reasons.push(`æ™šç¡â‰¥1h`); faults.push("ä¸¥é‡æ™šç¡"); } }

        defaultFund = penalty > 0 ? -penalty : parseFloat(config.reward || 5);
        calcReason = penalty > 0 ? reasons.join(' | ') : "ğŸ‰ å®Œç¾è¾¾æ ‡å¥–åŠ±";
        if(useTimeBank && penalty === 0) calcReason = "âœ¨ å®Œç¾è¾¾æ ‡ (æ—¶é—´é“¶è¡ŒæŠµç”¨)";

        failedTypes = types;
        document.getElementById('analysisCard').style.display = 'block';
        document.getElementById('analysisCard').innerHTML = `<div style="font-weight:700;color:var(--primary);padding:15px;text-align:center;">è¯Šæ–­å®Œæˆï¼Œè¯·åœ¨ä¸‹æ–¹ç¡®è®¤ç»“æœ...</div>`;
        renderForm(penalty > 0 ? (faults.length >= 2 ? 'repair' : 'fix') : 'success', null, useTimeBank);
    }

    function renderForm(type, extraInfo = null, isUsingBank = false) {
        const con = document.getElementById('formContainer');
        con.style.display = 'block';
        document.getElementById('inputCard').style.opacity = '0.5';
        document.getElementById('inputCard').style.pointerEvents = 'none';
        
        let inputs = [], title = '', theme = '', extraHTML = '';
        if (type === 'skip') {
            title = 'ğŸ›Œ ç”³è¯·ä¼‘æ¯'; theme = 'theme-skip'; defaultFund = 0; 
            inputs = [{l:'ç”³è¯·åŸå› ', id:'s_reason', p:'å¿…å¡«'}]; 
            extraHTML = `<div style="font-size:12px;color:var(--text-sub);background:var(--input-bg);padding:10px;border-radius:10px;margin-bottom:12px;">æœ¬æœˆå·²ä¼‘æ¯ ${extraInfo} æ¬¡</div>`;
        } else if (type === 'prevent') {
            title = 'ä¸»åŠ¨å¹²é¢„'; theme = 'theme-prevent';
            const cost = config.preventCost || 10;
            defaultFund = -cost;
            inputs = [{l:'å¹²é¢„è¯´æ˜', id:'p_fix', p:'è¯´æ˜æ¥ä¸‹æ¥çš„è¡ŒåŠ¨è®¡åˆ’'}];
            extraHTML = `<div style="font-size:12px;color:var(--info);background:var(--input-bg);padding:10px;border-radius:10px;margin-bottom:12px;">é£é™©å¯¹å†²é‡‘: ${cost} å…ƒ</div>`;
        } else if (type === 'repair') {
            title = 'æ·±åº¦ä¿®å¤'; theme = 'theme-repair'; 
            inputs = [{l:'å¤±æ§å¤ç›˜', id:'r_reason', p:'åˆ†æåŸå› '}, {l:'è¡¥æ•‘æªæ–½', id:'r_fix', p:'æ˜æ—¥å±•ç¤º'}];
        } else if (type === 'fix') {
            title = 'ä¸€çº§ä¿®æ­£'; theme = 'theme-fix'; 
            inputs = [{l:'åå·®åŸå› ', id:'f_reason', p:'ç®€å•æè¿°'}, {l:'è¡¥å¿è®¡åˆ’', id:'f_plan', p:'æ˜æ—¥å±•ç¤º'}];
        } else {
            title = 'ğŸ‰ å®Œç¾è¾¾æ ‡'; theme = 'theme-success'; 
            inputs = [{l:'ä»Šæ—¥æˆå°±', id:'s_note', p:'è®°ä¸‹ä¸€ä»¶å¼€å¿ƒçš„äº‹'}];
        }

        let moneyTip = defaultFund >= 0 ? `å¥–åŠ±: +${defaultFund}` : `æ‰£ç½š: ${defaultFund}`; 
        if (defaultFund === 0) moneyTip = "æ— èµ„é‡‘å˜åŠ¨";

        let timeTip = '';
        if (isUsingBank) {
            timeTip = `<div style="font-size:12px;color:var(--time);background:var(--time-bg);padding:10px;border-radius:10px;margin-bottom:10px;">é“¶è¡Œæ”¯å‡º: -${Math.abs(tempTimeDiff).toFixed(1)}h</div>`;
        }

        extraHTML += timeTip + `
            <div style="font-size:13px; font-weight:bold; color:${defaultFund>=0?'var(--success)':'var(--danger)'}; background:var(--bg-card); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px; text-align:center;">
                ${moneyTip} å…ƒæ„¿æœ›é‡‘<br>
                <span style="font-weight:normal; opacity:0.8; font-size:11px; color:var(--text-sub)">${calcReason}</span>
            </div>`;

        let html = `
            <div class="card" style="margin-top:0px; border-top: 4px solid ${theme==='theme-success'?'var(--success)':'var(--warning)'}; animation: slideDown 0.4s ease;">
                <div class="card-title">${title}</div>
                ${extraHTML}
                <div style="background:var(--input-bg); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <span style="font-size:13px; font-weight:bold;">æœ€ç»ˆé‡‘é¢:</span>
                        <div style="display:flex;align-items:center;"><span style="margin-right:4px;">Â¥</span><input type="number" id="fundInput" value="${defaultFund}" oninput="checkFundEdit()" style="width:80px; padding:8px; text-align:right;"></div>
                    </div>
                    <div id="fundReasonBox" style="display:none; margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                        <label style="font-size:11px; color:var(--danger); font-weight:bold;">âš ï¸ é‡‘é¢å·²ä¿®æ”¹ï¼Œè¯·å¡«å†™åŸå› :</label>
                        <input type="text" id="fundReason" placeholder="å¿…å¡«..." style="margin-top:4px; font-size:13px;">
                    </div>
                </div>
                ${inputs.map(i => `<div class="input-group"><label class="input-label">${i.l}</label><textarea id="${i.id}" placeholder="${i.p||''}" rows="2"></textarea></div>`).join('')}
                <div id="strategyArea" class="chips-container" style="margin-bottom:15px;"></div>
                <button class="btn-calc" onclick="submitForm('${theme}', '${title}')" style="margin-top:10px;">âœ“ ç¡®è®¤æäº¤</button>
                <button class="btn-calc btn-secondary" onclick="cancelForm()" style="margin-top:8px;">âœ• å–æ¶ˆ</button>
            </div>`;
        con.innerHTML = html;
        if (['theme-repair', 'theme-fix'].includes(theme)) renderStrategies();
    }

    function checkFundEdit() { 
        const val = parseFloat(document.getElementById('fundInput').value); 
        const box = document.getElementById('fundReasonBox'); 
        if (val !== defaultFund) { box.style.display = 'block'; } else { box.style.display = 'none'; } 
    }

    function cancelForm() {
        // æ£€æŸ¥æ˜¯å¦åœ¨checkinModalä¸­
        const checkinModal = document.getElementById('checkinModal');
        const isModalOpen = checkinModal && checkinModal.classList.contains('show');
        
        const getEl = (elId) => {
            if (isModalOpen) {
                const modalFormContainer = checkinModal.querySelector('#checkinModalFormContainer');
                if (modalFormContainer) {
                    const el = modalFormContainer.querySelector('#' + elId);
                    if (el) return el;
                }
            }
            return document.getElementById(elId);
        };
        
        const formContainer = getEl('formContainer');
        if (formContainer) formContainer.style.display = 'none';
        
        const analysisCard = getEl('analysisCard');
        if (analysisCard) analysisCard.style.display = 'none';
        
        const inputCard = document.getElementById('inputCard');
        if (inputCard) {
            inputCard.style.opacity = '1';
            inputCard.style.pointerEvents = 'auto';
        }
    }

    function submitForm(theme, title) {
        // æ£€æŸ¥æ˜¯å¦åœ¨checkinModalä¸­
        const checkinModal = document.getElementById('checkinModal');
        const isModalOpen = checkinModal && checkinModal.classList.contains('show');
        const modalContent = isModalOpen ? checkinModal : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                // åœ¨modalä¸­æŸ¥æ‰¾
                const modalFormContainer = modalContent.querySelector('#checkinModalFormContainer');
                if (modalFormContainer) {
                    const el = modalFormContainer.querySelector('#' + elId);
                    if (el) return el;
                }
                // ä¹Ÿåœ¨checkinModalCheckinAreaä¸­æŸ¥æ‰¾
                const checkinArea = modalContent.querySelector('#checkinModalCheckinArea');
                if (checkinArea) {
                    const el = checkinArea.querySelector('#' + elId);
                    if (el) return el;
                }
            }
            return document.getElementById(elId);
        };
        
        const getFormContainer = () => {
            if (isModalOpen && modalContent) {
                const modalFormContainer = modalContent.querySelector('#checkinModalFormContainer');
                if (modalFormContainer) return modalFormContainer;
            }
            return document.getElementById('formContainer');
        };
        
        const sReasonEl = getEl('s_reason');
        if (theme === 'theme-skip' && (!sReasonEl || !sReasonEl.value.trim())) return alert("è¯·å¡«å†™ç”³è¯·åŸå› ");
        
        const rFixEl = getEl('r_fix');
        if (theme === 'theme-repair' && (!rFixEl || !rFixEl.value.trim())) return alert("è¯·å¡«å†™è¡¥æ•‘æªæ–½");
        
        const fundInputEl = getEl('fundInput');
        if (!fundInputEl) return;
        const fund = parseFloat(fundInputEl.value);
        
        const fundReasonEl = getEl('fundReason');
        const fundReason = fundReasonEl ? fundReasonEl.value : '';
        if (fund !== defaultFund && !fundReason.trim()) return alert("âš ï¸ è¯·å¡«å†™æ‰‹åŠ¨ä¿®æ”¹é‡‘é¢çš„åŸå› ï¼");

        let details = {};
        const formContainer = getFormContainer();
        if (formContainer) {
            formContainer.querySelectorAll('textarea, input[type=text]').forEach(i => { 
                if(i.id !== 'fundReason' && i.id.indexOf('input_')!==0) details[i.id] = i.value;
            });
        }

        // ç»Ÿä¸€å¤„ç†æ‰“å¡åŸå§‹æ•°æ®
        const studyInputEl = getEl('studyInput') || getEl('checkinModalStudyInput');
        const sleepInputEl = getEl('sleepInput') || getEl('checkinModalSleepInput');
        const wakeInputEl = getEl('wakeInput') || getEl('checkinModalWakeInput');
        const dateInputEl = getEl('dateInput') || getEl('checkinModalDateInput');
        
        const studyVal = studyInputEl ? parseFloat(studyInputEl.value) : null;
        const sleepVal = sleepInputEl ? sleepInputEl.value : null;
        const wakeVal = wakeInputEl ? wakeInputEl.value : null;
        const dateStr = dateInputEl ? dateInputEl.value : document.getElementById('dateInput').value;
        
        if (studyVal) details.study = studyVal;
        if (sleepVal) details.sleep = sleepVal;
        if (wakeVal) details.wake = wakeVal;

        if (useTimeBank) {
            timeBank -= Math.abs(tempTimeDiff);
            details['time_bank_change'] = `-${Math.abs(tempTimeDiff).toFixed(1)}h`;
            localStorage.setItem('habit_time_bank_v1', timeBank);
        }

        if (calcReason && fund < 0 && theme !== 'theme-prevent') details['penalty_rule'] = calcReason;
        if (fund !== defaultFund) details['manual_edit_reason'] = fundReason;

        if (Number.isFinite(fund)) { if (fund >= 0) addWallet(fund); else addDebt(Math.abs(fund)); }
        // ä¿å­˜è®°å½•ï¼Œä¸é‡æ–°åŠ è½½é¡µé¢
        saveRecord({ fund, title, theme, details }, false);
        
        // å…³é—­è¡¨å•å®¹å™¨
        cancelForm();
        
        // å¦‚æœæ˜¯åœ¨checkinModalä¸­ï¼Œå…³é—­å¼¹çª—
        if (isModalOpen) {
            closeCheckinModal();
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ‰“å¡ç•Œé¢çŠ¶æ€
        const todayStr = getLocalTodayStr();
        if (dateStr && dateStr === todayStr) {
            const hasCheckin = historyData.some(r => r.date === dateStr && ['theme-success','theme-fix','theme-repair','theme-prevent','theme-skip'].includes(r.theme));
            if (hasCheckin) {
                const inputCard = document.getElementById('inputCard');
                if (inputCard) {
                    inputCard.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-sub);">ä»Šæ—¥å·²å®Œæˆæ‰“å¡</div>';
                }
                // éšè—æ ‡é¢˜åˆ‡æ¢æŒ‰é’®ï¼Œç›´æ¥æ˜¾ç¤ºå¾…åŠè§†å›¾
                const toggleContainer = document.querySelector('.toggle-container');
                if (toggleContainer) toggleContainer.style.display = 'none';
                toggleHomeView('todo');
            }
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        updateUI();
    }

    function quickSelectTask(name) {
        // æ£€æŸ¥æ˜¯å¦åœ¨å¼¹å‡ºçª—å£ä¸­
        const timerModal = document.getElementById('timerModal');
        const isModalOpen = timerModal && timerModal.classList.contains('show');
        
        // æ›´æ–°ä¸»é¡µé¢
        const mainTaskName = document.getElementById('timerTaskName');
        if (mainTaskName) {
            mainTaskName.value = name;
        }
        
        // å¦‚æœå¼¹å‡ºçª—å£æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å¼¹å‡ºçª—å£
        if (isModalOpen) {
            const modalTaskName = document.querySelector('#timerModalContent #timerTaskNameModal');
            if (modalTaskName) {
                modalTaskName.value = name;
            }
        }
        
        // ç»Ÿè®¡ä½¿ç”¨é¢‘æ¬¡ï¼ˆä½¿ç”¨è§„èŒƒåŒ–åç§°ï¼Œå¿½ç•¥å›¾æ ‡ï¼‰
        const normalizedName = normalizeTaskName(name);
        if (!taskUsageCount[normalizedName]) taskUsageCount[normalizedName] = 0;
        taskUsageCount[normalizedName]++;
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        
        // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ’åº
        renderQuickTasks();
        
        // å¦‚æœå¼¹å‡ºçª—å£æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å¼¹å‡ºçª—å£çš„å¿«æ·ä»»åŠ¡
        if (isModalOpen) {
            const modalQuickTasks = document.querySelector('#timerModalContent #quickTasksContainerModal');
            if (modalQuickTasks && typeof renderQuickTasks === 'function') {
                const originalId = document.getElementById('quickTasksContainer').id;
                document.getElementById('quickTasksContainer').id = 'quickTasksContainerTemp';
                modalQuickTasks.id = 'quickTasksContainer';
                renderQuickTasks();
                modalQuickTasks.id = 'quickTasksContainerModal';
                document.getElementById('quickTasksContainerTemp').id = 'quickTasksContainer';
            }
        }
    }

    function selectTodoForTimer(todoId) {
        // ç¡®ä¿èƒ½å¤„ç†å­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹çš„ID
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        const todo = todoList.find(t => String(t.id) === id);
        if (!todo) {
            console.warn('å¾…åŠæœªæ‰¾åˆ°:', todoId);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å¼¹å‡ºçª—å£ä¸­
        const timerModal = document.getElementById('timerModal');
        const isModalOpen = timerModal && timerModal.classList.contains('show');
        
        // è®¾ç½®ä¸»é¡µé¢ä»»åŠ¡åç§°
        const taskNameInput = document.getElementById('timerTaskName');
        if (taskNameInput) {
            taskNameInput.value = todo.title;
            // åœ¨ä»»åŠ¡åç§°è¾“å…¥æ¡†ä¸Šå­˜å‚¨todoIdï¼Œæ–¹ä¾¿ç»“æŸæ—¶è¯†åˆ«
            taskNameInput.setAttribute('data-todo-id', id);
        }
        
        // å¦‚æœå¼¹å‡ºçª—å£æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å¼¹å‡ºçª—å£
        if (isModalOpen) {
            const modalTaskName = document.querySelector('#timerModalContent #timerTaskNameModal');
            if (modalTaskName) {
                modalTaskName.value = todo.title;
                modalTaskName.setAttribute('data-todo-id', id);
            }
        }
        
        // è®¾ç½®ä¸»é¡µé¢ç»“æŸæ—¶é—´ï¼ˆå¦‚æœå¾…åŠæœ‰æˆªæ­¢æ—¶é—´ï¼‰
        if (todo.time) {
            const endTimeInput = document.getElementById('timerPlannedEndTime');
            if (endTimeInput) endTimeInput.value = todo.time;
            
            // å¦‚æœå¼¹å‡ºçª—å£æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å¼¹å‡ºçª—å£
            if (isModalOpen) {
                const modalEndTime = document.querySelector('#timerModalContent #timerPlannedEndTimeModal');
                if (modalEndTime) modalEndTime.value = todo.time;
            }
        }
        
        // å¦‚æœæœ‰å¤‡æ³¨ï¼Œä¹Ÿå¯ä»¥å¡«å……åˆ°å¤‡æ³¨æ¡†
        if (todo.note) {
            const noteInput = document.getElementById('timerNote');
            if (noteInput) noteInput.value = todo.note;
            
            // å¦‚æœå¼¹å‡ºçª—å£æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å¼¹å‡ºçª—å£
            if (isModalOpen) {
                const modalNote = document.querySelector('#timerModalContent #timerNoteModal');
                if (modalNote) modalNote.value = todo.note;
            }
        }
    }

    function addPlannedTask() {
        const name = document.getElementById('timerTaskName').value.trim();
        const note = document.getElementById('timerNote').value.trim();
        const plannedTime = document.getElementById('timerPlannedTime').value;
        const plannedEndTime = document.getElementById('timerPlannedEndTime').value;
        if (!name) return alert("è¯·è¾“å…¥è®¡åˆ’çš„ä»»åŠ¡åç§°");

        const plan = {
            id: Date.now(),
            name: name,
            note: note,
            plannedTime: plannedTime,
            plannedEndTime: plannedEndTime
        };

        plannedTasks.push(plan);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆä»…åœ¨ç©ºé—²æ—¶ï¼‰
        if (!timerRunning) {
            document.getElementById('timerTaskName').value = '';
            document.getElementById('timerNote').value = '';
            initTimerTime();
            document.getElementById('timerPlannedEndTime').value = '';
        }
        
        renderPlannedTasks();
        triggerAutoSave();
        
        if (timerRunning) {
            alert("âœ… è®¡åˆ’å·²æ·»åŠ ï¼å½“å‰è®¡æ—¶ä»»åŠ¡ä¸å—å½±å“ã€‚");
        }
    }
    
    // è®¡æ—¶å™¨è¿è¡Œæ—¶æ·»åŠ è®¡åˆ’ä»»åŠ¡ï¼ˆä½¿ç”¨ç®€å•å¯¹è¯æ¡†ï¼‰
    function addPlannedTaskWhileRunning() {
        const taskName = prompt("è¯·è¾“å…¥æ–°è®¡åˆ’çš„ä»»åŠ¡åç§°ï¼š");
        if (!taskName || !taskName.trim()) return;
        
        const plannedTime = prompt("è®¡åˆ’å¼€å§‹æ—¶é—´ï¼ˆæ ¼å¼ HH:MMï¼Œå¯ç•™ç©ºï¼‰ï¼š", "");
        const plannedEndTime = prompt("è®¡åˆ’ç»“æŸæ—¶é—´ï¼ˆæ ¼å¼ HH:MMï¼Œå¯ç•™ç©ºï¼‰ï¼š", "");
        const note = prompt("å¤‡æ³¨ï¼ˆå¯ç•™ç©ºï¼‰ï¼š", "") || '';
        
        // éªŒè¯æ—¶é—´æ ¼å¼ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
        if (plannedTime && plannedTime.trim() && !/^\d{1,2}:\d{2}$/.test(plannedTime.trim())) {
            alert("âŒ å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MM");
            return;
        }
        if (plannedEndTime && plannedEndTime.trim() && !/^\d{1,2}:\d{2}$/.test(plannedEndTime.trim())) {
            alert("âŒ ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MM");
            return;
        }
        
        const plan = {
            id: Date.now(),
            name: taskName.trim(),
            note: note.trim(),
            plannedTime: (plannedTime || '').trim(),
            plannedEndTime: (plannedEndTime || '').trim()
        };
        
        plannedTasks.push(plan);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        renderPlannedTasks();
        triggerAutoSave();
        
        alert(`âœ… è®¡åˆ’ã€Œ${taskName.trim()}ã€å·²æ·»åŠ ï¼\n\nå½“å‰è®¡æ—¶ä»»åŠ¡ã€Œ${document.getElementById('timerTaskName').value}ã€ç»§ç»­è¿è¡Œä¸­ã€‚`);
    }

    function renderPlannedTasks() {
        const list = document.getElementById('plannedTasksList');
        if (plannedTasks.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:10px;font-size:13px;">æš‚æ— è®¡åˆ’ï¼Œå¿«å»æ·»åŠ ä¸€ä¸ªå§</div>';
            return;
        }

        // æŒ‰æ—¶é—´æ’åºï¼Œæ—©çš„æ—¶é—´æ’åœ¨å‰é¢
        plannedTasks.sort((a, b) => {
            const timeA = a.plannedTime || '99:99';
            const timeB = b.plannedTime || '99:99';
            return timeA.localeCompare(timeB);
        });

        list.innerHTML = plannedTasks.map(p => {
            if (editingPlannedId === p.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">ä»»åŠ¡åç§°</label><input type="text" id="editPlanName-${p.id}" value="${p.name}" style="font-weight:bold;"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">èµ·å§‹æ—¶é—´</label><input type="time" id="editPlanStart-${p.id}" value="${p.plannedTime || ''}"></div>
                        <div class="input-group"><label class="input-label">ç»“æŸæ—¶é—´</label><input type="time" id="editPlanEnd-${p.id}" value="${p.plannedEndTime || ''}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">å¤‡æ³¨</label><textarea id="editPlanNote-${p.id}" style="min-height:60px;">${p.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlinePlannedTask(${p.id})">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                    </div>
                </div>`;
            }

            const idSuffix = `plan-${p.id}`;
            const showClass = openMenuId === idSuffix ? 'show' : '';

            return `
            <div class="list-item" style="border-left: 4px solid var(--info); padding-right: 8px;">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${p.name} 
                        ${p.plannedTime || p.plannedEndTime ? `
                        <span style="font-size:11px; color:var(--info); background:var(--border); padding:2px 6px; border-radius:4px; margin-left:4px;">
                            ${p.plannedTime || '--:--'}${p.plannedEndTime ? ' - ' + p.plannedEndTime : ''}
                        </span>` : ''}
                    </div>
                    ${p.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px;">' + p.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:4px; align-items:center;">
                    <button class="btn-mini" style="background:var(--success); color:#fff; padding:6px 10px;" onclick="startFromPlan(${p.id})">â–¶ï¸ å¼€å§‹</button>
                    
                    <div style="position:relative;">
                        <div class="btn-action" onclick="togglePlanMenu(event, '${idSuffix}')">â‹®</div>
                        <div id="menu-${idSuffix}" class="action-menu action-menu-dropdown ${showClass}">
                            <div class="btn-mini" style="background:var(--time); color:#fff; width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="completePlannedTask(${p.id})">âœ… å®Œæˆä»»åŠ¡</div>
                            <div class="btn-mini" style="background:var(--warning); color:#fff; width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="abandonPlannedTask(${p.id})">ğŸš« æ”¾å¼ƒä»»åŠ¡</div>
                            <div class="btn-mini" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="togglePinTask(${p.id})">
                                ${pinnedTaskId == p.id ? 'å–æ¶ˆç½®é¡¶' : 'è®¾ä¸ºç½®é¡¶'}
                            </div>
                            <div class="btn-mini" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="editPlannedTask(${p.id})">âœï¸ ç¼–è¾‘</div>
                            <div class="btn-mini" style="background:var(--danger-bg); color:var(--danger); border:1px solid var(--danger); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="deletePlannedTask(${p.id})">ğŸ—‘ï¸ åˆ é™¤è®¡åˆ’</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function togglePlanMenu(event, id) {
        event.stopPropagation();
        if (openMenuId === id) {
            openMenuId = null;
        } else {
            closeAllMenus();
            openMenuId = id;
        }
        renderPlannedTasks();
    }

    let currentReviewDate = getLocalTodayStr();

    function saveDailyReview(showMsg = false) {
        const date = currentReviewDate;
        const great = document.getElementById('reviewGreat').value.trim();
        const improve = document.getElementById('reviewImprove').value.trim();
        const insight = document.getElementById('reviewInsight').value.trim();
        
        if (!dailyReviews[date]) dailyReviews[date] = {};
        dailyReviews[date].great = great;
        dailyReviews[date].improve = improve;
        dailyReviews[date].insight = insight;
        
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        triggerAutoSave();
        
        if(showMsg) alert(`âœ… ${date === getLocalTodayStr() ? 'ä»Šæ—¥' : date} å¤ç›˜å·²ä¿å­˜`);
        
        // ä¿å­˜åé‡ç½®å›ä»Šæ—¥ï¼Œé˜²æ­¢è¯¯æ“ä½œè¦†ç›–å†å²
        currentReviewDate = getLocalTodayStr();
    }

    function loadDailyReview() {
        const date = getLocalTodayStr();
        const review = dailyReviews[date] || { great: '', improve: '', insight: '' };
        document.getElementById('reviewGreat').value = review.great || '';
        document.getElementById('reviewImprove').value = review.improve || '';
        document.getElementById('reviewInsight').value = review.insight || '';
    }

    function toggleHistoryReview() {
        const area = document.getElementById('reviewHistoryArea');
        const inputArea = document.getElementById('reviewInputArea');
        const saveBtn = document.getElementById('btnSaveReview');
        isReviewHistoryOpen = !isReviewHistoryOpen;
        
        if (isReviewHistoryOpen) {
            area.style.display = 'block';
            inputArea.style.display = 'none';
            saveBtn.style.display = 'none';
            renderHistoryReviews();
        } else {
            area.style.display = 'none';
            inputArea.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            // åˆ‡æ¢å›æ¥æ—¶ï¼Œç¡®ä¿åŠ è½½çš„æ˜¯ä»Šæ—¥å†…å®¹ï¼Œé™¤éç”¨æˆ·æ­£åœ¨ç¼–è¾‘å†å²
            if (currentReviewDate === getLocalTodayStr()) {
                loadDailyReview();
            }
        }
    }

    function renderHistoryReviews() {
        const list = document.getElementById('reviewHistoryList');
        const sortedDates = Object.keys(dailyReviews).sort((a,b) => b.localeCompare(a));
        
        if (sortedDates.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">æš‚æ— å†å²å¤ç›˜è®°å½•</div>';
            return;
        }

        list.innerHTML = sortedDates.map(date => {
            const r = dailyReviews[date];
            if (!r || (!r.great && !r.improve && !r.insight)) return '';
            return `
                <div class="review-history-item">
                    <div class="review-history-date">${date}</div>
                    ${r.great ? `
                        <div class="review-history-label">çœŸæ£’:</div>
                        <div class="review-history-content">${r.great}</div>
                    ` : ''}
                    ${r.improve ? `
                        <div class="review-history-label">åŠ æ²¹:</div>
                        <div class="review-history-content">${r.improve}</div>
                    ` : ''}
                    ${r.title ? `
                        <div class="review-history-label">æ ‡é¢˜:</div>
                        <div class="review-history-content" style="font-weight:600;">${r.title}</div>
                    ` : ''}
                    ${r.insight ? `
                        <div class="review-history-label">å†…å®¹:</div>
                        <div class="review-history-content">${r.insight}</div>
                    ` : ''}
                    <div style="text-align:right; margin-top:8px;">
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); font-size:10px;" onclick="editHistoricalReview('${date}')">âœï¸ ç¼–è¾‘</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editHistoricalReview(date) {
        const r = dailyReviews[date];
        if (!r) return;
        
        document.getElementById('reviewGreat').value = r.great || '';
        document.getElementById('reviewImprove').value = r.improve || '';
        document.getElementById('reviewInsight').value = r.insight || '';
        currentReviewDate = date; // åˆ‡æ¢ä¿å­˜ç›®æ ‡æ—¥æœŸ
        
        // è‡ªåŠ¨åˆ‡å›åˆ°è¾“å…¥æ¨¡å¼
        isReviewHistoryOpen = false;
        document.getElementById('reviewHistoryArea').style.display = 'none';
        document.getElementById('reviewInputArea').style.display = 'block';
        document.getElementById('btnSaveReview').style.display = 'inline-block';
        alert(`å·²è°ƒå‡º ${date} çš„å¤ç›˜å†…å®¹ï¼Œä¿®æ”¹åç‚¹å‡»ä¿å­˜å°†æ›´æ–°è¯¥æ—¥è®°å½•ã€‚`);
    }

    function editPlannedTask(id) {
        editingPlannedId = id;
        renderPlannedTasks();
    }

    function saveInlinePlannedTask(id) {
        const p = plannedTasks.find(x => x.id === id);
        if (!p) return;

        const name = document.getElementById(`editPlanName-${id}`).value.trim();
        const start = document.getElementById(`editPlanStart-${id}`).value;
        const end = document.getElementById(`editPlanEnd-${id}`).value;
        const note = document.getElementById(`editPlanNote-${id}`).value.trim();

        if (!name) return alert("è¯·è¾“å…¥åç§°");

        p.name = name;
        p.plannedTime = start;
        p.plannedEndTime = end;
        p.note = note;

        editingPlannedId = null;
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        renderPlannedTasks();
        updateStickyNotif(); // æ›´æ–°ç½®é¡¶é€šçŸ¥
        triggerAutoSave();
    }

    function togglePinTask(id) {
        if (pinnedTaskId == id) {
            pinnedTaskId = null;
        } else {
            pinnedTaskId = id;
        }
        localStorage.setItem('habit_pinned_task_id', pinnedTaskId || '');
        renderPlannedTasks();
        updateStickyNotif();
        triggerAutoSave();
    }

    function unpinTask() {
        pinnedTaskId = null;
        localStorage.setItem('habit_pinned_task_id', '');
        renderPlannedTasks();
        updateStickyNotif();
        triggerAutoSave();
    }

    function startPinnedTask() {
        let taskId = pinnedTaskId;
        // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨ç½®é¡¶ï¼Œåˆ™å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ€è¿‘çš„ä»»åŠ¡
        if (!taskId) {
            const next = getNextPlannedTask();
            if (next) taskId = next.id;
        }

        if (taskId) {
            startFromPlan(parseInt(taskId));
            if (pinnedTaskId == taskId) unpinTask();
        }
    }

    function getNextPlannedTask() {
        if (plannedTasks.length === 0) return null;
        const nowHm = new Date().toTimeString().slice(0, 5);
        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªèµ·å§‹æ—¶é—´å¤§äºç­‰äºå½“å‰æ—¶é—´çš„ä»»åŠ¡
        // (plannedTasks å·²ç»æŒ‰æ—¶é—´æ’å¥½åºäº†)
        return plannedTasks.find(p => p.plannedTime && p.plannedTime >= nowHm) || null;
    }

    // è®¡ç®—ä»Šå¤©å·²å­¦ä¹ æ—¶é—´ï¼ˆåªç»Ÿè®¡ä»»åŠ¡ååŒ…å«"å­¦ä¹ "çš„è®¡æ—¶ï¼Œä½¿ç”¨è§„èŒƒåŒ–åç§°åŒ¹é…ï¼‰
    function getTodayStudyTime() {
        const todayStr = getLocalTodayStr();
        const studyRecords = timerRecords.filter(r => {
            if (!r.name || r.date !== todayStr) return false;
            const normalizedName = normalizeTaskName(r.name);
            return normalizedName.includes('å­¦ä¹ ') || normalizedName.toLowerCase().includes('study');
        });
        const totalHours = studyRecords.reduce((sum, r) => sum + parseFloat(r.duration || 0), 0);
        return totalHours;
    }

    function updateStickyNotif() {
        const bar = document.getElementById('stickyNotifBar');
        const notifTimer = document.getElementById('notifTimer');
        const notifPinned = document.getElementById('notifPinned');
        const notifQuickStudy = document.getElementById('notifQuickStudy');
        
        let hasContent = false;

        // 1. æ›´æ–°è®¡æ—¶å™¨é€šçŸ¥
        if (timerRunning) {
            notifTimer.style.display = 'flex';
            const taskName = document.getElementById('timerTaskName').value || 'ä»»åŠ¡';
            document.getElementById('notifTimerName').innerText = formatTaskName(taskName);
            // æ›´æ–°æš‚åœæŒ‰é’®æ–‡å­—
            const pauseBtn = document.getElementById('notifTimerPauseBtn');
            if (pauseBtn) {
                pauseBtn.innerText = timerPaused ? 'â–¶ï¸' : 'â¸ï¸';
            }
            hasContent = true;
            // è®¡æ—¶è¿è¡Œæ—¶éšè—å­¦ä¹ å¿«é€ŸæŒ‰é’®
            if (notifQuickStudy) notifQuickStudy.style.display = 'none';
        } else {
            notifTimer.style.display = 'none';
            // è®¡æ—¶æœªè¿è¡Œæ—¶ï¼Œæ ¹æ®é…ç½®æ˜¾ç¤ºå­¦ä¹ å¿«é€ŸæŒ‰é’®
            const interfaceConfig = config.interface || { showQuickStudy: true };
            if (notifQuickStudy && interfaceConfig.showQuickStudy !== false) {
                notifQuickStudy.style.display = 'flex';
                // æ›´æ–°ä»Šå¤©å·²å­¦ä¹ æ—¶é—´
                const studyTime = getTodayStudyTime();
                const studyTimeEl = document.getElementById('notifStudyTime');
                if (studyTimeEl) {
                    studyTimeEl.innerText = studyTime.toFixed(1) + 'h';
                }
                hasContent = true;
            } else if (notifQuickStudy) {
                notifQuickStudy.style.display = 'none';
            }
        }

        // 2. æ›´æ–°ç½®é¡¶é€šçŸ¥ (ä¼˜å…ˆæ‰‹åŠ¨ç½®é¡¶ï¼Œå…¶æ¬¡è‡ªåŠ¨æ˜¾ç¤ºä¸‹ä¸€ä¸ªæœ€è¿‘ä»»åŠ¡)
        let displayTask = null;
        let isAutoPinned = false;

        if (pinnedTaskId) {
            displayTask = plannedTasks.find(x => x.id == pinnedTaskId);
            if (!displayTask) {
                pinnedTaskId = null;
                localStorage.setItem('habit_pinned_task_id', '');
            }
        }

        if (!displayTask) {
            displayTask = getNextPlannedTask();
            isAutoPinned = !!displayTask;
        }

        if (displayTask) {
            notifPinned.style.display = 'flex';
            const prefix = isAutoPinned ? 'ä¸‹ä¸€è®¡åˆ’: ' : 'ç½®é¡¶è®¡åˆ’: ';
            document.getElementById('notifPinnedName').innerText = displayTask.name;
            document.getElementById('notifPinnedTime').innerText = displayTask.plannedTime ? `${prefix}${displayTask.plannedTime}` : prefix;
            hasContent = true;
        } else {
            notifPinned.style.display = 'none';
        }

        // 3. æ›´æ–°ç½®é¡¶å€’æ•°æ—¥
        if (typeof renderPinnedDaysMatter === 'function') {
            if (renderPinnedDaysMatter()) {
                hasContent = true;
            }
        }

        bar.style.display = hasContent ? 'flex' : 'none';
    }

    // è§„èŒƒåŒ–ä»»åŠ¡åç§°ï¼šå»é™¤æ‰€æœ‰å›¾æ ‡/emojiï¼Œåªä¿ç•™æ–‡å­—å†…å®¹ï¼ˆç”¨äºç»Ÿè®¡åˆ†ç»„ï¼‰
    function normalizeTaskName(taskName) {
        if (!taskName) return taskName;
        // ç§»é™¤æ‰€æœ‰ emoji å’Œå›¾æ ‡ï¼ˆåŒ…æ‹¬ ğŸ“š ç­‰ï¼‰ï¼Œåªä¿ç•™æ–‡å­—
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¸¸è§çš„ emoji æ¨¡å¼ï¼ŒåŒ…æ‹¬ï¼š
        // - å¸¸ç”¨ç¬¦å·å’Œå›¾æ ‡ (U+1F300-U+1F9FF)
        // - æ‚é¡¹ç¬¦å· (U+2600-U+26FF)
        // - è£…é¥°ç¬¦å· (U+2700-U+27BF)
        // - è¡¥å……ç¬¦å·å’Œè±¡å½¢æ–‡å­— (U+1F900-U+1F9FF)
        // - ç¬¦å·å’Œè±¡å½¢æ–‡å­—æ‰©å±•-A (U+1FA00-U+1FAFF)
        let normalized = taskName.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FAFF}]/gu, '');
        // ç§»é™¤å¯èƒ½æ®‹ç•™çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
        normalized = normalized.replace(/\s+/g, ' ').trim();
        return normalized;
    }
    
    // æ ¼å¼åŒ–ä»»åŠ¡åç§°ï¼šç¡®ä¿"å­¦ä¹ "ç»Ÿä¸€æ˜¾ç¤ºä¸º"ğŸ“š å­¦ä¹ "
    function formatTaskName(taskName) {
        if (!taskName) return taskName;
        const trimmed = taskName.trim();
        // å¦‚æœä»»åŠ¡åæ˜¯"å­¦ä¹ "ï¼ˆä¸å¸¦å›¾æ ‡ï¼‰ï¼Œæ·»åŠ å›¾æ ‡
        if (trimmed === 'å­¦ä¹ ' && !trimmed.startsWith('ğŸ“š')) {
            return 'ğŸ“š å­¦ä¹ ';
        }
        return taskName;
    }
    
    // å¿«é€Ÿå¯åŠ¨"å­¦ä¹ "è®¡æ—¶
    function quickStartStudy(taskName = 'å­¦ä¹ ') {
        if (timerRunning) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'å·²æœ‰è®¡æ—¶åœ¨è¿›è¡Œä¸­ï¼Œè¯·å…ˆç»“æŸå½“å‰è®¡æ—¶',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }
        
        // ä¸è·³è½¬åˆ°è®¡æ—¶é¡µé¢ï¼Œåªåœ¨å½“å‰é¡µé¢å¼€å§‹è®¡æ—¶
        
        // è®¾ç½®ä»»åŠ¡åç§°ï¼ˆå¦‚æœè®¡æ—¶å™¨é¡µé¢å­˜åœ¨ï¼‰
        const timerTaskName = document.getElementById('timerTaskName');
        if (timerTaskName) {
            timerTaskName.value = formatTaskName(taskName);
        }
        
        // ç›´æ¥å¼€å§‹è®¡æ—¶
        setTimeout(() => {
            startTimer();
        }, 100);
    }
    
    // ä»é€šçŸ¥æ ç›´æ¥å¼€å§‹è®¡æ—¶ï¼ˆä½¿ç”¨å½“å‰æ˜¾ç¤ºçš„ä»»åŠ¡åç§°ï¼‰
    function quickStartFromNotif() {
        const label = document.getElementById('notifStudyLabel');
        const taskName = label ? label.innerText.replace(/^ğŸ“š\s*/, '').trim() : 'å­¦ä¹ ';
        quickStartStudy(taskName);
    }
    
    // æ˜¾ç¤ºå¿«é€‰ä»»åŠ¡èœå•
    function showQuickTaskSelectMenu(event) {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        
        const menu = document.getElementById('quickTaskSelectMenu');
        if (!menu) {
            console.error('quickTaskSelectMenu not found');
            return;
        }
        
        // è·å–æ‰€æœ‰å¿«é€‰ä»»åŠ¡
        const tasks = config.quickTasks || [];
        // é»˜è®¤"å­¦ä¹ "åœ¨æœ€å‰é¢ï¼Œå¹¶å»é‡ï¼ˆè¿‡æ»¤æ‰quickTasksä¸­çš„"å­¦ä¹ "æˆ–"ğŸ“š å­¦ä¹ "ï¼‰
        const defaultTask = 'å­¦ä¹ ';
        // è¿‡æ»¤æ‰æ‰€æœ‰å½¢å¼çš„"å­¦ä¹ "ä»»åŠ¡ï¼ˆå¸¦å›¾æ ‡æˆ–ä¸å¸¦å›¾æ ‡ï¼‰
        const filteredTasks = tasks.filter(t => {
            const taskName = t.replace(/^ğŸ“š\s*/, '').trim(); // ç§»é™¤å¯èƒ½çš„ğŸ“šå›¾æ ‡å‰ç¼€
            return taskName !== 'å­¦ä¹ ' && t !== 'å­¦ä¹ ' && t !== 'ğŸ“š å­¦ä¹ ';
        });
        const uniqueTasks = [defaultTask, ...filteredTasks];
        
        // ç”Ÿæˆèœå•å†…å®¹
        menu.innerHTML = uniqueTasks.map(task => {
            // é»˜è®¤çš„"å­¦ä¹ "æ·»åŠ å›¾æ ‡
            const displayText = task === defaultTask ? `ğŸ“š ${task}` : task;
            return `<div style="padding:8px 12px; cursor:pointer; border-radius:8px; margin-bottom:4px; text-align:left; white-space:nowrap; background:var(--input-bg); transition:background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='var(--input-bg)'" onclick="event.stopPropagation(); selectQuickTaskAndStart('${task.replace(/'/g, "\\'")}')">${displayText}</div>`;
        }).join('');
        
        // åˆ‡æ¢æ˜¾ç¤º/éšè—
        const isShown = menu.style.display !== 'none' && menu.style.display !== '';
        if (isShown) {
            menu.style.display = 'none';
        } else {
            menu.style.display = 'flex';
            console.log('èœå•å·²æ˜¾ç¤º', menu, menu.style.display);
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            const closeHandler = function(e) {
                if (!menu.contains(e.target) && e.target !== event.target) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 100);
        }
    }
    
    // é€‰æ‹©å¿«é€‰ä»»åŠ¡å¹¶å¼€å§‹è®¡æ—¶
    function selectQuickTaskAndStart(taskName) {
        const menu = document.getElementById('quickTaskSelectMenu');
        if (menu) menu.style.display = 'none';
        quickStartStudy(taskName);
    }
    
    // ä»å¾…åŠé¡¹å¿«é€Ÿå¼€å§‹è®¡æ—¶
    function startTimerFromTodo(todoId) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„è®¡æ—¶å™¨
        if (timerRunning) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'å·²æœ‰è®¡æ—¶åœ¨è¿›è¡Œä¸­ï¼Œè¯·å…ˆç»“æŸå½“å‰è®¡æ—¶',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }
        
        // å…³é—­æ‰€æœ‰èœå•
        closeAllMenus();
        
        // è·å–å¾…åŠä¿¡æ¯
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        const todo = todoList.find(t => String(t.id) === id);
        if (!todo) {
            console.warn('å¾…åŠæœªæ‰¾åˆ°:', todoId);
            return;
        }
        
        // å¦‚æœè®¡æ—¶é¡µé¢çš„è¾“å…¥æ¡†å­˜åœ¨ï¼Œæ›´æ–°å®ƒä»¬ï¼ˆç”¨äºå…¼å®¹ï¼‰
        const taskNameInput = document.getElementById('timerTaskName');
        if (taskNameInput) {
            taskNameInput.value = todo.title;
            taskNameInput.setAttribute('data-todo-id', id);
        }
        const noteInput = document.getElementById('timerNote');
        if (noteInput) noteInput.value = todo.note || '';
        const endTimeInput = document.getElementById('timerPlannedEndTime');
        if (endTimeInput) endTimeInput.value = todo.time || '';
        
        // ç›´æ¥å¼€å§‹è®¡æ—¶ï¼ˆä¸è·³è½¬é¡µé¢ï¼‰
        timerRunning = true;
        timerPaused = false;
        timerSeconds = 0;
        isTimerFromPlan = false;
        
        // å…ˆä¿å­˜ä¸€æ¬¡çŠ¶æ€ï¼ˆåŒ…å«ä»»åŠ¡åç§°ï¼‰ï¼Œç¡®ä¿å³ä½¿è¾“å…¥æ¡†ä¸å­˜åœ¨ä¹Ÿèƒ½ä¿å­˜
        const startTimestamp = Date.now();
        const timerState = {
            running: true,
            paused: false,
            seconds: 0,
            taskName: todo.title,
            note: todo.note || '',
            todoId: id,
            fromPlan: false,
            lastUpdate: Date.now(),
            startTimestamp: startTimestamp
        };
        localStorage.setItem('habit_timer_state_v1', JSON.stringify(timerState));
        
        // æ›´æ–°UIï¼ˆå¦‚æœè®¡æ—¶é¡µé¢å¯è§ï¼‰
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'none';
        if (activeBtns) activeBtns.style.display = 'flex';
        
        updateTimerModalButtons();
        updateStickyNotif(); // æ˜¾ç¤ºç½®é¡¶é€šçŸ¥æ 
        triggerAutoSave();
        
        // å¯åŠ¨è®¡æ—¶å™¨
        timerInterval = setInterval(() => {
            if (!timerPaused) {
                timerSeconds++;
                updateTimerUI();
                saveTimerState();
            }
        }, 1000);
        
        // å¯åŠ¨äº‘ç«¯åŒæ­¥
        timerSyncInterval = setInterval(async () => {
            if (timerRunning && ((ghConfig.token && ghConfig.repo) || (giteeConfig.token && giteeConfig.repo))) {
                console.log('ğŸ”„ å®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€...');
                await syncAll('pull', true);
                if (timerRunning) {
                    triggerAutoSave();
                }
            } else if (timerRunning) {
                saveTimerState();
            }
        }, 30000);
    }

    function startFromPlan(id) {
        const plan = plannedTasks.find(x => x.id === id);
        if (!plan) return;

        if (timerRunning) return alert("å·²æœ‰è®¡æ—¶åœ¨è¿›è¡Œä¸­ï¼Œè¯·å…ˆç»“æŸå½“å‰è®¡æ—¶");

        document.getElementById('timerTaskName').value = plan.name;
        document.getElementById('timerNote').value = plan.note || '';
        document.getElementById('timerPlannedTime').value = plan.plannedTime || '';
        document.getElementById('timerPlannedEndTime').value = plan.plannedEndTime || '';
        
        isTimerFromPlan = true; // æ ‡è®°æ¥è‡ªè®¡åˆ’

        // ä»è®¡åˆ’ä¸­ç§»é™¤
        plannedTasks = plannedTasks.filter(x => x.id !== id);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        renderPlannedTasks();
        startTimer(true); // ä¼ å…¥ true è¡¨ç¤ºä¸é‡ç½® isTimerFromPlan
        triggerAutoSave(); // ç¡®ä¿ä»è®¡åˆ’å¼€å§‹ä¹ŸåŒæ­¥
    }

    function completePlannedTask(id) {
        const p = plannedTasks.find(x => x.id === id);
        if (!p) return;
        
        // å¦‚æœå·²ç»æœ‰èµ·æ­¢æ—¶é—´ï¼Œç›´æ¥å®Œæˆ
        if (p.plannedTime && p.plannedEndTime) {
            const hours = getTimeDiff(p.plannedTime, p.plannedEndTime);
            if (hours > 0) {
                const record = {
                    id: Date.now(),
                    name: formatTaskName(p.name),
                    duration: hours.toFixed(2),
                    seconds: Math.floor(hours * 3600),
                    note: p.note,
                    date: getLocalTodayStr(),
                    startTime: p.plannedTime,
                    time: p.plannedEndTime,
                    isPlanned: true
                };
                timerRecords.unshift(record);
                if (pinnedTaskId == id) unpinTask(); // å¦‚æœå®Œæˆçš„æ˜¯ç½®é¡¶ä»»åŠ¡ï¼Œå–æ¶ˆç½®é¡¶
                plannedTasks = plannedTasks.filter(x => x.id !== id);
                localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
                localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                renderTimerHistory();
                renderPlannedTasks();
                
                // è¯¢é—®æ˜¯å¦æ·»åŠ å¥–åŠ±é‡‘
                showModal({
                    title: 'âœ… å®Œæˆè®¡åˆ’',
                    message: `è®¡åˆ’ä»»åŠ¡ã€Œ${p.name}ã€å·²å®Œæˆ\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶\n\næ˜¯å¦æ·»åŠ æ„¿æœ›é‡‘ï¼ˆå¥–åŠ±ï¼‰ï¼Ÿ`,
                    buttons: [
                        { text: 'ä¸æ·»åŠ ', primary: false, callback: () => {
                            updateUI();
                            triggerAutoSave();
                        }},
                        { text: 'æ·»åŠ å¥–åŠ±', primary: true, callback: () => {
                            showModal({
                                title: 'æ·»åŠ å¥–åŠ±é‡‘',
                                message: `ä»»åŠ¡ï¼š${p.name}\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶`,
                                inputs: [
                                    { id: 'planRewardAmount', label: 'é‡‘é¢ï¼ˆå…ƒï¼‰', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢', value: '' },
                                    { id: 'planRewardReason', label: 'åŸå› /å¤‡æ³¨', type: 'textarea', placeholder: 'è®°å½•ä¸€ä¸‹åŸå› ', value: `å®Œæˆè®¡åˆ’ä»»åŠ¡ã€Œ${p.name}ã€` }
                                ],
                                buttons: [
                                    { text: 'å–æ¶ˆ', primary: false, callback: () => {
                                        updateUI();
                                        triggerAutoSave();
                                    }},
                                    { text: 'ç¡®è®¤æ·»åŠ ', primary: true, callback: (values) => {
                                        const amount = parseFloat(values.planRewardAmount);
                                        if (!isNaN(amount) && amount > 0) {
                                            const fundRecord = {
                                                id: Date.now() + 1,
                                                date: getLocalTodayStr(),
                                                title: `å®Œæˆè®¡åˆ’ï¼š${p.name}`,
                                                fund: amount,
                                                theme: 'theme-success',
                                                details: {
                                                    note: values.planRewardReason,
                                                    duration: hours.toFixed(2) + 'h',
                                                    plannedTime: `${p.plannedTime} - ${p.plannedEndTime}`
                                                }
                                            };
                                            historyData.unshift(fundRecord);
                                            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
                                        }
                                        updateUI();
                                        triggerAutoSave();
                                    }}
                                ]
                            });
                        }}
                    ]
                });
                return;
            }
        }
        
        // å¦åˆ™è¿›å…¥ç¼–è¾‘çŠ¶æ€å®Œå–„æ—¶é—´
        alert("è¯·å®Œå–„è®¡åˆ’çš„èµ·æ­¢æ—¶é—´å†ç‚¹å‡»å®Œæˆ");
        editingPlannedId = id;
        renderPlannedTasks();
    }

    function deletePlannedTask(id) {
        if (!confirm("ç¡®å®šå–æ¶ˆæ­¤è®¡åˆ’ï¼Ÿ")) return;
        if (pinnedTaskId == id) unpinTask(); // å¦‚æœå–æ¶ˆçš„æ˜¯ç½®é¡¶ä»»åŠ¡ï¼Œç§»é™¤é€šçŸ¥
        plannedTasks = plannedTasks.filter(x => x.id !== id);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        renderPlannedTasks();
        triggerAutoSave();
    }
    
    function abandonPlannedTask(id) {
        const task = plannedTasks.find(x => x.id === id);
        if (!task) return;
        
        showModal({
            title: 'ğŸš« æ”¾å¼ƒè®¡åˆ’',
            message: `ç¡®å®šè¦æ”¾å¼ƒè®¡åˆ’ä»»åŠ¡ã€Œ${task.name}ã€å—ï¼Ÿ\n\nå¯ä»¥é€‰æ‹©æ˜¯å¦æ·»åŠ ç½šé‡‘`,
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { text: 'ä»…åˆ é™¤è®¡åˆ’', primary: false, callback: () => {
                    if (pinnedTaskId == id) unpinTask();
                    plannedTasks = plannedTasks.filter(x => x.id !== id);
                    localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                    renderPlannedTasks();
                    updateUI();
                    triggerAutoSave();
                }},
                { text: 'æ·»åŠ ç½šé‡‘å¹¶åˆ é™¤', primary: true, callback: () => {
                    showModal({
                        title: 'æ·»åŠ ç½šé‡‘',
                        message: `æ”¾å¼ƒä»»åŠ¡ï¼š${task.name}`,
                        inputs: [
                            { id: 'penaltyAmount', label: 'ç½šé‡‘é‡‘é¢ï¼ˆå…ƒï¼‰', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢', value: '' },
                            { id: 'penaltyReason', label: 'æ”¾å¼ƒåŸå› /å¤‡æ³¨', type: 'textarea', placeholder: 'è®°å½•ä¸€ä¸‹åŸå› ', value: `æ”¾å¼ƒè®¡åˆ’ä»»åŠ¡ã€Œ${task.name}ã€` }
                        ],
                        buttons: [
                            { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                            { text: 'ç¡®è®¤', primary: true, callback: (values) => {
                                const penalty = parseFloat(values.penaltyAmount);
                                if (!isNaN(penalty) && penalty > 0) {
                                    const fundRecord = {
                                        id: Date.now(),
                                        date: getLocalTodayStr(),
                                        title: `æ”¾å¼ƒè®¡åˆ’ï¼š${task.name}`,
                                        fund: -penalty,
                                        theme: 'theme-repair',
                                        details: {
                                            note: values.penaltyReason,
                                            plannedTime: task.plannedTime || '--',
                                            plannedEndTime: task.plannedEndTime || '--'
                                        }
                                    };
                                    historyData.unshift(fundRecord);
                                    localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
                                }
                                
                                if (pinnedTaskId == id) unpinTask();
                                plannedTasks = plannedTasks.filter(x => x.id !== id);
                                localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                                renderPlannedTasks();
                                updateUI();
                                triggerAutoSave();
                            }}
                        ]
                    });
                }}
            ]
        });
    }

    function startTimer(fromPlan = false) {
        if (!document.getElementById('timerTaskName').value.trim()) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'è¯·å…ˆè¾“å…¥ä»»åŠ¡åç§°',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }
        timerRunning = true;
        timerPaused = false;
        if (!fromPlan) isTimerFromPlan = false; // å¦‚æœä¸æ˜¯ä»è®¡åˆ’å¼€å§‹ï¼Œé‡ç½®æ ‡å¿—
        
        // å¦‚æœæ˜¯ä»0å¼€å§‹ï¼Œé‡ç½®timerSecondsï¼›å¦‚æœæ˜¯ä»æš‚åœæ¢å¤ï¼Œä¿æŒå½“å‰å€¼
        if (timerSeconds === 0) {
            timerSeconds = 0;
        }
        
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'none';
        if (activeBtns) activeBtns.style.display = 'flex';
        
        updateTimerModalButtons(); // æ›´æ–°å¼¹å‡ºçª—å£æŒ‰é’®çŠ¶æ€
        updateStickyNotif(); // å¼€å¯æ—¶æ˜¾ç¤ºç½®é¡¶é€šçŸ¥
        saveTimerState(); // ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€ï¼ˆä¼šè®¾ç½®startTimestampï¼‰
        triggerAutoSave(); // åŒæ­¥åˆ°äº‘ç«¯

        // è·å–å¼€å§‹æ—¶é—´æˆ³ç”¨äºå‡†ç¡®è®¡ç®—
        const savedState = localStorage.getItem('habit_timer_state_v1');
        let startTimestamp = Date.now();
        if (savedState) {
            try {
                const parsed = JSON.parse(savedState);
                if (parsed.startTimestamp) {
                    startTimestamp = parsed.startTimestamp;
                } else {
                    // å¦‚æœæ²¡æœ‰startTimestampï¼Œæ ¹æ®å½“å‰timerSecondsè®¡ç®—
                    startTimestamp = Date.now() - (timerSeconds * 1000);
                }
            } catch (e) {
                startTimestamp = Date.now() - (timerSeconds * 1000);
            }
        } else {
            startTimestamp = Date.now() - (timerSeconds * 1000);
        }

        timerInterval = setInterval(() => {
            if (!timerPaused && timerRunning) {
                // åŸºäºæ—¶é—´æˆ³è®¡ç®—å·²è¿‡å»çš„ç§’æ•°ï¼Œé¿å…é”å±å¯¼è‡´çš„åå·®
                const elapsedMs = Date.now() - startTimestamp;
                timerSeconds = Math.floor(elapsedMs / 1000);
                updateTimerUI();
                saveTimerState(); // æ¯ç§’ä¿å­˜ä¸€æ¬¡çŠ¶æ€åˆ°æœ¬åœ°
            }
        }, 1000);
        
        // æ¯30ç§’åŒæ­¥ä¸€æ¬¡åˆ°äº‘ç«¯ï¼Œç¡®ä¿å¤šè®¾å¤‡èƒ½åŠæ—¶è·å–æœ€æ–°çŠ¶æ€
        timerSyncInterval = setInterval(async () => {
            if (timerRunning && ((ghConfig.token && ghConfig.repo) || (giteeConfig.token && giteeConfig.repo))) {
                console.log('ğŸ”„ å®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€...');
                // å…ˆ pull æ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰å˜åŒ–ï¼ˆæ¯”å¦‚å…¶ä»–è®¾å¤‡å·²ç»“æŸè®¡æ—¶ï¼‰
                await syncAll('pull', true);
                // å¦‚æœè®¡æ—¶å™¨è¿˜åœ¨è¿è¡Œï¼ˆæ²¡æœ‰è¢« pull åœæ­¢ï¼‰ï¼Œå† push æœ¬åœ°çŠ¶æ€
                if (timerRunning) {
                    triggerAutoSave();
                }
            } else if (timerRunning) {
                // å¦‚æœæ²¡æœ‰é…ç½® GitHubï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                saveTimerState();
            }
        }, 30000); // 30ç§’
    }

    function toggleTimerPause() {
        timerPaused = !timerPaused;
        const btnTimerPause = document.getElementById('btnTimerPause');
        if (btnTimerPause) btnTimerPause.innerText = timerPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
        // æ›´æ–°é€šçŸ¥æ çš„æš‚åœæŒ‰é’®
        const notifPauseBtn = document.getElementById('notifTimerPauseBtn');
        if (notifPauseBtn) notifPauseBtn.innerText = timerPaused ? 'â–¶ï¸' : 'â¸ï¸';
        updateTimerModalButtons(); // æ›´æ–°å¼¹å‡ºçª—å£æŒ‰é’®çŠ¶æ€
        saveTimerState(); // ä¿å­˜æš‚åœçŠ¶æ€
        triggerAutoSave(); // åŒæ­¥åˆ°äº‘ç«¯
    }

    function updateTimerUI() {
        const h = Math.floor(timerSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (timerSeconds % 60).toString().padStart(2, '0');
        const clockStr = `${h}:${m}:${s}`;
        
        // æ›´æ–°ç½®é¡¶é€šçŸ¥æ çš„æ—¶é’Ÿ
        const notifClock = document.getElementById('notifTimerClock');
        if (notifClock) notifClock.innerText = clockStr;
    }

    function stopTimer() {
        const hours = timerSeconds / 3600;
        
        // å…¼å®¹ï¼šä»é¡µé¢è¾“å…¥æ¡†æˆ–ä¿å­˜çš„çŠ¶æ€ä¸­è·å–ä»»åŠ¡åç§°
        const taskInput = document.getElementById('timerTaskName');
        let taskName = '';
        if (taskInput) {
            taskName = taskInput.value || '';
        }
        if (!taskName) {
            const savedState = localStorage.getItem('habit_timer_state_v1');
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    taskName = parsed.taskName || 'æœªå‘½åä»»åŠ¡';
                } catch (_) {
                    taskName = 'æœªå‘½åä»»åŠ¡';
                }
            } else {
                taskName = 'æœªå‘½åä»»åŠ¡';
            }
        }
        
        showModal({
            title: 'ç»“æŸè®¡æ—¶',
            message: `ç¡®è®¤ç»“æŸæœ¬æ¬¡è®¡æ—¶å¹¶ä¿å­˜ï¼Ÿ\n\nä»»åŠ¡ï¼š${taskName}\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶`,
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { text: 'ç¡®è®¤ç»“æŸ', primary: true, callback: () => { finalizeStopTimer(); } }
            ]
        });
    }
    
    function finalizeStopTimer() {
        clearInterval(timerInterval);
        clearInterval(timerSyncInterval); // æ¸…é™¤åŒæ­¥å®šæ—¶å™¨
        const hours = timerSeconds / 3600;
        const endTime = new Date().toTimeString().slice(0, 5);
        const startTime = calculateStartTime(endTime, hours);
        
        // å…¼å®¹ï¼šä»é¡µé¢è¾“å…¥æ¡†æˆ–ä¿å­˜çš„çŠ¶æ€ä¸­è·å–ä»»åŠ¡ä¿¡æ¯
        const taskInput = document.getElementById('timerTaskName');
        const noteInput = document.getElementById('timerNote');
        let taskName = '';
        let note = '';
        let todoId = null;
        
        if (taskInput) {
            taskName = taskInput.value || '';
            todoId = taskInput.getAttribute('data-todo-id') || null;
        }
        if (noteInput) {
            note = noteInput.value || '';
        }
        
        // å¦‚æœè¾“å…¥æ¡†ä¸å­˜åœ¨ï¼Œä»ä¿å­˜çš„çŠ¶æ€ä¸­è·å–ï¼ˆå…¼å®¹ä»å¾…åŠé¡µé¢å¯åŠ¨è®¡æ—¶çš„æƒ…å†µï¼‰
        if (!taskName || !todoId) {
            const savedState = localStorage.getItem('habit_timer_state_v1');
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    if (!taskName && parsed.taskName) taskName = parsed.taskName;
                    if (!todoId && parsed.todoId) todoId = String(parsed.todoId);
                    if (!note && parsed.note) note = parsed.note;
                } catch (_) {}
            }
        }
        
        // å¦‚æœä»ç„¶æ²¡æœ‰ä»»åŠ¡åç§°ï¼Œä½¿ç”¨é»˜è®¤å€¼
        if (!taskName) taskName = 'æœªå‘½åä»»åŠ¡';

        // æ£€æŸ¥è®¡æ—¶æ—¶é•¿æ˜¯å¦å°äº2åˆ†é’Ÿï¼ˆ120ç§’ï¼‰
        if (timerSeconds < 120) {
            // å°äº2åˆ†é’Ÿï¼Œä¸ä¿å­˜è®°å½•ï¼Œç›´æ¥é‡ç½®
            timerSeconds = 0;
            timerRunning = false;
            isTimerFromPlan = false;
            updateTimerUI();
            
            // å…¼å®¹ï¼šå¦‚æœè¾“å…¥æ¡†å­˜åœ¨æ‰æ¸…ç©º
            const taskInput = document.getElementById('timerTaskName');
            const noteInput = document.getElementById('timerNote');
            if (taskInput) {
                taskInput.value = '';
                taskInput.removeAttribute('data-todo-id');
            }
            if (noteInput) noteInput.value = '';
            
            const timeInput = document.getElementById('timerPlannedEndTime');
            if (timeInput) initTimerTime();
            
            const idleBtns = document.getElementById('timerIdleBtns');
            const activeBtns = document.getElementById('timerActiveBtns');
            if (idleBtns) idleBtns.style.display = 'flex';
            if (activeBtns) activeBtns.style.display = 'none';
            
            updateStickyNotif();
            updateTimerModalButtons();
            localStorage.removeItem('habit_timer_state_v1');
            triggerAutoSave();
            
            // æç¤ºç”¨æˆ·
            alert('â±ï¸ è®¡æ—¶æ—¶é•¿å°äº2åˆ†é’Ÿï¼Œæœªä¿å­˜è®°å½•');
            return;
        }

        // ä¿å­˜è®°å½•
        const record = {
            id: Date.now(),
            name: formatTaskName(taskName),
            duration: hours.toFixed(2),
            seconds: timerSeconds,
            note: note,
            date: getLocalTodayStr(),
            startTime: startTime,
            time: endTime,
            isPlanned: isTimerFromPlan,
            todoId: todoId ? parseInt(todoId) : null
        };
        
        timerRecords.unshift(record);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        
        // æ›´æ–°å­¦ä¹ æ—¶é—´æ˜¾ç¤º
        updateStickyNotif();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„å¾…åŠäº‹é¡¹
        if (todoId) {
            const id = String(todoId);
            const todo = todoList.find(t => String(t.id) === id && t.status === 'pending');
            if (todo) {
                const reward = todo.reward || 0;
                showModal({
                    title: 'âœ… å®Œæˆå¾…åŠï¼Ÿ',
                    message: `è®¡æ—¶å·²ç»“æŸï¼\n\næ˜¯å¦åŒæ—¶å®Œæˆå¾…åŠäº‹é¡¹ã€Œ${todo.title}ã€ï¼Ÿ\nå®Œæˆå°†è·å¾— +${reward} å…ƒæ„¿æœ›é‡‘`,
                    buttons: [
                        { text: 'æš‚ä¸å®Œæˆ', primary: false, callback: () => { askForFunds(taskName, hours); } },
                        { text: 'å®Œæˆå¾…åŠ', primary: true, callback: () => {
                            finishTodo(id, 'success');
                            askForFunds(taskName, hours);
                        }}
                    ]
                });
                return;
            }
        }
        
        // ç›´æ¥è¯¢é—®æ·»åŠ å¥–åŠ±/ç½šé‡‘
        askForFunds(taskName, hours);
    }
    
    function askForFunds(taskName, hours) {
        showModal({
            title: 'æ·»åŠ å¥–åŠ±/æƒ©ç½š',
            message: `è®¡æ—¶ä»»åŠ¡ã€Œ${taskName}ã€å·²å®Œæˆ\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶\n\næ˜¯å¦æ·»åŠ æ„¿æœ›é‡‘æˆ–ç½šé‡‘ï¼Ÿ`,
            buttons: [
                { text: 'ä¸æ·»åŠ ', primary: false, callback: () => { completeTimerStop(); } },
                { text: 'æ·»åŠ å¥–åŠ±', primary: true, callback: () => { showFundInput(taskName, hours, true); } },
                { text: 'æ·»åŠ ç½šé‡‘', primary: false, callback: () => { showFundInput(taskName, hours, false); } }
            ]
        });
    }
    
    function showFundInput(taskName, hours, isReward) {
        showModal({
            title: isReward ? 'æ·»åŠ æ„¿æœ›é‡‘' : 'æ·»åŠ ç½šé‡‘',
            message: `ä»»åŠ¡ï¼š${taskName}\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶`,
            inputs: [
                { id: 'fundAmount', label: 'é‡‘é¢ï¼ˆå…ƒï¼‰', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢', value: '' },
                { id: 'fundReason', label: 'åŸå› /å¤‡æ³¨', type: 'textarea', placeholder: 'è®°å½•ä¸€ä¸‹åŸå› ', value: `å®Œæˆè®¡æ—¶ä»»åŠ¡ã€Œ${taskName}ã€` }
            ],
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => { completeTimerStop(); } },
                { text: 'ç¡®è®¤æ·»åŠ ', primary: true, callback: (values) => {
                    const amount = parseFloat(values.fundAmount);
                    if (isNaN(amount) || amount <= 0) {
                        completeTimerStop();
                        return;
                    }
                    
                    const fundRecord = {
                        id: Date.now() + 1,
                        date: getLocalTodayStr(),
                        title: isReward ? `è®¡æ—¶å¥–åŠ±ï¼š${taskName}` : `è®¡æ—¶æƒ©ç½šï¼š${taskName}`,
                        fund: isReward ? amount : -amount,
                        theme: isReward ? 'theme-success' : 'theme-repair',
                        details: {
                            note: values.fundReason,
                            timerDuration: hours.toFixed(2) + 'h'
                        }
                    };
                    
                    historyData.unshift(fundRecord);
                    localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
                    completeTimerStop();
                }}
            ]
        });
    }
    
    function completeTimerStop() {
        // é‡ç½®UI
        timerSeconds = 0;
        timerRunning = false;
        isTimerFromPlan = false;
        updateTimerUI();
        
        // å…¼å®¹ï¼šå¦‚æœè¾“å…¥æ¡†å­˜åœ¨æ‰æ¸…ç©º
        const taskInput = document.getElementById('timerTaskName');
        const noteInput = document.getElementById('timerNote');
        const timeInput = document.getElementById('timerPlannedEndTime');
        if (taskInput) {
            taskInput.value = '';
            taskInput.removeAttribute('data-todo-id');
        }
        if (noteInput) noteInput.value = '';
        if (timeInput) initTimerTime();
        
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'flex';
        if (activeBtns) activeBtns.style.display = 'none';
        
        updateTimerModalButtons(); // æ›´æ–°å¼¹å‡ºçª—å£æŒ‰é’®çŠ¶æ€
        updateStickyNotif();
        localStorage.removeItem('habit_timer_state_v1');
        console.log('â¹ï¸ è®¡æ—¶å™¨å·²ç»“æŸï¼Œå‡†å¤‡åŒæ­¥åˆ°äº‘ç«¯...');

        renderTimerHistory();
        
        // æ›´æ–°å¼¹å‡ºçª—å£çš„å†å²è®°å½•
        const modalHistoryList = document.querySelector('#timerModalContent #timerHistoryListModal');
        if (modalHistoryList) {
            renderTimerHistoryForModal(modalHistoryList);
        }
        renderQuickTasks();
        updateUI();
        triggerAutoSave();
    }

    function renderTimerHistory() {
        const list = document.getElementById('timerHistoryList');
        if (timerRecords.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:20px;">æš‚æ— è®¡æ—¶è®°å½•</div>';
            return;
        }

        // æŒ‰æ—¶é—´å€’åºæ’åºï¼ˆè¿‘æœŸåœ¨å‰ï¼‰
        timerRecords.sort((a, b) => {
            if (a.date !== b.date) return b.date.localeCompare(a.date);
            return b.time.localeCompare(a.time);
        });

        const limit = timerFullView ? timerRecords.length : (config.timerLimit || 5);
        const displayedRecords = timerRecords.slice(0, limit);

        list.innerHTML = displayedRecords.map(r => {
            const startTime = r.startTime || calculateStartTime(r.time, r.duration);
            
            if (editingTimerRecordId === r.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">ä»»åŠ¡åç§°</label><input type="text" id="editHistoryName-${r.id}" value="${formatTaskName(r.name)}" style="font-weight:bold;"></div>
                    <div class="input-group"><label class="input-label">æ—¥æœŸ</label><input type="date" id="editHistoryDate-${r.id}" value="${r.date}"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">èµ·å§‹æ—¶é—´</label><input type="time" id="editHistoryStart-${r.id}" value="${startTime}"></div>
                        <div class="input-group"><label class="input-label">ç»“æŸæ—¶é—´</label><input type="time" id="editHistoryEnd-${r.id}" value="${r.time}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">å¤‡æ³¨</label><textarea id="editHistoryNote-${r.id}" style="min-height:60px;">${r.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryRecord(${r.id})">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                    </div>
                </div>`;
            }

            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${formatTaskName(r.name)}</div>
                    <div style="font-size:12px; color:var(--primary);">${r.duration}h | ${r.date} ${startTime} - ${r.time}</div>
                    ${r.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px; background:var(--input-bg); padding:4px; border-radius:4px;">' + r.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:8px;">
                    <div class="btn-action" onclick="editTimerRecord(${r.id})">âœï¸</div>
                    <div class="btn-action btn-del" onclick="deleteTimerRecord(${r.id})">âœ•</div>
                </div>
            </div>
        `;}).join('');

        // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
        if (!timerFullView && timerRecords.length > limit) {
            list.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleTimerFullView()" title="å±•å¼€æ›´å¤š">
                    <span>å±•å¼€æ›´å¤š</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>`
            );
        } else if (timerFullView && timerRecords.length > (config.timerLimit || 5)) {
            list.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; padding:12px; cursor:pointer; opacity:0.7; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px; color:var(--text-sub); font-size:13px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" onclick="toggleTimerFullView()" title="æ”¶èµ·">
                    <span>æ”¶èµ·</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </div>`
            );
        }
        
        // åŒæ—¶æ›´æ–°å¼¹å‡ºçª—å£çš„å†å²è®°å½•
        const modalHistoryList = document.querySelector('#timerModalContent #timerHistoryListModal');
        if (modalHistoryList) {
            renderTimerHistoryForModal(modalHistoryList);
        }
    }

    function editTimerRecord(id) {
        editingTimerRecordId = id;
        renderTimerHistory();
        // åŒæ—¶æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²è®°å½•
        const modalHistoryList = document.querySelector('#timerModalContent #timerHistoryListModal');
        if (modalHistoryList) {
            renderTimerHistoryForModal(modalHistoryList);
        }
        updateDebtModalHistoryList(); // æ›´æ–°å†å²æ¡£æ¡ˆä¸­çš„æ˜¾ç¤º
    }

    function saveInlineHistoryRecord(id) {
        const r = timerRecords.find(x => x.id === id);
        if (!r) return;
        
        // ä¼˜å…ˆä»æ¨¡æ€æ¡†ä¸­è·å–è¾“å…¥å€¼ï¼ˆå¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼‰
        const timerModal = document.getElementById('timerModal');
        const isTimerModalOpen = timerModal && timerModal.classList.contains('show');
        const timerModalContent = isTimerModalOpen ? document.getElementById('timerModalContent') : null;
        
        const getEl = (elId) => {
            // ä¼˜å…ˆä» timerModal ä¸­æŸ¥æ‰¾ï¼ˆä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼‰
            if (isTimerModalOpen && timerModalContent) {
                // å…ˆå°è¯•åœ¨æ¨¡æ€æ¡†ä¸­æŸ¥æ‰¾
                const modalEl = timerModalContent.querySelector('#' + elId);
                if (modalEl) {
                    console.log(`æ‰¾åˆ°æ¨¡æ€æ¡†ä¸­çš„å…ƒç´ : ${elId}`, modalEl);
                    return modalEl;
                }
            }
            // ç„¶åä»ä¸»é¡µé¢æŸ¥æ‰¾
            const mainEl = document.getElementById(elId);
            if (mainEl) {
                console.log(`æ‰¾åˆ°ä¸»é¡µé¢ä¸­çš„å…ƒç´ : ${elId}`, mainEl);
            } else {
                console.error(`æœªæ‰¾åˆ°å…ƒç´ : ${elId}`);
            }
            return mainEl;
        };
        
        const nameEl = getEl(`editHistoryName-${id}`);
        const dateEl = getEl(`editHistoryDate-${id}`);
        const startEl = getEl(`editHistoryStart-${id}`);
        const endEl = getEl(`editHistoryEnd-${id}`);
        const noteEl = getEl(`editHistoryNote-${id}`);
        
        if (!nameEl || !dateEl || !startEl || !endEl || !noteEl) {
            console.error('ç¼–è¾‘è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            return;
        }
        
        const name = nameEl.value.trim();
        const date = dateEl.value;
        const start = startEl.value;
        const end = endEl.value;
        const note = noteEl.value.trim();

        if (!name) return alert("è¯·è¾“å…¥åç§°");
        if (!date) return alert("è¯·è¾“å…¥æ—¥æœŸ");

        const newDuration = getTimeDiff(start, end);
        if (!newDuration || newDuration < 0) return alert("æ—¶é—´è®¾ç½®ä¸åˆæ³•");

        r.name = formatTaskName(name);
        r.date = date;
        r.startTime = start;
        r.time = end;
        r.duration = newDuration.toFixed(2);
        r.seconds = Math.floor(newDuration * 3600);
        r.note = note;

        editingTimerRecordId = null;
        
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        
        // æ›´æ–°ä¸»é¡µé¢å†å²è®°å½•
        renderTimerHistory();
        
        // åŒæ—¶æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²è®°å½•
        if (isTimerModalOpen && timerModalContent) {
            const modalHistoryList = timerModalContent.querySelector('#timerHistoryListModal');
            if (modalHistoryList) {
                renderTimerHistoryForModal(modalHistoryList);
            }
        }
        
        updateUI();
        updateDebtModalHistoryList(); // æ›´æ–°å†å²æ¡£æ¡ˆä¸­çš„æ˜¾ç¤º
        triggerAutoSave();
    }
    
    function cancelTimerRecordEdit() {
        editingTimerRecordId = null;
        // æ›´æ–°ä¸»é¡µé¢å†å²è®°å½•
        renderTimerHistory();
        // åŒæ—¶æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å†å²è®°å½•
        const timerModal = document.getElementById('timerModal');
        const isTimerModalOpen = timerModal && timerModal.classList.contains('show');
        if (isTimerModalOpen) {
            const timerModalContent = document.getElementById('timerModalContent');
            if (timerModalContent) {
                const modalHistoryList = timerModalContent.querySelector('#timerHistoryListModal');
                if (modalHistoryList) {
                    renderTimerHistoryForModal(modalHistoryList);
                }
            }
        }
    }

    function deleteTimerRecord(id) {
        if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ")) return;
        timerRecords = timerRecords.filter(r => r.id !== id);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        renderTimerHistory();
        updateDebtModalHistoryList(); // æ›´æ–°å†å²æ¡£æ¡ˆä¸­çš„æ˜¾ç¤º
        triggerAutoSave();
    }

    function toMin(t){ const[h,m]=t.split(':').map(Number); return h*60+m; }
    function toAdjMin(t){ let[h,m]=t.split(':').map(Number); if(h<12)h+=24; return h*60+m; }

    function calculateStartTime(endTime, durationHours) {
        let [h, m] = endTime.split(':').map(Number);
        let totalMin = h * 60 + m - Math.round(parseFloat(durationHours) * 60);
        while (totalMin < 0) totalMin += 24 * 60;
        let sh = Math.floor(totalMin / 60 % 24).toString().padStart(2, '0');
        let sm = (totalMin % 60).toString().padStart(2, '0');
        return `${sh}:${sm}`;
    }

    function getTimeDiff(start, end) {
        let [sh, sm] = start.split(':').map(Number);
        let [eh, em] = end.split(':').map(Number);
        let startMin = sh * 60 + sm;
        let endMin = eh * 60 + em;
        if (endMin < startMin) endMin += 24 * 60; 
        return (endMin - startMin) / 60;
    }

    function checkWeekend() {
        const date = new Date(document.getElementById('dateInput').value);
        const day = date.getDay();
        const we = config.weekend || [0, 6];
        todayIsWeekend = we.includes(day);
        document.getElementById('dayTypeBadge').style.display = todayIsWeekend ? 'inline-block' : 'none';
        document.getElementById('targetWake').innerText = `â‰¤ ${todayIsWeekend ? config.wakeW : config.wake}`;
        document.getElementById('targetSleep').innerText = `â‰¤ ${todayIsWeekend ? config.sleepW : config.sleep}`;
    }

    function setStatPeriod(p) {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const debtModal = document.getElementById('debtModal');
        const timerModal = document.getElementById('timerModal');
        const isDebtModalOpen = debtModal && debtModal.classList.contains('show');
        const isTimerModalOpen = timerModal && timerModal.classList.contains('show');
        const debtModalContent = isDebtModalOpen ? document.getElementById('debtModalContent') : null;
        const timerModalContent = isTimerModalOpen ? document.getElementById('timerModalContent') : null;
        
        const getEl = (elId) => {
            // ä¼˜å…ˆä» timerModal ä¸­æŸ¥æ‰¾
            if (isTimerModalOpen && timerModalContent) {
                const el = timerModalContent.querySelector('#' + elId);
                if (el) return el;
            }
            // ç„¶åä» debtModal ä¸­æŸ¥æ‰¾
            if (isDebtModalOpen && debtModalContent) {
                const el = debtModalContent.querySelector('#' + elId);
                if (el) return el;
            }
            // æœ€åä»ä¸»é¡µé¢æŸ¥æ‰¾
            return document.getElementById(elId);
        };
        
        const statPeriodEl = getEl('statPeriod');
        if (statPeriodEl) statPeriodEl.value = p;
        
        // æ›´æ–°chipæŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        let container = null;
        if (isTimerModalOpen && timerModalContent) {
            container = timerModalContent;
        } else if (isDebtModalOpen && debtModalContent) {
            container = debtModalContent;
        } else {
            container = document.getElementById('page-stats');
        }
        if (container) {
            const chipsContainer = container.querySelector('.chips-container');
            if (chipsContainer) {
                chipsContainer.querySelectorAll('.chip').forEach(chip => {
                    const chipValue = chip.getAttribute('onclick')?.match(/setStatPeriod\('([^']+)'\)/)?.[1];
                    if (chipValue === p) {
                        chip.style.background = 'var(--primary)';
                        chip.style.borderColor = 'var(--primary)';
                        chip.style.color = '#fff';
                    } else {
                        chip.style.background = '';
                        chip.style.borderColor = '';
                        chip.style.color = '';
                    }
                });
            }
        }
        
        renderStats();
    }

    function renderStats() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const debtModal = document.getElementById('debtModal');
        const timerModal = document.getElementById('timerModal');
        const isDebtModalOpen = debtModal && debtModal.classList.contains('show');
        const isTimerModalOpen = timerModal && timerModal.classList.contains('show');
        const debtModalContent = isDebtModalOpen ? document.getElementById('debtModalContent') : null;
        const timerModalContent = isTimerModalOpen ? document.getElementById('timerModalContent') : null;
        
        const getEl = (elId) => {
            // ä¼˜å…ˆä» timerModal ä¸­æŸ¥æ‰¾
            if (isTimerModalOpen && timerModalContent) {
                const el = timerModalContent.querySelector('#' + elId);
                if (el) return el;
            }
            // ç„¶åä» debtModal ä¸­æŸ¥æ‰¾
            if (isDebtModalOpen && debtModalContent) {
                const el = debtModalContent.querySelector('#' + elId);
                if (el) return el;
            }
            // æœ€åä»ä¸»é¡µé¢æŸ¥æ‰¾
            return document.getElementById(elId);
        };
        
        const statPeriodEl = getEl('statPeriod');
        if (!statPeriodEl) return;
        
        const period = statPeriodEl.value;
        const todayStr = getLocalTodayStr();
        
        let filterDates = [];

        if (period === 'today') {
            filterDates = [todayStr];
        } else if (period === 'yesterday') {
            const yest = new Date();
            yest.setDate(yest.getDate() - 1);
            filterDates = [yest.toISOString().split('T')[0]];
        } else if (period === 'all') {
            filterDates = historyData.map(r => r.date);
        } else {
            const days = parseInt(period);
            for(let i=days-1; i>=0; i--) { 
                const d=new Date(); 
                d.setDate(d.getDate()-i); 
                filterDates.push(d.toISOString().split('T')[0]); 
            }
        }

        // çƒ­åŠ›å›¾å§‹ç»ˆæ˜¾ç¤ºæœ€è¿‘7å¤©
        const heatmapDates = [];
        for(let i=6; i>=0; i--) { const d=new Date(); d.setDate(d.getDate()-i); heatmapDates.push(d.toISOString().split('T')[0]); }
        const hm = getEl('heatmap');
        if (hm) {
            hm.innerHTML = heatmapDates.map(date => {
                const rec = historyData.find(r => r.date === date);
                let cls = 'hm-none';
                if (rec) { if (rec.theme.includes('success')) cls = 'hm-success'; else if (rec.theme.includes('fix')) cls = 'hm-fix'; else if (rec.theme.includes('repair')) cls = 'hm-repair'; }
                return `<div class="heatmap-day"><div class="heatmap-box ${cls}"></div><div style="font-size:9px;color:var(--text-sub)">${date.slice(5)}</div></div>`;
            }).join('');
        }

        const filteredHistory = historyData.filter(r => filterDates.includes(r.date) && !['theme-skip','theme-shop','theme-pay'].includes(r.theme));
        const total = filteredHistory.reduce((a,c) => a + parseFloat(c.study||0), 0);
        const rate = filteredHistory.length ? Math.round((filteredHistory.filter(r => r.theme==='theme-success').length/filteredHistory.length)*100) : 0;
        
        // ä¸“æ³¨è®¡æ—¶ç»Ÿè®¡ä¹Ÿå—å‘¨æœŸå½±å“
        const filteredTimerRecords = timerRecords.filter(r => filterDates.includes(r.date));
        const timerTotal = filteredTimerRecords.reduce((a,r) => a + parseFloat(r.duration), 0);
        const timerToday = timerRecords.filter(r => r.date === todayStr).reduce((a,r) => a + parseFloat(r.duration), 0);
        const timerCount = filteredTimerRecords.length;
        const timerAvg = timerCount > 0 ? (timerTotal / timerCount) : 0;

        // çƒ­é—¨ä»»åŠ¡ç»Ÿè®¡ï¼ˆä½¿ç”¨è§„èŒƒåŒ–åç§°è¿›è¡Œåˆ†ç»„ï¼Œå¿½ç•¥å›¾æ ‡ï¼‰
        const taskMap = {};
        filteredTimerRecords.forEach(r => {
            // ä½¿ç”¨è§„èŒƒåŒ–åçš„åç§°è¿›è¡Œåˆ†ç»„ï¼ˆå»é™¤å›¾æ ‡ï¼Œåªçœ‹æ–‡å­—å†…å®¹ï¼‰
            const normalizedName = normalizeTaskName(r.name);
            taskMap[normalizedName] = (taskMap[normalizedName] || 0) + parseFloat(r.duration);
        });
        const topTasks = Object.entries(taskMap)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3);
        
        const topTasksHtml = topTasks.length > 0 
            ? topTasks.map(([normalizedName, dur], i) => {
                // æ˜¾ç¤ºæ—¶ä½¿ç”¨æ ¼å¼åŒ–åçš„åç§°ï¼ˆå¸¦å›¾æ ‡ï¼‰
                const displayName = formatTaskName(normalizedName);
                return `
                <div style="display:flex; justify-content:space-between; padding:4px 0;">
                    <span>${i+1}. ${displayName}</span>
                    <span style="color:var(--primary); font-weight:bold;">${dur.toFixed(1)}h</span>
                </div>
              `;
            }).join('')
            : '<div style="text-align:center; color:var(--text-sub); margin-top:10px;">è¯¥å‘¨æœŸå†…æš‚æ— è®¡æ—¶æ•°æ®</div>';
        
        const statTimerTopTasksEl = getEl('statTimerTopTasks');
        if (statTimerTopTasksEl) statTimerTopTasksEl.innerHTML = topTasksHtml;
        
        // æ›´æ–°chipæŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        let container = null;
        if (isTimerModalOpen && timerModalContent) {
            container = timerModalContent;
        } else if (isDebtModalOpen && debtModalContent) {
            container = debtModalContent;
        } else {
            container = document.getElementById('page-stats');
        }
        if (container) {
            const chipsContainer = container.querySelector('.chips-container');
            if (chipsContainer) {
                chipsContainer.querySelectorAll('.chip').forEach(chip => {
                    const chipValue = chip.getAttribute('onclick')?.match(/setStatPeriod\('([^']+)'\)/)?.[1];
                    if (chipValue === period) {
                        chip.style.background = 'var(--primary)';
                        chip.style.borderColor = 'var(--primary)';
                        chip.style.color = '#fff';
                    } else {
                        chip.style.background = '';
                        chip.style.borderColor = '';
                        chip.style.color = '';
                    }
                });
            }
        }
    }

    function exportCSV(){
        let c="æ—¥æœŸ,ç±»å‹,åŸºé‡‘,è¯¦æƒ…\n";
        historyData.forEach(i=>c+=`${i.date},${i.title},${i.fund},"${Object.values(i.details||{}).join('|')}"\n`);
        const defaultName = "habit_backup_" + getTimestampStr() + ".csv";
        showModal({
            title: "åˆ›å»ºå­˜æ¡£",
            message: "è¾“å…¥CSVæ–‡ä»¶å",
            inputs: [{ id: "backupNameCsv", label: "æ–‡ä»¶å", type: "text", value: defaultName }],
            buttons: [
                { text: "å–æ¶ˆ", primary: false, callback: () => {} },
                { text: "ä¿å­˜", primary: true, callback: (values) => {
                    const name = values.backupNameCsv ? values.backupNameCsv.trim() : "";
                    const sanitized = (name || defaultName).replace(/[\\/:*?\"<>|]/g, "");
                    const finalName = /\.csv$/i.test(sanitized) ? sanitized : (sanitized + ".csv");
                    const l=document.createElement("a");
                    l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));
                    l.download=finalName;
                    document.body.appendChild(l);
                    l.click();
                    l.remove();
                } }
            ]
        });
    }

    function exportJSON() {
        const backup = { history: historyData, config: config, todos: todoList, wishes: wishList, strategies: userStrategies, gh: ghConfig, timeBank: timeBank, dailyReviews: dailyReviews, taskUsageCount: taskUsageCount };
        const defaultName = "habit_backup_" + getTimestampStr() + ".json";
        showModal({
            title: "åˆ›å»ºå­˜æ¡£",
            message: "è¾“å…¥JSONæ–‡ä»¶å",
            inputs: [{ id: "backupNameJson", label: "æ–‡ä»¶å", type: "text", value: defaultName }],
            buttons: [
                { text: "å–æ¶ˆ", primary: false, callback: () => {} },
                { text: "ä¿å­˜", primary: true, callback: (values) => {
                    const name = values.backupNameJson ? values.backupNameJson.trim() : "";
                    const sanitized = (name || defaultName).replace(/[\\/:*?\"<>|]/g, "");
                    const finalName = /\.json$/i.test(sanitized) ? sanitized : (sanitized + ".json");
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", finalName);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                } }
            ]
        });
    }

    function importJSON(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { const data = JSON.parse(e.target.result); restoreData(data); }
            catch(err) { alert("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ¢å¤"); }
        };
        reader.readAsText(file);
    }

    function restoreData(data) {
        if(confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
            const historyToRestore = data.history || data.data;
            if(historyToRestore) localStorage.setItem('habit_data_v15', JSON.stringify(historyToRestore));

            if(data.config) localStorage.setItem('habit_config_v7', JSON.stringify(data.config));
            if(data.todos) localStorage.setItem('habit_todos_v1', JSON.stringify(data.todos));
            if(data.wishes) localStorage.setItem('habit_wishes_v1', JSON.stringify(data.wishes));
            if(data.strategies) localStorage.setItem('habit_strategies_v1', JSON.stringify(data.strategies));
            if(data.gh) localStorage.setItem('habit_gh_v1', JSON.stringify(data.gh));
            if(data.timeBank !== undefined) localStorage.setItem('habit_time_bank_v1', data.timeBank);
            if(data.dailyReviews) localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(data.dailyReviews));
            if(data.taskUsageCount) localStorage.setItem('habit_task_usage_v1', JSON.stringify(data.taskUsageCount));
            alert("âœ… æ•°æ®æ¢å¤æˆåŠŸï¼\nå·²è¿˜åŸè®¾ç½®ä¸é…ç½®ã€‚\né¡µé¢å³å°†åˆ·æ–°..."); location.reload();
        }
    }

    function triggerAutoSave() {
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList));
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        localStorage.setItem('habit_time_bank_v1', timeBank);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        // è®¡æ—¶å™¨çŠ¶æ€å·²ç»ç”±saveTimerState()å•ç‹¬ä¿å­˜
        syncAll('push', true);
    }

    // æ¸²æŸ“å¤ç›˜æ ‡ç­¾è®¾ç½®
    function renderReviewTagSettings() {
        // å°è¯•ä»è®¾ç½®æ¨¡æ€æ¡†å’Œä¸»é¡µé¢æŸ¥æ‰¾å…ƒç´ ï¼Œç¡®ä¿åœ¨ä»»ä½•è§†å›¾ä¸‹éƒ½èƒ½æ›´æ–°
        const listIds = ['settingReviewTagsList']; // å¦‚æœæœ‰å¤šä¸ªå¯èƒ½çš„IDï¼Œå¯ä»¥æ·»åŠ åˆ°è¿™é‡Œ
        const titleIds = ['settingReviewTagTitle'];

        // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„å…ƒç´ è¿›è¡Œæ›´æ–°ï¼ˆå¤„ç†å¯èƒ½å­˜åœ¨çš„å¤šä¸ªå®ä¾‹ï¼Œä¾‹å¦‚ä¸€ä¸ªåœ¨Modalä¸­ï¼Œä¸€ä¸ªåœ¨ä¸»é¡µé¢ä¸­ï¼‰
        // å®é™…ä¸Š ID åº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œä½†å¦‚æœ Settings Modal æ˜¯åŠ¨æ€æ’å…¥çš„ï¼Œå¯èƒ½è¦æ³¨æ„æŸ¥æ‰¾èŒƒå›´
        
        // ä¼˜å…ˆæŸ¥æ‰¾ Settings Modal ä¸­çš„å†…å®¹
        const settingsModal = document.getElementById('settingsModal');
        const isSettingsModalOpen = settingsModal && settingsModal.classList.contains('show');
        const settingsModalContent = isSettingsModalOpen ? document.getElementById('settingsModalContent') : null;

        let list = document.getElementById('settingReviewTagsList');
        
        if (isSettingsModalOpen && settingsModalContent) {
            const modalList = settingsModalContent.querySelector('#settingReviewTagsList');
            if (modalList) list = modalList;
        }

        if (list) {
            list.innerHTML = (config.reviewTags || []).map((tag, i) => `
                <div class="chip" style="display:inline-flex; align-items:center; gap:4px;">
                    ${tag}
                    <span style="cursor:pointer; opacity:0.6; font-size:14px; margin-left:4px;" onclick="deleteReviewTag(${i})">âœ•</span>
                </div>
            `).join('');
        }
    }

    // æ·»åŠ å¤ç›˜æ ‡é¢˜è®¾ç½®
    function addReviewTagSetting() {
        showModal({
            title: 'æ·»åŠ å¤ç›˜æ ‡é¢˜',
            message: 'è¯·è¾“å…¥æ–°çš„å¤ç›˜æ ‡é¢˜å†…å®¹',
            inputs: [{ id: 'newTag', label: 'æ ‡é¢˜å†…å®¹', placeholder: 'ä¾‹å¦‚ï¼šğŸ›ï¸ è´­ç‰©æ¸…å•' }],
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { 
                    text: 'ç¡®å®š', 
                    primary: true, 
                    callback: (values) => {
                        const tag = values.newTag ? values.newTag.trim() : '';
                        if (!tag) return;
                        if (!config.reviewTags) config.reviewTags = [];
                        if (!config.reviewTags.includes(tag)) {
                            config.reviewTags.push(tag);
                            renderReviewTagSettings();
                        }
                    }
                }
            ]
        });
    }

    // åˆ é™¤å¤ç›˜æ ‡ç­¾
    function deleteReviewTag(index) {
        if (!config.reviewTags) return;
        config.reviewTags.splice(index, 1);
        renderReviewTagSettings();
    }

    // é‡ç½®å¤ç›˜æ ‡ç­¾
    function resetReviewTags() {
        if(confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤çš„å¤ç›˜æ ‡ç­¾è®¾ç½®å—ï¼Ÿ')) {
            config.reviewTags = [...DEFAULT_CONFIG.reviewTags];
            renderReviewTagSettings();
        }
    }
    
    // ä¿å­˜å¤ç›˜è®¾ç½®
    function saveReviewSettings() {
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
        alert('å¤ç›˜è®¾ç½®å·²ä¿å­˜');
        
        // åˆ·æ–°å¯èƒ½æ‰“å¼€çš„æ‰“å¡ç•Œé¢
        loadCheckinModalReview(getLocalTodayStr());
    }

    function saveSettings(){
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('settingsModalContent') : null;
        
        const getEl = (id) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + id);
                if (el) return el;
            }
            return document.getElementById(id);
        };
        
        ghConfig.token = getEl('ghToken').value.trim();
        ghConfig.repo = getEl('ghRepo').value.trim();
        localStorage.setItem('habit_gh_v1', JSON.stringify(ghConfig));

        giteeConfig.token = getEl('giteeToken').value.trim();
        giteeConfig.repo = getEl('giteeRepo').value.trim();
        localStorage.setItem('habit_gitee_v1', JSON.stringify(giteeConfig));

        config = {
            wake: getEl('setWake').value,
            sleep: getEl('setSleep').value,
            study: parseFloat(getEl('setStudy').value),
            expiredLimit: parseInt(getEl('setExpiredLimit').value) || 5,
            timerLimit: parseInt(getEl('setTimerLimit').value) || 5,
            historyLimit: parseInt(getEl('setHistoryLimit').value) || 5,
            quickTasks: config.quickTasks || [],
            wakeW: getEl('setWakeW').value,
            sleepW: getEl('setSleepW').value,
            reward: parseFloat(getEl('rewardAmount').value) || 0,
            exchangeRate: parseFloat(getEl('exchangeRate').value) || 5,
            wishToDebtRate: parseFloat(getEl('wishToDebtRate').value) || 2,
            penalties: {
                wakeS: parseFloat(getEl('pWakeS').value) || 0,
                wakeL: parseFloat(getEl('pWakeL').value) || 0,
                sleepS: parseFloat(getEl('pSleepS').value) || 0,
                sleepL: parseFloat(getEl('pSleepL').value) || 0,
                studyS: parseFloat(getEl('pStudyS').value) || 0,
                studyL: parseFloat(getEl('pStudyL').value) || 0
            },
            weekend: config.weekend || [0, 6],
            todoTimeChips: config.todoTimeChips || [],
            reviewTags: config.reviewTags || DEFAULT_CONFIG.reviewTags,
            interface: config.interface || DEFAULT_CONFIG.interface,
            syncProvider: getEl('syncProvider') ? getEl('syncProvider').value : (config.syncProvider || 'both')
        };
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
        alert("é…ç½®å·²ä¿å­˜");
        
        // å¦‚æœæ˜¯ä»modalä¿å­˜çš„ï¼Œå…³é—­modalå¹¶åˆ·æ–°åŸå§‹é¡µé¢
        if (isModalOpen) {
            closeSettingsModal();
            // åˆ·æ–°åŸå§‹é¡µé¢çš„è®¾ç½®æ˜¾ç¤º
            if (typeof applySettingsToUI === 'function') {
                applySettingsToUI();
            }
        }
    }

    function applySettingsToUI(){
        document.getElementById('setWake').value = config.wake;
        document.getElementById('setSleep').value = config.sleep;
        document.getElementById('setStudy').value = config.study;
        document.getElementById('setExpiredLimit').value = config.expiredLimit || 5;
        document.getElementById('setTimerLimit').value = config.timerLimit || 5;
        document.getElementById('setHistoryLimit').value = config.historyLimit || 5;
        document.getElementById('setWakeW').value = config.wakeW;
        document.getElementById('setSleepW').value = config.sleepW;
        document.getElementById('rewardAmount').value = config.reward;
        document.getElementById('exchangeRate').value = config.exchangeRate || 5;
        const wishToDebtRateEl = document.getElementById('wishToDebtRate');
        if (wishToDebtRateEl) wishToDebtRateEl.value = config.wishToDebtRate || 2;

        if(config.penalties) {
            document.getElementById('pWakeS').value = config.penalties.wakeS;
            document.getElementById('pWakeL').value = config.penalties.wakeL;
            document.getElementById('pSleepS').value = config.penalties.sleepS;
            document.getElementById('pSleepL').value = config.penalties.sleepL;
            document.getElementById('pStudyS').value = config.penalties.studyS;
            document.getElementById('pStudyL').value = config.penalties.studyL;
        }

        const we = config.weekend || [0, 6];
        document.getElementById('btn_week_6').className = `week-btn ${we.includes(6)?'active':''}`;
        document.getElementById('btn_week_0').className = `week-btn ${we.includes(0)?'active':''}`;

        renderQuickTaskSettings();
        renderTodoTimeChipSettings();
        renderReviewTagSettings();
        applyInterfaceSettings();

        // å¡«å……æ‰‹åŠ¨è°ƒèŠ‚æ•°å€¼
        document.getElementById('adjTimeBank').value = Number(timeBank).toFixed(1);
        document.getElementById('adjWallet').value = getWallet();
        document.getElementById('adjDebt').value = getDebt();
    }
    
    // æ¸²æŸ“å¾…åŠæ—¶é—´å¿«é€‰è®¾ç½®
    function renderTodoTimeChipSettings() {
        // ä¼˜å…ˆä»è®¾ç½®å¼¹çª—ä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœå¼¹çª—æ‰“å¼€ï¼‰
        const settingsModal = document.getElementById('settingsModal');
        const isSettingsModalOpen = settingsModal && settingsModal.classList.contains('show');
        const settingsModalContent = isSettingsModalOpen ? document.getElementById('settingsModalContent') : null;
        
        let list = null;
        if (isSettingsModalOpen && settingsModalContent) {
            // å¦‚æœè®¾ç½®å¼¹çª—æ‰“å¼€ï¼Œä»å¼¹çª—å†…å®¹ä¸­æŸ¥æ‰¾
            list = settingsModalContent.querySelector('#todoTimeChipsSettingsList');
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»ä¸»é¡µé¢æŸ¥æ‰¾
        if (!list) {
            list = document.getElementById('todoTimeChipsSettingsList');
        }
        
        if (!list) return;
        
        let chips = config.todoTimeChips || [];
        if (chips.length === 0) {
            list.innerHTML = '';
            return;
        }
        
        // åˆ›å»ºç´¢å¼•æ˜ å°„ï¼Œç”¨äºä¿æŒåŸå§‹ç´¢å¼•
        const indexedChips = chips.map((chip, idx) => ({ chip, originalIdx: idx }));
        
        // æ’åºï¼šå…ˆæŒ‰ç±»å‹ï¼ˆoffsetåœ¨å‰ï¼Œfixedåœ¨åï¼‰ï¼Œå†æŒ‰æ—¶é—´æ’åº
        indexedChips.sort((a, b) => {
            const chipA = a.chip;
            const chipB = b.chip;
            
            // å…ˆæŒ‰ç±»å‹æ’åºï¼šoffset åœ¨å‰ï¼Œfixed åœ¨å
            if (chipA.type !== chipB.type) {
                if (chipA.type === 'offset') return -1;
                if (chipB.type === 'offset') return 1;
                return 0;
            }
            
            // åŒç±»å‹å†…æŒ‰æ—¶é—´æ’åº
            if (chipA.type === 'offset') {
                // åç§»æ—¶é—´æŒ‰ hours æ’åº
                const hoursA = chipA.hours || 0;
                const hoursB = chipB.hours || 0;
                return hoursA - hoursB;
            } else if (chipA.type === 'fixed') {
                // å›ºå®šæ—¶é—´æŒ‰ time (HH:MM) æ’åº
                const timeA = chipA.time || '00:00';
                const timeB = chipB.time || '00:00';
                return timeA.localeCompare(timeB);
            }
            
            return 0;
        });
        
        // æ›´æ–° config.todoTimeChips çš„é¡ºåºï¼Œä½¿æ’åºåçš„é¡ºåºä¿æŒ
        config.todoTimeChips = indexedChips.map(item => item.chip);
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        
        // æ¸²æŸ“æ—¶ä½¿ç”¨æ–°çš„ç´¢å¼•ï¼ˆå› ä¸ºæ•°ç»„å·²é‡æ–°æ’åºï¼‰
        list.innerHTML = indexedChips.map((item, idx) => {
            const chip = item.chip;
            const label = chip.type === 'offset' ? `${chip.label} (+${chip.hours}h)` : chip.label;
            return `<div class="chip chip-removable" onclick="removeTodoTimeChip(${idx})">${label}</div>`;
        }).join('');
    }
    
    // æ·»åŠ å¾…åŠæ—¶é—´å¿«é€‰
    function addTodoTimeChip(type) {
        if (!config.todoTimeChips) config.todoTimeChips = [];
        
        if (type === 'offset') {
            showModal({
                title: 'æ·»åŠ åç§»æ—¶é—´',
                message: 'è®¾ç½®ç›¸å¯¹äºå½“å‰æ—¶é—´çš„åç§»å¿«é€‰',
                inputs: [
                    { id: 'chipLabel', label: 'æ ‡ç­¾åç§°', placeholder: 'ä¾‹å¦‚ï¼š1å°æ—¶å', type: 'text' },
                    { id: 'chipHours', label: 'å°æ—¶åç§»é‡', placeholder: 'ä¾‹å¦‚ï¼š1', type: 'number', value: '1' }
                ],
                buttons: [
                    { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                    { 
                        text: 'ç¡®å®š', 
                        primary: true, 
                        callback: (values) => {
                            const label = values.chipLabel ? values.chipLabel.trim() : '';
                            const hoursStr = values.chipHours ? values.chipHours.trim() : '';
                            
                            if (!label) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'è¯·å¡«å†™æ ‡ç­¾åç§°',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            const hours = parseFloat(hoursStr);
                            if (isNaN(hours) || hours <= 0) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'å°æ—¶åç§»é‡æ— æ•ˆï¼Œè¯·è¾“å…¥å¤§äº0çš„æ•°å­—',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            config.todoTimeChips.push({ type: 'offset', label: label, hours: hours });
                            localStorage.setItem('habit_config_v7', JSON.stringify(config));
                            triggerAutoSave();
                            
                            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°å®Œæˆåå†åˆ·æ–°ç•Œé¢
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    renderTodoTimeChipSettings();
                                    renderTodoTimeChips();
                                    renderTimerTimeChips();
                                });
                            });
                        }
                    }
                ]
            });
        } else if (type === 'fixed') {
            showModal({
                title: 'æ·»åŠ å›ºå®šæ—¶é—´',
                message: 'è®¾ç½®å›ºå®šæ—¶é—´çš„å¿«é€‰ï¼ˆå¦‚æœæ—¶é—´å·²è¿‡ä»Šå¤©ï¼Œå°†è‡ªåŠ¨è®¾ç½®ä¸ºæ˜å¤©ï¼›å¯é€‰æ‹©æ—¶é—´æ®µå åŠ ï¼‰',
                inputs: [
                    { id: 'chipLabel', label: 'æ ‡ç­¾åç§°', placeholder: 'ä¾‹å¦‚ï¼šä»Šæ™š23:59', type: 'text' },
                    { id: 'chipTime', label: 'å›ºå®šæ—¶é—´', placeholder: 'HH:MMï¼Œä¾‹å¦‚ï¼š23:59', type: 'text', value: '23:59' },
                    { 
                        id: 'chipDaysOffset', 
                        label: 'æ—¶é—´æ®µå åŠ ï¼ˆå¯é€‰ï¼‰', 
                        type: 'select',
                        value: '0',
                        options: [
                    { value: '0', label: 'æ— ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰' },
                    { value: 'force_today', label: 'ä»Šå¤©' },
                    { value: '1', label: '1å¤©å' },
                    { value: '3', label: '3å¤©å' },
                    { value: '7', label: '7å¤©å' },
                    { value: '30', label: '1æœˆåï¼ˆ30å¤©ï¼‰' }
                ]
                    }
                ],
                buttons: [
                    { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                    { 
                        text: 'ç¡®å®š', 
                        primary: true, 
                        callback: (values) => {
                            const label = values.chipLabel ? values.chipLabel.trim() : '';
                            const time = values.chipTime ? values.chipTime.trim() : '';
                            
                            if (!label) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'è¯·å¡«å†™æ ‡ç­¾åç§°',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            if (!time || !/^\d{1,2}:\d{2}$/.test(time)) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MMï¼ˆå¦‚ 23:59ï¼‰',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            // å¤„ç†æ—¶é—´æ®µå åŠ 
                            const rawOffset = values.chipDaysOffset;
                            const daysOffset = parseInt(rawOffset || '0', 10) || 0;
                            
                            // æ£€æŸ¥æ—¶é—´æ˜¯å¦å·²è¿‡ä»Šå¤©ï¼Œå¦‚æœå·²è¿‡åˆ™æç¤ºä¼šè‡ªåŠ¨è®¾ç½®ä¸ºæ˜å¤©
                            const [hours, minutes] = time.split(':').map(Number);
                            const now = new Date();
                            const fixedTime = new Date(now);
                            fixedTime.setHours(hours, minutes, 0, 0);
                            
                            if (rawOffset === 'force_today') {
                                // å¼ºåˆ¶ä»Šå¤©ï¼Œä¸è¿›è¡Œæ—¥æœŸåç§»
                            } else if (daysOffset > 0) {
                                // å¦‚æœæœ‰æ—¶é—´æ®µå åŠ ï¼Œå…ˆåŠ ä¸Šå¤©æ•°
                                fixedTime.setDate(fixedTime.getDate() + daysOffset);
                            } else {
                                // å¦‚æœæ²¡æœ‰å åŠ ï¼Œæ£€æŸ¥æ—¶é—´æ˜¯å¦å·²è¿‡ä»Šå¤©
                                if (fixedTime <= now) {
                                    fixedTime.setDate(fixedTime.getDate() + 1);
                                }
                            }
                            
                            // æ„å»ºé…ç½®å¯¹è±¡
                            const chipConfig = { type: 'fixed', label: label, time: time };
                            if (rawOffset === 'force_today') {
                                chipConfig.daysOffset = 0;
                            } else if (daysOffset > 0) {
                                chipConfig.daysOffset = daysOffset;
                            }
                            
                            config.todoTimeChips.push(chipConfig);
                            localStorage.setItem('habit_config_v7', JSON.stringify(config));
                            triggerAutoSave();
                            
                            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°å®Œæˆåå†åˆ·æ–°ç•Œé¢
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    renderTodoTimeChipSettings();
                                    renderTodoTimeChips();
                                    renderTimerTimeChips();
                                });
                            });
                            
                            // æç¤ºä¿¡æ¯
                            const fixedDateStr = getLocalDateStr(fixedTime);
                            const todayStr = getLocalDateStr(now);
                            const tomorrowStr = getLocalDateStr(new Date(now.getTime() + 24*60*60*1000));
                            let dateLabel = '';
                            if (fixedDateStr === todayStr) {
                                dateLabel = 'ä»Šå¤©';
                            } else if (fixedDateStr === tomorrowStr) {
                                dateLabel = 'æ˜å¤©';
                            } else {
                                dateLabel = fixedDateStr;
                            }
                            
                            if (daysOffset > 0) {
                                showModal({
                                    title: 'æç¤º',
                                    message: `å·²æ·»åŠ æ—¶é—´å¿«é€‰"${label}"ï¼Œæ—¶é—´ï¼š${time}ï¼Œ${daysOffset}å¤©åï¼ˆ${dateLabel}ï¼‰ã€‚`,
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                            } else if (fixedDateStr > todayStr) {
                                showModal({
                                    title: 'æç¤º',
                                    message: `å·²æ·»åŠ æ—¶é—´å¿«é€‰"${label}"ã€‚ç”±äºæ—¶é—´ ${time} å·²è¿‡ä»Šå¤©ï¼Œå°†è‡ªåŠ¨è®¾ç½®ä¸ºæ˜å¤©ï¼Œæ˜¾ç¤ºä¸º"æ¬¡æ—¥ ${label}"ã€‚`,
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                            }
                        }
                    }
                ]
            });
        }
    }
    
    // åˆ é™¤å¾…åŠæ—¶é—´å¿«é€‰
    function removeTodoTimeChip(idx) {
        if (!config.todoTimeChips) return;
        config.todoTimeChips.splice(idx, 1);
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderTodoTimeChipSettings();
        renderTodoTimeChips(); // åŒæ­¥æ›´æ–°å¾…åŠé¡µé¢
        renderTimerTimeChips(); // åŒæ­¥æ›´æ–°è®¡æ—¶é¡µé¢
        triggerAutoSave();
    }
    
    // é‡ç½®å¾…åŠæ—¶é—´å¿«é€‰ä¸ºé»˜è®¤
    function resetTodoTimeChips() {
        if (!confirm('ç¡®å®šè¦æ¢å¤ä¸ºé»˜è®¤çš„æ—¶é—´å¿«é€‰å—ï¼Ÿ')) return;
        config.todoTimeChips = [];
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderTodoTimeChipSettings();
        renderTodoTimeChips(); // åŒæ­¥æ›´æ–°å¾…åŠé¡µé¢
        renderTimerTimeChips(); // åŒæ­¥æ›´æ–°è®¡æ—¶é¡µé¢
        triggerAutoSave();
    }
    
    // ä¿å­˜ç•Œé¢æ˜¾ç¤ºè®¾ç½®
    // æ›´æ–°å•ä¸ªç•Œé¢é€‰é¡¹
    function updateInterfaceOption(id) {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('settingsModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const checkbox = getEl(id);
        if (!checkbox) return;
        
        const isChecked = checkbox.checked;
        
        // æ›´æ–°å¯¹åº”çš„labelæ ·å¼
        if (id === 'showTimer') {
            const label = getEl('label-showTimer');
            if (label) label.classList.toggle('checked', isChecked);
        } else if (id === 'showStats') {
            const label = getEl('label-showStats');
            if (label) label.classList.toggle('checked', isChecked);
        } else if (id === 'showShop') {
            const label = getEl('label-showShop');
            if (label) label.classList.toggle('checked', isChecked);
        } else if (id === 'showQuickStudy') {
            const label = getEl('label-showQuickStudy');
            if (label) label.classList.toggle('checked', isChecked);
        }
        
        // ä¿å­˜è®¾ç½®
        saveInterfaceSettings();
        // æ›´æ–°é€šçŸ¥æ æ˜¾ç¤º
        updateStickyNotif();
    }
    
    function saveInterfaceSettings() {
        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('settingsModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const showTimer = getEl('showTimer');
        const showStats = getEl('showStats');
        const showShop = getEl('showShop');
        
        if (!showTimer || !showStats || !showShop) return;
        
        const showQuickStudy = getEl('showQuickStudy');
        config.interface = {
            showTimer: showTimer.checked,
            showStats: showStats.checked,
            showShop: showShop.checked,
            showQuickStudy: showQuickStudy ? showQuickStudy.checked : true
        };
        
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        applyInterfaceSettings();
        triggerAutoSave();
    }
    
    // åº”ç”¨ç•Œé¢æ˜¾ç¤ºè®¾ç½®
    function applyInterfaceSettings() {
        const interfaceConfig = config.interface || { showTimer: true, showStats: true, showShop: true, showQuickStudy: true };
        
        // è®¾ç½®å¤é€‰æ¡†çŠ¶æ€å’Œæ ·å¼
        const showTimerCheckbox = document.getElementById('showTimer');
        const showStatsCheckbox = document.getElementById('showStats');
        const showShopCheckbox = document.getElementById('showShop');
        const showQuickStudyCheckbox = document.getElementById('showQuickStudy');
        
        const labelTimer = document.getElementById('label-showTimer');
        const labelStats = document.getElementById('label-showStats');
        const labelShop = document.getElementById('label-showShop');
        const labelQuickStudy = document.getElementById('label-showQuickStudy');
        
        if (showTimerCheckbox) {
            showTimerCheckbox.checked = interfaceConfig.showTimer !== false;
            if (labelTimer) {
                labelTimer.classList.toggle('checked', interfaceConfig.showTimer !== false);
            }
        }
        if (showStatsCheckbox) {
            showStatsCheckbox.checked = interfaceConfig.showStats !== false;
            if (labelStats) {
                labelStats.classList.toggle('checked', interfaceConfig.showStats !== false);
            }
        }
        if (showShopCheckbox) {
            showShopCheckbox.checked = interfaceConfig.showShop !== false;
            if (labelShop) {
                labelShop.classList.toggle('checked', interfaceConfig.showShop !== false);
            }
        }
        if (showQuickStudyCheckbox) {
            showQuickStudyCheckbox.checked = interfaceConfig.showQuickStudy !== false;
            if (labelQuickStudy) {
                labelQuickStudy.classList.toggle('checked', interfaceConfig.showQuickStudy !== false);
            }
        }
        
        // æ˜¾ç¤º/éšè—å¯¹åº”çš„é€‰é¡¹å¡
        const tabs = document.querySelectorAll('.tab');
        const tabOrder = ['checkin', 'timer', 'stats', 'shop', 'settings'];
        
        tabs.forEach((tab, index) => {
            const tabId = tabOrder[index];
            if (tabId === 'timer' && interfaceConfig.showTimer === false) {
                tab.style.display = 'none';
            } else if (tabId === 'stats' && interfaceConfig.showStats === false) {
                tab.style.display = 'none';
            } else if (tabId === 'shop' && interfaceConfig.showShop === false) {
                tab.style.display = 'none';
            } else {
                tab.style.display = '';
            }
        });
    }

    function renderQuickTasks() {
        const container = document.getElementById('quickTasksContainer');
        if (!container) return;
        
        // è·å–é¢„è®¾å¿«æ·ä»»åŠ¡
        let tasks = config.quickTasks || [];
        
        // è·å–ä»Šæ—¥å¾…åŠäº‹é¡¹ï¼ˆä»…"å»åš"ç±»å‹ï¼Œæœªå®Œæˆçš„ï¼‰
        const todayStr = getLocalTodayStr();
        const todayTodos = todoList.filter(t => 
            t.type === 'do' && 
            t.status === 'pending' && 
            t.date === todayStr &&
            !t.archived
        );
        
        // åˆå¹¶ä»»åŠ¡åˆ—è¡¨ï¼ˆä¸å†åŒ…å«å¾…åŠï¼Œå¾…åŠé€šè¿‡å›ºå®šæŒ‰é’®é€‰æ‹©ï¼‰
        const allTasks = tasks.map(t => ({ name: t, isTodo: false }));
        
        // ä¸ºéå¾…åŠä»»åŠ¡æ·»åŠ ä½¿ç”¨é¢‘æ¬¡å¹¶æ’åºï¼ˆä½¿ç”¨è§„èŒƒåŒ–åç§°ï¼Œå¿½ç•¥å›¾æ ‡ï¼‰
        allTasks.forEach(task => {
            if (!task.isTodo) {
                const normalizedName = normalizeTaskName(task.name);
                task.count = taskUsageCount[normalizedName] || 0;
            }
        });
        
        allTasks.sort((a, b) => b.count - a.count);
        
        container.style.display = 'flex';
        container.style.flexWrap = 'wrap';
        container.style.gap = '8px';
        
        // é¦–å…ˆæ·»åŠ å›ºå®šçš„"å¾…åŠ"æŒ‰é’®
        let html = `<div class="chip" style="background:var(--success-bg);border-color:var(--success);color:var(--success);font-weight:700;cursor:pointer;" onclick="showTodoSelectModal()">ğŸ“‹ å¾…åŠ</div>`;
        
        // ç„¶åæ·»åŠ å…¶ä»–å¿«æ·ä»»åŠ¡
        if (allTasks.length > 0) {
            html += allTasks.map(task => {
                return `<div class="chip" onclick="quickSelectTask('${task.name.replace(/'/g, "\\'")}')">${task.name}</div>`;
            }).join('');
        } else {
            html += '<div style="text-align:center;color:var(--text-sub);font-size:11px;padding:8px;width:100%;">æš‚æ— å¿«é€‰é¡¹ï¼Œå»è®¾ç½®ä¸­æ·»åŠ å§</div>';
        }
        
        container.innerHTML = html;
    }
    
    function showTodoSelectModal() {
        console.log('showTodoSelectModal è¢«è°ƒç”¨');
        // æ£€æŸ¥æ˜¯å¦åœ¨è®¡æ—¶å¼¹å‡ºçª—å£ä¸­
        const timerModal = document.getElementById('timerModal');
        const isTimerModalOpen = timerModal && timerModal.classList.contains('show');
        console.log('isTimerModalOpen:', isTimerModalOpen);
        
        // ä¼˜å…ˆæŸ¥æ‰¾å¼¹å‡ºçª—å£ä¸­çš„å¾…åŠé€‰æ‹©å¼¹çª—ï¼Œå¦åˆ™æŸ¥æ‰¾ä¸»é¡µé¢çš„
        let modal = null;
        let list = null;
        
        if (isTimerModalOpen) {
            // åœ¨å¼¹å‡ºçª—å£ä¸­ï¼Œä¼˜å…ˆæŸ¥æ‰¾bodyä¸­çš„å¼¹çª—ï¼ˆå› ä¸ºposition:fixedéœ€è¦ç›¸å¯¹äºè§†å£ï¼‰
            modal = document.body.querySelector('#todoSelectModalTimer');
            list = document.body.querySelector('#todoSelectListTimer');
            console.log('æŸ¥æ‰¾bodyä¸­çš„å¼¹çª—ç»“æœ:', { modal, list });
            
            // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒï¼ˆæ·»åŠ åˆ°bodyï¼Œè€Œä¸æ˜¯timerModalContentï¼‰
            if (!modal) {
                console.log('åˆ›å»ºæ–°çš„å¾…åŠé€‰æ‹©å¼¹çª—åˆ°body');
                const todoSelectModalHTML = `
                    <div id="todoSelectModalTimer" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100000; align-items:center; justify-content:center;">
                        <div style="background:var(--bg-card); border-radius:20px; padding:24px; max-width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); border:1px solid var(--border);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                <div style="font-weight:800; font-size:18px; color:var(--text-main);">é€‰æ‹©å¾…åŠ</div>
                                <div class="btn-action" onclick="closeTodoSelectModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
                            </div>
                            <div id="todoSelectListTimer" style="max-height:60vh; overflow-y:auto;"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', todoSelectModalHTML);
                modal = document.body.querySelector('#todoSelectModalTimer');
                list = document.body.querySelector('#todoSelectListTimer');
                console.log('åˆ›å»ºåçš„å¼¹çª—:', { modal, list });
            }
        }
        
        // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ä¸»é¡µé¢çš„
        if (!modal) {
            modal = document.getElementById('todoSelectModal');
            list = document.getElementById('todoSelectList');
            console.log('ä½¿ç”¨ä¸»é¡µé¢çš„å¼¹çª—:', { modal, list });
        }
        
        if (!modal || !list) {
            console.error('æœªæ‰¾åˆ°å¼¹çª—æˆ–åˆ—è¡¨å…ƒç´ ', { modal, list });
            return;
        }
        
        // ç¡®ä¿z-indexè¶³å¤Ÿé«˜ï¼Œæ˜¾ç¤ºåœ¨æœ€é¡¶å±‚
        if (isTimerModalOpen) {
            modal.style.zIndex = '100000';
        } else {
            modal.style.zIndex = '2000';
        }
        
        console.log('è®¾ç½®å¼¹çª—æ ·å¼:', { zIndex: modal.style.zIndex, display: modal.style.display });
        
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        
        // è·å–æ‰€æœ‰æœªå®Œæˆçš„å¾…åŠï¼ˆåŒ…æ‹¬ä»Šæ—¥å’Œæœªæ¥çš„ï¼‰
        const availableTodos = todoList.filter(t => {
            if (t.archived) return false;
            if (t.status !== 'pending') return false;
            if (t.date < todayStr) return false;
            if (t.date === todayStr && t.time && currentHm > t.time) return false;
            return true;
        });
        
        console.log('å¯ç”¨å¾…åŠæ•°é‡:', availableTodos.length);
        
        if (availableTodos.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:30px;">æš‚æ— å¯ç”¨å¾…åŠäº‹é¡¹</div>';
        } else {
            // æŒ‰æ—¥æœŸå’Œæ—¶é—´æ’åº
            availableTodos.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.time || '99:99').localeCompare(b.time || '99:99');
            });
            
            list.innerHTML = availableTodos.map(t => {
                const dateBadge = t.date > todayStr ? `<span style="font-size:10px;color:var(--text-sub);background:var(--border);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.date.slice(5)}</span>` : '';
                const timeBadge = t.time ? `<span style="font-size:10px;color:var(--text-sub);background:var(--border);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.time}</span>` : '';
                const importance = t.importance || 1;
                const importanceColors = { 3: 'var(--danger)', 2: 'var(--warning)', 1: 'var(--info)' };
                const importanceDot = `<span style="width:10px; height:10px; border-radius:50%; background:${importanceColors[importance]}; display:inline-block; margin-right:4px;"></span>`;
                
                return `
                    <div class="list-item" style="cursor:pointer; margin-bottom:8px;" onclick="selectTodoFromModal('${String(t.id)}')">
                        <div style="flex:1;">
                            <div style="font-weight:700; color:var(--text-main); display:flex; align-items:center;">
                                ${importanceDot}${t.title} ${timeBadge} ${dateBadge}
                            </div>
                            ${t.note ? `<div style="font-size:11px;color:var(--text-sub);margin-top:4px;">${t.note}</div>` : ''}
                            <div style="font-size:11px;color:var(--text-sub);margin-top:4px;">å¥–${t.reward || 0} / ç½š${t.penalty || 0}</div>
                        </div>
                        <div style="color:var(--success); font-size:20px;">âœ“</div>
                    </div>
                `;
            }).join('');
        }
        
        // ç¡®ä¿å¼¹çª—æ˜¾ç¤º
        modal.style.display = 'flex';
        console.log('å¼¹çª—å·²æ˜¾ç¤º:', { display: modal.style.display, zIndex: modal.style.zIndex, modal });
        
        // å¼ºåˆ¶é‡æ–°è®¡ç®—æ ·å¼
        void modal.offsetHeight;
    }
    
    function closeTodoSelectModal() {
        // æ£€æŸ¥æ˜¯å¦åœ¨è®¡æ—¶å¼¹å‡ºçª—å£ä¸­
        const timerModal = document.getElementById('timerModal');
        const isTimerModalOpen = timerModal && timerModal.classList.contains('show');
        
        let modal = null;
        
        if (isTimerModalOpen) {
            // æŸ¥æ‰¾bodyä¸­çš„å¼¹çª—ï¼ˆç”¨äºtimerModalï¼‰
            modal = document.body.querySelector('#todoSelectModalTimer');
        }
        
        // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ä¸»é¡µé¢çš„
        if (!modal) {
            modal = document.getElementById('todoSelectModal');
        }
        
        if (modal) {
            modal.style.display = 'none';
            console.log('å…³é—­å¾…åŠé€‰æ‹©å¼¹çª—');
        }
    }
    
    function selectTodoFromModal(todoId) {
        // ç¡®ä¿todoIdæ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—éƒ½èƒ½å¤„ç†
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        selectTodoForTimer(id);
        closeTodoSelectModal();
    }

    function renderQuickTaskSettings() {
        // åˆ›å»ºä»»åŠ¡æ•°ç»„å¹¶é™„åŠ ä½¿ç”¨é¢‘æ¬¡ä¿¡æ¯
        let tasks = (config.quickTasks || []).map((t, idx) => ({
            name: t,
            index: idx,
            count: taskUsageCount[t] || 0
        }));
        
        // æŒ‰ä½¿ç”¨é¢‘æ¬¡æ’åº
        tasks.sort((a, b) => b.count - a.count);
        
        const chipsHtml = tasks.map(t => {
            return `<div class="chip chip-removable" onclick="removeQuickTask(${t.index})">${t.name}</div>`;
        }).join('');
        
        // æ›´æ–°ä¸»é¡µé¢ä¸­çš„åˆ—è¡¨
        const list = document.getElementById('setQuickTasksList');
        if (list) {
            list.innerHTML = chipsHtml;
        }
        
        // å¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°æ¨¡æ€æ¡†ä¸­çš„åˆ—è¡¨
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.classList.contains('show');
        if (isModalOpen) {
            const modalContent = document.getElementById('settingsModalContent');
            if (modalContent) {
                const modalList = modalContent.querySelector('#setQuickTasksList');
                if (modalList) {
                    modalList.innerHTML = chipsHtml;
                }
            }
        }
    }

    function addQuickTask() {
        // ä¼˜å…ˆä»æ¨¡æ€æ¡†ä¸­è·å– inputï¼ˆå¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼‰
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.classList.contains('show');
        let input = null;
        
        if (isModalOpen) {
            const modalContent = document.getElementById('settingsModalContent');
            if (modalContent) {
                input = modalContent.querySelector('#input_quicktask');
            }
        }
        
        // å¦‚æœæ¨¡æ€æ¡†ä¸­æ²¡æ‰¾åˆ°ï¼Œåˆ™ä»ä¸»é¡µé¢è·å–
        if (!input) {
            input = document.getElementById('input_quicktask');
        }
        
        if (!input) {
            console.error('input_quicktask not found');
            alert('è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        const val = (input.value || '').trim();
        if(!val) {
            alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
            input.focus();
            return;
        }
        if(!config.quickTasks) config.quickTasks = [];
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (config.quickTasks.includes(val)) {
            alert('è¯¥ä»»åŠ¡å·²å­˜åœ¨');
            input.value = '';
            input.focus();
            return;
        }
        config.quickTasks.push(val);
        input.value = '';
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderQuickTaskSettings();
        renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
        renderTodoTaskChips(); // åŒæ­¥æ›´æ–°å¾…åŠçš„å¿«é€‰èƒ¶å›Š
        triggerAutoSave();
    }

    function removeQuickTask(idx) {
        if(!confirm(`åˆ é™¤æ­¤å¿«æ·é¡¹?`)) return;
        if (!config.quickTasks || idx < 0 || idx >= config.quickTasks.length) {
            console.error('Invalid index for removeQuickTask:', idx);
            return;
        }
        const removedTask = config.quickTasks[idx];
        config.quickTasks.splice(idx, 1);
        
        // åŒæ—¶åˆ é™¤è¯¥ä»»åŠ¡çš„ä½¿ç”¨é¢‘æ¬¡è®°å½•
        if (taskUsageCount && taskUsageCount[removedTask]) {
            delete taskUsageCount[removedTask];
            localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        }
        
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderQuickTaskSettings();
        renderQuickTasks();
        renderTodoTaskChips(); // åŒæ­¥æ›´æ–°å¾…åŠçš„å¿«é€‰èƒ¶å›Š
        triggerAutoSave();
    }

    function resetTaskUsage() {
        if(!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä»»åŠ¡çš„ä½¿ç”¨é¢‘æ¬¡ç»Ÿè®¡å—ï¼Ÿ')) return;
        taskUsageCount = {};
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        renderQuickTasks();
        renderQuickTaskSettings();
        alert('âœ… ä½¿ç”¨é¢‘æ¬¡å·²é‡ç½®');
        triggerAutoSave();
    }

    function getWallet() {
        const v = parseFloat(localStorage.getItem('habit_wallet_v1'));
        return Number.isFinite(v) ? Math.max(0, Math.round(v)) : 0;
    }
    function setWallet(v) {
        const n = Math.max(0, Math.round(v));
        localStorage.setItem('habit_wallet_v1', n);
        globalWallet = n;
    }
    function addWallet(delta) {
        setWallet(getWallet() + (Number(delta) || 0));
    }
    function getDebt() {
        const v = parseFloat(localStorage.getItem('habit_debt_v1'));
        return Number.isFinite(v) ? Math.max(0, Math.round(v)) : 0;
    }
    function setDebt(v) {
        const n = Math.max(0, Math.round(v));
        localStorage.setItem('habit_debt_v1', n);
        globalDebt = n;
    }
    function addDebt(delta) {
        setDebt(getDebt() + (Number(delta) || 0));
    }

    function applyManualAdjustment(event) {
        // å…œåº•ï¼šé¿å…æŸäº›æƒ…å†µä¸‹ç‚¹å‡»è¢«çˆ¶å±‚é€»è¾‘å¹²æ‰°
        if (event && typeof event.stopPropagation === 'function') event.stopPropagation();

        // é˜²é‡å¤è§¦å‘ï¼šinline onclick ä¸äº‹ä»¶å§”æ‰˜éƒ½ä¼šè°ƒç”¨ï¼Œè®¾ç½®è½»é‡æ ‡è®°é¿å…åŒä¸€ç‚¹å‡»æ‰§è¡Œä¸¤æ¬¡
        const btnTarget = event && (event.currentTarget || event.target);
        if (btnTarget) {
            const alreadyHandling = btnTarget.getAttribute('data-adjust-clicking') === '1';
            if (alreadyHandling) {
                return;
            }
            btnTarget.setAttribute('data-adjust-clicking', '1');
            // çŸ­æš‚çª—å£åç§»é™¤ï¼Œå…è®¸åç»­å†æ¬¡ç‚¹å‡»
            setTimeout(() => btnTarget.removeAttribute('data-adjust-clicking'), 500);
        }

        // å…³é”®ï¼šè®¾ç½®å¼¹çª—æ˜¯å…‹éš† DOMï¼Œå­˜åœ¨åŒå IDã€‚å¿…é¡»ä»â€œè§¦å‘æŒ‰é’®æ‰€åœ¨åŒºåŸŸâ€å‘ä¸Šé™å®šèŒƒå›´è¯»å–ã€‚
        const btn =
            event && (event.currentTarget || event.target) && (event.currentTarget || event.target).closest
                ? (event.currentTarget || event.target)
                : null;
        const cardRoot = btn && btn.closest ? btn.closest('.card') : null;
        const scopeRoot =
            (btn && btn.closest && btn.closest('#settingsModal')) ||
            (btn && btn.closest && btn.closest('#page-settings')) ||
            document;

        const q = (id) => {
            // åœ¨ scope å†…ä¼˜å…ˆæŸ¥æ‰¾ï¼Œé¿å…å–åˆ°å¦ä¸€å¥—åŒåå…ƒç´ 
            const el = scopeRoot && scopeRoot.querySelector ? scopeRoot.querySelector('#' + id) : null;
            return el || document.getElementById(id);
        };

        const statusEl = (cardRoot && cardRoot.querySelector) ? cardRoot.querySelector('#manualAdjustmentStatus') : q('manualAdjustmentStatus');
        if (statusEl) statusEl.textContent = 'å·²è§¦å‘ï¼šæ­£åœ¨æ ¡éªŒ...';

        const timeBankEl = cardRoot ? cardRoot.querySelector('#adjTimeBank') : q('adjTimeBank');
        const walletEl = cardRoot ? cardRoot.querySelector('#adjWallet') : q('adjWallet');
        const debtEl = cardRoot ? cardRoot.querySelector('#adjDebt') : q('adjDebt');
        const reasonEl = cardRoot ? cardRoot.querySelector('#adjReason') : q('adjReason');

        const rawTimeBank = timeBankEl ? timeBankEl.value : '';
        const rawWallet = walletEl ? walletEl.value : '';
        const rawDebt = debtEl ? debtEl.value : '';
        const reason = reasonEl ? reasonEl.value.trim() : '';

        // å…è®¸éƒ¨åˆ†ç•™ç©ºï¼šç•™ç©ºåˆ™è®¤ä¸ºâ€œä¸ä¿®æ”¹è¯¥é¡¹â€ï¼Œä½¿ç”¨å½“å‰å€¼
        // åŒæ—¶å¼ºåˆ¶æœ€å°å€¼ä¸º 0ï¼Œé¿å…è´Ÿæ•°å¯¼è‡´æ˜¾ç¤º/ç»Ÿè®¡æ··ä¹±
        let newTimeBank = rawTimeBank === '' ? timeBank : parseFloat(rawTimeBank);
        let newWallet = rawWallet === '' ? globalWallet : parseFloat(rawWallet);
        let newDebt = rawDebt === '' ? globalDebt : parseFloat(rawDebt);

        if (Number.isFinite(newTimeBank)) newTimeBank = Math.max(0, newTimeBank);
        if (Number.isFinite(newWallet)) newWallet = Math.max(0, Math.round(newWallet));
        if (Number.isFinite(newDebt)) newDebt = Math.max(0, Math.round(newDebt));

        // è‹¥ç”¨æˆ·è¾“å…¥äº†è´Ÿæ•°ï¼Œå›å†™ä¸º 0ï¼ˆæ‰€è§å³æ‰€å¾—ï¼‰
        if (timeBankEl && rawTimeBank !== '' && Number.isFinite(newTimeBank)) timeBankEl.value = Number(newTimeBank).toFixed(1);
        if (walletEl && rawWallet !== '' && Number.isFinite(newWallet)) walletEl.value = String(newWallet);
        if (debtEl && rawDebt !== '' && Number.isFinite(newDebt)) debtEl.value = String(newDebt);

        // æ ¡éªŒæ•°å€¼æœ‰æ•ˆæ€§ï¼ˆé˜²æ­¢ NaN é™é»˜é€šè¿‡ï¼‰
        if (!Number.isFinite(newTimeBank) || !Number.isFinite(newWallet) || !Number.isFinite(newDebt)) {
            if (statusEl) statusEl.textContent = 'æ ¡éªŒå¤±è´¥ï¼šè¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼ï¼ˆå¯ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰ã€‚';
            alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼");
            return;
        }
        if (!reason) {
            if (statusEl) statusEl.textContent = 'æ ¡éªŒå¤±è´¥ï¼šè¯·è¾“å…¥ä¿®æ”¹åŸå› ã€‚';
            alert("è¯·è¾“å…¥ä¿®æ”¹åŸå› ");
            return;
        }

        const today = getLocalTodayStr();
        let changed = false;

        // 1. è°ƒæ•´æ—¶é—´é“¶è¡Œ
        const diffTB = newTimeBank - timeBank;
        if (Math.abs(diffTB) > 0.01) {
            timeBank = newTimeBank;
            localStorage.setItem('habit_time_bank_v1', timeBank);
            // è®°å½•æ—¶é—´é“¶è¡Œå˜åŠ¨
            historyData.unshift({
                id: Date.now() + 1,
                date: today,
                title: "â³ æ—¶é—´é“¶è¡Œæ‰‹åŠ¨è°ƒèŠ‚",
                fund: 0,
                theme: "theme-skip",
                details: { manual_edit_reason: reason, note: (diffTB > 0 ? "+" : "") + diffTB.toFixed(1) + "h", time_bank_change: diffTB }
            });
            changed = true;
        }

        // 2. è°ƒæ•´æ„¿æœ›é‡‘ (Wallet)
        const diffW = newWallet - getWallet();
        if (Math.abs(diffW) > 0.01) {
            setWallet(newWallet);
            historyData.unshift({
                id: Date.now() + 2,
                date: today,
                title: "ğŸ’° æ„¿æœ›é‡‘æ‰‹åŠ¨è°ƒèŠ‚",
                fund: diffW,
                theme: diffW > 0 ? "theme-success" : "theme-shop",
                details: { manual_edit_reason: reason, wallet_change: diffW }
            });
            changed = true;
        }

        // 3. è°ƒæ•´å¾…ç½šé‡‘ (Debt)
        const diffD = newDebt - getDebt();
        if (Math.abs(diffD) > 0.01) {
            setDebt(newDebt);
            historyData.unshift({
                id: Date.now() + 3,
                date: today,
                title: "ğŸ’¸ å¾…ç½šé‡‘æ‰‹åŠ¨è°ƒèŠ‚",
                fund: diffD,
                theme: diffD > 0 ? "theme-repair" : "theme-pay",
                details: { manual_edit_reason: reason, note: diffD > 0 ? "æ‰‹åŠ¨å¢åŠ " : "æ‰‹åŠ¨å‡å°‘", debt_change: diffD }
            });
            changed = true;
        }

        if (changed) {
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            updateUI();
            triggerAutoSave();
            if (statusEl) statusEl.textContent = 'å·²åº”ç”¨ï¼šè°ƒæ•´å·²å†™å…¥å¹¶è®°å½•åˆ°å†å²ã€‚';
            alert("æ•°æ®å·²æˆåŠŸä¿®æ­£ï¼Œè°ƒæ•´å·²è®°å½•è‡³å†å²æ¡£æ¡ˆã€‚");
            if (reasonEl) reasonEl.value = '';
        } else {
            if (statusEl) statusEl.textContent = 'æœªåº”ç”¨ï¼šæ•°å€¼æ²¡æœ‰å˜åŒ–ï¼ˆå·®å€¼ â‰¤ 0.01ï¼‰ã€‚';
            alert("æ•°å€¼æœªå‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€è°ƒæ•´ã€‚");
        }
    }

    async function syncGitHub(action, isAuto) {
        // AIGC START
        // é˜²æ­¢é‡å¤æ‰§è¡Œï¼šå¦‚æœæ­£åœ¨åŒæ­¥ä¸­ï¼Œç›´æ¥è¿”å›
        const badge = document.getElementById('syncBadge');
        if (badge && badge.classList.contains('status-syncing')) {
            console.log('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
            return;
        }
        
        console.log('syncGitHubè¢«è°ƒç”¨:', action, isAuto);
        // AIGC START
        // ç«‹å³æ›´æ–°çŠ¶æ€å¹¶ç¦ç”¨æŒ‰é’®ï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°åé¦ˆä¸”é˜²æ­¢é‡å¤ç‚¹å‡»
        setSyncBadgeStatus('status-syncing', action==='push'?'ä¸Šä¼ ...':'åŒæ­¥...');
        // ä½¿ç”¨requestAnimationFrameç¡®ä¿çŠ¶æ€æ›´æ–°ç«‹å³æ¸²æŸ“ï¼Œæ— éœ€ç­‰å¾…50ms
        await new Promise(resolve => requestAnimationFrame(resolve));
        // AIGC END
        
        const token = ghConfig.token;
        const repo = ghConfig.repo;
        const path = ghConfig.path || 'habit_backup.json';
        if(!token || !repo) {
            setSyncBadgeStatus('status-error', 'æœªé…ç½®');
            if(!isAuto) alert("è¯·å…ˆé…ç½® GitHub");
            return;
        }

        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };

            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });

            let sha = null, cloudData = null;

            if(getRes.ok) {
                try {
                    const d = await getRes.json();
                    sha = d.sha || null;
                    cloudData = JSON.parse(decodeURIComponent(escape(atob((d.content || '').replace(/\n/g,"")))));
                } catch(parseError) {
                    console.error('è§£æäº‘ç«¯æ•°æ®å¤±è´¥:', parseError);
                    if(!isAuto) alert("âŒ äº‘ç«¯æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æ");
                    setSyncBadgeStatus('status-error', 'æ ¼å¼é”™è¯¯');
                    return;
                }
            } else if(getRes.status === 404) {
                // æ–‡ä»¶ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„ï¼ˆé¦–æ¬¡åŒæ­¥ï¼‰
                cloudData = null;
            } else {
                // å…¶ä»–é”™è¯¯ï¼ˆ401æœªæˆæƒã€403ç¦æ­¢è®¿é—®ç­‰ï¼‰
                const errorText = await getRes.text();
                console.error('GitHub APIé”™è¯¯:', getRes.status, errorText);
                throw new Error(`GitHub APIé”™è¯¯: ${getRes.status} - ${errorText}`);
            }

            if(action === 'pull') {
                if(!cloudData) {
                    // äº‘ç«¯æ²¡æœ‰æ•°æ®
                    setSyncBadgeStatus('status-idle', 'æ— äº‘ç«¯æ•°æ®');
                    // ä¸å†å¼¹çª—ï¼ŒçŠ¶æ€æ–‡å­—"æ— äº‘ç«¯æ•°æ®"å·²è¶³å¤Ÿè¯´æ˜
                    return;
                }

                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;

                let shouldApply = false;
                if (cloudTs > localTs) {
                    shouldApply = true;
                } else if (!isAuto) {
                    shouldApply = confirm(`äº‘ç«¯æ•°æ®æ—¶é—´æˆ³(${cloudTs})å¹¶ä¸æ¯”æœ¬åœ°æ–°(${localTs})ã€‚\nä»è¦ç”¨äº‘ç«¯è¦†ç›–æœ¬åœ°å—ï¼Ÿ`);
                }

                if(shouldApply) {
                    // åˆå¹¶æ•°æ®ï¼šä¿ç•™æœ¬åœ°å’Œäº‘ç«¯çš„æ–°å¢/ä¿®æ”¹ï¼Œè€Œä¸æ˜¯ç›´æ¥è¦†ç›–
                    mergeData(cloudData, {
                        data: historyData || [],
                        todos: todoList || [],
                        wishes: wishList || [],
                        strategies: userStrategies || {},
                        timerRecords: timerRecords || [],
                        plannedTasks: plannedTasks || [],
                        dailyReviews: dailyReviews || {},
                        taskUsageCount: taskUsageCount || {},
                        daysMatterList: daysMatterList || []
                    });
                    
                    // é…ç½®å’Œæ—¶é—´é“¶è¡Œç›´æ¥ä½¿ç”¨äº‘ç«¯çš„ï¼ˆè¿™äº›ä¸éœ€è¦åˆå¹¶ï¼‰
                    if(cloudData.config) config = cloudData.config;
                    if(cloudData.pinnedTaskId) {
                        pinnedTaskId = cloudData.pinnedTaskId;
                        localStorage.setItem('habit_pinned_task_id', pinnedTaskId);
                    }
                    if(cloudData.daysMatterList) {
                        daysMatterList = cloudData.daysMatterList;
                        localStorage.setItem('habit_days_matter_v1', JSON.stringify(daysMatterList));
                    }
                    if(cloudData.timeBank !== undefined) timeBank = cloudData.timeBank;
                    if(cloudData.wallet !== undefined) setWallet(cloudData.wallet);
                    if(cloudData.debt !== undefined) setDebt(cloudData.debt);
                    
                    // åŒæ­¥è®¡æ—¶å™¨çŠ¶æ€
                    const hadLocalTimer = localStorage.getItem('habit_timer_state_v1') !== null;
                    const hasCloudTimer = cloudData.timerState && cloudData.timerState.running;
                    
                    if(hasCloudTimer) {
                        // å¦‚æœäº‘ç«¯æœ‰æ­£åœ¨è¿è¡Œçš„è®¡æ—¶å™¨ï¼Œä¿å­˜åˆ°æœ¬åœ°
                        localStorage.setItem('habit_timer_state_v1', JSON.stringify(cloudData.timerState));
                        console.log('ğŸ“¥ ä»äº‘ç«¯åŒæ­¥åˆ°è®¡æ—¶å™¨çŠ¶æ€:', cloudData.timerState.taskName);
                    } else {
                        // å¦‚æœäº‘ç«¯æ²¡æœ‰è¿è¡Œçš„è®¡æ—¶å™¨ï¼Œæ¸…é™¤æœ¬åœ°çš„
                        if (hadLocalTimer && timerRunning) {
                            console.log('â¹ï¸ æ£€æµ‹åˆ°è®¡æ—¶å™¨åœ¨å…¶ä»–è®¾å¤‡å·²ç»“æŸï¼ŒåŒæ­¥åœæ­¢æœ¬åœ°è®¡æ—¶å™¨');
                        }
                        localStorage.removeItem('habit_timer_state_v1');
                    }

                    persistAllLocal();
                    localStorage.setItem('habit_last_save', String(cloudTs || Date.now()));

                    setSyncBadgeStatus('status-idle', 'å·²æ›´æ–°');
                    // AIGC START
                    // å¼‚æ­¥æ‰§è¡ŒUIæ›´æ–°ï¼Œé¿å…é˜»å¡åŒæ­¥çŠ¶æ€æ˜¾ç¤º
                    requestAnimationFrame(() => {
                        updateUI(); renderTodos(); checkDateChange(); applySettingsToUI(); renderStrategySettings();
                        if (typeof renderTimerHistory === 'function') renderTimerHistory();
                        if (typeof renderPlannedTasks === 'function') renderPlannedTasks();
                        // æ¢å¤è®¡æ—¶å™¨çŠ¶æ€ï¼ˆä¼šè‡ªåŠ¨å¤„ç†æœ‰/æ— è®¡æ—¶å™¨çš„æƒ…å†µï¼‰
                        restoreTimerState();
                        updateStickyNotif();
                    });
                    // AIGC END
                    // æˆåŠŸæ—¶ä¸å†å¼¹çª—ï¼ŒçŠ¶æ€æ–‡å­—"å·²æ›´æ–°"å·²è¶³å¤Ÿè¯´æ˜
                } else {
                    setSyncBadgeStatus('status-idle', 'å·²æœ€æ–°');
                    // å·²æ˜¯æœ€æ–°æ—¶ä¸å¼¹çª—ï¼ŒçŠ¶æ€æ–‡å­—"å·²æœ€æ–°"å·²è¶³å¤Ÿè¯´æ˜
                }
            } else {
                // Push æ“ä½œï¼šå…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°ï¼Œé¿å…è¦†ç›–å…¶ä»–è®¾å¤‡çš„æ›´æ”¹
                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;
                
                // å¦‚æœäº‘ç«¯æ•°æ®æ›´æ–°ï¼Œå…ˆåˆå¹¶å†æ¨é€
                if (cloudData && cloudTs > localTs) {
                    console.log('âš ï¸ æ£€æµ‹åˆ°äº‘ç«¯æœ‰æ›´æ–°ï¼Œå…ˆåˆå¹¶æ•°æ®å†æ¨é€');
                    // åˆå¹¶æ•°æ®ï¼šä¿ç•™æœ¬åœ°å’Œäº‘ç«¯çš„æ–°å¢/ä¿®æ”¹
                    mergeData(cloudData, {
                        data: historyData || [],
                        todos: todoList || [],
                        wishes: wishList || [],
                        strategies: userStrategies || {},
                        timerRecords: timerRecords || [],
                        plannedTasks: plannedTasks || [],
                        dailyReviews: dailyReviews || {},
                        taskUsageCount: taskUsageCount || {},
                        daysMatterList: daysMatterList || []
                    });
                }
                
                // è·å–å½“å‰è®¡æ—¶å™¨çŠ¶æ€
                const timerStateStr = localStorage.getItem('habit_timer_state_v1');
                const timerState = timerStateStr ? JSON.parse(timerStateStr) : null;
                
                if (timerState && timerState.running) {
                    console.log('ğŸ“¤ æ­£åœ¨ä¸Šä¼ è®¡æ—¶å™¨çŠ¶æ€åˆ°äº‘ç«¯:', timerState.taskName, 'å·²è®¡æ—¶', Math.floor(timerState.seconds / 60), 'åˆ†é’Ÿ');
                }
                
                const content = {
                    timestamp: Date.now(),
                    data: stripImagesFromHistory(historyData),
                    config,
                    todos: todoList,
                    deletedTodoIds: typeof deletedTodoIds !== 'undefined' ? deletedTodoIds : [],
                    wishes: wishList,
                    strategies: userStrategies,
                    timeBank: timeBank,
                    wallet: getWallet(),
                    debt: getDebt(),
                    timerRecords: timerRecords,
                    plannedTasks: plannedTasks,
                    dailyReviews: dailyReviews,
                    taskUsageCount: taskUsageCount,
                    pinnedTaskId: pinnedTaskId,
                    timerState: timerState, // åŒ…å«è®¡æ—¶å™¨çŠ¶æ€
                    daysMatterList: daysMatterList // å€’æ•°æ—¥
                };

                const body = {
                    message: "Sync",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content))))
                };
                if (sha) body.sha = sha;

                try {
                    const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers, body: JSON.stringify(body) });
                    
                    // å¤„ç†409å†²çªï¼ˆæ–‡ä»¶å·²è¢«å…¶ä»–è®¾å¤‡ä¿®æ”¹ï¼‰
                    if (putRes.status === 409) {
                        console.log('âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œé‡æ–°æ‹‰å–å¹¶åˆå¹¶åé‡è¯•');
                        // é‡æ–°è·å–æœ€æ–°æ•°æ®
                        const retryGetRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
                        if (retryGetRes.ok) {
                            const retryData = await retryGetRes.json();
                            const retryCloudData = JSON.parse(decodeURIComponent(escape(atob((retryData.content || '').replace(/\n/g,"")))));
                            const retrySha = retryData.sha;
                            
                            // åˆå¹¶æ•°æ®
                            mergeData(retryCloudData, {
                                data: historyData || [],
                                todos: todoList || [],
                                wishes: wishList || [],
                            strategies: userStrategies || {},
                            timerRecords: timerRecords || [],
                            plannedTasks: plannedTasks || [],
                            dailyReviews: dailyReviews || {},
                            taskUsageCount: taskUsageCount || {},
                            daysMatterList: daysMatterList || []
                        });
                            
                            // ä½¿ç”¨åˆå¹¶åçš„æ•°æ®é‡æ–°æ¨é€
                            content.data = stripImagesFromHistory(historyData);
                            content.todos = todoList;
                            content.deletedTodoIds = typeof deletedTodoIds !== 'undefined' ? deletedTodoIds : [];
                            content.wishes = wishList;
                            content.strategies = userStrategies;
                            content.timerRecords = timerRecords;
                            content.plannedTasks = plannedTasks;
                            content.dailyReviews = dailyReviews;
                            content.taskUsageCount = taskUsageCount;
                            content.daysMatterList = daysMatterList;
                            content.timestamp = Date.now();
                            
                            body.content = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
                            body.sha = retrySha;
                            
                            await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers, body: JSON.stringify(body) });
                        }
                    } else if (!putRes.ok) {
                        throw new Error(`Push failed with status ${putRes.status}`);
                    }
                } catch (fetchError) {
                    if (fetchError.message && fetchError.message.includes('409')) {
                        // å¦‚æœè¿˜æ˜¯409ï¼Œè¯´æ˜åœ¨é‡è¯•æœŸé—´åˆæœ‰æ›´æ–°ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨åŒæ­¥
                        setSyncBadgeStatus('status-error', 'å†²çª');
                        if(!isAuto) alert("âš ï¸ åŒæ­¥å†²çªï¼šå…¶ä»–è®¾å¤‡æ­£åœ¨åŒæ­¥ï¼Œè¯·ç¨åé‡è¯•");
                        return;
                    }
                    throw fetchError;
                }

                setSyncBadgeStatus('status-idle', 'å·²åŒæ­¥');
                localStorage.setItem('habit_last_save', String(content.timestamp));
                persistAllLocal(); // ç¡®ä¿æœ¬åœ°æ•°æ®å·²ä¿å­˜
                // æˆåŠŸæ—¶ä¸å†å¼¹çª—ï¼ŒçŠ¶æ€æ–‡å­—"å·²åŒæ­¥"å·²è¶³å¤Ÿè¯´æ˜
            }
        } catch(e) {
            console.error(e);
            setSyncBadgeStatus('status-error', 'å¤±è´¥');
            if(!isAuto) alert("âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Token");
        }
        // AIGC START
        // ç¼©çŸ­çŠ¶æ€æ˜¾ç¤ºæ—¶é—´ï¼Œä»2ç§’æ”¹ä¸º800msï¼Œè®©ç”¨æˆ·æ›´å¿«çœ‹åˆ°æœ€ç»ˆçŠ¶æ€
        setTimeout(()=>setSyncBadgeStatus('status-idle', document.getElementById('syncText').innerText || 'æœ¬åœ°æ¨¡å¼'), 800);
        // AIGC END
    }

    async function syncGitee(action, isAuto) {
        // é˜²æ­¢é‡å¤æ‰§è¡Œï¼šå¦‚æœæ­£åœ¨åŒæ­¥ä¸­ï¼Œç›´æ¥è¿”å›
        // æ³¨æ„ï¼šsyncAll ä¼šè´Ÿè´£è°ƒåº¦ï¼Œå¦‚æœå•ç‹¬è°ƒç”¨æ­¤å‡½æ•°ï¼Œéœ€è¦è‡ªè¡Œæ£€æŸ¥
        // ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å…è®¸ syncAll å†…éƒ¨ä¸²è¡Œè°ƒç”¨
        
        console.log('syncGiteeè¢«è°ƒç”¨:', action, isAuto);
        
        const token = giteeConfig.token;
        const repo = giteeConfig.repo;
        const path = giteeConfig.path || 'habit_backup.json';
        if(!token || !repo) {
            // Gitee æœªé…ç½®ï¼Œé™é»˜è¿”å›
            return;
        }

        // æ›´æ–°çŠ¶æ€
        setSyncBadgeStatus('status-syncing', action==='push'?'ä¸Šä¼ ...':'åŒæ­¥...');
        await new Promise(resolve => requestAnimationFrame(resolve));

        try {
            // Gitee API V5
            // GET /repos/{owner}/{repo}/contents/{path}
            // PUT /repos/{owner}/{repo}/contents/{path}
            // Headers: Authorization: token {access_token} (or Bearer)
            // æ³¨æ„ï¼šGitee æœ‰æ—¶å¯¹ Header è®¤è¯æ”¯æŒä¸ç¨³å®šï¼Œæ”¹ä¸º Query Param (GET) å’Œ Body Param (PUT) æ–¹å¼
            const headers = { "Content-Type": "application/json;charset=UTF-8" };
            
            // GET
            let getRes = await fetch(`https://gitee.com/api/v5/repos/${repo}/contents/${path}?access_token=${token}`, { headers });
            
            // Gitee 401/403 handling
            if (getRes.status === 401) {
                 console.error('Gitee API 401 Unauthorized');
                 if(!isAuto) alert("Gitee Token æ— æ•ˆæˆ–è¿‡æœŸ");
                 setSyncBadgeStatus('status-error', 'è®¤è¯å¤±è´¥');
                 return;
            }

            let sha = null, cloudData = null;

            if(getRes.ok) {
                try {
                    const d = await getRes.json();
                    sha = d.sha || null;
                    // Gitee è¿”å› content æ˜¯ base64
                    const rawContent = d.content ? decodeURIComponent(escape(atob((d.content || '').replace(/\n/g,"")))) : '';
                    if (!rawContent || !rawContent.trim()) {
                        console.log('Giteeæ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè§†ä¸ºæ–°æ–‡ä»¶');
                        cloudData = null;
                    } else {
                        cloudData = JSON.parse(rawContent);
                    }
                } catch(parseError) {
                    console.error('è§£æGiteeäº‘ç«¯æ•°æ®å¤±è´¥:', parseError);
                    // å¦‚æœè§£æå¤±è´¥ï¼ˆå¯èƒ½æ˜¯æ‰‹åŠ¨åˆ›å»ºçš„ç©ºæ–‡ä»¶æˆ–éJSONæ–‡ä»¶ï¼‰ï¼Œåœ¨Pushæ—¶å…è®¸è¦†ç›–
                    // è¿™é‡Œæˆ‘ä»¬å°†å…¶è§†ä¸ºnullï¼Œå¹¶åœ¨æ§åˆ¶å°è®°å½•ã€‚å¦‚æœæ˜¯æ‰‹åŠ¨åŒæ­¥ï¼Œç»™ä¸ªæç¤ºã€‚
                    if(!isAuto && action === 'push') {
                         if(confirm("âš ï¸ æ£€æµ‹åˆ°Giteeäº‘ç«¯æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼ˆå¯èƒ½æ˜¯æ‰‹åŠ¨åˆ›å»ºçš„ç©ºæ–‡ä»¶ï¼‰ã€‚\næ˜¯å¦å¼ºåˆ¶è¦†ç›–ï¼Ÿ")) {
                             cloudData = null; // è§†ä¸ºä¸å­˜åœ¨ï¼Œå…è®¸åç»­Pushé€»è¾‘è¦†ç›–
                         } else {
                             setSyncBadgeStatus('status-error', 'æ ¼å¼é”™è¯¯');
                             return;
                         }
                    } else if (action === 'push') {
                        // è‡ªåŠ¨åŒæ­¥ä¸”æ˜¯Pushæ“ä½œï¼Œå‡è®¾æ˜¯ç©ºæ–‡ä»¶åˆå§‹åŒ–é—®é¢˜ï¼Œå°è¯•è¦†ç›–ï¼ˆä¸ºäº†å®‰å…¨ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è·³è¿‡ï¼Œä½†é€šå¸¸åˆå§‹åŒ–æ˜¯ç©ºæ–‡ä»¶ï¼‰
                        // ä¸ºå®‰å…¨èµ·è§ï¼Œè‡ªåŠ¨æ¨¡å¼ä¸‹å¦‚æœæ ¼å¼é”™è¯¯ï¼Œå…ˆè·³è¿‡ï¼Œé¿å…è¯¯åˆ é‡è¦æ•°æ®ï¼ˆè™½ç„¶JSONè§£æå¤±è´¥é€šå¸¸æ„å‘³ç€æ•°æ®å·²æŸåï¼‰
                        console.warn('è‡ªåŠ¨åŒæ­¥æ£€æµ‹åˆ°æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡GiteeåŒæ­¥ä»¥ä¿æŠ¤æ•°æ®');
                        setSyncBadgeStatus('status-error', 'æ ¼å¼é”™è¯¯');
                        return;
                    } else {
                        if(!isAuto) alert("âŒ Giteeäº‘ç«¯æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æ");
                        setSyncBadgeStatus('status-error', 'æ ¼å¼é”™è¯¯');
                        return;
                    }
                }
            } else if(getRes.status === 404) {
                cloudData = null;
            } else {
                const errorText = await getRes.text();
                console.error('Gitee APIé”™è¯¯:', getRes.status, errorText);
                throw new Error(`Gitee APIé”™è¯¯: ${getRes.status} - ${errorText}`);
            }

            if(action === 'pull') {
                if(!cloudData) {
                    // äº‘ç«¯æ²¡æœ‰æ•°æ®
                    return;
                }

                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;

                let shouldApply = false;
                if (cloudTs > localTs) {
                    shouldApply = true;
                }
                // Gitee åŒæ­¥ä¸€èˆ¬ä½œä¸ºè¾…åŠ©ï¼Œä¸å»ºè®®é¢‘ç¹å¼¹çª—è¯¢é—®ï¼Œé™¤éæ˜¯æ˜ç¡®çš„æ‰‹åŠ¨åŒæ­¥
                // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šå¦‚æœæ˜¯è‡ªåŠ¨åŒæ­¥ä¸”äº‘ç«¯æ–°ï¼Œå°±è¦†ç›–ï¼›å¦‚æœæ˜¯æ‰‹åŠ¨ä¸”äº‘ç«¯æ–°ï¼Œè¦†ç›–ï¼›
                // å¦‚æœäº‘ç«¯æ—§ï¼Œå¿½ç•¥ã€‚
                
                if(shouldApply) {
                    mergeData(cloudData, {
                        data: historyData || [],
                        todos: todoList || [],
                        wishes: wishList || [],
                        strategies: userStrategies || {},
                        timerRecords: timerRecords || [],
                        plannedTasks: plannedTasks || [],
                        dailyReviews: dailyReviews || {},
                        taskUsageCount: taskUsageCount || {}
                    });
                    
                    if(cloudData.config) config = cloudData.config;
                    if(cloudData.pinnedTaskId) {
                        pinnedTaskId = cloudData.pinnedTaskId;
                        localStorage.setItem('habit_pinned_task_id', pinnedTaskId);
                    }
                    if(cloudData.timeBank !== undefined) timeBank = cloudData.timeBank;
                    if(cloudData.wallet !== undefined) setWallet(cloudData.wallet);
                    if(cloudData.debt !== undefined) setDebt(cloudData.debt);
                    
                    // åŒæ­¥è®¡æ—¶å™¨çŠ¶æ€ (åŒ GitHub é€»è¾‘)
                    const hasCloudTimer = cloudData.timerState && cloudData.timerState.running;
                    if(hasCloudTimer) {
                        localStorage.setItem('habit_timer_state_v1', JSON.stringify(cloudData.timerState));
                    } else {
                        localStorage.removeItem('habit_timer_state_v1');
                    }

                    persistAllLocal();
                    localStorage.setItem('habit_last_save', String(cloudTs || Date.now()));

                    requestAnimationFrame(() => {
                        updateUI(); renderTodos(); checkDateChange(); applySettingsToUI(); renderStrategySettings();
                        if (typeof renderTimerHistory === 'function') renderTimerHistory();
                        if (typeof renderPlannedTasks === 'function') renderPlannedTasks();
                        restoreTimerState();
                        updateStickyNotif();
                    });
                    setSyncBadgeStatus('status-idle', 'å·²æ›´æ–°');
                } else {
                    setSyncBadgeStatus('status-idle', 'å·²æœ€æ–°');
                }
            } else {
                // Push
                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;
                
                if (cloudData && cloudTs > localTs) {
                    console.log('âš ï¸ æ£€æµ‹åˆ°Giteeäº‘ç«¯æœ‰æ›´æ–°ï¼Œå…ˆåˆå¹¶æ•°æ®å†æ¨é€');
                    mergeData(cloudData, {
                        data: historyData || [],
                        todos: todoList || [],
                        wishes: wishList || [],
                        strategies: userStrategies || {},
                        timerRecords: timerRecords || [],
                        plannedTasks: plannedTasks || [],
                        dailyReviews: dailyReviews || {},
                        taskUsageCount: taskUsageCount || {},
                        daysMatterList: daysMatterList || []
                    });
                }
                
                const timerStateStr = localStorage.getItem('habit_timer_state_v1');
                const timerState = timerStateStr ? JSON.parse(timerStateStr) : null;
                
                const content = {
                    timestamp: Date.now(),
                    data: stripImagesFromHistory(historyData),
                    config,
                    todos: todoList,
                    deletedTodoIds: typeof deletedTodoIds !== 'undefined' ? deletedTodoIds : [],
                    wishes: wishList,
                    strategies: userStrategies,
                    timeBank: timeBank,
                    wallet: getWallet(),
                    debt: getDebt(),
                    timerRecords: timerRecords,
                    plannedTasks: plannedTasks,
                    dailyReviews: dailyReviews,
                    taskUsageCount: taskUsageCount,
                    pinnedTaskId: pinnedTaskId,
                    timerState: timerState,
                    daysMatterList: daysMatterList
                };

                const body = {
                    access_token: token, // Gitee sometimes needs this in body for PUT? Headers should suffice but keeping safe
                    message: "Sync",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content))))
                };
                if (sha) body.sha = sha;

                // Gitee: å¦‚æœæ²¡æœ‰shaï¼ˆæ–°æ–‡ä»¶ï¼‰ï¼Œä½¿ç”¨POSTåˆ›å»ºï¼›å¦‚æœæœ‰shaï¼ˆæ›´æ–°æ–‡ä»¶ï¼‰ï¼Œä½¿ç”¨PUTæ›´æ–°
                const method = sha ? 'PUT' : 'POST';
                const putRes = await fetch(`https://gitee.com/api/v5/repos/${repo}/contents/${path}`, { 
                    method: method, 
                    headers, 
                    body: JSON.stringify(body) 
                });
                
                if (!putRes.ok) {
                    const errText = await putRes.text();
                    console.error(`Gitee ${method} Error Detail:`, errText);
                    throw new Error(`Gitee ${method} failed: ${putRes.status} - ${errText}`);
                }
                
                localStorage.setItem('habit_last_save', String(content.timestamp));
                persistAllLocal();
                setSyncBadgeStatus('status-idle', 'å·²åŒæ­¥');
            }
        } catch(e) {
            console.error('Gitee Sync Error:', e);
            setSyncBadgeStatus('status-error', 'å¤±è´¥');
            if(!isAuto) alert("âŒ Gitee åŒæ­¥å¤±è´¥: " + e.message);
        }
    }

    async function syncAll(action, isAuto) {
        // é˜²æ­¢é‡å¤æ‰§è¡Œ
        const badge = document.getElementById('syncBadge');
        if (badge && badge.classList.contains('status-syncing')) {
            console.log('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
            return;
        }
        
        const provider = config.syncProvider || 'both'; // both, github, gitee

        const gh = (provider === 'both' || provider === 'github') && ghConfig.token && ghConfig.repo;
        const gitee = (provider === 'both' || provider === 'gitee') && giteeConfig.token && giteeConfig.repo;

        if (!gh && !gitee) {
            if(!isAuto) {
                if (provider === 'both') alert("è¯·å…ˆé…ç½®åŒæ­¥è®¾ç½® (GitHub æˆ– Gitee)");
                else if (provider === 'github') alert("è¯·å…ˆé…ç½® GitHub åŒæ­¥è®¾ç½®");
                else if (provider === 'gitee') alert("è¯·å…ˆé…ç½® Gitee åŒæ­¥è®¾ç½®");
            }
            return;
        }

        // ä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®
        if (gh) {
             // ä¿®æ”¹ syncGitHub è®©å®ƒä¸è¦æ£€æŸ¥ badge çŠ¶æ€ï¼Ÿ
             // æˆ–è€…æˆ‘ä»¬åœ¨è°ƒç”¨å‰æ‰‹åŠ¨é‡ç½® badge? 
             // å®é™…ä¸Š syncGitHub å†…éƒ¨æœ‰ checkï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¨å¾®ä¿®æ”¹ syncGitHub æˆ–è€…
             // ä¾èµ– syncGitHub æ‰§è¡Œå®Œåä¼šé‡ç½® badge ä¸º idleã€‚
             // syncGitHub æ˜¯ async çš„ï¼Œawait å®ƒä¼šç­‰å¾…å®ƒå®Œæˆã€‚
             await syncGitHub(action, isAuto);
        }
        
        if (gitee) {
            await syncGitee(action, isAuto);
        }
        
        // æœ€åç»Ÿä¸€é‡ç½®çŠ¶æ€ï¼ˆè™½ç„¶å„ä¸ª sync å‡½æ•°å†…éƒ¨ä¹Ÿä¼šé‡ç½®ï¼Œä½†ä¸ºäº†ä¿é™©ï¼‰
        setTimeout(() => {
            const el = document.getElementById('syncText');
            let txt = el ? el.innerText : 'å·²åŒæ­¥';
            // å¦‚æœæ–‡æœ¬ä»æ˜¾ç¤ºæ­£åœ¨åŒæ­¥ï¼ˆåŒ…å«...ï¼‰ï¼Œå¼ºåˆ¶é‡ç½®ä¸ºâ€œå·²åŒæ­¥â€
            if(txt.includes('...') || txt.includes('Gitee') || txt.includes('GitHub')) txt = 'å·²åŒæ­¥';
            setSyncBadgeStatus('status-idle', txt);
        }, 800);
    }

    async function archiveToGitHub() {
        const provider = config.syncProvider || 'both';
        const useGh = (provider === 'both' || provider === 'github') && ghConfig.token && ghConfig.repo;
        const useGitee = (provider === 'both' || provider === 'gitee') && giteeConfig.token && giteeConfig.repo;

        if(!useGh && !useGitee) return alert("è¯·å…ˆé…ç½®åŒæ­¥è®¾ç½® (GitHub æˆ– Gitee)");
        
        const timestamp = getTimestampStr();
        const defaultName = `habit_archive_${timestamp}.json`;
 
        showModal({
            title: 'åˆ›å»ºäº‘å­˜æ¡£',
            message: 'è¾“å…¥äº‘ç«¯å¤‡ä»½æ–‡ä»¶åï¼ˆä¿å­˜åœ¨ backups/ ç›®å½•ï¼‰',
            inputs: [{ id: 'cloudBackupName', label: 'æ–‡ä»¶å', type: 'text', value: defaultName }],
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { text: 'ä¿å­˜', primary: true, callback: async (values) => {
                    const name = values.cloudBackupName ? values.cloudBackupName.trim() : '';
                    const sanitized = (name || defaultName).replace(/[\\/:*?\"<>|]/g, '');
                    const finalName = /\.json$/i.test(sanitized) ? sanitized : (sanitized + '.json');
                    const path = `backups/${finalName}`;
 
                    setSyncBadgeStatus('status-syncing', 'ä¸Šä¼ ...');
 
                    try {
                        const timerStateStr = localStorage.getItem('habit_timer_state_v1');
                        const timerState = timerStateStr ? JSON.parse(timerStateStr) : null;
                        const content = {
                            timestamp: Date.now(),
                            data: stripImagesFromHistory(historyData),
                            config,
                            todos: todoList,
                            deletedTodoIds: typeof deletedTodoIds !== 'undefined' ? deletedTodoIds : [],
                            wishes: wishList,
                            strategies: userStrategies,
                            timeBank: timeBank,
                            timerRecords: timerRecords,
                            plannedTasks: plannedTasks,
                            dailyReviews: dailyReviews,
                            taskUsageCount: taskUsageCount,
                            pinnedTaskId: pinnedTaskId,
                            theme: currentTheme,
                            timerState: timerState
                        };
                        const contentStr = JSON.stringify(content);
                        const body = { message: `Archive ${timestamp}`, content: btoa(unescape(encodeURIComponent(contentStr))) };
                        
                        let success = [];
                        let fails = [];

                        // GitHub Archive
                        if (useGh) {
                            try {
                                const res = await fetch(`https://api.github.com/repos/${ghConfig.repo}/contents/${path}`, { 
                                    method:'PUT', 
                                    headers: { "Authorization": `Bearer ${ghConfig.token}`, "Accept": "application/vnd.github.v3+json" }, 
                                    body: JSON.stringify(body) 
                                });
                                if (res.ok) success.push('GitHub');
                                else fails.push('GitHub');
                            } catch(e) { fails.push('GitHub'); }
                        }

                        // Gitee Archive
                        if (useGitee) {
                            try {
                                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼ˆGiteeä¸æ”¯æŒç›´æ¥PUTæ–°å»ºå¦‚æœæ²¡shaï¼Œä½†backupsé€šå¸¸æ˜¯æ–°å»ºï¼Œæ‰€ä»¥ç›´æ¥POSTï¼‰
                                // ä¸ºä¿é™©èµ·è§ï¼Œå…ˆå°è¯•GETæ£€æŸ¥ï¼ˆè™½ç„¶å­˜æ¡£åé€šå¸¸æ˜¯æ–°çš„ï¼‰
                                // ç®€å•èµ·è§ï¼Œå­˜æ¡£é€šå¸¸å”¯ä¸€ï¼Œç›´æ¥POSTåˆ›å»ºã€‚å¦‚æœæ–‡ä»¶åé‡å¤ï¼ŒAPIä¼šæŠ¥é”™ï¼Œè¿™é‡Œä¸åšå¤æ‚æ£€æŸ¥ã€‚
                                // Gitee POST to create file
                                const res = await fetch(`https://gitee.com/api/v5/repos/${giteeConfig.repo}/contents/${path}`, { 
                                    method:'POST', 
                                    headers: { "Content-Type": "application/json;charset=UTF-8" }, 
                                    body: JSON.stringify({
                                        access_token: giteeConfig.token,
                                        message: body.message,
                                        content: body.content
                                    })
                                });
                                if (res.ok) success.push('Gitee');
                                else {
                                    // å¦‚æœPOSTå¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰ï¼Œå°è¯•GETè·å–shaç„¶åPUT
                                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šå­˜æ¡£ä¸€èˆ¬å¸¦æ—¶é—´æˆ³ï¼Œè§†ä¸ºæ–°å»ºã€‚å¦‚æœé‡åï¼Œè®©ç”¨æˆ·æ”¹åæˆ–å¤±è´¥ã€‚
                                    fails.push('Gitee'); 
                                }
                            } catch(e) { fails.push('Gitee'); }
                        }

                        if (success.length > 0) {
                            alert(`âœ… å­˜æ¡£æˆåŠŸ (${success.join(', ')})ï¼\nå·²åŒ…å«ï¼šå¿«æ·ä»»åŠ¡ã€å¤ç›˜è®¾ç½®ã€æ—¶é—´å¿«é€‰ç­‰é…ç½®ã€‚\næ–‡ä»¶å: ${path}`);
                        } else {
                            alert("âŒ å­˜æ¡£å¤±è´¥");
                        }
                    } catch(e) {
                        alert("âŒ å‘ç”Ÿé”™è¯¯: " + e.message);
                    } finally {
                        setSyncBadgeStatus('status-idle', 'æœ¬åœ°æ¨¡å¼');
                    }
                } }
            ]
        });
    }

    async function listCloudBackups() {
        const provider = config.syncProvider || 'both';
        const useGh = (provider === 'both' || provider === 'github') && ghConfig.token && ghConfig.repo;
        const useGitee = (provider === 'both' || provider === 'gitee') && giteeConfig.token && giteeConfig.repo;
        
        if(!useGh && !useGitee) return alert("è¯·å…ˆé…ç½®åŒæ­¥è®¾ç½®");

        // ä¼˜å…ˆä»modalä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå¦‚æœmodalæ˜¯æ‰“å¼€çš„ï¼‰
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.classList.contains('show');
        const modalContent = isModalOpen ? document.getElementById('settingsModalContent') : null;
        
        const getEl = (elId) => {
            if (isModalOpen && modalContent) {
                const el = modalContent.querySelector('#' + elId);
                if (el) return el;
            }
            return document.getElementById(elId);
        };
        
        const listEl = getEl('cloudBackupList');
        if (!listEl) return;
        
        listEl.style.display = 'block';
        listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">âŒ› æ­£åœ¨åŠ è½½åˆ—è¡¨...</div>';

        let files = [];
        let errors = [];

        // GitHub
        if (useGh) {
            try {
                const headers = { "Authorization": `Bearer ${ghConfig.token}`, "Accept": "application/vnd.github.v3+json" };
                const res = await fetch(`https://api.github.com/repos/${ghConfig.repo}/contents/backups`, { headers });
                if(res.ok) {
                    const ghFiles = await res.json();
                    if (Array.isArray(ghFiles)) {
                        files = files.concat(ghFiles.map(f => ({...f, source: 'GitHub'})));
                    }
                }
            } catch(e) { errors.push('GitHub'); }
        }

        // Gitee
        if (useGitee) {
            try {
                const headers = { "Content-Type": "application/json;charset=UTF-8" };
                const res = await fetch(`https://gitee.com/api/v5/repos/${giteeConfig.repo}/contents/backups?access_token=${giteeConfig.token}`, { headers });
                if(res.ok) {
                    const giteeFiles = await res.json();
                    if (Array.isArray(giteeFiles)) {
                        // Gitee files format is similar
                        files = files.concat(giteeFiles.map(f => ({...f, source: 'Gitee'})));
                    }
                }
            } catch(e) { errors.push('Gitee'); }
        }

        if(files.length === 0) {
            listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">ğŸ“‚ æ— äº‘ç«¯å­˜æ¡£' + (errors.length > 0 ? ' (åŠ è½½å‡ºé”™)' : '') + 'ã€‚</div>';
            return;
        }

        // å»é‡ (å¦‚æœæœ‰åŒåæ–‡ä»¶ï¼Œä¼˜å…ˆä¿ç•™å“ªä¸€ä¸ªï¼Ÿæˆ–è€…éƒ½æ˜¾ç¤ºï¼Ÿè¿™é‡Œç®€å•å¤„ç†ï¼Œæ˜¾ç¤ºæ¥æº)
        // ç®€å•æ’åº
        files.sort((a,b) => b.name.localeCompare(a.name));
        
        listEl.innerHTML = files.map(f => `
            <div class="backup-file-item" onclick="restoreCloudBackup('${f.path}', '${f.source}')">
                <span>ğŸ“„ ${f.name} <span style="font-size:10px;color:var(--text-sub);background:var(--bg);padding:2px 4px;border-radius:4px;">${f.source}</span></span>
                <span style="font-size:10px; color:var(--info);">æ¢å¤æ­¤ç‰ˆ</span>
            </div>
        `).join('');
    }

    async function restoreCloudBackup(path, source) {
        if(!confirm(`âš ï¸ ç¡®å®šè¦ä» ${source} äº‘ç«¯æ–‡ä»¶ [${path}] æ¢å¤æ•°æ®å—ï¼Ÿ`)) return;
        
        let contentStr = '';
        
        try {
            if (source === 'GitHub') {
                const headers = { "Authorization": `Bearer ${ghConfig.token}`, "Accept": "application/vnd.github.v3+json" };
                const res = await fetch(`https://api.github.com/repos/${ghConfig.repo}/contents/${path}`, { headers });
                const d = await res.json();
                contentStr = decodeURIComponent(escape(atob(d.content.replace(/\n/g,""))));
            } else if (source === 'Gitee') {
                const headers = { "Content-Type": "application/json;charset=UTF-8" };
                const res = await fetch(`https://gitee.com/api/v5/repos/${giteeConfig.repo}/contents/${path}?access_token=${giteeConfig.token}`, { headers });
                const d = await res.json();
                contentStr = decodeURIComponent(escape(atob(d.content.replace(/\n/g,""))));
            }
            
            if (contentStr) {
                const content = JSON.parse(contentStr);
                restoreData(content);
            }
        } catch(e) { 
            console.error(e);
            alert(`âŒ ä» ${source} æ¢å¤å¤±è´¥: ${e.message}`); 
        }
    }

    function renderStrategies() {
        const container = document.getElementById('strategyArea');
        if (!container) return;
        container.innerHTML = '';
        if (!historyData || historyData.length === 0) return;
        const lastRecord = historyData[0];
        if (!lastRecord || !lastRecord.details || !lastRecord.details.penalty_rule) return;
        
        let failedTypes = [];
        if (lastRecord.details.penalty_rule.includes('å°‘å­¦')) failedTypes.push('study');
        if (lastRecord.details.penalty_rule.includes('æ™šèµ·')) failedTypes.push('wake');
        if (lastRecord.details.penalty_rule.includes('æ™šç¡')) failedTypes.push('sleep');

        if (failedTypes.length === 0) return;

        let suggestions = [];
        failedTypes.forEach(type => {
            if (userStrategies[type] && Array.isArray(userStrategies[type])) {
                suggestions = suggestions.concat(userStrategies[type]);
            }
        });

        if (suggestions.length === 0) return;

        const html = `
            <div style="width:100%; font-size:11px; color:var(--text-sub); margin:8px 0 4px 0; font-weight:600;">ğŸ’¡ ç‚¹å‡»å¼•ç”¨è¡¥æ•‘ç­–ç•¥:</div>
            ${suggestions.map(s => `<div class="chip" onclick="fillStrategy('${s}')" style="background:var(--input-bg);border-color:var(--primary);color:var(--primary)">${s}</div>`).join('')}
        `;
        container.innerHTML = html;
    }

    function fillStrategy(txt) {
        const targetIds = ['r_fix', 'f_plan'];
        let target = null;
        for(let id of targetIds) {
            if(document.getElementById(id)) { target = document.getElementById(id); break; }
        }
        if(target) {
            const oldVal = target.value;
            target.value = oldVal ? (oldVal + " + " + txt) : txt;
            target.style.borderColor = 'var(--primary)';
            setTimeout(()=>target.style.borderColor='var(--border)', 300);
        }
    }

    function toggleExpiredFullView() {
        expiredFullView = !expiredFullView;
        renderTodos();
    }

    function toggleTimerFullView() {
        timerFullView = !timerFullView;
        renderTimerHistory();
    }

    function toggleHistoryFullView() {
        historyFullView = !historyFullView;
        updateUI();
        updateDebtModalHistoryList();
    }

        // å…œåº•ï¼šå¦‚æœæµè§ˆå™¨/ç¯å¢ƒå±è”½ inline onclickï¼Œä»èƒ½ç‚¹å‡»ç”Ÿæ•ˆ
        document.addEventListener('click', function (e) {
        // AIGC START
        // å¤„ç†åŒæ­¥æŒ‰é’®ç‚¹å‡»ï¼ˆä½œä¸ºå…œåº•ï¼Œå¦‚æœonclickå¤±æ•ˆï¼‰
        const syncBadge = e.target && e.target.closest ? e.target.closest('#syncBadge') : null;
        if (syncBadge) {
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŒæ­¥ä¸­ï¼Œé¿å…é‡å¤ç‚¹å‡»ï¼ˆä¼˜å…ˆæ£€æŸ¥çŠ¶æ€ï¼‰
            const isSyncing = syncBadge.classList.contains('status-syncing');
            if (isSyncing) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰onclickå¤„ç†æ ‡è®°ï¼Œé¿å…é‡å¤æ‰§è¡Œ
            const clickedAttr = syncBadge.getAttribute('data-click-handled');
            if (!clickedAttr) {
                console.log('é€šè¿‡äº‹ä»¶å§”æ‰˜æ•è·åŒæ­¥æŒ‰é’®ç‚¹å‡»ï¼ˆonclickå¯èƒ½å¤±æ•ˆï¼‰');
                // ç«‹å³è®¾ç½®æ ‡è®°ï¼Œé˜²æ­¢onclickå’Œäº‹ä»¶å§”æ‰˜åŒæ—¶æ‰§è¡Œ
                syncBadge.setAttribute('data-click-handled', 'true');
                setTimeout(() => syncBadge.removeAttribute('data-click-handled'), 1000);
                // ä¸åœ¨è¿™é‡Œæå‰æ”¹æˆåŒæ­¥ä¸­ï¼Œç›´æ¥è°ƒç”¨ syncAllï¼Œ
                // è®© syncAll è‡ªå·±è´Ÿè´£çŠ¶æ€åˆ‡æ¢ï¼Œé¿å…è¢«å®ƒçš„â€œæ­£åœ¨åŒæ­¥ä¸­â€åˆ¤æ–­ç›´æ¥ return æ‰
                syncAll('pull', false);
            }
            return;
        }
        // AIGC END
        
        const btn = e.target && e.target.closest ? e.target.closest('#btnApplyManualAdjustment') : null;
        if (btn) {
            // æ˜ç¡®çš„å¯è§†åé¦ˆï¼šæŒ‰é’®å˜è‰² + çŠ¶æ€æ–‡æ¡ˆ
            btn.style.opacity = '0.8';
            btn.style.transform = 'scale(0.98)';
            setTimeout(() => {
                btn.style.opacity = '';
                btn.style.transform = '';
            }, 120);

            const statusEl = document.getElementById('manualAdjustmentStatus');
            if (statusEl) statusEl.textContent = 'å·²è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼ˆç›‘å¬å™¨ï¼‰ï¼Œæ­£åœ¨æ‰§è¡Œ applyManualAdjustment...';

            // ç”¨ä¸€ä¸ªâ€œä¼ªäº‹ä»¶â€ç¡®ä¿ currentTarget/target å¯ç”¨ï¼ˆæµè§ˆå™¨åŸç”Ÿ event.currentTarget é€šå¸¸ä¸å¯å†™ï¼‰
            applyManualAdjustment({
                currentTarget: btn,
                target: btn,
                stopPropagation: () => {}
            });
        }
    }, true);

    // --------------------------------------------------------
    // å€’æ•°æ—¥ (Days Matter) åŠŸèƒ½
    // --------------------------------------------------------

    // è·å–æ—¥æœŸå·®å€¼ï¼ˆå¤©æ•°ï¼‰
    function getTimeDiffDays(date1Str, date2Str) {
        if (!date1Str || !date2Str) return 0;
        const d1 = new Date(date1Str);
        const d2 = new Date(date2Str);
        // é‡ç½®æ—¶é—´éƒ¨åˆ†ä¸º0ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
        d1.setHours(0, 0, 0, 0);
        d2.setHours(0, 0, 0, 0);
        const diffTime = d2 - d1;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // æ¸²æŸ“å€’æ•°æ—¥åˆ—è¡¨ï¼ˆåœ¨æ—¶é—´é“¶è¡Œå¼¹çª—ä¸­ï¼‰
    function renderDaysMatter() {
        const list = document.getElementById('daysMatterList');
        if (!list) return;
        
        if (!daysMatterList || daysMatterList.length === 0) {
            list.innerHTML = '<div style="color:var(--text-sub); font-size:12px; text-align:center;">æš‚æ— å€’æ•°æ—¥ï¼Œç‚¹å‡» + æ·»åŠ </div>';
            return;
        }
        
        // æ’åºï¼šæŒ‰æ—¥æœŸå‡åº
        daysMatterList.sort((a, b) => a.date.localeCompare(b.date));
        
        list.innerHTML = daysMatterList.map((item, idx) => {
            const today = getLocalTodayStr();
            const diff = getTimeDiffDays(today, item.date);
            let diffText = '';
            let style = '';
            
            if (diff > 0) {
                diffText = `${diff}å¤©å`;
                style = 'color:var(--primary);';
            } else if (diff < 0) {
                diffText = `å·²è¿‡${Math.abs(diff)}å¤©`;
                style = 'color:var(--text-sub);';
            } else {
                diffText = 'ä»Šå¤©';
                style = 'color:var(--warning); font-weight:bold;';
            }
            
            const pinIcon = item.pinned ? '<span style="font-size:12px; margin-right:4px;">ğŸ“Œ</span>' : '';
            
            return `
                <div class="chip" style="display:flex; justify-content:space-between; align-items:center; padding:8px 12px; width:100%; box-sizing:border-box;">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-weight:600;">${pinIcon}${item.name}</span>
                        <span style="font-size:11px; opacity:0.7;">${item.date} Â· <span style="${style}">${diffText}</span></span>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <span style="cursor:pointer; opacity:0.6;" onclick="editDaysMatterItem(${idx})">âœ</span>
                        <span style="cursor:pointer; opacity:0.6; color:var(--danger);" onclick="deleteDaysMatterItem(${idx})">âœ•</span>
                    </div>
                </div>
            `;
        }).join('');
        
        // æ›´æ–°ç½®é¡¶é€šçŸ¥
        updateStickyNotif();
    }

    // æ¸²æŸ“ç½®é¡¶å€’æ•°æ—¥ï¼ˆåœ¨ä¸»é¡µé¡¶éƒ¨ï¼‰
    function renderPinnedDaysMatter() {
        const container = document.getElementById('notifDaysMatter');
        if (!container) return false;
        
        const pinnedItems = daysMatterList.filter(item => item.pinned === true || item.pinned === 'true');
        
        if (pinnedItems.length === 0) {
            container.style.display = 'none';
            return false;
        }
        
        container.style.display = 'grid';
        container.innerHTML = pinnedItems.map(item => {
            const today = getLocalTodayStr();
            const diff = getTimeDiffDays(today, item.date);
            let diffText = '';
            let colorClass = ''; // For text color
            
            if (diff > 0) {
                diffText = `${diff}å¤©`;
                colorClass = 'color:var(--primary);';
            } else if (diff < 0) {
                diffText = `è¿‡${Math.abs(diff)}å¤©`;
                colorClass = 'color:var(--text-sub);';
            } else {
                diffText = 'ä»Šå¤©';
                colorClass = 'color:var(--warning); font-weight:bold;';
            }
            
            return `
                <div style="display:flex; flex-direction:column; align-items:center; background:var(--input-bg); border-radius:4px; padding:4px; font-size:11px;">
                    <span style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%;">${item.name}</span>
                    <span style="${colorClass}">${diffText}</span>
                </div>
            `;
        }).join('');
        
        return true;
    }

    // æ·»åŠ å€’æ•°æ—¥
    function addDaysMatterItem() {
        showModal({
            title: 'æ·»åŠ å€’æ•°æ—¥',
            message: 'è®¾ç½®é‡è¦çš„æ—¥å­ï¼ˆå¦‚è€ƒè¯•ã€çºªå¿µæ—¥ç­‰ï¼‰',
            inputs: [
                { id: 'dmName', label: 'åç§°', placeholder: 'ä¾‹å¦‚ï¼šæœŸæœ«è€ƒè¯•', type: 'text' },
                { id: 'dmDate', label: 'æ—¥æœŸ', type: 'date', value: getLocalTodayStr() },
                { 
                    id: 'dmPinned', 
                    label: 'ç½®é¡¶æ˜¾ç¤º', 
                    type: 'select', 
                    value: 'false',
                    options: [
                        { value: 'false', label: 'å¦' },
                        { value: 'true', label: 'æ˜¯' }
                    ]
                }
            ],
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { 
                    text: 'ç¡®å®š', 
                    primary: true, 
                    callback: (values) => {
                        const name = values.dmName ? values.dmName.trim() : '';
                        const date = values.dmDate;
                        const pinned = values.dmPinned === 'true';
                        
                        if (!name || !date) {
                            alert('è¯·å¡«å†™åç§°å’Œæ—¥æœŸ');
                            return;
                        }
                        
                        daysMatterList.push({ name, date, pinned });
                        localStorage.setItem('habit_days_matter_v1', JSON.stringify(daysMatterList));
                        triggerAutoSave();
                        renderDaysMatter();
                    }
                }
            ]
        });
    }

    // ç¼–è¾‘å€’æ•°æ—¥
    function editDaysMatterItem(idx) {
        if (idx < 0 || idx >= daysMatterList.length) return;
        const item = daysMatterList[idx];
        
        showModal({
            title: 'ç¼–è¾‘å€’æ•°æ—¥',
            message: 'ä¿®æ”¹åç§°æˆ–æ—¥æœŸ',
            inputs: [
                { id: 'dmName', label: 'åç§°', value: item.name, type: 'text' },
                { id: 'dmDate', label: 'æ—¥æœŸ', value: item.date, type: 'date' },
                { 
                    id: 'dmPinned', 
                    label: 'ç½®é¡¶æ˜¾ç¤º', 
                    type: 'select', 
                    value: item.pinned ? 'true' : 'false',
                    options: [
                        { value: 'false', label: 'å¦' },
                        { value: 'true', label: 'æ˜¯' }
                    ]
                }
            ],
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { 
                    text: 'ç¡®å®š', 
                    primary: true, 
                    callback: (values) => {
                        const name = values.dmName ? values.dmName.trim() : '';
                        const date = values.dmDate;
                        const pinned = values.dmPinned === 'true';
                        
                        if (!name || !date) {
                            alert('è¯·å¡«å†™åç§°å’Œæ—¥æœŸ');
                            return;
                        }
                        
                        daysMatterList[idx] = { name, date, pinned };
                        localStorage.setItem('habit_days_matter_v1', JSON.stringify(daysMatterList));
                        triggerAutoSave();
                        renderDaysMatter();
                    }
                }
            ]
        });
    }

    // åˆ é™¤å€’æ•°æ—¥
    function deleteDaysMatterItem(idx) {
        if (idx < 0 || idx >= daysMatterList.length) return;
        
        showModal({
            title: 'åˆ é™¤ç¡®è®¤',
            message: `ç¡®å®šè¦åˆ é™¤å€’æ•°æ—¥â€œ${daysMatterList[idx].name}â€å—ï¼Ÿ`,
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { 
                    text: 'åˆ é™¤', 
                    primary: true, 
                    callback: () => {
                        daysMatterList.splice(idx, 1);
                        localStorage.setItem('habit_days_matter_v1', JSON.stringify(daysMatterList));
                        triggerAutoSave();
                        renderDaysMatter();
                    }
                }
            ]
        });
    }

    // -----------------------------------------------------------
    // ç§»åŠ¨ç«¯é”®ç›˜é®æŒ¡ä¿®å¤ï¼šå½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œæ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ
    // -----------------------------------------------------------
    document.addEventListener('focusin', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            // å»¶è¿Ÿä»¥ç­‰å¾…é”®ç›˜å¼¹å‡ºåŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    });

    init();
</script>
</body>
</html>
